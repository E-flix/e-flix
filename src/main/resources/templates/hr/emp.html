<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{common/layouts/default}">
<!-- ============================================
  - ì‘ì„±ì   : ê¹€ì–´ì§„
  - ìµœì´ˆì‘ì„± : 2025-06-18
  - ì„¤ëª…     : ì‚¬ì› ì¡°íšŒí™”ë©´ (ê´€ë¦¬ì)
  -----------------------------------------------
  [ ë³€ê²½ ì´ë ¥ ]
  - 2025-06-18 (ê¹€ì–´ì§„): title ë° ë‚´ìš© ì¶”ê°€
  - 2025-06-19 (ê¹€ì–´ì§„): layout êµ¬ì„± ë° ëª¨ë‹¬ì°½ ìƒì„±
  - 2025-06-20 (ê¹€ì–´ì§„): ì‚¬ì› ì „ì²´ì¡°íšŒ êµ¬í˜„
  - 2025-06-23 (ê¹€ì–´ì§„): ì¡°ê±´ë³„ ê²€ìƒ‰ êµ¬í˜„
  - 2025-06-24 (ê¹€ì–´ì§„): ì‚¬ì›ë“±ë¡ êµ¬í˜„ ì¤‘
============================================ -->

<head>
  <title>ì‚¬ì›ê´€ë¦¬</title>
</head>

<div layout:fragment="content">
  <div class="w-100" id="empList">
    <div class="d-flex justify-content-between align-items-center mb-1">
      <h3>ì‚¬ì›ê´€ë¦¬</h3>
    </div>
    <div class="py-4">
      <!-- ì‚¬ì›ë“±ë¡ / ìˆ˜ì • ë²„íŠ¼ -->
      <div class="d-flex justify-content-end mb-2 gap-2">
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#employeeModal">
          ì‚¬ì›ë“±ë¡
        </button>
        <button class="btn btn-primary">ì‚¬ì›ìˆ˜ì •</button>
      </div>

      <!-- ê²€ìƒ‰ í•„í„° -->
      <form>
        <div class="p-4 bg-light rounded mb-4">
          <div class="row g-3 align-items-center mb-3">
            <div class="col-md-2"><label class="form-label">ê²€ìƒ‰ ê¸°ì¤€</label></div>
            <div class="col-md-2">
              <select name="option" class="form-select" id="searchSelect">
                <option>ì „ì²´</option>
                <option value="empName" th:selected="${option=='empName'}">ì‚¬ì›ëª…</option>
                <option value="empIdx" th:selected="${option=='empIdx'}">ì‚¬ì›ID</option>
              </select>
            </div>
            <div class="col-md-4">
              <input type="text" name="keyword" class="form-control" id="searchInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥ í›„ [enter]">
            </div>
          </div>
          <div class="row g-3 mb-3">
            <div class="col-md-2">
              <label class="form-label">ë¶€ì„œ</label>
            </div>
            <div class="col-md-2">
              <select id="deptSelect" name="deptUpIdx" class="form-select">
                <option>ì„ íƒ</option>
                <!-- ìµœìƒìœ„ ë¶€ì„œ ëª©ë¡ ë°”ì¸ë”© -->
                <option th:each="d : ${depts}" th:value="${d.deptIdx}" th:text="${d.deptName}">
                </option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label">ìƒì„¸ ë¶€ì„œ</label>
            </div>
            <div class="col-md-2">
              <select id="detailDeptSelect" name="deptIdx" class="form-select">
                <option>ì„ íƒ</option>
              </select>
            </div>
          </div>
          <div class="row g-3 mb-3 align-items-center">
            <div class="col-md-2">
              <label class="form-label">ì§ê¸‰</label>
            </div>
            <div class="col-md-2">
              <select name="empGrade" class="form-select">
                <option value="">ì„ íƒ</option>
                <option th:each="g : ${gradeList}" th:value="${g.empGrade}" th:text="${g.empGrade}"
                  th:selected="${option=='empGrade' and keyword==empGrade}">
                </option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label">ì¬ì§ ìƒíƒœ</label>
            </div>
            <div class="col-md-2">
              <select name="empStatusType" class="form-select">
                <option value="">ì„ íƒ</option>
                <option th:each="es : ${empStatusList}" th:value="${es.empIdx}" th:text="${es.empStatus}"
                  th:selected="${option== 'empStatusType' and keyword==es.empIdx}">
                </option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label">ê·¼ë¬´ ìœ í˜•</label>
            </div>
            <div class="col-md-2">
              <select name="empType" class="form-select">
                <option value="">ì„ íƒ</option>
                <option th:each="w : ${workList}" th:value="${w.workTypeId}" th:text="${w.workTypeNm}"
                  th:selected="${option=='empType' and keyword==w.workTypeId}">
                </option>
              </select>
            </div>
          </div>

          <div class="d-flex justify-content-center gap-3">
            <button type="submit" class="btn btn-primary" id="searchBtn">ì¡°íšŒ</button>
            <button class="btn btn-secondary">ì´ˆê¸°í™”</button>
          </div>
        </div>
      </form>
      <!-- ì‚¬ì›ë“±ë¡ ëª¨ë‹¬ -->
      <div class="modal fade" id="employeeModal" tabindex="-1" aria-labelledby="employeeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
          <div class="modal-content p-3">

            <!-- 1) í—¤ë” -->
            <div class="modal-header">
              <h5 class="modal-title" id="employeeModalLabel">ì‚¬ì›ë“±ë¡</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <!-- 2) ë°”ë”” -->
            <div class="modal-body">
              <form id="employeeForm">
                <!-- ì‚¬ì›ë²ˆí˜¸ / ì‚¬ì›ëª… -->
                <div class="row mb-3 align-items-center">
                  <label for="empIdx" class="col-md-2 col-form-label">ì‚¬ì›ë²ˆí˜¸</label>
                  <div class="col-md-4">
                    <input type="text" id="empIdx" name="empIdx" class="form-control">
                  </div>
                  <label for="empName" class="col-md-2 col-form-label">ì‚¬ì›ëª…</label>
                  <div class="col-md-4">
                    <input type="text" id="empName" name="empName" class="form-control" placeholder="ì‚¬ì›ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
                  </div>
                </div>

                <!-- ì£¼ë¯¼ë²ˆí˜¸: ì•6 / - / ë’¤7 -->
                <div class="row mb-3 align-items-center">
                  <!-- 1) ë¼ë²¨ -->
                  <label class="col-md-2 col-form-label">ì£¼ë¯¼ë²ˆí˜¸</label>

                  <!-- 2) ì•6-â€“-ë’¤7ì„ í•œ Input Group ì•ˆì— -->
                  <div class="col-md-4">
                    <div class="input-group">
                      <input type="text" name="rrnPfx" class="form-control" placeholder="ì• 6ìë¦¬" maxlength="6">
                      <span class="input-group-text">-</span>
                      <input type="password" name="rrnSfx" class="form-control" placeholder="ë’¤ 7ìë¦¬" maxlength="7">
                    </div>
                  </div>
                  <div class="col-md-2"></div>
                  <div class="col-md-4"></div>
                </div>

                <!-- ì´ë©”ì¼ / ì—°ë½ì²˜ -->
                <div class="row mb-3 align-items-center">
                  <label for="empEmail" class="col-md-2 col-form-label">ì´ë©”ì¼(ID)</label>
                  <div class="col-md-4">
                    <input type="email" id="empEmail" name="empEmail" class="form-control" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”">
                  </div>
                  <label for="empPhone" class="col-md-2 col-form-label">ì—°ë½ì²˜</label>
                  <div class="col-md-4">
                    <input type="text" id="empPhone" name="empPhone" class="form-control" placeholder="'-' ì—†ì´ ì…ë ¥">
                  </div>
                </div>

                <!-- ë¹„ë°€ë²ˆí˜¸ / ì…ì‚¬ì¼ -->
                <div class="row mb-3 align-items-center">
                  <label for="empPassword" class="col-md-2 col-form-label">ë¹„ë°€ë²ˆí˜¸</label>
                  <div class="col-md-4">
                    <input type="password" id="empPassword" name="empPw" class="form-control">
                  </div>
                  <label for="hireDate" class="col-md-2 col-form-label">ì…ì‚¬ì¼</label>
                  <div class="col-md-4">
                    <input type="date" id="hireDate" name="empRegdate" class="form-control">
                  </div>
                </div>
                </select>

                <!-- ë¶€ì„œ / ì§ê¸‰ -->
                <div class="row mb-3 align-items-center">
                  <div class="row mb-3 align-items-center gx-4">
                    <label for="deptIdx" class="col-md-2 col-form-label">ë¶€ì„œ</label>
                    <div class="col-md-4">
                      <select id="insertDeptSelect" name="deptUpIdx" class="form-select">
                        <option value="">ì„ íƒ</option>
                        <option th:each="d : ${depts}" th:value="${d.deptIdx}" th:text="${d.deptName}"></option>
                      </select>
                    </div>

                    <!-- <div class="col-md-2">
              <select id="detailDeptSelect" name="deptIdx" class="form-select">
                <option>ì„ íƒ</option>
              </select>
            </div> -->

                    <label class="col-md-2 col-form-label">ìƒì„¸ ë¶€ì„œ</label>
                    <div class="col-md-4">
                      <select id="insertDetailDeptSelect" name="deptIdx" class="form-select">
                        <option>ì„ íƒ</option>
                      </select>
                    </div>
                  </div>

                  <label for="empGrade" class="col-md-2 col-form-label">ì§ê¸‰</label>
                  <div class="col-md-4">
                    <select name="empGrade" class="form-select">
                      <option value="">ì„ íƒ</option>
                      <option th:each="g : ${gradeList}" th:value="${g.empGrade}" th:text="${g.empGrade}"
                        th:selected="${option=='empGrade' and keyword==empGrade}">
                      </option>
                    </select>
                    <!-- <option>â€¦</option> -->
                    </select>

                  </div>
                </div>

                <!-- ê¶Œí•œ / ê·¼ë¬´ìœ í˜• -->
                <div class="row mb-3 align-items-center">
                  <label for="authority" class="col-md-2 col-form-label">ê¶Œí•œ</label>
                  <div class="col-md-4">
                    <select name="roleName" class="form-select">
                      <option value="">ì„ íƒ</option>
                      <option th:each="r : ${roleList}" th:value="${r.roleId}" th:text="${r.roleName}"
                        th:selected="${option=='roleName' and keyword==roleName}">
                      </option>
                    </select>
                  </div>
                  <label for="empType" class="col-md-2 col-form-label">ê·¼ë¬´ìœ í˜•</label>
                  <div class="col-md-4">
                    <select id="empType" class="form-select">
                      <option value="">ì„ íƒ</option>
                      <option th:each="w : ${workList}" th:value="${w.workTypeId}" th:text="${w.workTypeNm}"
                        th:selected="${option=='empType' and keyword==w.workTypeId}">
                      </option>
                    </select>
                  </div>
                </div>
                <!-- ê¸‰ì—¬ê³„ì¢Œ -->
                <div class="row mb-3 align-items-center">
                  <label for="bankListSelect" class="col-md-2 col-form-label">
                    ê¸‰ì—¬ê³„ì¢Œ
                  </label>
                  <div class="col-md-4">
                    <select id="bankListSelect" name="bankListSelect" class="form-select">
                      <option value="">ì„ íƒ</option>
                      <option th:each="bank : ${bankList}" th:value="${bank.commonCode}"
                        th:text="${bank.commonCodeName}">
                      </option>
                    </select>
                  </div>
                  <label for="empAccount" class="col-md-2 col-form-label">
                    ê³„ì¢Œë²ˆí˜¸
                  </label>
                  <div class="col-md-4">
                    <input type="text" id="empAccount" name="empAccount" class="form-control">
                  </div>
                </div>
                <!-- ì£¼ì†Œ -->
                <div class="row mb-3">
                  <label class="col-md-2 col-form-label">ì£¼ì†Œ</label>
                  <div class="col-md-8">
                    <div class="input-group mb-2">
                      <button class="btn btn-outline-danger" type="button">ğŸ“ ìš°í¸ë²ˆí˜¸ ê²€ìƒ‰</button>
                      <input type="text" class="form-control" placeholder="ìš°í¸ë²ˆí˜¸">
                    </div>
                    <input type="text" class="form-control mb-2" placeholder="ê¸°ë³¸ ì£¼ì†Œ">
                    <input type="text" class="form-control" placeholder="ìƒì„¸ì£¼ì†Œ ì…ë ¥">
                  </div>
                </div>

                <!-- ë©”ëª¨ -->
                <div class="row mb-3">
                  <label for="memo" class="col-md-2 col-form-label">ë©”ëª¨</label>
                  <div class="col-md-8">
                    <textarea id="memo" class="form-control" rows="4" placeholder="í•„ìš”ì‹œ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                  </div>
                </div>
              </form>
            </div>

            <!-- 3) í‘¸í„° -->
            <div class="modal-footer justify-content-end">
              <button type="submit" form="employeeForm" class="btn btn-primary">ë“±ë¡</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
            </div>

          </div>
        </div>
      </div>


      <!-- 2. ì‚¬ì› í…Œì´ë¸” -->
      <div class="container-fluid px-0" style="height:100vh;">
        <div id="myGrid" class="ag-theme-alpine" style="width:100%; height:75%;"></div>
      </div>
    </div>
    <script th:inline="javascript">
      // Thymeleaf empList â†’ JS
      var rowData = /*[[${empList}]]*/ [];
      console.log(rowData);

      // ì»¬ëŸ¼ ì •ì˜
      const columnDefs = [{
          headerName: "",
          checkboxSelection: true,
          headerCheckboxSelection: true,
          width: 50
        },
        {
          headerName: "ì‚¬ì›ID",
          field: "empIdx",
          sortable: true,
          filter: true,
          resizable: true
        },
        {
          headerName: "ì‚¬ì›ëª…",
          field: "empName",
          sortable: true,
          filter: true,
          resizable: true
        },
        {
          headerName: "ë¶€ì„œ",
          field: "deptName",
          sortable: true,
          filter: true,
          resizable: true
        },
        {
          headerName: "ì§ê¸‰",
          field: "empGrade",
          sortable: true,
          filter: true,
          resizable: true
        },
        {
          headerName: "ì¬ì§ ìƒíƒœ",
          field: "empStatus",
          sortable: true,
          filter: true,
          resizable: true
        },
        {
          headerName: "ê·¼ë¬´ ìœ í˜•",
          field: "empType",
          sortable: true,
          filter: true,
          resizable: true
        },
        {
          headerName: "ì…ì‚¬ì¼",
          field: "empRegdate",
          sortable: true,
          filter: 'agDateColumnFilter',
          valueFormatter: params => new Date(params.value).toISOString().slice(0, 10)
        },
        {
          headerName: "ì—°ë½ì²˜",
          field: "empAccount",
          sortable: true,
          filter: true,
          resizable: true
        },
        {
          headerName: "ì´ë©”ì¼",
          field: "empEmail",
          sortable: true,
          filter: true,
          resizable: true
        },
        {
          headerName: "ê·¼ë¡œê³„ì•½ì„œ",
          field: "empIdx",
          cellRenderer: params => `<a href="/employees/${params.value}/contract" target="_blank">ë‹¤ìš´ë¡œë“œ</a>`,
          resizable: true
        }
      ];

      // ê·¸ë¦¬ë“œ ì˜µì…˜
      const gridOptions = {
        columnDefs,
        rowData,
        defaultColDef: {
          flex: 1,
          minWidth: 100
        },
        pagination: true,
        paginationPageSize: 20,
        rowSelection: 'multiple'
      };

      // ì´ˆê¸°í™”
      document.addEventListener('DOMContentLoaded', () => {
        // ê·¸ë¦¬ë“œ ìƒì„±
        agGrid.createGrid(document.querySelector("#myGrid"), gridOptions);

        // ë¶€ì„œ â†’ ìƒì„¸ë¶€ì„œ AJAX
        document.getElementById('deptSelect').addEventListener('change', function () {
          const detail = document.getElementById('detailDeptSelect');
          detail.innerHTML = '<option value="">ì„ íƒ</option>';
          if (!this.value) return;
          fetch(`/hr/${this.value}/children`)
            .then(r => r.json())
            .then(list => list.forEach(d => {
              const opt = document.createElement('option');
              opt.value = d.deptIdx;
              opt.textContent = d.deptName;
              detail.append(opt);
            }));
        });
        // ì‚¬ì›ë“±ë¡ ë¶€ì„œ â†’ ìƒì„¸ë¶€ì„œ AJAX
        document.getElementById('insertDeptSelect').addEventListener('change', function () {
          const detail = document.getElementById('insertDetailDeptSelect');
          detail.innerHTML = '<option value="">ì„ íƒ</option>';
          if (!this.value) return;
          fetch(`/hr/${this.value}/children`)
            .then(r => r.json())
            .then(list => list.forEach(d => {
              const opt = document.createElement('option');
              opt.value = d.deptIdx;
              opt.textContent = d.deptName;
              detail.append(opt);
            }));
        });
      });



      $('#employeeForm').on('submit', function (e) {
        e.preventDefault(); // ê¸°ë³¸ submit ë°©ì§€

        var $form = $(this);
        var formData = new FormData(this);

        $.ajax({
          url: "insertEmp",
          type: 'POST',
          data: formData,
          processData: false, // jQueryê°€ dataë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì§€ ì•Šë„ë¡
          contentType: false, // multipart/form-data í—¤ë”ë¥¼ ìë™ ì„¸íŒ…í•˜ë„ë¡
          success: function (code) {
            if (code === '200') {
              alert('ë“±ë¡ ì„±ê³µ!');
              // ì›í•˜ë©´ ë¦¬ë‹¤ì´ë ‰íŠ¸ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.
              // window.location.href = '/empList';
              $('employeeModal').modal('hide');
            } else {
              alert('ë“±ë¡ ì‹¤íŒ¨: ì €ì¥ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
          },
          error: function (xhr, status, error) {
            console.error(error);
            alert('ì„œë²„ í†µì‹  ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }
        });
      });
    </script>
  </div>