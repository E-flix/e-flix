<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{common/layouts/default}">
<!-- ============================================
  - 작성자   : 김어진
  - 최초작성 : 2025-06-18
  - 설명     : 사원 조회화면 (관리자)
  -----------------------------------------------
  [ 변경 이력 ]
  - 2025-06-18 (김어진): title 및 내용 추가
  - 2025-06-19 (김어진): layout 구성 및 모달창 생성
  - 2025-06-20 (김어진): 사원 전체조회 구현
  - 2025-06-23 (김어진): 조건별 검색 구현
============================================ -->

<head>
  <title>사원관리</title>
</head>

<div layout:fragment="content">
  <div class="w-100" id="empList">
    <div class="d-flex justify-content-between align-items-center mb-1">
      <h3>사원관리</h3>
    </div>
    <div class="py-4">
      <!-- 사원등록 / 수정 버튼 -->
      <div class="d-flex justify-content-end mb-2 gap-2">
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#employeeModal">
          사원등록
        </button>
        <button class="btn btn-primary">사원수정</button>
      </div>

      <!-- 검색 필터 -->
      <form>
        <div class="p-4 bg-light rounded mb-4">
          <div class="row g-3 align-items-center mb-3">
            <div class="col-md-2"><label class="form-label">검색 기준</label></div>
            <div class="col-md-2">
              <select name="option" class="form-select" id="searchSelect">
                <option>전체</option>
                <option value="empName" th:selected="${option=='empName'}">사원명</option>
                <option value="empIdx" th:selected="${option=='empIdx'}">사원ID</option>
              </select>
            </div>
            <div class="col-md-4">
              <input type="text" name="keyword" class="form-control" id="searchInput" placeholder="검색어 입력 후 [enter]">
            </div>
          </div>
          <div class="row g-3 mb-3">
            <div class="col-md-2">
              <label class="form-label">부서</label>
            </div>
            <div class="col-md-2">
              <select id="deptSelect" name="deptUpIdx" class="form-select">
                <option>선택</option>
                <!-- 최상위 부서 목록 바인딩 -->
                <option th:each="d : ${depts}" th:value="${d.deptIdx}" th:text="${d.deptName}">
                </option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label">상세 부서</label>
            </div>
            <div class="col-md-2">
              <select id="detailDeptSelect" name="deptIdx" class="form-select">
                <option>선택</option>
              </select>
            </div>
          </div>
          <script>
            $(document).ready(function () {
              $('#deptSelect').on('change', function () {
                var parentIdx = $(this).val();
                var $child = $('#detailDeptSelect');
                $child.html('<option value="">선택</option>'); // 초기화

                if (!parentIdx) {
                  return; // 선택 해제 시 종료
                }

                // jQuery AJAX 호출
                $.ajax({
                  type: 'GET',
                  url: `/hr/${parentIdx}/children`,
                  success: function (res) {
                    $.each(res, function (i, d) {
                      $('<option>')
                        .val(d.deptIdx)
                        .text(d.deptName)
                        .appendTo($child);
                    });
                  },
                  error: function (req, xhr, err) {
                    console.error(err)
                  }
                });
              });
            });
          </script>

          <div class="row g-3 mb-3 align-items-center">
            <div class="col-md-2">
              <label class="form-label">직급</label>
            </div>
            <div class="col-md-2">
              <select name="option" class="form-select" id="searchSelect">
                <option>선택</option>
                <option value="empGrade" th:selected="${option=='empGrade'}"></option>
              </select>
            </div>
            <div class="col-md-2"><label class="form-label">재직 상태</label></div>
            <div class="col-md-2"><select class="form-select">
                <option>선택</option>
              </select></div>
            <div class="col-md-2"><label class="form-label">근무 유형</label></div>
            <div class="col-md-2"><select class="form-select">
                <option>선택</option>
              </select></div>
          </div>

          <div class="d-flex justify-content-center gap-3">
            <button type="submit" class="btn btn-primary" id="searchBtn">조회</button>
            <button class="btn btn-secondary">초기화</button>
          </div>
      </form>
      <!-- <script>
        $("#searchBtn").on("click", () => {
          let searchInput = $("#searchInput").val();
          let searchSelect = $("#searchSelect").val();

          $.ajax({
            type: "GET",
            url: `/hr/el?option=${searchSelect}&keyword=${searchInput}`,
            success: function(res) {
              console.log(res);
            },
            error: function(xhr, status, err) {
              console.log(err);
            }
          })
        });
      </script> -->
      
  <!-- 4. 사원등록 모달 -->
  <div class="modal fade" id="employeeModal" tabindex="-1" aria-labelledby="employeeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content p-3">
        <div class="modal-header">
          <h5 class="modal-title fw-bold">사원등록</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
        </div>

        <div class="modal-body">
          <!-- 탭 메뉴 -->
          <ul class="nav nav-tabs mb-3">
            <li class="nav-item">
              <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#basicInfo">기본정보</button>
            </li>
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#extraInfo">추가정보</button>
            </li>
          </ul>

          <div class="tab-content">
            <!-- 기본정보 -->
            <div class="tab-pane fade show active" id="basicInfo">
              <div class="row">
                <div class="col-md-3 text-center">
                  <img src="https://via.placeholder.com/100x140?text=사진" class="img-thumbnail mb-2" alt="사원사진">
                  <div class="mb-3">
                    <label class="form-label">파일선택</label>
                    <input class="form-control" type="file">
                  </div>
                  <div>
                    <label class="form-label">근로계약서*</label>
                    <input class="form-control" type="file">
                  </div>
                </div>

                <div class="col-md-9">
                  <div class="row g-2 mb-2">
                    <div class="col-md-3"><label class="form-label">사원번호</label></div>
                    <div class="col-md-3"><input type="text" class="form-control"></div>
                    <div class="col-md-3"><label class="form-label">사원명</label></div>
                    <div class="col-md-3"><input type="text" class="form-control" placeholder="사원명을 입력하세요"></div>
                  </div>

                  <div class="row g-2 mb-2">
                    <div class="col-md-3"><label class="form-label">주민번호</label></div>
                    <div class="col-md-3"><input type="text" class="form-control" placeholder="앞 6자리"></div>
                    <div class="col-md-1 text-center">-</div>
                    <div class="col-md-3"><input type="text" class="form-control" placeholder="뒤 7자리"></div>
                  </div>

                  <div class="row g-2 mb-2">
                    <div class="col-md-3"><label class="form-label">이메일(ID)</label></div>
                    <div class="col-md-3"><input type="email" class="form-control" placeholder="이메일을 입력하세요"></div>
                    <div class="col-md-3"><label class="form-label">연락처</label></div>
                    <div class="col-md-3"><input type="text" class="form-control" placeholder="'-' 없이 입력"></div>
                  </div>

                  <div class="row g-2 mb-2">
                    <div class="col-md-3"><label class="form-label">비밀번호</label></div>
                    <div class="col-md-3"><input type="password" class="form-control"></div>
                    <div class="col-md-3"><label class="form-label">입사일</label></div>
                    <div class="col-md-3"><input type="date" class="form-control"></div>
                  </div>

                  <div class="row g-2 mb-2">
                    <div class="col-md-3"><label class="form-label">부서</label></div>
                    <div class="col-md-3"><select class="form-select">
                        <option>선택</option>
                      </select></div>
                    <div class="col-md-3"><label class="form-label">직급</label></div>
                    <div class="col-md-3"><select class="form-select">
                        <option>선택</option>
                      </select></div>
                  </div>

                  <div class="row g-2 mb-2">
                    <div class="col-md-3"><label class="form-label">권한</label></div>
                    <div class="col-md-3"><select class="form-select">
                        <option>선택</option>
                      </select></div>
                    <div class="col-md-3"><label class="form-label">근무유형</label></div>
                    <div class="col-md-3"><select class="form-select">
                        <option>선택</option>
                      </select></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 추가정보 -->
            <div class="tab-pane fade" id="extraInfo">
              <div class="row mb-3">
                <div class="col-md-2"><label class="form-label">급여계좌</label></div>
                <div class="col-md-4"><select class="form-select">
                    <option>선택</option>
                  </select></div>
              </div>

              <div class="mb-3">
                <label class="form-label">주소</label>
                <div class="d-flex gap-2 mb-2">
                  <button class="btn btn-outline-danger">📍 우편번호 검색</button>
                  <input type="text" class="form-control w-25" placeholder="우편번호">
                </div>
                <input type="text" class="form-control mb-2" placeholder="기본 주소">
                <input type="text" class="form-control" placeholder="상세주소 입력">
              </div>

              <div class="mb-3">
                <label class="form-label">메모</label>
                <textarea class="form-control" rows="5" placeholder="필요시 입력하세요"></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- 모달 하단 버튼 -->
        <div class="modal-footer justify-content-end">
          <button type="button" class="btn btn-primary">등록</button>
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal">취소</button>
          <button type="reset" class="btn btn-secondary">초기화</button>
        </div>
      </div>
    </div>
  </div>
    </div>
    <!-- 2. 사원 테이블 -->
    <div class="container-fluid px-0" style="height:100vh;">
      <div id="myGrid" class="ag-theme-alpine" style="width:100%; height:75%;"></div>
    </div>
  </div>
  <script th:inline="javascript">
    // Thymeleaf empList → JS
    var rowData = /*[[${empList}]]*/ [];

    // 컬럼 정의
    const columnDefs = [{
        headerName: "",
        checkboxSelection: true,
        headerCheckboxSelection: true,
        width: 50
      },
      {
        headerName: "사원ID",
        field: "empIdx",
        sortable: true,
        filter: true,
        resizable: true
      },
      {
        headerName: "사원명",
        field: "empName",
        sortable: true,
        filter: true,
        resizable: true
      },
      {
        headerName: "부서",
        field: "deptName",
        sortable: true,
        filter: true,
        resizable: true
      },
      {
        headerName: "직급",
        field: "empGrade",
        sortable: true,
        filter: true,
        resizable: true
      },
      {
        headerName: "재직 상태",
        field: "empStatus",
        sortable: true,
        filter: true,
        resizable: true
      },
      {
        headerName: "근무 유형",
        field: "empType",
        sortable: true,
        filter: true,
        resizable: true
      },
      {
        headerName: "입사일",
        field: "empRegdate",
        sortable: true,
        filter: 'agDateColumnFilter',
        valueFormatter: params => new Date(params.value).toISOString().slice(0, 10)
      },
      {
        headerName: "연락처",
        field: "empAccount",
        sortable: true,
        filter: true,
        resizable: true
      },
      {
        headerName: "이메일",
        field: "empEmail",
        sortable: true,
        filter: true,
        resizable: true
      },
      {
        headerName: "근로계약서",
        field: "empIdx",
        cellRenderer: params => `<a href="/employees/${params.value}/contract" target="_blank">다운로드</a>`,
        resizable: true
      }
    ];

    // 그리드 옵션
    const gridOptions = {
      columnDefs,
      rowData,
      defaultColDef: {
        flex: 1,
        minWidth: 100
      },
      pagination: true,
      paginationPageSize: 20,
      rowSelection: 'multiple'
    };

    // 초기화
    document.addEventListener('DOMContentLoaded', () => {
      // 그리드 생성
      agGrid.createGrid(document.querySelector("#myGrid"), gridOptions);

      // 부서 → 상세부서 AJAX
      document.getElementById('deptSelect').addEventListener('change', function () {
        const detail = document.getElementById('detailDeptSelect');
        detail.innerHTML = '<option value="">선택</option>';
        if (!this.value) return;
        fetch(`/hr/${this.value}/children`)
          .then(r => r.json())
          .then(list => list.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.deptIdx;
            opt.textContent = d.deptName;
            detail.append(opt);
          }));
      });
    });
  </script>
</div>