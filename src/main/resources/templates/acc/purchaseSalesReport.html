<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{common/layouts/default}">

<!-- ============================================
  - 작성자   : 김희정
  - 최초작성 : 2025-06-18
  - 설명     : 매입매출장 화면
  -----------------------------------------------
  [ 변경 이력 ]
  - 2025-06-18 (김희정): title 및 내용 추가
  - 2025-06-24 (김희정): ag-grid 소계 테스트
============================================ -->
<head>
  <title>매입매출장</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <style>
    .ag-overlay-no-rows-center {
      font-size: 1rem; 
      /* font-weight: bold; */
      color: #444; 
    }
    .ag-theme-alpine .ag-row-even, 
    .ag-theme-alpine .ag-row-odd {
      background: white !important;
    }
    .ag-theme-alpine .subtotal-row {
      background: #f3f6fa !important;
      font-weight: bold !important;
    }
  </style>
</head>
<div layout:fragment="content">
  <!-- 모달 불러오기 -->
  <div th:replace="acc/modal/modal :: modals"></div>
  <div class="w-100" id="purchaseSalesReport">
    <div class="d-flex justify-content-between align-items-center mb-1">
      <!-- 왼쪽: 매입매출장 제목 -->
      <h3 class="mb-0">매입매출장</h3>
      <!-- 오른쪽: 버튼 모음 -->
      <div>
        <button class="btn btn-secondary btn-sm" id="printBtn">인쇄</button>
      </div>
    </div>
    <!-- 탭 버튼 -->
    <div class="mb-2 tab-btns">
      <button type="button" class="btn btn-outline-primary btn-sm active" id="tab-all" style="margin-right:3px;">전체</button>
      <button type="button" class="btn btn-outline-primary btn-sm" id="tab-sales" style="margin-right:3px;">매출</button>
      <button type="button" class="btn btn-outline-primary btn-sm" id="tab-purchase">매입</button>
    </div>
    <!-- 검색조건 영역 -->
         <div class="d-flex mb-2 align-items-end flex-nowrap" style="flex-wrap:nowrap;">
      <div class="d-flex align-items-center me-2">
        <label class="form-label me-2 mb-0">일자</label>
        2025 년
        <input type="number" value="1" min="1" max="12" class="form-control form-control-sm d-inline-block mx-1" name="startMonth" id="startMonth" style="width:45px;"> 월
        <input type="number" value="1" min="1" max="31" class="form-control form-control-sm d-inline-block mx-1" name="startDay" id="startDay" style="width:45px;"> 일 ~
        2025 년
        <input type="number" value="12" min="1" max="12" class="form-control form-control-sm d-inline-block mx-1" name="endMonth" id="endMonth" style="width:45px;"> 월
        <input type="number" value="31" min="1" max="31" class="form-control form-control-sm d-inline-block mx-1" name="endDay" id="endDay" style="width:45px;"> 일
      </div>
      <div class="d-flex align-items-center me-2">
        <label class="me-2 mb-0" style="white-space:nowrap;">과세유형</label>
        <select id="transactionType" name="transactionType" class="form-select form-select-sm">
          <option value="">전체</option><option value="일반">일반</option><option value="간이">간이</option>
        </select>
      </div>
      <div class="d-flex align-items-center me-2">
        <label class="me-2 mb-0" style="white-space:nowrap;">전자유형</label>
        <select id="electronicType" name="electronicType" class="form-select form-select-sm">
          <option value="">전체</option><option value="a1">전자</option><option value="a2">수기</option>
        </select>
      </div>
    </div>
    <!-- 탭별 컨텐츠 -->
    <div id="tab-content-all">
      <div id="psrGridAll" class="ag-theme-quartz" style="height: 70vh; width: 100%;"></div>
    </div>
    <div id="tab-content-sales" style="display:none;">
      <div id="psrGridSales" class="ag-theme-quartz" style="height: 70vh; width: 100%;"></div>
    </div>
    <div id="tab-content-purchase" style="display:none;">
      <div id="psrGridPurchase" class="ag-theme-quartz" style="height: 70vh; width: 100%;"></div>
    </div>
  </div>
  <script th:inline="javascript">
    // 공통 코드(과세유형) 매핑
    const code0H = /*[[${code0H}]]*/ [];
    // ag-Grid 컬럼 정의 (사진 참고)
    const columnDefs = [
      { headerName: "유형", field: "transactionType", initialWidth: 65, 
        cellRenderer: params => {
          const code = params.value;
          const mapping = code0H.find(item => item.commonCode === code);
          if (mapping) {
            const badgeColor = parseInt(mapping.commonCode) <= 50 ? 'bg-danger' : 'bg-primary';
            return `<span class="badge ${badgeColor}">${mapping.commonCodeName}</span>`;
          }
          return code || '';
        }
      },
      { headerName: '일자',  field: 'entryDate',  width: 90, 
        valueFormatter: params => {
          if (!params.value) return '';
          const d = new Date(params.value);
          const mm = String(d.getMonth() + 1).padStart(2, '0');
          const dd = String(d.getDate()).padStart(2, '0');
          return `${mm}-${dd}`;
        }
      },
      { headerName: '품목', field: 'itemName', width: 180 },
      { headerName: '공급가액', field: 'totalSupplyAmount', width: 120, type: 'numericColumn', valueFormatter: params => params.value?.toLocaleString() },
      { headerName: '세액', field: 'totalTaxAmount', width: 110, type: 'numericColumn', valueFormatter: params => params.value?.toLocaleString() },
      { headerName: '합계', field: 'total', width: 130, type: 'numericColumn', valueGetter: params => (params.data?.totalSupplyAmount || 0) + (params.data?.totalTaxAmount || 0), valueFormatter: params => params.value?.toLocaleString() },
      { headerName: '코드', field: 'partnerCode', width: 70 },
      { headerName: '거래처명', field: 'partnerName', width: 170 },
      { headerName: '계정코드', valueGetter: params => params.data?.details?.[0]?.accountCode || '', width: 110 },
      { headerName: '계정과목명', valueGetter: params => params.data?.details?.[0]?.accountName || '', width: 150 },
      { headerName: '전자', field: 'electronicType', width: 60,
        cellRenderer: params => {
          if (params.value === 'a1') return '○'; return '';
        }
      }
    ];

    function addSummaryRows(data) {
      if (!data.length) return [];
      const grouped = {};
      let grand = { supplyAmount: 0, tax: 0, total: 0 };
      const result = [];
      data.forEach(row => {
        if (!grouped[row.type]) grouped[row.type] = { supplyAmount: 0, tax: 0, total: 0, rows: [] };
        grouped[row.type].supplyAmount += row.supplyAmount || 0;
        grouped[row.type].tax += row.tax || 0;
        grouped[row.type].total += row.total || 0;
        grouped[row.type].rows.push(row);
        grand.supplyAmount += row.supplyAmount || 0;
        grand.tax += row.tax || 0;
        grand.total += row.total || 0;
      });
      for (const type in grouped) {
        result.push(...grouped[type].rows);
        result.push({ type: type + ' 소계', supplyAmount: grouped[type].supplyAmount, tax: grouped[type].tax, total: grouped[type].total, isSubtotal: true });
      }
      result.push({ type: '총계', supplyAmount: grand.supplyAmount, tax: grand.tax, total: grand.total, isGrandTotal: true });
      return result;
    }

    // 각 탭별 ag-Grid 인스턴스
    const gridOptionsAll = {
      headerHeight: 35,
      rowHeight: 35,
      columnDefs,
      rowData: [],
      getRowClass: params => {
        if (params.data?.isGrandTotal) return 'grandtotal-row';
        if (params.data?.isSubtotal) return 'subtotal-row';
      },
      defaultColDef: { resizable: true, sortable: true },
      suppressMovableColumns: true,
      localeText: { noRowsToShow: '조회 결과가 없습니다.' }
    };
    const gridOptionsSales = { ...gridOptionsAll, rowData: [] };
    const gridOptionsPurchase = { ...gridOptionsAll, rowData: [] };
    const apiAll = agGrid.createGrid(document.getElementById('psrGridAll'), gridOptionsAll);
    const apiSales = agGrid.createGrid(document.getElementById('psrGridSales'), gridOptionsSales);
    const apiPurchase = agGrid.createGrid(document.getElementById('psrGridPurchase'), gridOptionsPurchase);

    // 탭 전환 이벤트
    document.getElementById('tab-all').onclick = function() {
      document.getElementById('tab-content-all').style.display = '';
      document.getElementById('tab-content-sales').style.display = 'none';
      document.getElementById('tab-content-purchase').style.display = 'none';
      this.classList.add('active');
      document.getElementById('tab-sales').classList.remove('active');
      document.getElementById('tab-purchase').classList.remove('active');
    };
    document.getElementById('tab-sales').onclick = function() {
      document.getElementById('tab-content-all').style.display = 'none';
      document.getElementById('tab-content-sales').style.display = '';
      document.getElementById('tab-content-purchase').style.display = 'none';
      this.classList.add('active');
      document.getElementById('tab-all').classList.remove('active');
      document.getElementById('tab-purchase').classList.remove('active');
    };
    document.getElementById('tab-purchase').onclick = function() {
      document.getElementById('tab-content-all').style.display = 'none';
      document.getElementById('tab-content-sales').style.display = 'none';
      document.getElementById('tab-content-purchase').style.display = '';
      this.classList.add('active');
      document.getElementById('tab-all').classList.remove('active');
      document.getElementById('tab-sales').classList.remove('active');
    };

    function pad2(n) { return n < 10 ? '0' + n : n; }
    function getDateRange() {
      const startMonth = pad2(Number(document.getElementById('startMonth').value));
      const startDay = pad2(Number(document.getElementById('startDay').value));
      const endMonth = pad2(Number(document.getElementById('endMonth').value));
      const endDay = pad2(Number(document.getElementById('endDay').value));
      return {
        startDate: `${startMonth}-${startDay}`,
        endDate: `${endMonth}-${endDay}`
      };
    }
    function getActiveTabEntryType() {
      if(document.getElementById('tab-all').classList.contains('active')) return '';
      if(document.getElementById('tab-sales').classList.contains('active')) return '매출';
      if(document.getElementById('tab-purchase').classList.contains('active')) return '매입';
      return '';
    }
    async function loadReport() {
      const { startDate, endDate } = getDateRange();
      const transactionType = document.getElementById('transactionType').value;
      const electronicType = document.getElementById('electronicType').value;
      const entryType = getActiveTabEntryType();
      let res, data;
      try {
        res = await fetch(`/acc/psr/list?startDate=${startDate}&endDate=${endDate}&entryType=${entryType}&transactionType=${transactionType}&electronicType=${electronicType}`);
        if (!res.ok) {
          console.error('HTTP error', res.status, await res.text());
          data = [];
        } else {
          data = await res.json();
          console.log((entryType||'전체') + ' 데이터:', data);
        }
      } catch (e) {
        console.error('fetch error', e);
        data = [];
      }
      if(entryType === '' || entryType === '전체') apiAll.setGridOption('rowData', addSummaryRows(data));
      if(entryType === '매출') apiSales.setGridOption('rowData', addSummaryRows(data));
      if(entryType === '매입') apiPurchase.setGridOption('rowData', addSummaryRows(data));
    }
    ['startMonth','startDay','endMonth','endDay','transactionType','electronicType'].forEach(id => {
      document.getElementById(id).addEventListener('change', loadReport);
    });
    // 인쇄 버튼(단순 window.print)
    document.getElementById('printBtn').onclick = () => window.print();

    // 과세유형 옵션
    const transactionTypeOptions = {
      '전체': `
        <option value="">전체</option>
        <option value="11">11. 과세</option><option value="12">12. 영세</option><option value="13">13. 면세</option><option value="14">14. 건별</option><option value="15">15. 간이</option>
        <option value="16">16. 수출</option><option value="17">17. 카과</option><option value="18">18. 카면</option><option value="19">19. 카영</option><option value="20">20. 면건</option>
        <option value="21">21. 전자</option><option value="22">22. 현과</option><option value="23">23. 현면</option><option value="24">24. 현영</option>
        <option value="51">51. 과세</option><option value="52">52. 영세</option><option value="53">53. 면세</option><option value="54">54. 불공</option>
        <option value="55">55. 수입</option><option value="56">56. 금전</option><option value="57">57. 카과</option><option value="58">58. 카면</option><option value="59">59. 카영</option>
        <option value="60">60. 면건</option><option value="61">61. 현과</option><option value="62">62. 현면</option>
      `,
      '매출': `
        <option value="">전체</option>
        <option value="11">11. 과세</option><option value="12">12. 영세</option><option value="13">13. 면세</option><option value="14">14. 건별</option><option value="15">15. 간이</option>
        <option value="16">16. 수출</option><option value="17">17. 카과</option><option value="18">18. 카면</option><option value="19">19. 카영</option><option value="20">20. 면건</option>
        <option value="21">21. 전자</option><option value="22">22. 현과</option><option value="23">23. 현면</option><option value="24">24. 현영</option>
      `,
      '매입': `
        <option value="">전체</option>
        <option value="51">51. 과세</option><option value="52">52. 영세</option><option value="53">53. 면세</option><option value="54">54. 불공</option>
        <option value="55">55. 수입</option><option value="56">56. 금전</option><option value="57">57. 카과</option><option value="58">58. 카면</option><option value="59">59. 카영</option>
        <option value="60">60. 면건</option><option value="61">61. 현과</option><option value="62">62. 현면</option>
      `
    };
    function updateTransactionTypeOptions(tab) {
      const transactionTypeSelect = document.getElementById('transactionType');
      transactionTypeSelect.innerHTML = transactionTypeOptions[tab] || transactionTypeOptions['전체'];
      transactionTypeSelect.value = ""; // 항상 전체로 초기화
      transactionTypeSelect.dispatchEvent(new Event('change'));
    }
    ['tab-all','tab-sales','tab-purchase'].forEach(id => {
      document.getElementById(id).addEventListener('click', function() {
        let tab = '전체';
        if(id==='tab-sales') tab = '매출';
        if(id==='tab-purchase') tab = '매입';
        updateTransactionTypeOptions(tab);
      });
    });
    updateTransactionTypeOptions('전체');
  </script>
</div>