<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{common/layouts/default}">

<!-- ============================================
  - 작성자   : 김희정
  - 최초작성 : 2025-06-18
  - 설명     : 매입매출장 화면
  -----------------------------------------------
  [ 변경 이력 ]
  - 2025-06-18 (김희정): title 및 내용 추가
  - 2025-06-24 (김희정): ag-grid 소계 테스트
============================================ -->
<!-- <head>
  <title>매입매출장</title>
</head>
<div layout:fragment="content">
  <div id="purchase-sales-report">
    <h2>매입매출장</h2>
    <p>매입매출장 화면입니다.</p>
  </div>
</div> -->
<head>
  <title>매입매출장</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <style>
    .ag-overlay-no-rows-center {
      font-size: 1rem; 
      /* font-weight: bold; */
      color: #444; 
    }
    .ag-theme-alpine .ag-row-even, 
    .ag-theme-alpine .ag-row-odd {
      background: white !important;
    }
    .ag-theme-alpine .subtotal-row {
      background: #f3f6fa !important;
      font-weight: bold !important;
    }
  </style>
</head>
<div layout:fragment="content">
  <!-- 모달 불러오기 -->
  <div th:replace="acc/modal/modal :: modals"></div>
  <div class="w-100" id="purchaseSalesReport">
    <div class="d-flex justify-content-between align-items-center mb-1">
      <!-- 왼쪽: 매입매출장 제목 -->
      <h3 class="mb-0">매입매출장</h3>
      <!-- 오른쪽: 버튼 모음 -->
      <div>
        <button class="btn btn-secondary btn-sm" onclick="printLedger()">인쇄</button>
      </div>
    </div>
    <!-- 탭 버튼 -->
    <div class="mb-2 tab-btns">
      <button type="button" class="btn btn-outline-primary btn-sm active" id="tab-all" style="margin-right:3px;">전체</button>
      <button type="button" class="btn btn-outline-primary btn-sm" id="tab-sales" style="margin-right:3px;">매출</button>
      <button type="button" class="btn btn-outline-primary btn-sm" id="tab-purchase">매입</button>
    </div>
    <!-- 검색조건 영역 -->
         <div class="d-flex mb-2 align-items-end flex-nowrap" style="flex-wrap:nowrap;">
      <div class="d-flex align-items-center me-2">
        <label class="form-label me-2 mb-0">일자</label>
        2025 년
        <input type="number" value="1" class="form-control form-control-sm d-inline-block mx-1" name="startMonth" style="width:45px;"> 월
        <input type="number" value="1" class="form-control form-control-sm d-inline-block mx-1" name="startDay" style="width:45px;"> 일 ~
        2025 년
        <input type="number" value="12" class="form-control form-control-sm d-inline-block mx-1" name="endMonth" style="width:45px;"> 월
        <input type="number" value="31" class="form-control form-control-sm d-inline-block mx-1" name="endDay" style="width:45px;"> 일
      </div>
      <div class="d-flex align-items-center me-2">
        과세유형
        <select id="taxType" class="form-select form-select-sm">
          <option>전체</option><option>일반</option><option>간이</option>
        </select>
      </div>
      <div class="d-flex align-items-center me-2">
        전자유형
        <select id="electronicType" class="form-select form-select-sm">
          <option>전체</option><option>전자</option><option>수기</option>
        </select>
      </div>
    </div>
    </div>
    <!-- 탭별 컨텐츠 -->
    <div id="tab-content-all">
      <div id="psrGridAll" class="ag-theme-quartz" style="height: 70vh; width: 100%;"></div>
    </div>
    <div id="tab-content-sales" style="display:none;">
      <div id="psrGridSales" class="ag-theme-quartz" style="height: 70vh; width: 100%;"></div>
    </div>
    <div id="tab-content-purchase" style="display:none;">
      <div id="psrGridPurchase" class="ag-theme-quartz" style="height: 70vh; width: 100%;"></div>
    </div>
  </div>
  <script>
    // ag-Grid 컬럼 정의 (사진 참고)
    const columnDefs = [
      { headerName: '유형', field: 'type', width: 70 },
      { headerName: '일자', field: 'date', width: 90 },
      { headerName: '품목', field: 'item', width: 180 },
      { headerName: '공급가액', field: 'supplyAmount', width: 100, type: 'numericColumn', valueFormatter: params => params.value?.toLocaleString() },
      { headerName: '세액', field: 'tax', width: 90, type: 'numericColumn', valueFormatter: params => params.value?.toLocaleString() },
      { headerName: '합계', field: 'total', width: 100, type: 'numericColumn', valueFormatter: params => params.value?.toLocaleString() },
      { headerName: '코드', field: 'code', width: 70 },
      { headerName: '거래처명', field: 'partnerName', width: 120 },
      { headerName: '계정코드', field: 'accountCode', width: 80 },
      { headerName: '계정과목명', field: 'accountName', width: 100 },
      { headerName: '전자', field: 'electronic', width: 60 }
    ];

    function addSummaryRows(data) {
      if (!data.length) return [];
      const grouped = {};
      let grand = { supplyAmount: 0, tax: 0, total: 0 };
      const result = [];
      data.forEach(row => {
        if (!grouped[row.type]) grouped[row.type] = { supplyAmount: 0, tax: 0, total: 0, rows: [] };
        grouped[row.type].supplyAmount += row.supplyAmount || 0;
        grouped[row.type].tax += row.tax || 0;
        grouped[row.type].total += row.total || 0;
        grouped[row.type].rows.push(row);
        grand.supplyAmount += row.supplyAmount || 0;
        grand.tax += row.tax || 0;
        grand.total += row.total || 0;
      });
      for (const type in grouped) {
        result.push(...grouped[type].rows);
        result.push({ type: type + ' 소계', supplyAmount: grouped[type].supplyAmount, tax: grouped[type].tax, total: grouped[type].total, isSubtotal: true });
      }
      result.push({ type: '총계', supplyAmount: grand.supplyAmount, tax: grand.tax, total: grand.total, isGrandTotal: true });
      return result;
    }

    // 각 탭별 ag-Grid 인스턴스
    const gridOptionsAll = {
      columnDefs,
      rowData: [],
      getRowClass: params => {
        if (params.data?.isGrandTotal) return 'grandtotal-row';
        if (params.data?.isSubtotal) return 'subtotal-row';
      },
      defaultColDef: { resizable: true, sortable: true },
      suppressMovableColumns: true,
      localeText: { noRowsToShow: '조회 결과가 없습니다.' }
    };
    const gridOptionsSales = { ...gridOptionsAll, rowData: [] };
    const gridOptionsPurchase = { ...gridOptionsAll, rowData: [] };
    const apiAll = agGrid.createGrid(document.getElementById('psrGridAll'), gridOptionsAll);
    const apiSales = agGrid.createGrid(document.getElementById('psrGridSales'), gridOptionsSales);
    const apiPurchase = agGrid.createGrid(document.getElementById('psrGridPurchase'), gridOptionsPurchase);

    // 탭 전환 이벤트
    document.getElementById('tab-all').onclick = function() {
      document.getElementById('tab-content-all').style.display = '';
      document.getElementById('tab-content-sales').style.display = 'none';
      document.getElementById('tab-content-purchase').style.display = 'none';
      this.classList.add('active');
      document.getElementById('tab-sales').classList.remove('active');
      document.getElementById('tab-purchase').classList.remove('active');
    };
    document.getElementById('tab-sales').onclick = function() {
      document.getElementById('tab-content-all').style.display = 'none';
      document.getElementById('tab-content-sales').style.display = '';
      document.getElementById('tab-content-purchase').style.display = 'none';
      this.classList.add('active');
      document.getElementById('tab-all').classList.remove('active');
      document.getElementById('tab-purchase').classList.remove('active');
    };
    document.getElementById('tab-purchase').onclick = function() {
      document.getElementById('tab-content-all').style.display = 'none';
      document.getElementById('tab-content-sales').style.display = 'none';
      document.getElementById('tab-content-purchase').style.display = '';
      this.classList.add('active');
      document.getElementById('tab-all').classList.remove('active');
      document.getElementById('tab-sales').classList.remove('active');
    };

    // 데이터 로드 함수 (전체/매출/매입)
    async function loadReport() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const taxType = document.getElementById('taxType').value;
      const electronicType = document.getElementById('electronicType').value;
      // 전체
      let res = await fetch(`/acc/psr/list?startDate=${startDate}&endDate=${endDate}&type=전체&taxType=${taxType}&electronicType=${electronicType}`);
      let data = await res.json();
      apiAll.setGridOption('rowData', addSummaryRows(data));
      // 매출
      res = await fetch(`/acc/psr/list?startDate=${startDate}&endDate=${endDate}&type=매출&taxType=${taxType}&electronicType=${electronicType}`);
      data = await res.json();
      apiSales.setGridOption('rowData', addSummaryRows(data));
      // 매입
      res = await fetch(`/acc/psr/list?startDate=${startDate}&endDate=${endDate}&type=매입&taxType=${taxType}&electronicType=${electronicType}`);
      data = await res.json();
      apiPurchase.setGridOption('rowData', addSummaryRows(data));
    }
    document.getElementById('searchBtn').onclick = loadReport;
    // 최초 조회
    loadReport();
    // 인쇄 버튼(단순 window.print)
    document.getElementById('printBtn').onclick = () => window.print();
  </script>
</div>