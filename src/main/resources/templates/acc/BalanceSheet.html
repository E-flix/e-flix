<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{common/layouts/default}">
<!-- ============================================
  - 작성자   : 김희정
  - 최초작성 : 2025-06-18
  - 설명     : 재무상태표 화면
  -----------------------------------------------
  [ 변경 이력 ]
  - 2025-06-18 (김희정): title 및 내용 추가
  - 2025-07-04 (김희정): 재무상태표 레이아웃
  - 2025-07-04 (김희정): 재무상태표 DB연결
  - 2025-07-06 (김희정): 날짜 필터 추가
============================================ -->

<head>
  <title>재무상태표</title>
  <style>
    .financial-header {
      border-bottom: 3px solid #0d6efd;
      padding-bottom: 1rem;
      margin-bottom: 2rem;
    }

    .ag-header-cell-style {
      background-color: #6c757d !important;
      color: white !important;
      font-weight: 500;
    }

    .ag-subtotal-cell-style {
      background-color: #f1f3f4 !important;
      font-weight: 400;
      border-top: 1px solid #dee2e6;
    }

    .ag-total-cell-style {
      background-color: #f8f9fa !important;
      font-weight: 500;
    }

    .ag-grand-total-cell-style {
      background-color: #e9ecef !important;
      font-weight: 600;
    }
  </style>
</head>

<div layout:fragment="content">
  <div class="container-fluid">
    <div class="row">
      <!-- 재무상태표 헤더 영역 -->
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <!-- 왼쪽: 재무상태표 제목 -->
          <h3 class="mb-0">재무상태표</h3>
          <!-- 오른쪽: 버튼 모음 -->
          <div>
            <button class="btn btn-outline-secondary btn-sm" onclick="출력()">출력</button>
            <button class="btn btn-outline-secondary btn-sm" onclick="엑셀()">엑셀</button>
          </div>
        </div>
        <!-- 검색/필터 영역 -->
        <form class="row mb-2 align-items-end" method="get" action="/acc/bs">
          <div class="col-auto">
            <label class="form-label mb-0">기준일</label>
            <input type="number" name="year" value="2025" class="form-control form-control-sm d-inline-block" style="width:80px;" readonly>
            년
            <select class="form-control form-control-sm d-inline-block" name="endMonth" style="width:70px;">
              <option value="1">1월</option>
              <option value="2">2월</option>
              <option value="3">3월</option>
              <option value="4">4월</option>
              <option value="5">5월</option>
              <option value="6">6월</option>
              <option value="7">7월</option>
              <option value="8">8월</option>
              <option value="9">9월</option>
              <option value="10">10월</option>
              <option value="11">11월</option>
              <option value="12" selected>12월</option>
            </select>
            말까지
          </div>
        </form>
        <div class="grid-container" style="height:100vh;">
          <div id="balanceSheetGrid" class="ag-theme-alpine" style="width:100%; height:75%;"></div>
        </div>
      </div>
    </div>
  </div>

  <script th:inline="javascript">
    let balanceSheetData = [];

    // 페이지 로드 시 데이터 가져오기
    document.addEventListener('DOMContentLoaded', function() {
        loadBalanceSheetData();
        
        // 월 변경 시 자동 조회 이벤트 추가
        document.querySelector('select[name="endMonth"]').addEventListener('change', function() {
            loadBalanceSheetData();
        });
    });
    
    // 서버에서 재무상태표 데이터 가져오기
    async function loadBalanceSheetData() {
      try {
        const year = document.querySelector('input[name="year"]')?.value || '2025';
        const endMonth = document.querySelector('select[name="endMonth"]')?.value || '12';
        
        console.log(`재무상태표 조회: ${year}년 ${endMonth}월말까지`);
        
        const response = await fetch(`/acc/bs/data?year=${year}&endMonth=${endMonth}`);
        const result = await response.json();
        
        if (result.success) {
            balanceSheetData = result.data;
            
            // 그리드 새로고침 - v33에서는 setGridOption 사용
            if (gridOptions.api) {
                gridOptions.api.setGridOption('rowData', balanceSheetData);
            }
        } else {
            console.error('데이터 조회 실패:', result.message);
            // 에러 시 더미 데이터 사용
            balanceSheetData = getDummyData();
            if (gridOptions.api) {
                gridOptions.api.setGridOption('rowData', balanceSheetData);
            }
        }
      } catch (error) {
        console.error('재무상태표 데이터 로드 실패:', error);
        // 에러 시 더미 데이터 사용
        balanceSheetData = getDummyData();
        if (gridOptions.api) {
            gridOptions.api.setGridOption('rowData', balanceSheetData);
        }
      }
    }

    // 더미 데이터 함수 (에러 시 백업용)
    function getDummyData() {
        return [
            { section: "자 산", subsection: "", subcategory: "", accountCode: "", accountName: "", amount: "", total: "", isHeader: true, level: 0 },
            { section: "", subsection: "", subcategory: "", accountCode: "", accountName: "현금및현금성자산", amount: "1,000,000", total: "", isHeader: false, level: 3 },
            { section: "", subsection: "", subcategory: "", accountCode: "", accountName: "자산총계", amount: "", total: "1,000,000", isHeader: false, level: 0, isGrandTotal: true },
            { section: "부 채", subsection: "", subcategory: "", accountCode: "", accountName: "", amount: "", total: "", isHeader: true, level: 0 },
            { section: "", subsection: "", subcategory: "", accountCode: "", accountName: "부채총계", amount: "", total: "0", isHeader: false, level: 0, isGrandTotal: true },
            { section: "자 본", subsection: "", subcategory: "", accountCode: "", accountName: "", amount: "", total: "", isHeader: true, level: 0 },
            { section: "", subsection: "", subcategory: "", accountCode: "", accountName: "자본총계", amount: "", total: "1,000,000", isHeader: false, level: 0, isGrandTotal: true }
        ];
    }

    // ag-Grid 세팅
    const gridOptions = {
      headerHeight: 35, // 헤더 높이 설정
      rowHeight: 35, // 행 높이 설정
      rowData: [], // 초기 데이터는 빈 배열로 설정
      suppressMovableColumns: true, // 열 이동 기능 비활성화
      suppressRowDrag: true, // 행 드래그 기능 비활성화
      rowDragManaged: false, // 행 드래그 관리 비활성화
      rowSelection: 'multiRow', // 다중 행 선택
      suppressRowClickSelection: true, // 행 클릭 시 선택 방지
      columnDefs: [
        { headerName: "계정과목", field: "accountName",  width: 300, sortable: false, // flex: 1,
          cellRenderer: params => {
            let displayText = '';
            if (params.data.section) {
              displayText = `<strong style="font-weight: 600;">${params.data.section}</strong>`;
            }
            else if (params.data.subsection) {
              displayText = `<strong style="font-weight: 500;">${params.data.subsection}</strong>`;
            }
            else if (params.data.subcategory) {
              displayText = `<span style="font-weight: 500;">${params.data.subcategory}</span>`;
            }
            else if (params.value) {
              if (params.data.isSubTotal || params.data.isTotal || params.data.isGrandTotal) {
                displayText = `<strong style="font-weight: 500;">${params.value}</strong>`;
              } else {
                displayText = params.value;
              }
            }
            return displayText;
          },
          cellClass: params => {
            if (params.data.isHeader) return 'ag-header-cell-style'; 
            if (params.data.isSubTotal) return 'ag-subtotal-cell-style';
            if (params.data.isTotal) return 'ag-total-cell-style';
            if (params.data.isGrandTotal) return 'ag-grand-total-cell-style';
            return '';
          }
        },
        { headerName: "코드", field: "accountCode", width: 100, sortable: false,
          cellClass: params => {
            if (params.data.isHeader) return 'ag-header-cell-style';
            return '';
          }
        },
        { headerName: "금액", field: "amount", width: 120, sortable: false,
          cellStyle: { textAlign: 'right' },
          cellRenderer: params => {
            if (!params.value) return '';
            return params.value;
          },
          cellClass: params => {
            if (params.data.isHeader) return 'ag-header-cell-style';
            return '';
          }
        },
        { headerName: "합계", field: "total", width: 150, sortable: false,
          cellStyle: { textAlign: 'right'},
          cellRenderer: params => {
            if (!params.value) return '';
            return `<span>${params.value}</span>`;
          },
          cellClass: params => {
            if (params.data.isHeader) return 'ag-header-cell-style';
            return '';
          }
        }
      ],
      onGridReady: (params) => { 
        gridOptions.api = params.api;
        // 초기 데이터 로드
        loadBalanceSheetData();
      }
    };

    // 그리드 생성
    agGrid.createGrid(document.querySelector("#balanceSheetGrid"), gridOptions);

    function exportToExcel() {
      alert('Excel 내보내기 기능을 준비 중입니다.');
    }
</script>
</div>