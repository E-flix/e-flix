<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{common/layouts/default}">
<!-- ============================================
  - 작성자   : 김희정
  - 최초작성 : 2025-06-18
  - 설명     : 매입매출전표 화면
  -----------------------------------------------
  [ 변경 이력 ]
  - 2025-06-18 (김희정): title 및 내용 추가
  - 2025-06-20 (김희정): 임시 레이아웃
  - 2025-06-30 (김희정): ag-Grid 기반 매입매출전표 구현 (entry.html 참고)
============================================ -->

<head>
  <title>매입매출전표</title>
  <style>
    .ag-theme-alpine .ag-row-even, 
    .ag-theme-alpine .ag-row-odd {
      background: white !important;
    }
    .ag-row-total .ag-cell {
      background-color: #fff3cd !important;
      color: #856404 !important;
      font-weight: bold !important;
    }
    .subtotal-row .ag-cell {
      background: #f3f6fa !important;
      font-weight: bold !important;
      text-align: center;
    }
    /* 같은 전표번호 강조 표시 */
    .ag-row-highlighted .ag-cell {
      background-color: #e3f2fd !important;
    }
    .ag-row-highlighted .ag-cell:first-child {
      border-left: 3px solid #2196f3 !important;
    }
    .ag-row-highlighted.ag-row-selected .ag-cell {
      background-color: #bbdefb !important;
    }
    /* 모든 AG Grid 헤더 중앙정렬 */
    .ag-header-cell .ag-header-cell-text {
      text-align: center !important;
      justify-content: center !important;
    }
    .ag-header-group-cell .ag-header-group-text {
      text-align: center !important;
      justify-content: center !important;
    }
  </style>
</head>
<div layout:fragment="content">
  <!-- 모달 불러오기 -->
  <div th:replace="acc/modal/modal :: modals"></div>
  
  <div class="w-100">
    <!-- 헤더 영역 -->
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h4 class="mb-0">매입매출전표</h4>
      <div>
        <button class="btn btn-outline-primary btn-sm" onclick="addEmptyRow()">추가</button>
        <button class="btn btn-outline-secondary btn-sm" onclick="deleteSelectedRow()">삭제</button>
        <button class="btn btn-outline-secondary btn-sm" onclick="window.print()">인쇄</button>
      </div>
    </div>

    <!-- 날짜 필터 영역 -->
    <form class="row g-2 mb-2 align-items-end" method="get" action="/voucher/list">
      <div class="col-auto">
        <label class="form-label mb-0">일자</label>
        2025 년
        <input type="number" value="1" class="form-control form-control-sm d-inline-block" name="startMonth" style="width:45px;"> 월
        <input type="number" value="1" class="form-control form-control-sm d-inline-block" name="startDay" style="width:45px;"> 일 ~
        2025 년
        <input type="number" value="12" class="form-control form-control-sm d-inline-block" name="endMonth" style="width:45px;"> 월
        <input type="number" value="31" class="form-control form-control-sm d-inline-block" name="endDay" style="width:45px;"> 일
        <small class="text-muted ms-3">*전자세금계산서 및 신용카드매출전표에서 관리하세요.</small>
      </div>
    </form>
    <!-- 메인 매입매출전표 그리드 -->
    <div class="grid-container mb-2" style="height:40vh;">
      <div id="purchaseSalesGrid" class="ag-theme-alpine" style="width:100%; height:100%;"></div>
    </div>

    <!-- 중간 상세정보 영역 -->
    <div class="mb-2" style="height:12vh;">
      <div class="d-flex justify-content-between align-items-center mb-1">
        <h6 class="mb-0 text-muted">상세 전표 내용</h6>
        <div>
          <button class="btn btn-outline-primary btn-sm" onclick="addDetailRow()" id="addDetailBtn" disabled>상세 추가</button>
          <small class="text-muted ms-2">마스터 행을 선택하면 해당 전표의 상세내용을 편집할 수 있습니다.</small>
        </div>
      </div>
      <div id="detailGrid" class="ag-theme-alpine" style="width:100%; height:calc(100% - 25px);"></div>
    </div>

    <!-- 하단 통합 그리드 영역 -->
    <div class="grid-container" style="height:161px;">
      <div id="combinedGrid" class="ag-theme-alpine" style="width:100%; height:100%;"></div>
    </div>
  </div>

  <script th:inline="javascript">
    // 공통 코드(과세유형) 매핑
    const code0H = /*[[${code0H}]]*/ [];
    const code0A = /*[[${code0A}]]*/ [];
    const code0G = /*[[${code0G}]]*/ [];
    let purchaseSalesGridApi = null;
    let combinedGridApi = null;
    let detailGridApi = null;
    let highlightedEntryNumber = null;
    let arrowKeyDebounceTimer = null;
    let selectedMaster = null;  // 선택된 마스터 로우 저장
    let resizeEventRegistered = false;  // resize 이벤트 중복 등록 방지
    
    // 매입매출 데이터 (backend에서 로드)
    let purchaseSalesData = [];

    // 상세정보 데이터 (초기에는 빈 상태)
    let detailData = [];

    // 빈 행 생성 함수
    function getEmptyRow() {
      const emptyRow = {
        entryDate: null, // 빈 상태로 초기화 (사용자가 직접 입력)
        month: null,     // 월 필드 추가
        day: null,       // 일 필드 추가
        entryNumber: null,
        transactionType: '',
        itemName: '',
        quantity: null,
        unitPrice: null,
        totalSupplyAmount: null,
        totalTaxAmount: null,
        partnerCode: '',
        partnerName: '',
        businessNumber: '',
        electronicType: '',
        resentmenType: '',
        debitAmount: null,
        creditAmount: null,
        description: ''
      };
      // 유니크한 ID 미리 할당
      emptyRow._emptyRowId = `empty_row_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      return emptyRow;
    }

    // 빈 행인지 확인하는 함수
    function isEmptyRow(rowData) {
      return !rowData.entryNumber && (!rowData.entryDate || !rowData.transactionType || !rowData.itemName);
    }

    // 상세정보용 빈 행 생성 함수
    function getEmptyDetailRow() {
      const emptyRow = {
        entryNumber: null,  // 이후에 선택된 마스터의 전표번호로 설정됨
        resentmenType: '',
        accountCode: '',
        accountName: '',
        partnerCode: '',
        partnerName: '',
        debitAmount: null,
        creditAmount: null,
        description: '',
        lineNumber: null
      };
      emptyRow._emptyRowId = `empty_detail_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      return emptyRow;
    }

    // 상세정보 빈 행인지 확인하는 함수
    function isEmptyDetailRow(rowData) {
      return !rowData.lineNumber && (!rowData.resentmenType || !rowData.accountCode);
    }

    // 통합 데이터 (매출 + 매입을 한 행에 표시)
    let combinedData = [
      { saleCode: '11', saleName: '과세', saleDetail: '과세매출', saleNum: '16', saleType: '수출', saleValue: '수출', buyCode: '21', buyName: '전자', buyDetail: '전자화폐', buyNum: '31', buyType: '수입', buyValue: '수입' },
      { saleCode: '12', saleName: '영세', saleDetail: '영세율', saleNum: '17', saleType: '기타', saleValue: '카드과세', buyCode: '22', buyName: '현과', buyDetail: '현금과세', buyNum: '32', buyType: '면세', buyValue: '면세매입' },
      { saleCode: '13', saleName: '면세', saleDetail: '계산서', saleNum: '18', saleType: '기타', saleValue: '카드면세', buyCode: '23', buyName: '현면', buyDetail: '현금면세', buyNum: '33', buyType: '기타', buyValue: '카드면세' },
      { saleCode: '14', saleName: '건물', saleDetail: '유흥업', saleNum: '19', saleType: '기타', saleValue: '카드영세', buyCode: '24', buyName: '현영', buyDetail: '현금영세', buyNum: '34', buyType: '기타', buyValue: '카드영세' },
      { saleCode: '15', saleName: '간이', saleDetail: '간이과세', saleNum: '20', saleType: '면세', saleValue: '유흥업', buyCode: '25', buyName: '기장', buyDetail: '카드영세', buyNum: '35', buyType: '금전', buyValue: '금전등록' },
    ];

    // ag-Grid 로드 함수: master 리스트 가져오기
    async function loadMasterData() {
      try {
        const response = await fetch('/acc/enps/ma');
        const data = await response.json();
        if (purchaseSalesGridApi && typeof purchaseSalesGridApi.applyTransaction === 'function') {
          // 기존 데이터에 month, day 필드 추가
          data.forEach(item => {
            if (item.entryDate) {
              const date = new Date(item.entryDate);
              item.month = date.getMonth() + 1;
              item.day = date.getDate();
            }
          });
          
          // 전체 기존 데이터 제거 후 새 데이터 추가
          const currentData = [];
          purchaseSalesGridApi.forEachNode(node => currentData.push(node.data));
          purchaseSalesGridApi.applyTransaction({ remove: currentData, add: data });
          console.log('Master list load 성공:', data);
          if (data.length > 0) {
            console.log('Master 거래처명:', data[0].partnerName);
          }
        } else {
          console.log('Grid API 미지원 또는 applyTransaction 없음');
        }
      } catch (err) {
        console.error('Master 리스트 로드 실패:', err);
      }
    }

    // 상세정보 표시 함수: 선택한 master의 detail 가져오기
    function showDetailInfo(master) {
      const entryNo = master.entryNumber;
      if (!entryNo) {
        // 빈 마스터 행인 경우 상세정보 그리드 초기화
        if (detailGridApi) {
          const current = [];
          detailGridApi.forEachNode(node => current.push(node.data));
          detailGridApi.applyTransaction({ remove: current });
        }
        return;
      }
      
      fetch(`/acc/enps/de/${entryNo}`)
        .then(res => {
          return res.json();
        })
        .then(data => {
          if (detailGridApi && typeof detailGridApi.applyTransaction === 'function') {
            // 기존 데이터 제거 후 새 데이터 추가
            console.log('상세 리스트 로드 성공:', data);
            const current = [];
            detailGridApi.forEachNode(node => current.push(node.data));
            detailGridApi.applyTransaction({ remove: current, add: data });
            
            // 빈 행이 있는지 확인하고 없으면 추가
            setTimeout(() => {
              let hasEmptyRow = false;
              for (let i = 0; i < detailGridApi.getDisplayedRowCount(); i++) {
                const row = detailGridApi.getDisplayedRowAtIndex(i)?.data;
                if (row && isEmptyDetailRow(row)) {
                  hasEmptyRow = true;
                  break;
                }
              }
              if (!hasEmptyRow) {
                const newEmptyRow = getEmptyDetailRow();
                // 선택된 마스터의 전표번호를 빈 행에 설정
                newEmptyRow.entryNumber = master.entryNumber;
                detailGridApi.applyTransaction({ add: [newEmptyRow] });
              }
            }, 100);
            
            detailGridApi.refreshCells({ force: true });
          } else {
            console.log('Grid API 준비 안됨 또는 applyTransaction 미지원');
          }
        })
        .catch(err => {
          console.log('상세 리스트 로드 실패:', err);
          // 오류 발생 시에도 빈 행 추가
          if (detailGridApi) {
            const current = [];
            detailGridApi.forEachNode(node => current.push(node.data));
            detailGridApi.applyTransaction({ remove: current });
            
            const newEmptyRow = getEmptyDetailRow();
            newEmptyRow.entryNumber = master.entryNumber;
            detailGridApi.applyTransaction({ add: [newEmptyRow] });
          }
        });
    }

    // 매입매출전표 그리드 설정
    const purchaseSalesGridOptions = {
      suppressClickEdit: false,
      singleClickEdit: true,
      headerHeight: 30,
      rowHeight: 28,
      rowData: purchaseSalesData,
      getRowId: params => {
        const data = params.data;
        // 일반 데이터 행 (entryNumber로 고유 ID 생성)
        if (data.entryNumber) {
          return `entry_${data.entryNumber}`;
        }
        // 빈 행 (신규 행) 처리
        if (!data.entryNumber) {
          // _emptyRowId가 없으면 새로 생성하여 할당
          if (!data._emptyRowId) {
            data._emptyRowId = `empty_row_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
          }
          return data._emptyRowId;
        }
        return undefined;
      },
      columnDefs: [
        { headerName: "월", field: "month", initialWidth: 75, cellClass: 'ag-cell-center', editable: true,
          valueSetter: params => {
            const month = Number(params.newValue);
            if (month >= 1 && month <= 12) {
              params.data.month = month;
              // 월과 일이 모두 있으면 entryDate 생성
              if (params.data.month && params.data.day) {
                const date = new Date(2025, params.data.month - 1, params.data.day);
                params.data.entryDate = date.toISOString().split('T')[0];
              }
              return true;
            }
            return false;
          }
        },
        { 
          headerName: "일", field: "day", initialWidth: 75, cellClass: 'ag-cell-center', editable: true,
          valueSetter: params => {
            const day = Number(params.newValue);
            if (day >= 1 && day <= 31) {
              params.data.day = day;
              // 월과 일이 모두 있으면 entryDate 생성
              if (params.data.month && params.data.day) {
                const date = new Date(2025, params.data.month - 1, params.data.day);
                params.data.entryDate = date.toISOString().split('T')[0];
              }
              return true;
            }
            return false;
          }
        },
        { headerName: "번호", field: "entryNumber", initialWidth: 95, editable: false },
        { headerName: "유형", field: "transactionType", initialWidth: 90, editable: true, cellRenderer: params => {
            const code = params.value;
            const mapping = code0H.find(item => item.commonCode === code);
            if (mapping) {
              const badgeColor = parseInt(mapping.commonCode) <= 50 ? 'bg-danger' : 'bg-primary';
              return `<span class="badge ${badgeColor}">${mapping.commonCodeName}</span>`;
            }
            return code || '';
          } },
        { headerName: "품명", field: "itemName", minWidth: 200, editable: true },
        { headerName: "수량", field: "quantity", initialWidth: 90, cellClass: 'ag-right-aligned-cell', valueFormatter: params => params.value?.toLocaleString() || '', editable: true },
        { headerName: "단가", field: "unitPrice", minWidth: 100, cellClass: 'ag-right-aligned-cell', valueFormatter: params => params.value?.toLocaleString() || '', editable: true },
        { headerName: "공급가액", field: "totalSupplyAmount", minWidth: 120, cellClass: 'ag-right-aligned-cell', valueFormatter: params => params.value?.toLocaleString() || '', editable: true },
        { headerName: "부가세", field: "totalTaxAmount", minWidth: 100, cellClass: 'ag-right-aligned-cell', valueFormatter: params => params.value?.toLocaleString() || '', editable: true },
        { headerName: "코드", field: "partnerCode", initialWidth: 90, editable: true },
        { headerName: "공급처명", field: "partnerName", minWidth: 120, editable: true },
        { headerName: "등록번호", field: "businessNumber", minWidth: 150, editable: true },
        { headerName: "전자", field: "electronicType", minWidth: 50, editable: true,
            cellRenderer: params => { 
              const code = params.value;
              if (code === 'a1') { return '○'; } 
              else if (code === 'a2') { return ''; } 
              return code || '';
            }
        }
      ],
      rowSelection: { mode: 'multiRow' },
      onGridReady: (params) => {
        purchaseSalesGridApi = params.api;
        loadMasterData();
        // 컬럼 너비 자동맞춤
        params.api.sizeColumnsToFit();
        // 창 크기 변경 시 모든 그리드 자동맞춤 (한 번만 등록)
        if (!resizeEventRegistered) {
          window.addEventListener('resize', () => {
            if (purchaseSalesGridApi) purchaseSalesGridApi.sizeColumnsToFit();
            if (detailGridApi) detailGridApi.sizeColumnsToFit();
            if (combinedGridApi) combinedGridApi.sizeColumnsToFit();
          });
          resizeEventRegistered = true;
        }
        
        // 빈 행 추가
        setTimeout(() => {
          let hasEmptyRow = false;
          for (let i = 0; i < params.api.getDisplayedRowCount(); i++) {
            const row = params.api.getDisplayedRowAtIndex(i)?.data;
            if (row && isEmptyRow(row)) {
              hasEmptyRow = true;
              break;
            }
          }
          if (!hasEmptyRow) {
            const newEmptyRow = getEmptyRow();
            params.api.applyTransaction({ add: [newEmptyRow] });
          }
        }, 100);
      },
      onRowClicked: (event) => {
        selectedMaster = event.data;  // 클릭된 마스터 저장
        // 상세 추가 버튼 상태 업데이트
        updateDetailButtonState();
        // 등록된 마스터 행(전표번호가 있는 행)만 상세정보 표시
        if (event.data.entryNumber) {
          showDetailInfo(event.data);
        } else {
          // 빈 행 클릭 시 상세정보 그리드 초기화
          if (detailGridApi) {
            const current = [];
            detailGridApi.forEachNode(node => current.push(node.data));
            detailGridApi.applyTransaction({ remove: current });
          }
        }
      },
      onCellValueChanged: (event) => {
        // 셀 값이 변경될 때 빈 행이 있는지 확인하고 없으면 추가
        setTimeout(() => {
          let hasEmptyRow = false;
          for (let i = 0; i < event.api.getDisplayedRowCount(); i++) {
            const row = event.api.getDisplayedRowAtIndex(i)?.data;
            if (row && isEmptyRow(row)) {
              hasEmptyRow = true;
              break;
            }
          }
          if (!hasEmptyRow) {
            const newEmptyRow = getEmptyRow();
            event.api.applyTransaction({ add: [newEmptyRow] });
          }
        }, 50);
      }
    };

    // 상세정보 그리드 설정
    const detailGridOptions = {
      headerHeight: 28,
      rowHeight: 28,
      rowData: detailData,
      suppressHorizontalScroll: false,
      suppressClickEdit: false,
      singleClickEdit: true,
      getRowId: params => {
        const data = params.data;
        // 일반 데이터 행
        if (data.entryNumber && data.lineNumber) {
          return `detail_${data.entryNumber}_${data.lineNumber}`;
        }
        // 빈 행 처리
        if (!data.entryNumber) {
          if (!data._emptyRowId) {
            data._emptyRowId = `empty_detail_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
          }
          return data._emptyRowId;
        }
        return undefined;
      },
      columnDefs: [
        { headerName: "일자", cellRenderer: params => {
            if (!selectedMaster || !selectedMaster.entryDate) return '';
            const d = new Date(selectedMaster.entryDate);
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return `${mm}-${dd}`;
          }, minWidth: 80, cellClass: 'ag-cell-center' },
        { headerName: "전표번호", field: "entryNumber", minWidth: 100, editable: false },
        { headerName: "구분", field: "resentmenType", minWidth: 80, editable: true, cellRenderer: params => {
            return code0G.find(v => String(v.commonCode) === String(params.value))?.commonCodeName || params.value || '';
          }},
        { headerName: "코드", field: "accountCode", minWidth: 80, editable: true },
        { headerName: "계정과목", field: "accountName", minWidth: 120, editable: false },
        { headerName: "코드", field: "partnerCode", minWidth: 80, editable: true },
        { headerName: "거래처명", field: "partnerName", minWidth: 120, editable: true },
        { headerName: "차변", field: "debitAmount", minWidth: 100, cellClass: 'ag-right-aligned-cell', valueFormatter: params => params.value ? params.value.toLocaleString() : '', editable: true },
        { headerName: "대변", field: "creditAmount", minWidth: 100, cellClass: 'ag-right-aligned-cell', valueFormatter: params => params.value ? params.value.toLocaleString() : '', editable: true },
        { headerName: "적요", field: "description", minWidth: 150, editable: true }
      ],
      onGridReady: (params) => {
        detailGridApi = params.api;
        // 컬럼 너비 자동맞춤
        params.api.sizeColumnsToFit();
      },
      onCellValueChanged: (event) => {
        // 셀 값이 변경될 때 빈 행이 있는지 확인하고 없으면 추가
        setTimeout(() => {
          if (!selectedMaster || !selectedMaster.entryNumber) return;
          
          let hasEmptyRow = false;
          for (let i = 0; i < event.api.getDisplayedRowCount(); i++) {
            const row = event.api.getDisplayedRowAtIndex(i)?.data;
            if (row && isEmptyDetailRow(row)) {
              hasEmptyRow = true;
              break;
            }
          }
          if (!hasEmptyRow) {
            const newEmptyRow = getEmptyDetailRow();
            newEmptyRow.entryNumber = selectedMaster.entryNumber;
            event.api.applyTransaction({ add: [newEmptyRow] });
          }
        }, 50);
      }
    };

    // 통합 그리드 설정
    const combinedGridOptions = {
      headerHeight: 24,
      rowHeight: 22,
      rowData: combinedData,
      suppressHorizontalScroll: false,
      // 편집 및 정렬 비활성화
      suppressClickEdit: true,
      singleClickEdit: false,
      readOnlyEdit: true,
      columnDefs: [
        // 매출 영역
        { 
          headerName: "매출(판매)", 
          headerClass: 'ag-header-group-blue',
          children: [
            { headerName: "코드", field: "saleCode", width: 70, cellClass: 'ag-cell-center', sortable: false, editable: false, resizable: false },
            { headerName: "구분", field: "saleName", width: 70, cellClass: 'ag-cell-center', sortable: false, editable: false, resizable: false },
            { headerName: "세부내용", field: "saleDetail", width: 110, sortable: false, editable: false, resizable: false },
            { headerName: "코드", field: "saleNum", width: 70, cellClass: 'ag-cell-center', sortable: false, editable: false, resizable: false },
            { headerName: "구분", field: "saleType", width: 70, cellClass: 'ag-cell-center', sortable: false, editable: false, resizable: false },
            { headerName: "세부내용", field: "saleValue", width: 110, sortable: false, editable: false, resizable: false }
          ]
        },
        // 매입 영역
        { 
          headerName: "매입(구매)", 
          headerClass: 'ag-header-group-blue',
          children: [
            { headerName: "코드", field: "buyCode", width: 70, cellClass: 'ag-cell-center', sortable: false, editable: false, resizable: false },
            { headerName: "구분", field: "buyName", width: 70, cellClass: 'ag-cell-center', sortable: false, editable: false, resizable: false },
            { headerName: "세부내용", field: "buyDetail", width: 110, sortable: false, editable: false, resizable: false },
            { headerName: "코드", field: "buyNum", width: 70, cellClass: 'ag-cell-center', sortable: false, editable: false, resizable: false },
            { headerName: "구분", field: "buyType", width: 70, cellClass: 'ag-cell-center', sortable: false, editable: false, resizable: false },
            { headerName: "세부내용", field: "buyValue", width: 110, sortable: false, editable: false, resizable: false }
          ]
        }
      ],
      // 선택 및 상호작용 비활성화
      suppressMultiSort: true,
      suppressColumnMoveAnimation: true,
      suppressMovableColumns: true,
      suppressMenuHide: true,
      onGridReady: (params) => {
        combinedGridApi = params.api;
        // 컬럼 너비 자동맞춤
        params.api.sizeColumnsToFit();
      }
    };

    // 그리드 생성
    agGrid.createGrid(document.querySelector("#purchaseSalesGrid"), purchaseSalesGridOptions);
    agGrid.createGrid(document.querySelector("#detailGrid"), detailGridOptions);
    agGrid.createGrid(document.querySelector("#combinedGrid"), combinedGridOptions);

    // 삭제 함수
    function deleteSelectedRow() {
      const selectedNodes = purchaseSalesGridApi.getSelectedNodes();
      if (selectedNodes.length === 0) {
        alert("삭제할 행을 선택하세요.");
        return;
      }

      const confirmMessage = selectedNodes.length === 1
        ? "선택된 행을 삭제하시겠습니까?"
        : `선택된 ${selectedNodes.length}개 행을 삭제하시겠습니까?`;

      if (!confirm(confirmMessage)) {
        return;
      }

      const deleteData = selectedNodes.map(node => node.data);
      purchaseSalesGridApi.applyTransaction({ remove: deleteData });
    }

    // 빈 행 추가 함수
    function addEmptyRow() {
      if (purchaseSalesGridApi) {
        const newEmptyRow = getEmptyRow();
        purchaseSalesGridApi.applyTransaction({ add: [newEmptyRow] });
        
        // 새로 추가된 행으로 포커스 이동
        setTimeout(() => {
          const rowCount = purchaseSalesGridApi.getDisplayedRowCount();
          if (rowCount > 0) {
            purchaseSalesGridApi.setFocusedCell(rowCount - 1, 'itemName');
          }
        }, 100);
      }
    }

    // 상세 행 추가 함수
    function addDetailRow() {
      if (detailGridApi && selectedMaster && selectedMaster.entryNumber) {
        const newEmptyRow = getEmptyDetailRow();
        newEmptyRow.entryNumber = selectedMaster.entryNumber;
        detailGridApi.applyTransaction({ add: [newEmptyRow] });
        
        // 새로 추가된 행으로 포커스 이동
        setTimeout(() => {
          const rowCount = detailGridApi.getDisplayedRowCount();
          if (rowCount > 0) {
            detailGridApi.setFocusedCell(rowCount - 1, 'resentmenType');
          }
        }, 100);
      }
    }

    // 상세 추가 버튼 활성화/비활성화
    function updateDetailButtonState() {
      const addDetailBtn = document.getElementById('addDetailBtn');
      if (addDetailBtn) {
        if (selectedMaster && selectedMaster.entryNumber) {
          addDetailBtn.disabled = false;
          addDetailBtn.textContent = `상세 추가 (전표번호: ${selectedMaster.entryNumber})`;
        } else {
          addDetailBtn.disabled = true;
          addDetailBtn.textContent = '상세 추가';
        }
      }
    }

    // 날짜 필터
    function filterByDate() {
      const startMonth = Number(document.querySelector('input[name="startMonth"]').value);
      const startDay = Number(document.querySelector('input[name="startDay"]').value);
      const endMonth = Number(document.querySelector('input[name="endMonth"]').value);
      const endDay = Number(document.querySelector('input[name="endDay"]').value);
      
      console.log('Date filter:', { startMonth, startDay, endMonth, endDay });
    }

    // 이벤트 리스너
    ['startMonth', 'startDay', 'endMonth', 'endDay'].forEach(name => {
      document.querySelector(`input[name="${name}"]`).addEventListener('input', filterByDate);
    });
  </script>
</div>