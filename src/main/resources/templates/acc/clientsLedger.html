<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{common/layouts/default}">
<!-- ============================================
  - 작성자   : 김희정
  - 최초작성 : 2025-06-18
  - 설명     : 거래처원장 화면
  -----------------------------------------------
  [ 변경 이력 ]
  - 2025-06-18 (김희정): title 및 내용 추가
  - 2025-06-26 (김희정): DB조회 후 ag-gird 전체조회 기능 구현 (날짜/계정과목코드/거래처코드 필터가능)
  - 2025-06-27 (김희정): 대분류까지 불러오기 => loadLedger함수의 잔액 필터 수정
                       : 계정과목코드(필수조회조건)를 반드시 입력해야 데이터 나오도록 수정
                       : 거래처원장 탭 구분 (잔액/내용)
  [ to-do ]
  - 검색조건 (계정과목/거래처) 코드 입력시 계정과목명/거래처명 자동 불러오기
  - 검색조건 (계정과목/거래처) 모달 연동하기
  - 월 소계 및 누계 행 추가
  - 거래처 없는 거래도 내역 조회 추가 (계정과목코드o 거래처코드x)
  - pdf기능 추가
============================================ -->

<head>
  <title>거래처원장</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <style>
  .ag-overlay-no-rows-center {
    font-size: 1rem; 
    /* font-weight: bold; */
    color: #444; 
  }
  </style>
</head>
<div layout:fragment="content">
  <!-- 모달 불러오기 -->
  <div th:replace="acc/modal/modal :: modals"></div>
  <div class="w-100" id="clients-ledger">
    <div class="d-flex justify-content-between align-items-center mb-1">
      <!-- 왼쪽: 일반전표 제목 -->
      <h3 class="mb-0">거래처원장</h3>
      <!-- 오른쪽: 버튼 모음 -->
      <div>
        <button class="btn btn-secondary btn-sm" onclick="printLedger()">인쇄</button>
      </div>
    </div>
    <div class="d-flex mb-2 align-items-end flex-nowrap" style="flex-wrap:nowrap;">
      <div class="d-flex align-items-center me-2">
        <label class="form-label me-2 mb-0">일자</label>
        2025 년
        <input type="number" value="1" class="form-control form-control-sm d-inline-block mx-1" name="startMonth" style="width:45px;"> 월
        <input type="number" value="1" class="form-control form-control-sm d-inline-block mx-1" name="startDay" style="width:45px;"> 일 ~
        2025 년
        <input type="number" value="12" class="form-control form-control-sm d-inline-block mx-1" name="endMonth" style="width:45px;"> 월
        <input type="number" value="31" class="form-control form-control-sm d-inline-block mx-1" name="endDay" style="width:45px;"> 일
      </div>
      <div class="d-flex align-items-center me-2">
        <label class="me-2 mb-0" style="white-space:nowrap;">계정과목</label>
        <input type="text" id="accountCode" class="form-control form-control-sm d-inline-block me-1" style="width:45px;">
        <button class="btn btn-outline-secondary btn-sm me-1"><i class="bi bi-search"></i></button>
        <input type="text" id="accountName" class="form-control form-control-sm d-inline-block" style="width:120px;">
      </div>
      <div class="d-flex align-items-center me-2">
        <label class="me-2 mb-0" style="white-space:nowrap;">거래처</label>
        <input type="text" id="partnerCode" class="form-control form-control-sm d-inline-block me-1" style="width:60px;">
        <button class="btn btn-outline-secondary btn-sm me-1"><i class="bi bi-search"></i></button>
        <input type="text" id="partnerName" class="form-control form-control-sm d-inline-block" style="min-width:120px;">
      </div>
    </div>
    <!-- 탭 버튼 -->
    <div class="mb-2">
      <button type="button" class="btn btn-outline-primary btn-sm active" id="tab-balance" style="margin-right:8px;">잔액</button>
      <button type="button" class="btn btn-outline-primary btn-sm" id="tab-detail">내용</button>
    </div>
    <!-- 탭 컨텐츠 -->
    <div id="tab-content-balance">
      <!-- 본문 ag-Grid -->
      <div class="grid-container" style="height:75vh;">
        <div id="ledgerGrid" class="ag-theme-alpine" style="width:100%; height:100%;"></div>
      </div>
    </div>
    <div id="tab-content-detail" style="display:none;">
      <div class="grid-container" style="height:75vh;">
        <div id="ledgerDetailGrid" class="ag-theme-alpine" style="width:100%; height:100%;"></div>
      </div>
    </div>

  </div>
  <script th:inline="javascript">
    let year = 2025;
    // 잔액 grid옵션
    const gridOptions = {
      // 헤더 높이 지정
      headerHeight: 35,
      // 행 높이 지정
      rowHeight: 35,
      // 그리드 values 배열
      rowData: [],
      // noRows 메시지 설정
      localeText: { noRowsToShow: '조회할 [계정과목]을 선택해주세요.' },
      // 헤더 설정
      columnDefs: [
        { headerName: '코드', field: 'partnerCode' },
        { headerName: '거래처명', field: 'partnerName' },
        { headerName: '전기이월', field: 'openingBalance', valueFormatter: p => p.value?.toLocaleString() },
        { headerName: '차변', field: 'debit', valueFormatter: p => p.value?.toLocaleString() },
        { headerName: '대변', field: 'credit', valueFormatter: p => p.value?.toLocaleString() },
        { headerName: '잔액', field: 'balance', valueFormatter: p => p.value?.toLocaleString() },
        { headerName: '등록번호', field: 'businessNumber' },
        { headerName: '대표자명', field: 'representativeName' }
      ]
    };
    const api = agGrid.createGrid(document.querySelector("#ledgerGrid"), gridOptions);
    const columnApi = api.columnApi;

    // 내용 grid옵션
    const detailGridOptions = {
      // 헤더 높이 지정
      headerHeight: 35,
      // 행 높이 지정
      rowHeight: 35,
      // 그리드 values 배열
      rowData: [],
      // noRows 메시지 설정
      localeText: { noRowsToShow: '조회할 [계정과목]과 [거래처]를 선택해주세요.' },
      // 헤더 설정
      columnDefs: [
        { headerName: '날짜', field: 'entryDate' },
        { headerName: '적요', field: 'description' },
        { headerName: '차변', field: 'debit', valueFormatter: p => p.value?.toLocaleString() },
        { headerName: '대변', field: 'credit', valueFormatter: p => p.value?.toLocaleString() },
        { headerName: '잔액', field: 'balance', valueFormatter: p => p.value?.toLocaleString() },
        { headerName: '전표번호', field: 'entryNumber' },
      ]
    };
    const detailApi = agGrid.createGrid(document.querySelector("#ledgerDetailGrid"), detailGridOptions);
    const detailColumnApi = detailApi.columnApi;

    loadLedger();
    // 이벤트 등록 (초기에는 잔액탭이 active이므로 잔액용만 등록)
    $('input[name=startMonth], input[name=startDay], input[name=endMonth], input[name=endDay], #accountCode, #partnerCode').on('change', onBalanceInputChange);

    // 탭 전환
    $('#tab-balance').on('click', function() {
      $('#tab-content-balance').show();
      $('#tab-content-detail').hide();
      $(this).addClass('active');
      $('#tab-detail').removeClass('active');
      $('#partnerCode').val(null);
      // 잔액탭용 이벤트 등록, 내용탭용 이벤트 해제
      $('input[name=startMonth], input[name=startDay], input[name=endMonth], input[name=endDay], #accountCode, #partnerCode')
        .off('change', onDetailInputChange)
        .on('change', onBalanceInputChange);
    });
    $('#tab-detail').on('click', function() {
      $('#tab-content-balance').hide();
      $('#tab-content-detail').show();
      $(this).addClass('active');
      $('#tab-balance').removeClass('active');
      // 항상 문자열로 변환해서 전달
      const accountCode = String($('#accountCode').val() ?? '');
      const partnerCode = String($('#partnerCode').val() ?? '');
      loadLedgerDetale(accountCode, partnerCode);
      // 내용탭용 이벤트 등록, 잔액탭용 이벤트 해제
      $('input[name=startMonth], input[name=startDay], input[name=endMonth], input[name=endDay], #accountCode, #partnerCode')
        .off('change', onBalanceInputChange)
        .on('change', onDetailInputChange);
    });

    // 잔액에서 행 클릭시 내용으로 이동
    api.addEventListener('rowClicked', function(event) {
      // 탭 전환 => 잔액탭 숨기고 내용탭 보이게
      $('#tab-content-balance').hide();
      $('#tab-content-detail').show();
      $('#tab-detail').addClass('active');
      $('#tab-balance').removeClass('active');
      $('#partnerCode').val(event.data.partnerCode);
      // 상세 데이터 조회 (선택한 거래처코드로) 
      const partnerCode = String(event.data.partnerCode || '');
      const accountCode = String($('#accountCode').val() || '');
      loadLedgerDetale(accountCode, partnerCode);
    });
    
    // change 이벤트 핸들러 함수 정의
    function onBalanceInputChange() {
      if ($('#tab-balance').hasClass('active')) {
        loadLedger();
      }
    }
    function onDetailInputChange() {
      if ($('#tab-detail').hasClass('active')) {
        const accountCode = String($('#accountCode').val() ?? '');
        const partnerCode = String($('#partnerCode').val() ?? '');
        loadLedgerDetale(accountCode, partnerCode);
      }
    }

    // 말일 함수
    function getLastDayOfMonth(year, month) {
      return new Date(year, month, 0).getDate();
    }
    // 날짜 검증 함수
    function isValidDate(year, month, day) {
      const d = new Date(year, month - 1, day);
      return d.getFullYear() == year && (d.getMonth() + 1) == month && d.getDate() == day;
    }
    // 날짜 보정(말일) 및 year-month-day 날짜포맷
    function getDateString(year, monthInputName, dayInputName) {
      let month = $(`[name=${monthInputName}]`).val();
      let day = $(`[name=${dayInputName}]`).val();
      if (!isValidDate(year, month, day)) {
        day = getLastDayOfMonth(year, month);
        $(`[name=${dayInputName}]`).val(day); // input 값 보정(수정)
      }
      return `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
    }
    
    // 잔액 => DB조회하고 ag-grid 데이터 파싱 및 추가
    async function loadLedger() {
      let startDate = getDateString(year, 'startMonth', 'startDay'); // 검사 시작일 포맷
      let endDate = getDateString(year, 'endMonth', 'endDay'); // 검사 종료일 포맷
      // 검색 계정과목코드
      let accountCode = $('#accountCode').val();
      // 검색 거래처코드
      let partnerCode = $('#partnerCode').val();
      // DB 조회
      const response = await fetch(`/acc/cl/list?startDate=${startDate}&endDate=${endDate}&accountCode=${accountCode}&partnerCode=${partnerCode}`);
      // 조회한 DB 데이터 json 파싱
      let data = await response.json();
      // ag-grid에서 사용할 rowData 구성하기
      let rowMap = new Map();
      data.forEach(master => {
        master.details.forEach(detail => {
          const key = detail.partnerCode || '[거래처코드 없음]';
          const existing = rowMap.get(key); // 지정한 key(partnerCode)에 해당하는 값

          const debit = detail.resentmenType === 'g3' ? detail.amount : 0;
          const credit = detail.resentmenType === 'g4' ? detail.amount : 0;

          if (existing) {
            existing.debit += debit;
            existing.credit += credit;
            // 잔액 갱신
            if ( detail.majorCategory === '자산' || detail.majorCategory === '비용' ) { // 대분류가 자산/비용이면
              existing.balance = existing.openingBalance + existing.debit - existing.credit;
            } else { // 대분류가 부채/자본/수익이면 
              existing.balance = existing.openingBalance - existing.debit + existing.credit;
            }
          } else {
            const openingBalance = 0; // 전기이월
            let balance = 0; // 잔액
            // 잔액 계산
            if ( detail.majorCategory === '자산' || detail.majorCategory === '비용' ) { // 대분류가 자산/비용이면
              balance = openingBalance + debit - credit;
            } else { // 대분류가 부채/자본/수익이면 
              balance = openingBalance - debit + credit;
            }
            rowMap.set(key, { 
              partnerCode: detail.partnerCode, // 거래처코드
              partnerName: detail.partnerName || '[거래처코드 없음]', // 거래처명
              openingBalance: openingBalance, // 전기이월 
              debit: debit, // 차변
              credit: credit, // 대변
              balance: balance, //잔액
              businessNumber: detail.businessNumber || detail.residentNumber || null, // 등록번호
              representativeName: detail.representativeName || null // 대표자명
            });
          }
        });
      });
      // rowMap.values(): Map 내부 값들만 순서대로 꺼낼 수 있는 반복자(iterator)
      // Array.from(): 반복자나 유사 배열 객체를 배열로 변환하는 함수
      let rowData = Array.from(rowMap.values()); // rowMap 에 들어 있는 값들을 배열로 변환

      // 거래처코드 기준으로 오름차순 정렬 + 거래처코드가 없다면 가장 마지막으로 정렬
      rowData.sort((a, b) => {
        if (!a.partnerCode) return 1;
        if (!b.partnerCode) return -1;
        // 두 partnerCode 가 모두 값이 있으면 숫자형으로 변환하여 오름차순 정렬 (작은 값이 앞에 오도록)
        return Number(a.partnerCode) - Number(b.partnerCode);
      });
      api.updateGridOptions({ rowData: rowData });
    }

    // 내용 => DB조회하고 ag-grid 데이터 파싱 및 추가
    async function loadLedgerDetale(setAccountCode, setPartnerCode) {
      let startDate = getDateString(year, 'startMonth', 'startDay'); // 검사 시작일 포맷
      let endDate = getDateString(year, 'endMonth', 'endDay'); // 검사 종료일 포맷
      // 검색 계정과목코드
      let accountCode = String(setAccountCode || $('#accountCode').val() || '');
      // 검색 거래처코드
      let partnerCode = String(setPartnerCode || $('#partnerCode').val() || '');
      // DB 조회
      const response = await fetch(`/acc/cl/listDetail?startDate=${startDate}&endDate=${endDate}&accountCode=${accountCode}&partnerCode=${partnerCode}`);
      // 조회한 DB 데이터 json 파싱
      let data = await response.json();
      console.log("조회 데이터", data);
      let rowData = [];
      let balance = 0; // 잔액 => for문에서 누적시켜서 잔액 표시
      // 전기이월 행 첫줄 세팅
      let preValue = 50000; // 테스트용
      // let preValue = data[0].detail[0].전기이월;
      let majorCategory = null;
      if (
        data && data.length > 0 &&
        Array.isArray(data[0].details) &&
        data[0].details.length > 0
      ) {
        majorCategory = data[0].details[0].majorCategory;
      }
      if ( preValue && majorCategory ){ // 전기이월이 있다면
        let preDebit, preCredit = 0;
        balance += preValue; // 잔액에 전기이월 누적
        // 자산/비용이면 차변에 금액을, 부채/자본/수익이면 대변에 금액을 부여
        if ( data[0].details[0].majorCategory === '자산' || data[0].detail[0].majorCategory === '비용' ) { // 대분류가 자산/비용
          preDebit = preValue; // 차변
        } else { // 대분류가 부채/자본/수익이면 
          preCredit = preValue; // 대변
        }
        // rowData에 값 할당
        rowData.push({
          entryDate: null,
          description: '[전기이월]',
          debit: preDebit,
          credit: preCredit,
          balance: balance,
          entryNumber: null
        });
      }
      // ag-grid에서 사용할 rowData 구성하기
      data.forEach(master => {
        master.details.forEach(detail => {
          // 차변, 대변, 잔액 처리
          let debit, credit = 0;
          const isAssetOrExpense = detail.majorCategory === '자산' || detail.majorCategory === '비용';
          if (detail.resentmenType === 'g3') {
            debit = detail.amount;
            balance = isAssetOrExpense ? balance + detail.amount : balance - detail.amount;
          } else {
            credit = detail.amount;
            balance = isAssetOrExpense ? balance - detail.amount : balance + detail.amount;
          }
          // 처리된 행 추가
          rowData.push({ 
            entryDate: master.entryDate ? master.entryDate.substring(0, 10) : null, // 날짜
            description: detail.description, // 적요
            debit: debit, // 차변
            credit: credit, // 대변
            balance: balance, // 잔액
            entryNumber: detail.entryNumber, // 전표번호
          });
        });
      });

      // entryDate 기준으로 오름차순 정렬 + entryDate가 없다면 가장 마지막으로 정렬
      rowData.sort((a, b) => {
        if (!a.entryDate) return -1;
        if (!b.entryDate) return 1;
        // 두 entryDate 가 모두 값이 있으면 숫자형으로 변환하여 오름차순 정렬 (작은 값이 앞에 오도록)
        return Number(a.entryDate) - Number(b.entryDate);
      });
      console.log("그리드에 적용할 rowData", rowData);
      detailApi.updateGridOptions({ rowData: rowData });
    }
  </script>
</div>
