<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{common/layouts/default}">
<!-- ============================================
  - 작성자   : 김희정
  - 최초작성 : 2025-06-18
  - 설명     : 손익계산서 화면
  -----------------------------------------------
  [ 변경 이력 ]
  - 2025-06-18 (김희정): title 및 내용 추가
  - 2025-07-04 (김희정): 손익계산서 레이아웃
  - 2025-07-04 (김희정): DB 연결
============================================ -->

<head>
  <title>손익계산서</title>
  <style>
    .income-header {
      border-bottom: 3px solid #198754;
      padding-bottom: 1rem;
      margin-bottom: 2rem;
    }

    .ag-header-cell-style {
      background-color: #6c757d !important;
      color: white !important;
      font-weight: 500;
    }

    .ag-subtotal-cell-style {
      background-color: #f1f3f4 !important;
      font-weight: 400;
      border-top: 1px solid #dee2e6;
    }

    .ag-total-cell-style {
      background-color: #f8f9fa !important;
      font-weight: 500;
    }

    .ag-grand-total-cell-style {
      background-color: #e9ecef !important;
      font-weight: 600;
    }
  </style>
</head>

<div layout:fragment="content">
  <div class="container-fluid">
    <!-- 손익계산서 섹션 -->
    <div class="row">
      <div class="col-12">

        <div class="d-flex justify-content-between align-items-center mb-1">
          <!-- 왼쪽: 손익계산서 제목 -->
          <h3 class="mb-0">손익계산서</h3>
          <!-- 오른쪽: 버튼 모음 -->
          <div>
            <button type="button" id="diffFilterBtn" class="btn btn-outline-secondary btn-sm">조회</button>
            <button class="btn btn-outline-secondary btn-sm" onclick="출력()">출력</button>
            <button class="btn btn-outline-secondary btn-sm" onclick="엑셀()">엑셀</button>
          </div>
        </div>
        <!-- 검색/필터 영역 -->
        <form class="row mb-2 align-items-end" method="get" action="/acc/is">
          <div class="col-auto">
            <label class="form-label mb-0">기준일</label>
            <input type="number" name="year" value="2025" class="form-control form-control-sm d-inline-block" style="width:80px;" readonly>
            년
            <select class="form-control form-control-sm d-inline-block" name="endMonth" style="width:70px;">
              <option value="1">1월</option>
              <option value="2">2월</option>
              <option value="3">3월</option>
              <option value="4">4월</option>
              <option value="5">5월</option>
              <option value="6">6월</option>
              <option value="7">7월</option>
              <option value="8">8월</option>
              <option value="9">9월</option>
              <option value="10">10월</option>
              <option value="11">11월</option>
              <option value="12" selected>12월</option>
            </select>
            말까지
          </div>
        </form>
        <div class="grid-container" style="height:100vh;">
          <div id="incomeStatementGrid" class="ag-theme-alpine" style="width:100%; height:75%;"></div>
        </div>
      </div>
    </div>
  </div>

  <script th:inline="javascript">
    let incomeStatementData = [];

    // 페이지 로드 시 데이터 가져오기
    document.addEventListener('DOMContentLoaded', function() {
        loadIncomeStatementData();
        
        // 월 변경 시 자동 조회 이벤트 추가
        document.querySelector('select[name="endMonth"]').addEventListener('change', function() {
            loadIncomeStatementData();
        });
    });
    
    // 서버에서 손익계산서 데이터 가져오기
    async function loadIncomeStatementData() {
      try {
        const year = document.querySelector('input[name="year"]')?.value || '2025';
        const endMonth = document.querySelector('select[name="endMonth"]')?.value || '12';
        
        console.log(`손익계산서 조회: ${year}년 ${endMonth}월말까지`);
        
        const response = await fetch(`/acc/is/data?year=${year}&endMonth=${endMonth}`);
        const result = await response.json();
        
        if (result.success) {
            incomeStatementData = result.data;
            
            // 그리드 새로고침 - v33에서는 setGridOption 사용
            if (gridOptions.api) {
                gridOptions.api.setGridOption('rowData', incomeStatementData);
            }
        } else {
            console.error('데이터 조회 실패:', result.message);
            // 에러 시 더미 데이터 사용
            incomeStatementData = getDummyData();
            if (gridOptions.api) {
                gridOptions.api.setGridOption('rowData', incomeStatementData);
            }
        }
      } catch (error) {
        console.error('손익계산서 데이터 로드 실패:', error);
        // 에러 시 더미 데이터 사용
        incomeStatementData = getDummyData();
        if (gridOptions.api) {
            gridOptions.api.setGridOption('rowData', incomeStatementData);
        }
      }
    }

    // 더미 데이터 함수 (에러 시 백업용)
    function getDummyData() {
        return [
            { section: "영 업 수 익", subsection: "", subcategory: "", accountCode: "", accountName: "", amount: "", total: "", isHeader: true, level: 0 },
            { section: "", subsection: "Ⅰ. 매출액", subcategory: "", accountCode: "", accountName: "", amount: "", total: "10,000,000", isHeader: true, level: 1 },
            { section: "", subsection: "", subcategory: "", accountCode: "", accountName: "제품매출", amount: "8,000,000", total: "", isHeader: false, level: 3 },
            { section: "영 업 비 용", subsection: "", subcategory: "", accountCode: "", accountName: "", amount: "", total: "", isHeader: true, level: 0 },
            { section: "", subsection: "Ⅱ. 매출원가", subcategory: "", accountCode: "", accountName: "", amount: "", total: "6,000,000", isHeader: true, level: 1 },
            { section: "", subsection: "Ⅲ. 매출총이익 ( Ⅰ-Ⅱ )", subcategory: "", accountCode: "", accountName: "", amount: "", total: "4,000,000", isHeader: true, level: 1, isGrandTotal: true }
        ];
    }

    // ag-Grid 세팅
    const gridOptions = {
      headerHeight: 35,
      rowHeight: 35,
      rowData: [],
      suppressMovableColumns: true,
      suppressRowDrag: true,
      rowDragManaged: false,
      rowSelection: 'multiRow',
      suppressRowClickSelection: true,
      columnDefs: [
        { headerName: "계정과목", field: "accountName", width: 300, sortable: false, // flex: 1,
          cellRenderer: params => {
            let displayText = '';
            if (params.data.section) {
              displayText = `<strong style="font-weight: 600;">${params.data.section}</strong>`;
            }
            else if (params.data.subsection) {
              displayText = `<strong style="font-weight: 500;">${params.data.subsection}</strong>`;
            }
            else if (params.data.subcategory) {
              displayText = `<span style="font-weight: 500;">${params.data.subcategory}</span>`;
            }
            else if (params.value) {
              if (params.data.isSubTotal || params.data.isTotal || params.data.isGrandTotal) {
                displayText = `<strong style="font-weight: 500;">${params.value}</strong>`;
              } else {
                displayText = params.value;
              }
            }
            return displayText;
          },
          cellClass: params => {
            if (params.data.isHeader) return 'ag-header-cell-style'; 
            if (params.data.isSubTotal) return 'ag-subtotal-cell-style';
            if (params.data.isTotal) return 'ag-total-cell-style';
            if (params.data.isGrandTotal) return 'ag-grand-total-cell-style';
            return '';
          }
        },
        { headerName: "코드", field: "accountCode", width: 100, sortable: false,
          cellClass: params => {
            if (params.data.isHeader) return 'ag-header-cell-style';
            return '';
          }
        },
        { headerName: "금액", field: "amount", width: 120, sortable: false,
          cellStyle: { textAlign: 'right' },
          cellRenderer: params => {
            if (!params.value) return '';
            return params.value;
          },
          cellClass: params => {
            if (params.data.isHeader) return 'ag-header-cell-style';
            return '';
          }
        },
        { headerName: "합계", field: "total", width: 150, sortable: false,
          cellStyle: { textAlign: 'right'},
          cellRenderer: params => {
            if (!params.value) return '';
            return `<span>${params.value}</span>`;
          },
          cellClass: params => {
            if (params.data.isHeader) return 'ag-header-cell-style';
            if (params.data.isGrandTotal) return 'ag-grand-total-cell-style';
            return '';
          }
        }
      ],
      onGridReady: (params) => { 
        gridOptions.api = params.api;
        // 초기 데이터 로드
        loadIncomeStatementData();
      }
    };

    // 그리드 생성
    agGrid.createGrid(document.querySelector("#incomeStatementGrid"), gridOptions);

    // 기능 함수들
    function 출력() {
      window.print();
    }

    function 엑셀() {
      alert('Excel 내보내기 기능을 준비 중입니다.');
    }

    // 당기순손익 금액을 반환하는 함수 추가
    function getCurrentNetIncome() {
      const netIncomeRow = incomeStatementData.find(row => 
        row.subsection && row.subsection.includes("당기순손익")
      );
      
      if (netIncomeRow && netIncomeRow.total) {
        // 콤마 제거 후 숫자로 변환
        const amount = parseFloat(netIncomeRow.total.replace(/,/g, '')) || 0;
        console.log(`손익계산서 당기순손익: ${amount}`);
        return amount;
      }
      
      console.log('손익계산서 당기순손익을 찾을 수 없습니다.');
      return 0;
    }

    // 전역 함수로 노출 (다른 페이지에서 접근 가능)
    window.getIncomeStatementNetIncome = getCurrentNetIncome;
</script>
</div>
</html>
