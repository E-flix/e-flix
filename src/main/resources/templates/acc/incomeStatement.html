<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{common/layouts/default}">
<!-- ============================================
  - 작성자   : 김희정
  - 최초작성 : 2025-06-18
  - 설명     : 손익계산서 화면
  -----------------------------------------------
  [ 변경 이력 ]
  - 2025-06-18 (김희정): title 및 내용 추가
  - 2025-07-04 (김희정): 손익계산서 레이아웃
  - 2025-07-04 (김희정): DB 연결
============================================ -->

<head>
  <title>손익계산서</title>
  <style>
    .income-header {
      border-bottom: 3px solid #198754;
      padding-bottom: 1rem;
      margin-bottom: 2rem;
    }

    .ag-header-cell-style {
      background-color: #6c757d !important;
      color: white !important;
      font-weight: 500;
    }

    .ag-subtotal-cell-style {
      background-color: #f1f3f4 !important;
      font-weight: 400;
      border-top: 1px solid #dee2e6;
    }

    .ag-total-cell-style {
      background-color: #f8f9fa !important;
      font-weight: 500;
    }

    .ag-grand-total-cell-style {
      background-color: #e9ecef !important;
      font-weight: 600;
    }
  </style>
</head>

<div layout:fragment="content">
  <div class="container-fluid">
    <!-- 손익계산서 섹션 -->
    <div class="row">
      <div class="col-12">

        <div class="d-flex justify-content-between align-items-center mb-1">
          <!-- 왼쪽: 일반전표 제목 -->
          <h3 class="mb-0">손익계산서</h3>
          <!-- 오른쪽: 버튼 모음 -->
          <div>
            <button type="button" id="diffFilterBtn" class="btn btn-outline-secondary btn-sm">조회</button>
            <button class="btn btn-outline-secondary btn-sm" onclick="출력()">출력</button>
            <button class="btn btn-outline-secondary btn-sm" onclick="엑셀()">엑셀</button>
          </div>
        </div>
        <!-- 검색/필터 영역 -->
        <form class="row mb-2 align-items-end" method="get" action="/voucher/list">
          <div class="col-auto">
            <label class="form-label mb-0">일자</label>
            <div class="d-inline-flex align-items-center gap-1">
              <span>2025년</span>
              <input type="number" class="form-control form-control-sm" style="width:4rem;" name="startMonth" min="1" max="12" value="1" id="startMonth">
              <span>월</span>
              <input type="number" class="form-control form-control-sm" style="width:4rem;" name="startDay" min="1" max="31" value="1" id="startDay">
              <span>일부터</span>
              <span>2025년</span>
              <input type="number" class="form-control form-control-sm" style="width:4rem;" name="endMonth" min="1" max="12" value="12" id="endMonth">
              <span>월</span>
              <input type="number" class="form-control form-control-sm" style="width:4rem;" name="endDay" min="1" max="31" value="31" id="endDay">
              <span>일까지</span>
            </div>
          </div>
        </form>
        <div class="grid-container" style="height:100vh;">
          <div id="incomeStatementGrid" class="ag-theme-alpine" style="width:100%; height:75%;"></div>
        </div>
      </div>
    </div>
  </div>

  <script th:inline="javascript">
    // 전역 변수 선언
    let gridApi = null;
    
    // 손익계산서 데이터 (대분류, 중분류, 소분류 구조 적용)
    const incomeStatementData = [
      // 영업수익
      { section: "영 업 수 익", subsection: "", subcategory: "", accountCode: "", accountName: "", amount: "", total: "", isHeader: true, level: 0 },
      
      // Ⅰ. 매출액
      { section: "", subsection: "Ⅰ. 매출액", subcategory: "", accountCode: "01", accountName: "", amount: "", total: "", isHeader: true, level: 1 },
      
      // 1. 상품매출
      { section: "", subsection: "", subcategory: "1. 제품매출", accountCode: "02", accountName: "1. 제품매출", amount: "8,500,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "2. 상품매출", accountCode: "03", accountName: "2. 상품매출", amount: "1,500,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "3. 공사수입", accountCode: "04", accountName: "3. 공사수입", amount: "1,500,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "4. 분양수입", accountCode: "05", accountName: "4. 분양수입", amount: "1,500,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "5. 임대수입", accountCode: "06", accountName: "5. 임대수입", amount: "1,500,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "6. 서비스수입", accountCode: "07", accountName: "6. 서비스수입", amount: "1,500,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "7. 기타", accountCode: "08", accountName: "7. 기타", amount: "1,500,000", total: "", isHeader: false, level: 3 },
      
      { section: "", subsection: "", subcategory: "", accountCode: "", accountName: "매출액 합계", amount: "", total: "", isHeader: false, level: 0, isTotal: true },
      
      // 영업비용
      { section: "영 업 비 용", subsection: "", subcategory: "", accountCode: "", accountName: "", amount: "", total: "", isHeader: true, level: 0 },
      
      // Ⅱ. 매출원가
      { section: "", subsection: "Ⅱ. 매출원가", subcategory: "", accountCode: "09", accountName: "", amount: "", total: "", isHeader: true, level: 1 },
      
      // 1. 상품매출원가
      { section: "", subsection: "", subcategory: "1. 상품매출원가", accountCode: "10", accountName: "1. 상품매출원가 (①+②-③-④)", amount: "2,000,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "", accountCode: "11", accountName: "① 기초재고액", amount: "2,000,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "", accountCode: "12", accountName: "② 당기매입액", amount: "1,500,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "", accountCode: "13", accountName: "③ 기말재고액", amount: "1,500,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "", accountCode: "14", accountName: "④ 타계정대체액", amount: "0", total: "", isHeader: false, level: 3 },

      // 2. 제조ㆍ공사ㆍ분양ㆍ기타원가
      { section: "", subsection: "", subcategory: "2. 제조ㆍ공사ㆍ분양ㆍ기타원가", accountCode: "15", accountName: "2. 제조ㆍ공사ㆍ분양ㆍ기타원가", amount: "3,500,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "", accountCode: "16", accountName: "① 기초재고액", amount: "2,000,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "", accountCode: "17", accountName: "② 당기매입액", amount: "1,500,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "", accountCode: "18", accountName: "③ 기말재고액", amount: "0", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "", accountCode: "19", accountName: "④ 타계정대체액", amount: "0", total: "", isHeader: false, level: 3 },
      
      { section: "", subsection: "", subcategory: "", accountCode: "", accountName: "매출원가 합계", amount: "", total: "", isHeader: false, level: 0, isTotal: true },
      
      { section: "", subsection: "Ⅲ. 매출총이익 ( Ⅰ-Ⅱ )", subcategory: "", accountCode: "20", accountName: "", amount: "", total: "", isHeader: true, level: 1, isGrandTotal: true },

      // Ⅲ. 판매비와관리비
      { section: "", subsection: "Ⅳ. 판매비와관리비", subcategory: "", accountCode: "21", accountName: "", amount: "", total: "", isHeader: true, level: 1 },
      
      { section: "", subsection: "", subcategory: "1. 급여와 임금ㆍ제수당", accountCode: "22", accountName: "1. 급여와 임금ㆍ제수당", amount: "800,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "2. 일용급여", accountCode: "23", accountName: "2. 일용급여", amount: "200,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "3. 퇴직급여 (충당부채 전입ㆍ환입액 포함)", accountCode: "24", accountName: "3. 퇴직급여 (충당부채 전입ㆍ환입액 포함)", amount: "300,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "4. 복리후생비", accountCode: "25", accountName: "4. 복리후생비", amount: "200,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "5. 여비교통비", accountCode: "26", accountName: "5. 여비교통비", amount: "400,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "6. 임차료", accountCode: "27", accountName: "6. 임차료", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "7. 통신비", accountCode: "28", accountName: "7. 통신비", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "8. 전력비", accountCode: "29", accountName: "8. 전력비", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "9. 가스ㆍ수도비", accountCode: "30", accountName: "9. 가스ㆍ수도비", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "10. 유류비", accountCode: "31", accountName: "10. 유류비", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "11. 보험료", accountCode: "32", accountName: "11. 보험료", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "12. 리스료", accountCode: "33", accountName: "12. 리스료", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "13. 세금과공과", accountCode: "34", accountName: "13. 세금과공과", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "14. 감가상각비", accountCode: "35", accountName: "14. 감가상각비", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "15. 무형자산상각비", accountCode: "36", accountName: "15. 무형자산상각비", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "16. 수선비", accountCode: "37", accountName: "16. 수선비", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "17. 건물관리비", accountCode: "38", accountName: "17. 건물관리비", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "18. 접대비 (①+②)", accountCode: "39", accountName: "18. 접대비 (①+②)", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "", accountCode: "40", accountName: "① 해외접대비", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "", accountCode: "41", accountName: "② 국내접대비", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "19. 광고선전비", accountCode: "42", accountName: "19. 광고선전비", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "20. 도서인쇄비", accountCode: "43", accountName: "20. 도서인쇄비", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "21. 운반비", accountCode: "44", accountName: "21. 운반비", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "22. 차량유지비", accountCode: "45", accountName: "22. 차량유지비", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "23. 교육훈련비", accountCode: "46", accountName: "23. 교육훈련비", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "24. 지급수수료", accountCode: "47", accountName: "24. 지급수수료", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "25. 판매수수료", accountCode: "48", accountName: "25. 판매수수료", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "26. 대손상각비 (충당금 전입ㆍ환입액 포함)", accountCode: "49", accountName: "26. 대손상각비 (충당금 전입ㆍ환입액 포함)", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "27. 경상개발비", accountCode: "50", accountName: "27. 경상개발비", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "28. 소모품비", accountCode: "51", accountName: "28. 소모품비", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "29. 의약품비", accountCode: "52", accountName: "29. 의약품비", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "30. 의료소모품비", accountCode: "53", accountName: "30. 의료소모품비", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "31. 경영위탁수수료 (프랜차이즈 수수료 포함)", accountCode: "54", accountName: "31. 경영위탁수수료 (프랜차이즈 수수료 포함)", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "32. 외주용역비", accountCode: "55", accountName: "32. 외주용역비", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "33. 인적용역비", accountCode: "56", accountName: "33. 인적용역비", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "34. 기타소계 (①+②+③+④)", accountCode: "57", accountName: "34. 기타소계 (①+②+③+④)", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "", accountCode: "58", accountName: "①", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "", accountCode: "59", accountName: "②", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "", accountCode: "60", accountName: "③", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "", accountCode: "61", accountName: "④ 기타", amount: "100,000", total: "", isHeader: false, level: 3 },
      
      { section: "", subsection: "", subcategory: "", accountCode: "", accountName: "판매비와관리비 합계", amount: "", total: "", isHeader: false, level: 0, isTotal: true },
      
      { section: "", subsection: "Ⅴ. 영업손익( Ⅲ－Ⅳ )", subcategory: "", accountCode: "62", accountName: "", amount: "", total: "", isHeader: true, level: 1, isGrandTotal: true },
      
      // Ⅳ. 영업외손익
      { section: "", subsection: "Ⅵ. 영업외수익", subcategory: "", accountCode: "63", accountName: "", amount: "", total: "", isHeader: true, level: 1 },
      
      { section: "", subsection: "", subcategory: "1. 이자수익", accountCode: "64", accountName: "1. 이자수익", amount: "50,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "2. 배당금수익", accountCode: "65", accountName: "2. 배당금수익", amount: "30,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "3. 외환차익", accountCode: "66", accountName: "3. 외환차익", amount: "20,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "4. 외화환산이익", accountCode: "67", accountName: "4. 외화환산이익", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "5. 단기투자자산 처분이익", accountCode: "68", accountName: "5. 단기투자자산 처분이익", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "6. 투자자산 처분이익", accountCode: "69", accountName: "6. 투자자산 처분이익", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "7. 유ㆍ무형자산 처분이익", accountCode: "70", accountName: "7. 유ㆍ무형자산 처분이익", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "8. 판매장려금", accountCode: "71", accountName: "8. 판매장려금", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "9. 국고보조금", accountCode: "72", accountName: "9. 국고보조금", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "10. 보험차익", accountCode: "73", accountName: "10. 보험차익", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "11. 충당금ㆍ준비금 환입액", accountCode: "74", accountName: "11. 충당금ㆍ준비금 환입액", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "12. 전기오류수정이익", accountCode: "75", accountName: "12. 전기오류수정이익", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "기타 소계 (①+②+③+④", accountCode: "76", accountName: "13. 기타 소계 (①+②+③+④)", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "", accountCode: "77", accountName: "①", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "", accountCode: "78", accountName: "②", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "", accountCode: "79", accountName: "③", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "", accountCode: "80", accountName: "④ 기타", amount: "100,000", total: "", isHeader: false, level: 3 },

      { section: "", subsection: "", subcategory: "", accountCode: "", accountName: "영업외수익 합계", amount: "", total: "", isHeader: false, level: 0, isSubTotal: true },
      // Ⅶ. 영업외비용
      { section: "", subsection: "Ⅶ. 영업외비용", subcategory: "", accountCode: "81", accountName: "", amount: "", total: "", isHeader: true, level: 1 },

      { section: "", subsection: "", subcategory: "1. 이자비용", accountCode: "82", accountName: "1. 이자비용", amount: "120,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "2. 외환차손", accountCode: "83", accountName: "2. 외환차손", amount: "20,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "3. 외화환산손실", accountCode: "84", accountName: "3. 외화환산손실", amount: "10,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "4. 기타 대손상각비 (충당금전입액 포함)", accountCode: "85", accountName: "4. 기타 대손상각비 (충당금전입액 포함)", amount: "10,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "5. 기부금", accountCode: "86", accountName: "5. 기부금", amount: "10,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "6. 단기투자자산 처분손실", accountCode: "87", accountName: "6. 단기투자자산 처분손실", amount: "10,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "7. 투자자산 처분손실", accountCode: "88", accountName: "7. 투자자산 처분손실", amount: "10,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "8. 유ㆍ무형자산 처분손실", accountCode: "89", accountName: "8. 유ㆍ무형자산 처분손실", amount: "10,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "9. 재고자산 감모손실", accountCode: "90", accountName: "9. 재고자산 감모손실", amount: "10,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "10. 재해손실", accountCode: "91", accountName: "10. 재해손실", amount: "10,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "11. 충당금ㆍ준비금 전입액", accountCode: "92", accountName: "11. 충당금ㆍ준비금 전입액", amount: "10,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "12. 전기오류수정손실", accountCode: "93", accountName: "12. 전기오류수정손실", amount: "10,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "13. 기타 소계 (①+②+③+④)", accountCode: "94", accountName: "13. 기타 소계 (①+②+③+④)", amount: "10,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "", accountCode: "95", accountName: "①", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "", accountCode: "96", accountName: "②", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "", accountCode: "97", accountName: "③", amount: "100,000", total: "", isHeader: false, level: 3 },
      { section: "", subsection: "", subcategory: "", accountCode: "98", accountName: "④ 기타", amount: "100,000", total: "", isHeader: false, level: 3 },

      { section: "", subsection: "", subcategory: "", accountCode: "", accountName: "영업외비용 합계", amount: "", total: "", isHeader: false, level: 0, isSubTotal: true },
      
      { section: "", subsection: "Ⅷ. 당기순손익( Ⅴ＋Ⅵ－Ⅶ )", subcategory: "", accountCode: "99", accountName: "", amount: "", total: "", isHeader: false, level: 1, isGrandTotal: true, isFinal: true }
    ];

    // ag-Grid 세팅 (성능 최적화 옵션 추가)
    const gridOptions = {
      headerHeight: 35, // 헤더 높이
      rowHeight: 35, // 행 높이
      rowData: incomeStatementData, // 손익계산서 데이터
      suppressMovableColumns: true, // 컬럼 이동 금지
      suppressRowDrag: true, // 행 드래그 금지
      rowDragManaged: false, // 행 드래그 관리 비활성화
      // 성능 최적화 옵션
      suppressAnimationFrame: false, // 애니메이션 프레임 사용
      suppressCellFocus: true, // 셀 포커스 비활성화
      suppressRowHoverHighlight: true, // 행 호버 하이라이트 비활성화
      suppressRowDeselection: true, // 행 선택 해제 비활성화
      columnDefs: [
        { 
          headerName: "계정코드", 
          field: "accountCode", 
          width: 100,
          sortable: false,
          cellClass: params => {
            if (params.data.isHeader) return 'ag-header-cell-style';
            if (params.data.isSubTotal) return 'ag-subtotal-cell-style';
            if (params.data.isTotal) return 'ag-total-cell-style';
            if (params.data.isGrandTotal) return 'ag-grand-total-cell-style';
            return '';
          }
        },
        { 
          headerName: "계정과목", 
          field: "accountName",
          flex: 1,
          sortable: false,
          cellRenderer: params => {
            let displayText = '';
            // 대분류 (level 0)
            if (params.data.section) {
              displayText = `<strong style="font-weight: 600;">${params.data.section}</strong>`;
            }
            // 중분류 (level 1)
            else if (params.data.subsection) {
              displayText = `<strong style="font-weight: 500;">${params.data.subsection}</strong>`;
            }
            // 소분류 (level 2)
            else if (params.data.subcategory) {
              displayText = `<span style="font-weight: 500;">${params.data.subcategory}</span>`;
            }
            // 계정과목 및 합계 (level 3 및 합계)
            else if (params.value) {
              if (params.data.isTotal || params.data.isGrandTotal || params.data.isFinal) {
                displayText = `<strong style="font-weight: 500;">${params.value}</strong>`;
              } else {
                displayText = params.value;
              }
            }
            return displayText;
          },
          cellClass: params => {
            if (params.data.isHeader) return 'ag-header-cell-style';
            if (params.data.isSubTotal) return 'ag-subtotal-cell-style';
            if (params.data.isTotal) return 'ag-total-cell-style';
            if (params.data.isGrandTotal) return 'ag-grand-total-cell-style';
            return '';
          }
        },
        { 
          headerName: "금액", 
          field: "amount", 
          width: 150,
          sortable: false,
          cellStyle: { textAlign: 'right' },
          cellRenderer: params => {
            if (!params.value) return '';
            return `<span>${params.value}</span>`;
          },
          cellClass: params => {
            if (params.data.isHeader) return 'ag-header-cell-style';
            if (params.data.isSubTotal) return 'ag-subtotal-cell-style';
            if (params.data.isTotal) return 'ag-total-cell-style';
            if (params.data.isGrandTotal) return 'ag-grand-total-cell-style';
            return '';
          }
        },
        { 
          headerName: "합계", 
          field: "total", 
          width: 150,
          sortable: false,
          cellStyle: { textAlign: 'right'},
          cellRenderer: params => {
            if (!params.value) return '';
            return `<span>${params.value}</span>`;
          },
          cellClass: params => {
            if (params.data.isHeader) return 'ag-header-cell-style';
            if (params.data.isSubTotal) return 'ag-subtotal-cell-style';
            if (params.data.isTotal) return 'ag-total-cell-style';
            if (params.data.isGrandTotal) return 'ag-grand-total-cell-style';
            return '';
          }
        }
      ],
      suppressRowClickSelection: true, // 행 클릭 시 선택 방지
      onGridReady: (params) => { 
        gridApi = params.api; // 전역 변수에 그리드 API 저장
        calculateTotals(); // 그리드 준비 후 자동계산 실행
      }
    };

    // 그리드 생성
    agGrid.createGrid(document.querySelector("#incomeStatementGrid"), gridOptions);

    // 데이터 갱신 함수 - setRowData 없이 효율적인 방식 사용
    function updateGridData() {
      if (gridApi) {
        // 방법 1: 특정 컬럼만 갱신 (가장 효율적)
        gridApi.refreshCells({
          columns: ['amount', 'total'],
          force: true,
          suppressFlash: false
        });
        
        // 필요한 경우에만 행 높이 재계산
        // gridApi.resetRowHeights();
        
        // 방법 2: 트랜잭션 방식 (대량 데이터 갱신 시 사용)
        // const updatedRows = incomeStatementData.filter(row => row.amount || row.total);
        // if (updatedRows.length > 0) {
        //   gridApi.applyTransactionAsync({ update: updatedRows });
        // }
        
        console.log('ag-Grid 데이터 갱신 완료');
      }
    }

    // 대용량 데이터 처리용 트랜잭션 갱신 함수 (필요시 사용)
    function updateGridDataByTransaction(updatedData) {
      if (gridApi && updatedData && updatedData.length > 0) {
        // 트랜잭션을 사용하여 효율적으로 대량 데이터 갱신
        gridApi.applyTransaction({ update: updatedData });
        console.log(`트랜잭션으로 ${updatedData.length}개 행 갱신 완료`);
      }
    }

    // 자동 계산 함수 - 손익계산서의 합계 필드를 동적으로 계산
    function calculateTotals() {
      // 1단계: 복합 계산 항목들 먼저 계산
      calculateComplexItems();
      
      incomeStatementData.forEach((row, index) => {
        // 중분류(level 1) 헤더 행의 합계 계산  
        if (row.isHeader && row.level === 1) {
          calculateSubsectionTotal(index);
        }
        // 합계 항목 계산 (isTotal이 true인 행들)
        else if (row.isTotal || row.isSubTotal) {
          calculateSectionSummary(index);
        }
        // 차액 계산 (매출총이익, 영업손익, 당기순손익)
        else if (row.isGrandTotal || row.isFinal) {
          calculateDifferenceTotal(index);
        }
      });

      // 그리드 데이터 업데이트 - 효율적인 갱신 함수 호출
      updateGridData();
      console.log('손익계산서 합계 계산 완료');
    }

    // 복합 계산 항목들 처리
    function calculateComplexItems() {
      incomeStatementData.forEach((row, index) => {
        if (row.level === 3 && row.accountName) {
          // 상품매출원가 계산 (①+②-③-④)
          if (row.accountName.includes("상품매출원가 (①+②-③-④)")) {
            const item1 = incomeStatementData[index + 1]; // 기초재고액
            const item2 = incomeStatementData[index + 2]; // 당기매입액
            const item3 = incomeStatementData[index + 3]; // 기말재고액
            const item4 = incomeStatementData[index + 4]; // 타계정대체액
            
            if (item1?.amount && item2?.amount && item3?.amount && item4?.amount) {
              const calculated = parseFloat(item1.amount.replace(/,/g, '')) + 
                               parseFloat(item2.amount.replace(/,/g, '')) - 
                               parseFloat(item3.amount.replace(/,/g, '')) - 
                               parseFloat(item4.amount.replace(/,/g, ''));
              row.amount = calculated.toLocaleString();
            }
          }
          // 접대비 계산 (①+②)
          else if (row.accountName.includes("접대비 (①+②)")) {
            const item1 = incomeStatementData[index + 1]; // 해외접대비
            const item2 = incomeStatementData[index + 2]; // 국내접대비
            
            if (item1?.amount && item2?.amount) {
              const calculated = parseFloat(item1.amount.replace(/,/g, '')) + 
                               parseFloat(item2.amount.replace(/,/g, ''));
              row.amount = calculated.toLocaleString();
            }
          }
          // 기타소계 계산 (①+②+③+④)
          else if (row.accountName.includes("기타소계 (①+②+③+④)") || 
                   row.accountName.includes("기타 소계 (①+②+③+④)")) {
            const item1 = incomeStatementData[index + 1];
            const item2 = incomeStatementData[index + 2];
            const item3 = incomeStatementData[index + 3];
            const item4 = incomeStatementData[index + 4];
            
            if (item1?.amount && item2?.amount && item3?.amount && item4?.amount) {
              const calculated = parseFloat(item1.amount.replace(/,/g, '')) + 
                               parseFloat(item2.amount.replace(/,/g, '')) + 
                               parseFloat(item3.amount.replace(/,/g, '')) + 
                               parseFloat(item4.amount.replace(/,/g, ''));
              row.amount = calculated.toLocaleString();
            }
          }
        }
      });
    }



    // 중분류 합계 계산 (해당 중분류의 모든 level 3 항목들의 합)
    function calculateSubsectionTotal(startIndex) {
      let amountTotal = 0;
      const subsectionRow = incomeStatementData[startIndex];
      
      // 해당 중분류에 속한 모든 level 3 항목들을 합계
      for (let i = startIndex + 1; i < incomeStatementData.length; i++) {
        const row = incomeStatementData[i];
        
        // 다음 중분류나 대분류에 도달하면 중단
        if (row.level <= 1) break;
        
        // level 3 항목이고 하위 계산 항목이 아닌 경우만 합계에 포함
        if (row.level === 3 && row.amount && !isSubCalculationItem(row)) {
          const amount = parseFloat(row.amount.replace(/,/g, ''));
          if (!isNaN(amount)) {
            amountTotal += amount;
          }
        }
      }
      
      // 중분류의 total 필드에 합계 저장
      subsectionRow.total = amountTotal.toLocaleString();
      
      console.log(`중분류 "${subsectionRow.subsection}" 합계: ${amountTotal.toLocaleString()}`);
    }

    // 하위 계산 항목인지 확인하는 함수 (①, ②, ③, ④ 등)
    function isSubCalculationItem(row) {
      if (!row.accountName) return false;
      
      // ①, ②, ③, ④로 시작하는 항목들은 하위 계산 항목
      return row.accountName.match(/^[①②③④⑤⑥⑦⑧⑨⑩]/) !== null;
    }


    // 섹션별 합계 계산 (매출액 합계, 매출원가 합계, 판매비와관리비 합계 등)
    function calculateSectionSummary(totalRowIndex) {
      let amountTotal = 0;
      const totalRow = incomeStatementData[totalRowIndex];
      const totalRowName = totalRow.accountName;

      console.log(`합계 계산 시작: ${totalRowName}`);

      // 영업외수익 합계와 영업외비용 합계는 특별 처리
      if (totalRowName === "영업외수익 합계" || totalRowName === "영업외비용 합계" || totalRowName === "판매비와관리비 합계") {
        console.log(`${totalRowName} - 직접 level 3 항목 합산 방식 사용`);
        
        // 해당 합계 항목 이전의 모든 level 3 항목들을 직접 합산
        for (let i = totalRowIndex - 1; i >= 0; i--) {
          const row = incomeStatementData[i];
          
          // 이전 중분류 헤더에 도달하면 중단 (영업외수익/영업외비용/판매비와관리비 중분류)
          if (row.level === 1 && row.isHeader && 
              (row.subsection?.includes("영업외수익") || 
               row.subsection?.includes("영업외비용") || 
               row.subsection?.includes("판매비와관리비"))) {
            console.log(`중분류 "${row.subsection}" 시작점 확인`);
            break;
          }
          
          // 다른 중분류나 대분류에 도달하면 중단
          if (row.level <= 1) {
            continue;
          }
          
          // level 3 항목이고 하위 계산 항목이 아닌 경우만 합계에 포함
          if (row.level === 3 && row.amount && !isSubCalculationItem(row)) {
            const amount = parseFloat(row.amount.replace(/,/g, ''));
            if (!isNaN(amount)) {
              amountTotal += amount;
              console.log(`직접 합산: "${row.accountName}" = ${amount.toLocaleString()}`);
            }
          }
        }
      } else {
        // 기존 방식: 중분류 헤더들의 total 값을 합산
        for (let i = totalRowIndex - 1; i >= 0; i--) {
          const row = incomeStatementData[i];
          
          // 이전 섹션의 대분류 헤더에 도달하면 중단
          if (row.isHeader && row.level === 0 && row.section) {
            console.log(`대분류 "${row.section}"에 도달하여 중단`);
            break;
          }
          
          // 중분류 헤더인 경우 해당 중분류의 total 값을 합계에 추가
          if (row.level === 1 && row.isHeader && row.total) {
            const totalAmount = parseFloat(row.total.replace(/,/g, ''));
            if (!isNaN(totalAmount)) {
              amountTotal += totalAmount;
              console.log(`중분류 "${row.subsection}" 추가: ${totalAmount.toLocaleString()}`);
            }
          }
        }
      }

      // 합계 항목에 계산된 값 설정
      totalRow.total = amountTotal.toLocaleString();
      console.log(`${totalRowName} 최종 합계: ${amountTotal.toLocaleString()}`);
    }

    // 차액 계산 (매출총이익 = 매출액 - 매출원가 등)
    function calculateDifferenceTotal(resultRowIndex) {
      const resultRow = incomeStatementData[resultRowIndex];
      
      // 매출총이익 계산
      if (resultRow.subsection && resultRow.subsection.includes("매출총이익")) {
        // 매출총이익 = 매출액 - 매출원가
        const salesRow = findRowByName("매출액 합계");
        const costRow = findRowByName("매출원가 합계");
        
        if (salesRow && costRow && salesRow.total && costRow.total) {
          const profit = parseFloat(salesRow.total.replace(/,/g, '')) - parseFloat(costRow.total.replace(/,/g, ''));
          resultRow.total = profit.toLocaleString();
        }
      }
      // 영업손익 계산
      else if (resultRow.subsection && resultRow.subsection.includes("영업손익")) {
        // 영업손익 = 매출총이익 - 판매비와관리비
        const grossProfitRow = findRowBySubsection("Ⅲ. 매출총이익 ( Ⅰ-Ⅱ )");
        const expenseRow = findRowByName("판매비와관리비 합계");
        
        if (grossProfitRow && expenseRow && grossProfitRow.total && expenseRow.total) {
          const operating = parseFloat(grossProfitRow.total.replace(/,/g, '')) - parseFloat(expenseRow.total.replace(/,/g, ''));
          resultRow.total = operating.toLocaleString();
        }
      }
      // 당기순손익 계산
      else if (resultRow.subsection && resultRow.subsection.includes("당기순손익")) {
        // 당기순손익 = 영업손익 + 영업외수익 - 영업외비용
        const operatingRow = findRowBySubsection("Ⅴ. 영업손익( Ⅲ－Ⅳ )");
        const incomeRow = findRowByName("영업외수익 합계");
        const expenseRow = findRowByName("영업외비용 합계");
        
        if (operatingRow && incomeRow && expenseRow && operatingRow.total && incomeRow.total && expenseRow.total) {
          const net = parseFloat(operatingRow.total.replace(/,/g, '')) + 
                     parseFloat(incomeRow.total.replace(/,/g, '')) - 
                     parseFloat(expenseRow.total.replace(/,/g, ''));
          resultRow.total = net.toLocaleString();
        }
      }
    }

    // 헬퍼 함수: 계정과목명으로 행 찾기
    function findRowByName(accountName) {
      return incomeStatementData.find(row => row.accountName === accountName);
    }

    // 헬퍼 함수: 섹션명으로 행 찾기
    function findRowBySection(section) {
      return incomeStatementData.find(row => row.section === section);
    }

    // 헬퍼 함수: 서브섹션명으로 행 찾기
    function findRowBySubsection(subsection) {
      return incomeStatementData.find(row => row.subsection === subsection);
    }

    // 헬퍼 함수: 서브카테고리명으로 행 찾기
    function findRowBySubcategory(subcategory) {
      return incomeStatementData.find(row => row.subcategory === subcategory);
    }

    // 월별 일자 제한 기능
    function setDayLimits() {
      const months = [
        { month: 1, days: 31 }, { month: 2, days: 28 }, { month: 3, days: 31 },
        { month: 4, days: 30 }, { month: 5, days: 31 }, { month: 6, days: 30 },
        { month: 7, days: 31 }, { month: 8, days: 31 }, { month: 9, days: 30 },
        { month: 10, days: 31 }, { month: 11, days: 30 }, { month: 12, days: 31 }
      ];

      function updateDayLimit(monthInput, dayInput) {
        const month = parseInt(monthInput.value);
        const monthData = months.find(m => m.month === month);
        if (monthData) {
          dayInput.max = monthData.days;
          if (parseInt(dayInput.value) > monthData.days) {
            dayInput.value = monthData.days;
          }
        }
      }

      // 이벤트 리스너 추가
      document.getElementById('startMonth').addEventListener('change', function() {
        updateDayLimit(this, document.getElementById('startDay'));
      });

      document.getElementById('endMonth').addEventListener('change', function() {
        updateDayLimit(this, document.getElementById('endDay'));
      });

      // 초기 설정
      updateDayLimit(document.getElementById('startMonth'), document.getElementById('startDay'));
      updateDayLimit(document.getElementById('endMonth'), document.getElementById('endDay'));
    }

    // 필터 기능
    function applyDateFilter() {
      const startMonth = document.getElementById('startMonth').value;
      const startDay = document.getElementById('startDay').value;
      const endMonth = document.getElementById('endMonth').value;
      const endDay = document.getElementById('endDay').value;

      console.log(`필터 적용: 2025년 ${startMonth}월 ${startDay}일 ~ ${endMonth}월 ${endDay}일`);
      
      // 실제 DB 조회 로직은 여기에 구현
      // 현재는 기존 데이터를 다시 계산하여 표시
      calculateTotals();
      
      // 필터 적용 후 그리드 갱신
      updateGridData();
    }

    // 조회 버튼 이벤트
    document.getElementById('diffFilterBtn').addEventListener('click', applyDateFilter);

    // 페이지 로드 시 초기화
    document.addEventListener('DOMContentLoaded', function() {
      setDayLimits();
    });

    // 기능 함수들
    function 출력() {
      window.print();
    }

    function 엑셀() {
      alert('Excel 내보내기 기능을 준비 중입니다.');
    }

    function printReport(reportType) {
      window.print();
    }

    function exportToExcel() {
      alert('Excel 내보내기 기능을 준비 중입니다.');
    }

    // 전역 함수 등록
    window.출력 = 출력;
    window.엑셀 = 엑셀;
    window.printReport = printReport;
    window.exportToExcel = exportToExcel;
  </script>
</div>
</html>
