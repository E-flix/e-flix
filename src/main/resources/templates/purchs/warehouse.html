<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{common/layouts/default}">
<!-- ============================================
  - 작성자   : 이혁진
  - 최초작성 : 2025-06-19
  - 설명     : 창고 관리 (AG Grid 적용)
  -----------------------------------------------
  [ 변경 이력 ]
  - 2025-06-19 (이혁진): 화면완성
  - 2025-06-20 (이혁진): warehouse 조회 완료
  - 2025-06-20 (이혁진): warehouse 등록 완료
  - 2025-06-23 (이혁진): warehouse 삭제 완료
  - 2025-06-23 (이혁진): 가장 최근 ID 불러오기 완료
  - 2025-06-23 (이혁진): AG Grid 적용
============================================ -->
<head>
	<title>창고관리</title>
</head>
<div layout:fragment="content" class="container-fluid">
	<div class="d-flex justify-content-between align-items-center mb-4">
		<h2>창고관리</h2>
	</div>
	<div class="col-md-12">
		<div class="radio-group">
			<input type="radio" class="btn-check" name="accountFilter" id="warehouse" autocomplete="off" checked>
			<label class="btn btn-outline-secondary btn-sm me-1" for="warehouse">창고관리</label>

			<input type="radio" class="btn-check" name="accountFilter" id="warehouse_mnt" autocomplete="off">
			<label class="btn btn-outline-secondary btn-sm me-1" for="warehouse_mnt">창고이동</label>
		</div>
	</div>
	<div class="card border-0">
		<div class="card-body">
			<!-- 등록 폼 및 버튼 -->
			<div class="row mb-3 align-items-end">
				<div class="col-md-2"><input type="text" class="form-control form-control-sm" id="warehouseId"
						placeholder="창고ID" readonly style="text-align: center;"></div>
				<div class="col-md-3"><input type="text" class="form-control form-control-sm" id="warehouseLocation"
						placeholder="창고위치" style="text-align: center;"></div>
				<div class="col-md-2"><input type="text" class="form-control form-control-sm" id="warehouseScale"
						placeholder="창고크기 단위 : L" style="text-align: center;"></div>
				<div class="col-md-3"><input type="text" class="form-control form-control-sm" id="warehouseManager"
						placeholder="창고담당자" style="text-align: center;"></div>
				<div class="col-md-2 d-flex justify-content-end gap-2">
					<button type="button" class="btn btn-success btn-sm" id="addBtn">저장</button>
					<button type="button" class="btn btn-danger btn-sm" id="delBtn">삭제</button>
				</div>
			</div>
			<!-- AG Grid -->
			<div class="grid-container" style="height:100vh; width:100%;">
				<div id="warehouseGrid" class="ag-theme-alpine" style="width:100%; height:75%;"></div>
			</div>
		</div>
	</div>
</div>

</html>

<!-- AG Grid 설정 -->
<script th:inline="javascript">
	let warehouseList = /*[[${whList}]]*/[];

	const gridOptions = {
		headerHeight: 35,
		rowHeight: 35,
		rowData: warehouseList,
		columnDefs: [
			{ headerName: "창고ID", field: "warehouseId", editable: false },
			{ headerName: "창고위치", field: "warehouseLocation", editable: false },
			{ headerName: "창고크기", field: "warehouseScale", editable: false, valueFormatter: params => params.value + "L" },
			{ headerName: "담당자", field: "warehouseManager", editable: false }
		],
		rowSelection: {
			mode: "multiRow"
		},
		onGridReady: (params) => {
			gridOptions.api = params.api;
			params.api.sizeColumnsToFit();
		}
	};
	// 창 크기 바뀔 때도 다시 꽉 채우기
	window.addEventListener('resize', () => {
		if (gridOptions.api) {
			gridOptions.api.sizeColumnsToFit();
		}
	});
	// 그리드 초기화
	agGrid.createGrid(document.querySelector("#warehouseGrid"), gridOptions);
</script>

<!-- 페이지 기능 -->
<script>
	// 창고이동
	document.getElementById('warehouse_mnt').addEventListener('change', function () {
		if (this.checked) {
			window.location.href = '/purchs/whm';
		}
	});

	// 등록
	$("#addBtn").on("click", () => {
		const warehouseId = $("#warehouseId").val();
		const warehouseLocation = $("#warehouseLocation").val();
		const warehouseScale = $("#warehouseScale").val();
		const warehouseManager = $("#warehouseManager").val();

		const data = {
			warehouseId,
			warehouseLocation,
			warehouseScale,
			warehouseManager
		};

		$.ajax({
			type: 'POST',
			url: '/purchs/whc',
			contentType: 'application/json',
			data: JSON.stringify(data),
			success: function () {
				Swal.fire({
					icon: "success",
					title: "성공",
					text: "창고정보가 저장되었습니다.",
					showConfirmButton: false,
					timer: 1000
				}).then(() => window.location.reload());
			},
			error: function () {
				Swal.fire({
					icon: "warning",
					title: "경고",
					text: "창고정보를 모두 입력하세요.",
					showConfirmButton: false,
					timer: 1000
				});
			}
		});
	});
	// 마지막 창고번호 가져오기
	$(document).ready(() => {
		$.ajax({
			type: 'GET',
			url: '/purchs/whNexTid',
			success: function (id) {
				$("#warehouseId").val(id);
			},
			error: function () {
				alert("오류");
			}
		});
	});
	// 삭제
	$("#delBtn").on("click", () => {
		const selectedRows = gridOptions.api.getSelectedRows();
		const selectedIds = selectedRows.map(row => row.warehouseId);
		if (selectedIds.length === 0) {
			Swal.fire({
				icon: "warning",
				title: "알림",
				text: "삭제할 창고를 선택하세요.",
				timer: 1000,
				showConfirmButton: false
			});
			return;
		}
		Promise.all(selectedIds.map(id => {
			return $.ajax({
				type: "DELETE",
				url: "/purchs/whd",
				contentType: "application/json",
				data: JSON.stringify({ warehouseId: id })
			});
		})).then(() => {
			Swal.fire({
				icon: "success",
				title: "삭제 완료",
				text: "선택된 창고가 삭제되었습니다.",
				timer: 1000,
				showConfirmButton: false
			}).then(() => window.location.reload());
		}).catch(() => {
			Swal.fire({
				icon: "error",
				title: "오류",
				text: "삭제 중 오류가 발생했습니다.",
				timer: 1500,
				showConfirmButton: false
			});
		});
	});
</script>