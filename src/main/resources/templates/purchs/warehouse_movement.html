<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default}">
<!-- ============================================
  - 작성자   : 이혁진
  - 최초작성 : 2025-06-23
  - 설명     : 입고 이동 (AG Grid 적용)
  -----------------------------------------------
  [ 변경 이력 ]
  - 2025-07-02 (이혁진): AG Grid, 레이아웃 통일 적용
  - 2025-07-02 (이혁진): 더미로 진행되고 있음
============================================ -->

<head>
	<title>창고이동관리</title>
</head>
<div layout:fragment="content" class="container-fluid">
	<div class="d-flex justify-content-between align-items-center mb-4">
		<h2>창고이동관리</h2>
	</div>

	<!-- 상단 탭 -->
	<div class="col-md-12 mb-2">
		<div class="radio-group">
			<input type="radio" class="btn-check" name="accountFilter" id="warehouse" autocomplete="off">
			<label class="btn btn-outline-secondary btn-sm me-1" for="warehouse">창고관리</label>

			<input type="radio" class="btn-check" name="accountFilter" id="warehouse_mnt" autocomplete="off" checked>
			<label class="btn btn-outline-secondary btn-sm me-1" for="warehouse_mnt">창고이동</label>
		</div>
	</div>

	<!-- 버튼 -->
	<div class="d-flex justify-content-end mb-2 gap-2">
		<button type="button" class="btn btn-warning btn-sm" onclick="resetTransfer()">초기화</button>
		<button type="button" class="btn btn-success btn-sm" onclick="saveTransfer()">저장</button>
		<button type="button" class="btn btn-primary btn-sm" onclick="addTransferRow()">+ 행 추가</button>
		<button type="button" class="btn btn-danger btn-sm" onclick="deleteSelectedRows()">선택 삭제</button>
	</div>

	<!-- AG Grid 테이블 영역 -->
	<div class="grid-container mb-4" style="height: 45vh; width: 100%;">
		<div id="whMovementGrid" class="ag-theme-alpne" style="width: 100%; height: 100%;"></div>
	</div>
</div>

</html>

<script th:inline="javascript">

	let prdList = /*[[${prdList}]]*/[];
	let prod = prdList.map(p => p.prodName);
	console.log("prdList : ", prdList);
	let updateData = [];
	// 로컬스토리지 행 저장
	const STORAGE_KEY = "whMovementData";

	let whMovementList = [];
	if (localStorage.getItem(STORAGE_KEY)) {
		whMovementList = JSON.parse(localStorage.getItem(STORAGE_KEY));
	} else {
		whMovementList = [];
	}

	const whmGridOptions = {
		rowData: whMovementList,
		rowHeight: 35,
		headerHeight: 35,
		defaultColDef: { resizable: true },

		columnDefs: [
			{
				headerName: "제품ID",
				editable: false,
				field: "prodId",
				valueGetter: (params) => {
					return params.data.prodId || "제품ID";
				},
				cellStyle: (params) => {
					return params.value === "제품ID" ? { color: 'gray' } : { color: 'black' };
				},
			},
			{
				headerName: "제품명",
				editable: true,
				field: "prodName",
				cellEditor: "agSelectCellEditor",
				valueGetter: (params) => {
					return params.data.prodName || "제품명 선택";
				},
				cellStyle: (params) => {
					return params.value === "제품명 선택" ? { color: 'gray' } : { color: 'black' };
				},
				cellEditorParams: {
					values: prod
				},

			},
			{
				headerName: "보내는 창고 정보",
				children: [
					{
						headerName: "창고ID",
						ditable: false,
						field: "sendWh",
						valueGetter: (params) => {
							return params.data.sendWh || "창고ID";
						},
						cellStyle: (params) => {
							return params.value === "창고ID" ? { color: 'gray' } : { color: 'black' };
						},
					},
					{ headerName: "이동전", field: "sendBeforeQty", cellStyle: { color: 'blue' } },
					{ headerName: "이동후", field: "sendAfterQty", cellStyle: { color: 'blue' } },
					{ headerName: "이동수량 - 값 입력", field: "sendMoveQty", editable: true, cellStyle: { color: 'green' } }
				]
			},
			{
				headerName: "받는 창고 정보",
				children: [
					{ headerName: "창고ID", field: "recvWh" },
					{ headerName: "이동전", field: "recvBeforeQty", cellStyle: { color: 'red' } },
					{ headerName: "이동후", field: "recvAfterQty", cellStyle: { color: 'red' } }
				]
			}
		],
		rowSelection: {
			mode: "multiRow"
		},
		onGridReady: (params) => {
			whmGridOptions.api = params.api;
			params.api.sizeColumnsToFit();
		},
		onCellValueChanged: (event) => {
			if (event.colDef.field === "prodName") {
				const selectedName = event.newValue;
				const matched = prdList.find(p => p.prodName === selectedName);
				if (matched) {
					event.data.prodId = matched.prodId;
					event.data.sendWh = matched.sendWh;
					event.api.applyTransaction({ update: [event.data] });
				}
			}
		}
	};

	// ✅ 그리드 생성
	document.addEventListener("DOMContentLoaded", () => {
		agGrid.createGrid(document.querySelector("#whMovementGrid"), whmGridOptions);
		window.addEventListener("resize", () => {
			whmGridOptions.api?.sizeColumnsToFit();
		});
	});
</script>

<!-- 버튼 기능 -->
<script>
	// 초기화
	function resetTransfer() {
		if (!confirm("모든 데이터를 초기화 하시겠습니까?")) return;

		localStorage.removeItem(STORAGE_KEY);
		location.reload();
	}
	// 창고이동 후 저장
	function saveTransfer() {
		alert("저장 기능은 개발 중입니다.");
	}
	// 행추가
	function addTransferRow() {
		const newRow = {
			prodCode: "",
			prodName: "",
			sendWh: "",
			sendBeforeQty: 0,
			sendAfterQty: 0,
			sendMoveQty: 0,
			recvWh: "",
			recvBeforeQty: 0,
			recvAfterQty: 0
		};

		// 그리드에 새 행 추가
		whmGridOptions.api.applyTransaction({ add: [newRow] });
		// 행추가 후 저장
		updateData = [];
		whmGridOptions.api.forEachNode(node => updateData.push(node.data));
		localStorage.setItem(STORAGE_KEY, JSON.stringify(updateData));
	}
	// 행삭제
	function deleteSelectedRows() {
		const selectedRows = whmGridOptions.api.getSelectedRows();
		if (selectedRows.length === 0) {
			alert("삭제할 행을 선택하세요.");
			return;
		}
		whmGridOptions.api.applyTransaction({ remove: selectedRows });
		// 삭제 후 저장
		updateData = [];
		whmGridOptions.api.forEachNode(node => updateData.push(node.data));
		localStorage.setItem(STORAGE_KEY, JSON.stringify(updateData));
	}
	// 페이지 이동
	document.getElementById('warehouse').addEventListener('change', function () {
		if (this.checked) {
			window.location.href = '/purchs/wh';
		}
	});
</script>