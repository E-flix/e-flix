<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default}">
<!-- ============================================
  - 작성자   : 이혁진
  - 최초작성 : 2025-06-23
  - 설명     : 입고 이동 (AG Grid 적용)
  -----------------------------------------------
  [ 변경 이력 ]
  - 2025-07-02 (이혁진): AG Grid, 레이아웃 통일 적용
  - 2025-07-02 (이혁진): 더미로 진행되고 있음
  - 2025-07-02 (이혁진): 작업중
============================================ -->

<head>
	<title>창고이동관리</title>
</head>
<div layout:fragment="content" class="container-fluid">
	<div class="d-flex justify-content-between align-items-center mb-4">
		<h2>창고이동관리</h2>
	</div>

	<!-- 상단 탭 -->
	<div class="col-md-12 mb-2">
		<div class="radio-group">
			<input type="radio" class="btn-check" name="accountFilter" id="warehouse" autocomplete="off">
			<label class="btn btn-outline-secondary btn-sm me-1" for="warehouse">창고관리</label>

			<input type="radio" class="btn-check" name="accountFilter" id="warehouse_mnt" autocomplete="off" checked>
			<label class="btn btn-outline-secondary btn-sm me-1" for="warehouse_mnt">창고이동</label>
		</div>
	</div>

	<!-- 버튼 -->
	<div class="d-flex justify-content-end mb-2 gap-2">
		<!-- <button type="button" class="btn btn-warning btn-sm" onclick="resetTransfer()">초기화</button> -->
		<button type="button" class="btn btn-success btn-sm" onclick="saveTransfer()">저장</button>
		<button type="button" class="btn btn-primary btn-sm" onclick="addTransferRow()">+ 행 추가</button>
		<button type="button" class="btn btn-danger btn-sm" onclick="deleteSelectedRows()">선택 삭제</button>
	</div>

	<!-- AG Grid 테이블 영역 -->
	<div class="grid-container mb-4" style="height: 45vh; width: 100%;">
		<div id="whMovementGrid" class="ag-theme-alpine" style="width: 100%; height: 100%;"></div>
	</div>
</div>

</html>
<script th:inline="javascript">

	let sendWhList = /*[[${sendWhList}]]*/[];
	let toWhList = /*[[${toWhList}]]*/[];

	let toSendWh = sendWhList.map(p => p.prodName);
	let toWh = toWhList.map(v => v.toWh);

	let updateData = [];
	const STORAGE_KEY = "whMovementData";

	let whMovementList = [];
	if (localStorage.getItem(STORAGE_KEY)) {
		whMovementList = JSON.parse(localStorage.getItem(STORAGE_KEY));
	} else {
		whMovementList = [];
	}

	const whmGridOptions = {
		rowData: whMovementList,
		rowHeight: 35,
		headerHeight: 35,
		defaultColDef: { resizable: true },

		columnDefs: [
			{
				headerName: "제품ID",
				editable: false,
				field: "prodId",
				valueGetter: (params) => {
					return params.data.prodId || "제품ID";
				},
				cellStyle: (params) => {
					return params.value === "제품ID" ? { color: 'gray' } : { color: 'black' };
				},
			},
			{
				headerName: "제품명",
				editable: true,
				field: "prodName",
				cellEditor: "agSelectCellEditor",
				valueGetter: (params) => {
					return params.data.prodName || "제품명 선택";
				},
				cellStyle: (params) => {
					return params.value === "제품명 선택" ? { color: 'gray' } : { color: 'black' };
				},
				cellEditorParams: {
					values: toSendWh
				},
			},
			{
				headerName: "보내는 창고 정보",
				children: [
					{
						headerName: "창고ID",
						editable: false,
						field: "sendWh",
						valueGetter: (params) => {
							return params.data.sendWh || "창고ID";
						},
						cellStyle: (params) => {
							return params.value === "창고ID" ? { color: 'gray' } : { color: 'black' };
						},
					},
					{ headerName: "이동전", field: "sendBeforeQty", cellStyle: { color: 'blue' } },
					{ headerName: "이동후", field: "sendAfterQty", cellStyle: { color: 'blue' } },
					{ 
						headerName: "이동수량", 
						field: "sendMoveQty", 
						editable: true, 
						cellStyle: { color: 'green' },
					}
				]
			},
			{
				headerName: "받는 창고 정보",
				children: [
					{
						headerName: "창고ID",
						field: "toWh",
						editable: true,
						cellEditor: "agSelectCellEditor",
						valueGetter: (params) => {
							return params.data.toWh || "창고ID 선택";
						},
						cellStyle: (params) => {
							return params.value === "창고ID 선택" ? { color: 'gray' } : { color: 'black' };
						},
						cellEditorParams: (params) => {
							const sendWhId = params.data.sendWh;
							const filteredToWh = toWh.filter(wh => wh !== sendWhId);
							return {
								values: filteredToWh
							};
						}
					},
					{ headerName: "이동전", field: "toBeforeQty", cellStyle: { color: 'blue' } },
					{ headerName: "이동후", field: "recvAfterQty", cellStyle: { color: 'red' } },
					{ headerName: "창고용량", field: "warehouseScale" }
				]
			}
		],
		rowSelection: {
			mode: "multiRow"
		},
		onGridReady: (params) => {
			whmGridOptions.api = params.api;
			params.api.sizeColumnsToFit();
		},
		onCellValueChanged: (event) => {
			// 제품선택 시 정보 설정
			if (event.colDef.field === "prodName") {
				const selectedName = event.newValue;
				const matched = sendWhList.find(p => p.prodName === selectedName);

				if (matched) {
					event.data.prodId = matched.prodId;
					event.data.sendWh = matched.sendWh;
					event.data.sendBeforeQty = matched.sendBeforeQty;
					event.api.applyTransaction({ update: [event.data] });
					event.api.refreshCells({ rowNodes: [event.node], columns: ['toWh'], force: true });
				}
			}

			// 받는 창고 선택 시 이동전 수량 반영
			if (event.colDef.field === "toWh") {
				const selectedWh = event.newValue;
				const matched = toWhList.find(v => v.toWh === selectedWh);

				if (matched) {
					event.data.toBeforeQty = matched.toBeforeQty;
					event.data.warehouseScale = matched.warehouseScale;
					event.api.applyTransaction({ update: [event.data] });
				}
			}

			// 이동수량 변경 시 후 수량 계산
			if (event.colDef.field === "sendMoveQty") {
				const moveQty = Number(event.newValue ?? 0);
				const beforeSend = Number(event.data.sendBeforeQty ?? 0);
				const beforeRecv = Number(event.data.toBeforeQty ?? 0);

				event.data.sendAfterQty = beforeSend - moveQty;
				event.data.recvAfterQty = beforeRecv + moveQty;

				event.api.applyTransaction({ update: [event.data] });
			}
		}
	};

	document.addEventListener("DOMContentLoaded", () => {
		agGrid.createGrid(document.querySelector("#whMovementGrid"), whmGridOptions);
		window.addEventListener("resize", () => {
			whmGridOptions.api?.sizeColumnsToFit();
		});
	});
</script>

<!-- 버튼 기능 -->
<script>
	// 초기화
	// function resetTransfer() {
	// 	if (!confirm("모든 데이터를 초기화 하시겠습니까?")) return;

	// 	localStorage.removeItem(STORAGE_KEY);
	// 	location.reload();
	// }
	// 창고이동 후 저장
	function saveTransfer() {
		alert("저장 기능은 개발 중입니다.");
	}
	// 행추가
	function addTransferRow() {
		const newRow = {
			prodCode: "",
			prodName: "",
			sendWh: "",
			sendBeforeQty: 0,
			sendAfterQty: 0,
			sendMoveQty: 0,
			toBeforeQty: 0,
			recvBeforeQty: 0,
			recvAfterQty: 0
		};

		// 그리드에 새 행 추가
		whmGridOptions.api.applyTransaction({ add: [newRow] });
		// 행추가 후 저장
		updateData = [];
		whmGridOptions.api.forEachNode(node => updateData.push(node.data));
		localStorage.setItem(STORAGE_KEY, JSON.stringify(updateData));
	}
	// 행삭제
	function deleteSelectedRows() {
		const selectedRows = whmGridOptions.api.getSelectedRows();
		if (selectedRows.length === 0) {
			alert("삭제할 행을 선택하세요.");
			return;
		}
		whmGridOptions.api.applyTransaction({ remove: selectedRows });
		// 삭제 후 저장
		updateData = [];
		whmGridOptions.api.forEachNode(node => updateData.push(node.data));
		localStorage.setItem(STORAGE_KEY, JSON.stringify(updateData));
	}
	// 페이지 이동
	document.getElementById('warehouse').addEventListener('change', function () {
		if (this.checked) {
			window.location.href = '/purchs/wh';
		}
	});

	
</script>