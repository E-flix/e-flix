<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{common/layouts/default}">
<head>
  <meta charset="UTF-8" />
  <title>견적서 입력</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .bg-cell { background-color: #f5f5f5; }
    .detail-table thead th { background-color: #f5f5f5; }
    .detail-table input { height: 28px; }
  </style>
</head>
<div layout:fragment="content" class="container-fluid px-3 py-2">
  <!-- 헤더 -->
  <div class="d-flex justify-content-between align-items-center border p-2 rounded bg-light mb-2">
    <h6 class="mb-0">견적서 입력</h6>
  </div>
  <!-- 버튼 그룹 -->
  <div class="text-end mb-2">
    <button class="btn btn-primary btn-sm me-1">등록</button>
    <button class="btn btn-light btn-sm border btn-reset me-1">초기화</button>
    <button type="button"  class="btn btn-light btn-sm border btn-list">목록</button>
  </div>
  <!-- 탭 -->
  <ul class="nav nav-tabs mb-3">
    <li class="nav-item"><a class="nav-link active" href="#">내역</a></li>
  </ul>
  <!-- 입력 테이블 -->
  <div class="table-responsive mb-3">
    <table class="table table-bordered align-middle">
      <colgroup>
        <col style="width:15%;">
        <col style="width:35%;">
        <col style="width:15%;">
        <col style="width:35%;">
      </colgroup>
      <tbody>
        <tr>
          <th class="bg-cell" style="width:140px;">견적서 번호</th>
          <td><input type="text" class="form-control form-control-sm" th:value="${nextQuotationNo}" readonly></td>
          <th class="bg-cell" style="width:140px;">일자</th>
          <td style="width:280px;"><input type="date" class="form-control form-control-sm" th:value="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}"></td>
        </tr>
        <tr>
          <th class="bg-cell">거래처</th>
          <td><input id="customer" type="text" class="form-control form-control-sm" placeholder="거래처 코드/이름" readonly></td>
          <th class="bg-cell">대표명</th>
          <td><input id="repName" type="text" class="form-control form-control-sm" readonly></td>
        </tr>
        <tr>
          <th class="bg-cell">발신담당자</th>
          <td><input id="sender" type="text"  class="form-control form-control-sm"></td>
          <th class="bg-cell">전화번호</th>
          <td><input id="phone" type="text" class="form-control form-control-sm" readonly></td>
        </tr>
        <tr>
          <th class="bg-cell">할인율(%)</th>
          <td>
            <div class="input-group input-group-sm">
              <input id="discountRate" type="number" step="0.01" min="0" max="100" class="form-control" value="0">
              <span class="input-group-text">%</span>
            </div>
          </td>
          <th class="bg-cell">유효기간</th>
          <td><input id="validUntil" type="date" class="form-control form-control-sm"></td>
        </tr>
        <tr>
          <th class="bg-cell">납기예정일</th>
          <td><input id="deliveryDate" type="date" class="form-control form-control-sm"></td>
          <th class="bg-cell">첨부</th>
          <td colspan="3">
            <a href="#" id="attachmentLink">개인파일함</a>
            <input type="file" id="attachmentInput" multiple class="d-none">
            <div id="attachmentList" class="small text-body mt-1"></div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <!-- 행추가/삭제 버튼 -->
  <div class="mb-3">
    <button class="btn btn-secondary btn-sm add-row me-1">행 추가</button>
    <button class="btn btn-danger btn-sm delete-row">행 삭제</button>
  </div>
  <!-- 상세 테이블 -->
  <div class="table-responsive">
    <table class="table table-bordered text-center detail-table" style="min-width:1200px;">
      <thead>
        <tr>
          <th style="width:35px;"><input type="checkbox"></th>
          <th style="width:35px;">▶</th>
          <th>품목코드</th>
          <th>품목명</th>
          <th>규격</th>
          <th style="width:70px;">수량</th>
          <th style="width:90px;">단가</th>
          <th style="width:110px;">공급가액</th>
          <th style="width:90px;">부가세</th>
          <th>비고</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><input type="checkbox"></td>
          <td>▶</td>
          <td><input class="form-control form-control-sm item-code" readonly></td>
          <td><input class="form-control form-control-sm item-name" readonly></td>
          <td><input class="form-control form-control-sm item-spec" readonly></td>
          <td><input type="number" class="form-control form-control-sm item-qty" min="1" value="1"></td>
          <td><input class="form-control form-control-sm item-price" readonly></td>
          <td><input class="form-control form-control-sm item-amount" readonly></td>
          <td><input class="form-control form-control-sm item-tax" readonly></td>
          <td><input class="form-control form-control-sm item-remark"></td>
        </tr>
      </tbody>
      <tfoot class="table-light fw-bold">
        <tr>
          <td colspan="7" class="text-end">총&nbsp;합계</td>
          <td class="tot-final" colspan="2">0</td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </div>


<!-- 품목 모달 -->
<div class="modal fade" id="itemModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">품목 목록</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-0">
        <table class="table table-bordered m-0 modal-table">
          <thead class="table-light">
            <tr><th>선택</th><th>코드</th><th>이름</th><th>규격</th><th>단위</th><th>단가</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- 거래처 모달 -->
<div class="modal fade" id="customerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">거래처 조회</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="input-group mb-2">
          <input id="customerSearch" type="text" class="form-control" placeholder="거래처명 검색">
          <button id="btnCustomerSearch" class="btn btn-outline-secondary">검색</button>
        </div>
        <table class="table table-bordered modal-table mb-0">
          <thead class="table-light">
            <tr><th>선택</th><th>코드</th><th>이름</th><th>대표명</th><th>전화번호</th><th>할인율(%)</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
  document.addEventListener('DOMContentLoaded', () => {
  const VAT_RATE = 10;  
  /* ───── 공용 요소 ───── */
  const detailTbody   = document.querySelector('.detail-table tbody');
  const discountInput = document.getElementById('discountRate');

  /* ───── 개인파일함 ───── */
  const attachLink  = document.getElementById('attachmentLink');
  const attachInput = document.getElementById('attachmentInput');
  const attachList  = document.getElementById('attachmentList');
  attachLink?.addEventListener('click', e => { e.preventDefault(); attachInput.click(); });
  attachInput?.addEventListener('change', () => {
    attachList.innerHTML = '';
    Array.from(attachInput.files).forEach(f => {
      const d = document.createElement('div'); d.textContent = f.name; attachList.appendChild(d);
    });
  });

  /* ───── 모달 ───── */
  const itemModal     = new bootstrap.Modal(document.getElementById('itemModal'));
  const customerModal = new bootstrap.Modal(document.getElementById('customerModal'));

  /* ───── 거래처 선택 로직 ───── */
  const custInput  = document.getElementById('customer');
  const repInput   = document.getElementById('repName');
  const phoneInput = document.getElementById('phone');
  const custTbody  = document.querySelector('#customerModal tbody');
  document.getElementById('btnCustomerSearch').addEventListener('click', () =>
    loadCustomers(document.getElementById('customerSearch').value.trim())
  );
  custInput.addEventListener('click', () => { loadCustomers(); customerModal.show(); });

  function loadCustomers(name = '') {
    let url = '/bsn/customer/list';
    if (name) url += `?customerName=${encodeURIComponent(name)}`;
    fetch(url).then(r => r.json()).then(list => {
      custTbody.innerHTML = '';
      list.forEach(c => {
        const tr = document.createElement('tr');
        tr.innerHTML =
          `<td><button class="btn btn-sm btn-outline-primary selCust">선택</button></td>
          <td>${c.customerCd}</td><td>${c.customerNm}</td>
          <td>${c.representativeNm}</td><td>${c.phoneNo}</td><td>${c.discountRate}</td>`;
        custTbody.appendChild(tr);
      });
      custTbody.querySelectorAll('.selCust').forEach(btn => btn.addEventListener('click', () => {
        const r = btn.closest('tr');
        // 폼 채우기
        custInput.value     = `${r.children[1].textContent} / ${r.children[2].textContent}`;
        repInput.value      = r.children[3].textContent;
        phoneInput.value    = r.children[4].textContent;
        discountInput.value = r.children[5].textContent;
        customerModal.hide();
        recalcAllRows(); updateTotals();
      }));
    });
  }

  /* ───── 품목 선택 로직 ───── */
  let currentRow;
  detailTbody.addEventListener('click', e => {
    if (e.target.classList.contains('item-code')) {
      currentRow = e.target.closest('tr');
      loadItems(); itemModal.show();
    }
  });

  function loadItems() {
    fetch('/bsn/item/list').then(r => r.json()).then(list => {
      const body = document.querySelector('#itemModal tbody'); body.innerHTML = '';
      list.forEach(it => {
        const tr = document.createElement('tr'); tr.dataset.taxRate = it.taxRate;
        tr.innerHTML =
          `<td><button class="btn btn-sm btn-outline-primary selItem">선택</button></td>
          <td>${it.itemCode}</td><td>${it.itemName}</td><td>${it.spec}</td>
          <td>${it.unit}</td><td>${it.salePrice}</td>`;
        body.appendChild(tr);
      });
      body.querySelectorAll('.selItem').forEach(btn => btn.addEventListener('click', () => {
        const r = btn.closest('tr');
        currentRow.dataset.taxRate                 = r.dataset.taxRate;   // ★ taxRate 복사
        currentRow.querySelector('.item-code').value  = r.children[1].textContent;
        currentRow.querySelector('.item-name').value  = r.children[2].textContent;
        currentRow.querySelector('.item-spec').value  = r.children[3].textContent;
        currentRow.querySelector('.item-price').value = r.children[5].textContent;
        recalcRow(currentRow); 
        updateTotals();
        itemModal.hide();
      }));
    });
  }

  /* ───── 할인율·수량 변경 처리 ───── */
  discountInput.addEventListener('input', () => { recalcAllRows(); updateTotals(); });

  detailTbody.addEventListener('input', e => {
    if (e.target.classList.contains('item-qty')) {
      recalcRow(e.target.closest('tr')); 
      updateTotals();
    }
  });

  /* ───── 행 추가/삭제 ───── */
  document.querySelector('.add-row').addEventListener('click', () => {
    const tr = detailTbody.querySelector('tr').cloneNode(true);
    // tr.dataset.taxRate = 0;                         // 기본 부가세율
    tr.querySelectorAll('input').forEach(i => {
      if (i.type === 'checkbox') i.checked = false;
      else if (i.classList.contains('item-qty')) i.value = 1;
      else i.value = '';
    });
    detailTbody.appendChild(tr);
  });
  document.querySelector('.delete-row').addEventListener('click', () => {
    detailTbody.querySelectorAll('input[type="checkbox"]:checked')
      .forEach(cb => cb.closest('tr').remove());
    updateTotals();
  });

  /* ───── 계산 유틸 ───── */
  function recalcRow(row) {
    const price   = +row.querySelector('.item-price').value || 0;
    const qty     = +row.querySelector('.item-qty').value   || 0;
    const discPct = +discountInput.value                    || 0;

    const raw  = price * qty;
    const amt  = Math.round(raw * (1 - discPct / 100));
    const tax  = Math.round(amt  * (VAT_RATE / 100));  // 부가세 고정 10%

    row.querySelector('.item-amount').value = amt;
    row.querySelector('.item-tax').value    = tax;
  }

  function recalcAllRows() {
    detailTbody.querySelectorAll('tr').forEach(recalcRow);
  }

  function updateTotals() {
    let totQty = 0, totAmt = 0, totTax = 0;
    detailTbody.querySelectorAll('tr').forEach(r => {
      totAmt += +r.querySelector('.item-amount').value|| 0;
      totTax += +r.querySelector('.item-tax').value   || 0;
    });
    const fianl = totAmt + totTax;
    document.querySelector('.tot-final').textContent = fianl.toLocaleString();
  }

  /* ───── 초기화·목록 버튼 ───── */
  document.querySelector('.btn-reset').addEventListener('click', () => {
    document.querySelectorAll('input:not([readonly])').forEach(el => el.value = '');
    detailTbody.querySelectorAll('.item-qty').forEach(i => i.value = 1);
    recalcAllRows(); updateTotals();
  });
  document.querySelector('.btn-list').addEventListener('click', () => {
    window.location.href = '/bsn/qot_list';
  });
});
</script>
</div>