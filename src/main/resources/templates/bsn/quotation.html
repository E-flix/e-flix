<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{common/layouts/default}">

<head>
  <meta charset="UTF-8" />
  <title>견적서 입력</title>
  <style>
    .bg-cell {
      background-color: #f5f5f5;
    }

    .detail-table thead th {
      background-color: #f5f5f5;
    }

    .detail-table input {
      height: 28px;
    }
  </style>
</head>
<div layout:fragment="content" class="container-fluid px-3 py-2">
  <!-- ① form 시작 -->
  <!-- ──────────────── form 시작 ──────────────── -->
  <form th:action="@{/bsn/createQuotation}"
        th:object="${quotation}"
        method="post"
        enctype="multipart/form-data">

    <!-- 헤더 -->
    <div class="d-flex justify-content-between align-items-center border p-2 rounded bg-light mb-2">
      <h6 class="mb-0">견적서 입력</h6>
    </div>

    <!-- 버튼 -->
    <div class="text-end mb-2">
      <button type="submit" class="btn btn-primary btn-sm me-1">등록</button>
      <button type="button" class="btn btn-light btn-sm border btn-reset me-1">초기화</button>
      <button type="button" class="btn btn-light btn-sm border btn-list">목록</button>
    </div>

    <!-- 탭 -->
    <ul class="nav nav-tabs mb-3">
      <li class="nav-item"><a class="nav-link active" href="#">내역</a></li>
    </ul>

    <!-- ───── 기본 정보 테이블 ───── -->
    <div class="table-responsive mb-3">
      <table class="table table-bordered align-middle">
        <colgroup>
          <col style="width:15%"><col style="width:35%">
          <col style="width:15%"><col style="width:35%">
        </colgroup>
        <tbody>
          <tr>
            <th class="bg-cell">견적서 번호</th>
            <td><input type="text" th:field="*{quotationNo}"
                       class="form-control form-control-sm" readonly></td>
            <th class="bg-cell">일자</th>
            <td><input type="date" th:field="*{quotationDt}"
                       class="form-control form-control-sm"></td>
          </tr>
          <tr>
            <th class="bg-cell">거래처</th>
            <td>
              <input id="customerDisplay" type="text"
                     class="form-control form-control-sm"
                     placeholder="거래처 코드/이름" readonly>
              <input type="hidden" th:field="*{customerCd}"  id="customerCd">
              <input type="hidden" th:field="*{customerName}">
            </td>
            <th class="bg-cell">대표명</th>
            <td><input type="text" th:field="*{representativeNm}"
                       id="repName" class="form-control form-control-sm" readonly></td>
          </tr>
          <tr>
            <th class="bg-cell">발신담당자</th>
            <td><input type="text" th:field="*{sender}"
                       id="sender" class="form-control form-control-sm"></td>
            <th class="bg-cell">전화번호</th>
            <td><input type="text" th:field="*{phone}"
                       id="phone" class="form-control form-control-sm" readonly></td>
          </tr>
          <tr>
            <th class="bg-cell">할인율(%)</th>
            <td>
              <div class="input-group input-group-sm">
                <input type="number" th:field="*{discountRate}"
                       id="discountRate" step="0.01" min="0" max="100"
                       class="form-control">
                <span class="input-group-text">%</span>
              </div>
            </td>
            <th class="bg-cell">유효기간</th>
            <td><input type="date" th:field="*{validPeriod}"
                       id="validUntil" class="form-control form-control-sm"></td>
          </tr>
          <tr>
            <th class="bg-cell">납기예정일</th>
            <td><input type="date" th:field="*{expectedDeliveryDt}"
                       id="deliveryDate" class="form-control form-control-sm"></td>
            <th class="bg-cell">첨부</th>
            <td>
              <a href="#" id="attachmentLink">개인파일함</a>
              <input type="file" name="attachFile"
                     id="attachmentInput" multiple class="d-none">
              <div id="attachmentList" class="small text-body mt-1"></div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- 행 추가·삭제 -->
    <div class="mb-3">
      <button type="button" class="btn btn-secondary btn-sm add-row me-1">행 추가</button>
      <button type="button" class="btn btn-danger btn-sm delete-row">행 삭제</button>
    </div>

    <!-- ───── 상세 테이블 ───── -->
    <div class="table-responsive">
      <table class="table table-bordered text-center detail-table" style="min-width:1200px;">
        <thead>
          <tr>
            <th><input type="checkbox"></th>
            <th>▶</th>
            <th>품목코드</th>
            <th>품목명</th>
            <th>규격</th>
            <th>수량</th>
            <th>단가</th>
            <th>공급가액</th>
            <th>부가세</th>
            <th>비고</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="d,idx : *{details}">
            <td><input type="checkbox"></td>
            <td>▶</td>

            <td><input th:field="*{details[__${idx.index}__].itemCode}"
                      class="form-control form-control-sm item-code" readonly></td>
            <td><input th:field="*{details[__${idx.index}__].itemName}"
                      class="form-control form-control-sm item-name" readonly></td>
            <td><input th:field="*{details[__${idx.index}__].spec}"
                      class="form-control form-control-sm item-spec" readonly></td>

            <td><input type="number"
                      th:field="*{details[__${idx.index}__].qty}"
                      class="form-control form-control-sm item-qty" min="1" value="1"></td>
            <td><input th:field="*{details[__${idx.index}__].unitPrice}"
                      class="form-control form-control-sm item-price" readonly></td>

            <!-- 공급가액 -->
            <td><input th:field="*{details[__${idx.index}__].supplyAmount}"
                      class="form-control form-control-sm item-supply" readonly></td>

            <!-- 부가세 -->
            <td>
              <input th:field="*{details[__${idx.index}__].taxAmount}"
                    class="form-control form-control-sm item-tax" readonly>
              <input type="hidden"
                    th:field="*{details[__${idx.index}__].totalMoney}"
                    class="item-total">
            </td>
            <td><input th:field="*{details[__${idx.index}__].remarks}"
                      class="form-control form-control-sm item-remark"></td>
          </tr>
        </tbody>
        <tfoot class="table-light fw-bold">
          <tr>
            <!-- 앞쪽 7칸 묶음 -->
            <td colspan="7" class="text-end">&nbsp;계산</td>
        
            <!-- 공급가액 합계 -->
            <td id="sum-supply">0</td>
        
            <!-- 부가세 합계 -->
            <td id="sum-tax">0</td>
        
            <!-- ★ 총합계 셀: “총 합계: 값” 형태 -->
            <td id="sum-total">총&nbsp;합계:&nbsp;0</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </form>


  <!-- 거래처 모달 -->
  <div class="modal fade" id="customerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">거래처 조회</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="input-group mb-2">
            <input id="customerSearch" type="text" class="form-control" placeholder="거래처명 검색">
            <button id="btnCustomerSearch" class="btn btn-outline-secondary">검색</button>
          </div>
          <table class="table table-bordered modal-table mb-0">
            <thead class="table-light">
              <tr>
                <th>선택</th>
                <th>코드</th>
                <th>이름</th>
                <th>대표명</th>
                <th>전화번호</th>
                <th>할인율(%)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- 품목 모달 -->
  <div class="modal fade" id="itemModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">품목 목록</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
          <table class="table table-bordered m-0 modal-table">
            <thead class="table-light">
              <tr>
                <th>선택</th>
                <th>코드</th>
                <th>이름</th>
                <th>규격</th>
                <th>단위</th>
                <th>단가</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', () => {
      const VAT_RATE = 10;

      /* ───── 공용 요소 ───── */
      const tbody = document.querySelector('.detail-table tbody');
      const discountInput = document.getElementById('discountRate');

      /* ───── 모달 ───── */
      const itemModal = new bootstrap.Modal(document.getElementById('itemModal'));
      const customerModal = new bootstrap.Modal(document.getElementById('customerModal'));

      /* ───── 계산 유틸 ───── */
      function recalcRow(row) {
        const price = +row.querySelector('.item-price').value || 0;
        const qty = +row.querySelector('.item-qty').value || 0;
        const discPct = +discountInput.value || 0;

        const supply = Math.round(price * qty * (1 - discPct / 100)); // 공급가액
        const tax = Math.round(supply * (VAT_RATE / 100)); // 부가세
        const total = supply + tax; // 총합계

        row.querySelector('.item-supply').value = supply;
        row.querySelector('.item-tax').value = tax;
        row.querySelector('.item-total').value = total; // hidden
      }

      function recalcAllRows() {
        tbody.querySelectorAll('tr').forEach(recalcRow);
      }

      function updateTotals() {
        let sumSupply = 0, sumTax = 0;
        tbody.querySelectorAll('tr').forEach(r => {
          sumSupply += +r.querySelector('.item-supply').value || 0;
          sumTax    += +r.querySelector('.item-tax').value    || 0;
        });
        const sumTotal = sumSupply + sumTax;
      
        document.getElementById('sum-supply').textContent = sumSupply.toLocaleString();
        document.getElementById('sum-tax').textContent    = sumTax.toLocaleString();
        /* 총합계 셀은 ‘총 합계: ’ 레이블 포함 */
        document.getElementById('sum-total').textContent  =
            `총 합계: ${sumTotal.toLocaleString()}`;
      }

      /* ───── 할인율 / 수량 변경 ───── */
      discountInput.addEventListener('input', () => {
        recalcAllRows();
        updateTotals();
      });
      tbody.addEventListener('input', e => {
        if (e.target.classList.contains('item-qty')) {
          recalcRow(e.target.closest('tr'));
          updateTotals();
        }
      });

      /* ───── 행 추가 / 삭제 ───── */
      document.querySelector('.add-row').addEventListener('click', () => {
        const tr = tbody.querySelector('tr').cloneNode(true);
        tr.querySelectorAll('input').forEach(i => {
          if (i.type === 'checkbox') i.checked = false;
          else if (i.classList.contains('item-qty')) i.value = 1;
          else i.value = '';
        });
        tbody.appendChild(tr);
      });

      document.querySelector('.delete-row').addEventListener('click', () => {
        tbody.querySelectorAll('input[type="checkbox"]:checked')
          .forEach(cb => cb.closest('tr').remove());
        updateTotals();
      });

      /* ───── 거래처 모달 로직 ───── */
      const custInput = document.getElementById('customerDisplay');
      const hiddenCd = document.getElementById('customerCd');
      const hiddenName = document.querySelector('input[name="customerName"]');
      const repInput = document.getElementById('repName');
      const phoneInput = document.getElementById('phone');
      const custTbody = document.querySelector('#customerModal tbody');

      document.getElementById('btnCustomerSearch')
        .addEventListener('click', () =>
          loadCustomers(document.getElementById('customerSearch').value.trim())
        );
      custInput.addEventListener('click', () => {
        loadCustomers();
        customerModal.show();
      });

      function loadCustomers(name = '') {
        let url = '/bsn/customer/list';
        if (name) url += `?customerName=${encodeURIComponent(name)}`;
        fetch(url).then(r => r.json()).then(list => {
          custTbody.innerHTML = '';
          list.forEach(c => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
          <td><button class="btn btn-sm btn-outline-primary selCust">선택</button></td>
          <td>${c.customerCd}</td>
          <td>${c.customerNm}</td>
          <td>${c.representativeNm}</td>
          <td>${c.phoneNo}</td>
          <td>${c.discountRate}</td>`;
            custTbody.appendChild(tr);
          });
          custTbody.querySelectorAll('.selCust').forEach(btn => btn.addEventListener('click', () => {
            const r = btn.closest('tr');
            custInput.value = `${r.children[1].textContent} / ${r.children[2].textContent}`;
            hiddenCd.value = r.children[1].textContent;
            hiddenName.value = r.children[2].textContent;
            repInput.value = r.children[3].textContent;
            phoneInput.value = r.children[4].textContent;
            discountInput.value = r.children[5].textContent;
            customerModal.hide();
            recalcAllRows();
            updateTotals();
          }));
        });
      }

      /* ───── 품목 모달 로직 ───── */
      let currentRow;
      tbody.addEventListener('click', e => {
        if (e.target.classList.contains('item-code')) {
          currentRow = e.target.closest('tr');
          loadItems();
          itemModal.show();
        }
      });

      function loadItems() {
        fetch('/bsn/item/list').then(r => r.json()).then(list => {
          const body = document.querySelector('#itemModal tbody');
          body.innerHTML = '';
          list.forEach(it => {
            const tr = document.createElement('tr');
            tr.dataset.taxRate = it.taxRate;
            tr.innerHTML = `
          <td><button class="btn btn-sm btn-outline-primary selItem">선택</button></td>
          <td>${it.itemCode}</td><td>${it.itemName}</td><td>${it.spec}</td>
          <td>${it.unit}</td><td>${it.salePrice}</td>`;
            body.appendChild(tr);
          });
          body.querySelectorAll('.selItem').forEach(btn => btn.addEventListener('click', () => {
            const r = btn.closest('tr');
            currentRow.dataset.taxRate = r.dataset.taxRate;
            currentRow.querySelector('.item-code').value = r.children[1].textContent;
            currentRow.querySelector('.item-name').value = r.children[2].textContent;
            currentRow.querySelector('.item-spec').value = r.children[3].textContent;
            currentRow.querySelector('.item-price').value = r.children[5].textContent;
            recalcRow(currentRow);
            updateTotals();
            itemModal.hide();
          }));
        });
      }

      /* ───── 초기 합계 계산 ───── */
      recalcAllRows();
      updateTotals();

      /* ───── 초기화 / 목록 버튼 ───── */
      document.querySelector('.btn-reset').addEventListener('click', () => {
        document.querySelectorAll('input:not([readonly])').forEach(el => el.value = '');
        tbody.querySelectorAll('.item-qty').forEach(i => i.value = 1);
        recalcAllRows();
        updateTotals();
      });
      document.querySelector('.btn-list').addEventListener('click', () => {
        window.location.href = '/bsn/qot_list';
      });
    });
  </script>
</div>