<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{common/layouts/default}">
<head>
  <meta charset="UTF-8" />
  <title>견적서 입력</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .bg-cell { background-color: #f5f5f5; }
    .detail-table thead th { background-color: #f5f5f5; }
    .detail-table input { height: 28px; }
  </style>
</head>
<div layout:fragment="content" class="container-fluid px-3 py-2">
  <!-- 헤더 -->
  <div class="d-flex justify-content-between align-items-center border p-2 rounded bg-light mb-2">
    <h6 class="mb-0">견적서 입력</h6>
  </div>
  <!-- 버튼 그룹 -->
  <div class="text-end mb-2">
    <button class="btn btn-primary btn-sm me-1">등록</button>
    <button class="btn btn-light btn-sm border btn-reset me-1">초기화</button>
    <button type="button"  class="btn btn-light btn-sm border btn-list">목록</button>
  </div>
  <!-- 탭 -->
  <ul class="nav nav-tabs mb-3">
    <li class="nav-item"><a class="nav-link active" href="#">내역</a></li>
  </ul>
  <!-- 입력 테이블 -->
  <div class="table-responsive mb-3">
    <table class="table table-bordered align-middle">
      <colgroup>
        <col style="width:15%;">
        <col style="width:35%;">
        <col style="width:15%;">
        <col style="width:35%;">
      </colgroup>
      <tbody>
        <tr>
          <th class="bg-cell" style="width:140px;">견적서 번호</th>
          <td><input type="text" class="form-control form-control-sm" th:value="${nextQuotationNo}" readonly></td>
          <th class="bg-cell" style="width:140px;">일자</th>
          <td style="width:280px;"><input type="date" class="form-control form-control-sm" th:value="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}"></td>
        </tr>
        <tr>
          <th class="bg-cell">거래처</th>
          <td><input id="customer" type="text" class="form-control form-control-sm" placeholder="거래처 코드/이름" readonly></td>
          <th class="bg-cell">담당자</th>
          <td><input id="salesRep" type="text" class="form-control form-control-sm" readonly></td>
        </tr>
        <tr>
          <th class="bg-cell">거래유형</th>
          <td>
            <select id="tradeType" class="form-select form-select-sm">
              <option value="vat">부가세율 적용</option>
              <option value="no-vat">부가세율 미적용</option>
            </select>
          </td>
          <th class="bg-cell">전화번호</th>
          <td><input id="phone" type="text" class="form-control form-control-sm" readonly></td>
        </tr>
        <tr>
          <th class="bg-cell">할인율(%)</th>
          <td><input id="discountRate" type="number" step="0.01" min="0" max="100" class="form-control form-control-sm" value="0.00"></td>
          <th class="bg-cell">유효기간</th>
          <td><input id="validUntil" type="date" class="form-control form-control-sm"></td>
        </tr>
        <tr>
          <th class="bg-cell">납기예정일</th>
          <td><input id="deliveryDate" type="date" class="form-control form-control-sm"></td>
          <th class="bg-cell">첨부</th>
          <td colspan="3">
            <a href="#" id="attachmentLink">개인파일함</a>
            <input type="file" id="attachmentInput" multiple class="d-none">
            <div id="attachmentList" class="small text-body mt-1"></div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <!-- 행추가/삭제 버튼 -->
  <div class="mb-3">
    <button class="btn btn-secondary btn-sm add-row me-1">행 추가</button>
    <button class="btn btn-danger btn-sm delete-row">행 삭제</button>
  </div>
  <!-- 상세 테이블 -->
  <div class="table-responsive">
    <table class="table table-bordered text-center detail-table" style="min-width:1200px;">
      <thead>
        <tr>
          <th style="width:35px;"><input type="checkbox"></th>
          <th style="width:35px;">▶</th>
          <th>품목코드</th>
          <th>품목명</th>
          <th>규격</th>
          <th style="width:70px;">수량</th>
          <th style="width:90px;">단가</th>
          <th style="width:110px;">공급가액</th>
          <th style="width:90px;">부가세</th>
          <th>비고</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><input type="checkbox"></td>
          <td>▶</td>
          <td><input class="form-control form-control-sm item-code" readonly></td>
          <td><input class="form-control form-control-sm item-name" readonly></td>
          <td><input class="form-control form-control-sm item-spec" readonly></td>
          <td><input type="number" class="form-control form-control-sm item-qty" min="1" value="1"></td>
          <td><input class="form-control form-control-sm item-price" readonly></td>
          <td><input class="form-control form-control-sm item-amount" readonly></td>
          <td><input class="form-control form-control-sm item-tax" readonly></td>
          <td><input class="form-control form-control-sm item-remark"></td>
        </tr>
      </tbody>
      <tfoot class="table-light fw-bold">
        <tr>
          <td colspan="5" class="text-end">합계</td>
          <td class="tot-qty">0</td>
          <td></td>
          <td class="tot-amount">0</td>
          <td class="tot-tax">0</td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </div>


<!-- 품목 모달 -->
<div class="modal fade" id="itemModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">품목 목록</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-0">
        <table class="table table-bordered m-0 modal-table">
          <thead class="table-light">
            <tr><th>선택</th><th>코드</th><th>이름</th><th>규격</th><th>단위</th><th>단가</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- 거래처 모달 -->
<div class="modal fade" id="customerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">거래처 조회</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="input-group mb-2">
          <input id="customerSearch" type="text" class="form-control" placeholder="거래처명 검색">
          <button id="btnCustomerSearch" class="btn btn-outline-secondary">검색</button>
        </div>
        <table class="table table-bordered modal-table mb-0">
          <thead class="table-light">
            <tr><th>선택</th><th>코드</th><th>이름</th><th>담당자</th><th>전화번호</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
  document.addEventListener('DOMContentLoaded', () => {
    // 개인파일함 기능
  const attachLink = document.getElementById('attachmentLink');
  const attachInput = document.getElementById('attachmentInput');
  const attachList = document.getElementById('attachmentList');
  if (attachLink && attachInput && attachList) {
    attachLink.addEventListener('click', e => {
      e.preventDefault();
      attachInput.click();
    });
    attachInput.addEventListener('change', () => {
      attachList.innerHTML = '';
      Array.from(attachInput.files).forEach(file => {
        const div = document.createElement('div');
        div.textContent = file.name;
        attachList.appendChild(div);
      });
    });
  }

    // 모달 인스턴스 생성
    const itemModalEl = document.getElementById('itemModal');
    const itemModal = new bootstrap.Modal(itemModalEl);
    const customerModalEl = document.getElementById('customerModal');
    const customerModal = new bootstrap.Modal(customerModalEl);

    // 거래처 모달
    const custInput = document.getElementById('customer');
    const custTbody = document.querySelector('#customerModal tbody');
    const btnCustSearch = document.getElementById('btnCustomerSearch');

    custInput.addEventListener('click', () => {
      loadCustomers();
      customerModal.show();
    });
    btnCustSearch.addEventListener('click', () => loadCustomers(document.getElementById('customerSearch').value.trim()));

    function loadCustomers(name) {
      let url = '/bsn/customer/list';
      if (name) url += `?customerName=${encodeURIComponent(name)}`;
      fetch(url)
        .then(res => res.json())
        .then(data => {
          custTbody.innerHTML = '';
          data.forEach(c => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><button class="btn btn-sm btn-outline-primary selCust">선택</button></td>
                            <td>${c.customerCd}</td>
                            <td>${c.customerNm}</td>
                            <td>${c.salesEmpCd}</td>
                            <td>${c.phoneNo}</td>`;
            custTbody.appendChild(tr);
          });
          custTbody.querySelectorAll('.selCust').forEach(btn => btn.addEventListener('click', function() {
            const r = this.closest('tr');
            selectCustomer({ code: r.children[1].textContent, name: r.children[2].textContent, emp: r.children[3].textContent, phone: r.children[4].textContent });
            customerModal.hide();
          }));
        });
    }
    function selectCustomer(c) {
      custInput.value = `${c.code} / ${c.name}`;
      document.getElementById('salesRep').value = c.emp;
      document.getElementById('phone').value = c.phone;
    }

    // 품목 모달
    const detailTbody = document.querySelector('.detail-table tbody');
    let currentRow;
    detailTbody.addEventListener('click', e => {
      if (e.target.classList.contains('item-code')) {
        currentRow = e.target.closest('tr');
        loadItems();
        itemModal.show();
      }
    });
    function loadItems() {
      fetch('/bsn/item/list')
        .then(res => res.json())
        .then(data => {
          const body = document.querySelector('#itemModal tbody');
          body.innerHTML = '';
          data.forEach(item => {
            const tr = document.createElement('tr');
            tr.dataset.taxRate = item.taxRate;
            tr.innerHTML = `<td><button class="btn btn-sm btn-outline-primary selItem">선택</button></td>
                            <td>${item.itemCode}</td>
                            <td>${item.itemName}</td>
                            <td>${item.spec}</td>
                            <td>${item.unit}</td>
                            <td>${item.salePrice}</td>`;
            body.appendChild(tr);
          });
          body.querySelectorAll('.selItem').forEach(btn => btn.addEventListener('click', function() {
            const r = this.closest('tr');
            selectItem({
              itemCode: r.children[1].textContent,
              itemName: r.children[2].textContent,
              spec: r.children[3].textContent,
              unit: r.children[4].textContent,
              salePrice: +r.children[5].textContent,
              taxRate: +r.dataset.taxRate
            });
            itemModal.hide();
          }));
        });
    }
    // 행 추가 버튼
  document.querySelector('.add-row').addEventListener('click', () => {
    const tr = detailTbody.querySelector('tr').cloneNode(true);
    tr.querySelectorAll('input').forEach(i => {
      if (i.type === 'checkbox') i.checked = false;
      else if (i.classList.contains('item-qty')) i.value = 1;
      else i.value = '';
    });
    detailTbody.appendChild(tr);
  });

  // 행 삭제 버튼
  document.querySelector('.delete-row').addEventListener('click', () => {
    detailTbody.querySelectorAll('input[type="checkbox"]:checked')
      .forEach(cb => cb.closest('tr').remove());
    updateTotals();
  });

  // 초기화 버튼
  document.querySelector('.btn-reset').addEventListener('click', () => {
    document.querySelectorAll('input:not([readonly]), select').forEach(el => el.value = (el.type==='number'? '': ''));
    document.querySelectorAll('.item-qty').forEach(i => i.value = 1);
    updateTotals();
  });
  // 목록 버튼
  document.querySelector('.btn-list').addEventListener('click', () => {
    window.location.href = '/bsn/qot_list';
  });


    function selectItem(item) {
      currentRow.querySelector('.item-code').value = item.itemCode;
      currentRow.querySelector('.item-name').value = item.itemName;
      currentRow.querySelector('.item-spec').value = item.spec;
      currentRow.querySelector('.item-price').value = item.salePrice;
      const qty = +currentRow.querySelector('.item-qty').value || 1;
      const amt = qty * item.salePrice;
      const tax = Math.round(amt * (item.taxRate / 100));
      currentRow.querySelector('.item-amount').value = amt;
      currentRow.querySelector('.item-tax').value = tax;
      updateTotals();
    }
    function updateTotals() {
      let totQty = 0, totAmt = 0, totTax = 0;
      document.querySelectorAll('.detail-table tbody tr').forEach(r => {
        totQty += +r.querySelector('.item-qty').value || 0;
        totAmt += +r.querySelector('.item-amount').value || 0;
        totTax += +r.querySelector('.item-tax').value || 0;
      });
      document.querySelector('.tot-qty').textContent = totQty;
      document.querySelector('.tot-amount').textContent = totAmt.toLocaleString();
      document.querySelector('.tot-tax').textContent = totTax.toLocaleString();
    }
    // 수량 변경 이벤트
    detailTbody.addEventListener('input', e => {
      if (e.target.classList.contains('item-qty')) {
        const row = e.target.closest('tr');
        const price = +row.querySelector('.item-price').value || 0;
        const qty = +e.target.value || 0;
        const amt = price * qty;
        const tax = Math.round(amt * (+row.dataset.taxRate / 100));
        row.querySelector('.item-amount').value = amt;
        row.querySelector('.item-tax').value = tax;
        updateTotals();
      }
    });
  });
</script>
</div>