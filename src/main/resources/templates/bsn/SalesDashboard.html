<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
      layout:decorate="~{common/layouts/default}">
<head>
  <title>ì˜ì—… ëŒ€ì‹œë³´ë“œ</title>
</head>
<div layout:fragment="content">
  <div class="container" id="dashboard-main">
    
    <!-- ë©”ì¸ íƒ€ì´í‹€ -->
    <div class="page-header bg-gradient-primary text-white rounded mb-4 p-4">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2 class="mb-1">ğŸ“Š ì˜ì—… ëŒ€ì‹œë³´ë“œ</h2>
          <p class="mb-0 opacity-75">ì‹¤ì‹œê°„ ì˜ì—… ì„±ê³¼ ë° ë¹„ì¦ˆë‹ˆìŠ¤ ì¸ì‚¬ì´íŠ¸</p>
        </div>
        <button class="btn btn-light btn-lg" onclick="refreshAllData()">
          <i class="fas fa-sync-alt"></i> ìƒˆë¡œê³ ì¹¨
        </button>
      </div>
    </div>

    <!-- KPI ì¹´ë“œ ì˜ì—­ -->
    <div class="row mb-4">
      <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
          <div class="card-body">
            <div class="row no-gutters align-items-center">
              <div class="col mr-2">
                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                  ì˜¤ëŠ˜ ë§¤ì¶œ
                </div>
                <div class="h5 mb-0 font-weight-bold text-gray-800" id="todaySales">
                  <div class="spinner-border spinner-border-sm"></div>
                </div>
              </div>
              <div class="col-auto">
                <i class="fas fa-calendar fa-2x text-gray-300"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
          <div class="card-body">
            <div class="row no-gutters align-items-center">
              <div class="col mr-2">
                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                  ì´ë²ˆë‹¬ ë§¤ì¶œ
                </div>
                <div class="h5 mb-0 font-weight-bold text-gray-800" id="monthSales">
                  <div class="spinner-border spinner-border-sm"></div>
                </div>
              </div>
              <div class="col-auto">
                <i class="fas fa-dollar-sign fa-2x text-gray-300"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
          <div class="card-body">
            <div class="row no-gutters align-items-center">
              <div class="col mr-2">
                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                  ê²¬ì â†’ìˆ˜ì£¼ ì „í™˜ìœ¨
                </div>
                <div class="row no-gutters align-items-center">
                  <div class="col-auto">
                    <div class="h5 mb-0 mr-3 font-weight-bold text-gray-800" id="conversionRate">
                      <div class="spinner-border spinner-border-sm"></div>
                    </div>
                  </div>
                  <div class="col">
                    <div class="progress progress-sm mr-2">
                      <div class="progress-bar bg-info" id="conversionProgress" role="progressbar" style="width: 50%"></div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-auto">
                <i class="fas fa-clipboard-list fa-2x text-gray-300"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
          <div class="card-body">
            <div class="row no-gutters align-items-center">
              <div class="col mr-2">
                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                  ëŒ€ê¸°ì¤‘ ì£¼ë¬¸
                </div>
                <div class="h5 mb-0 font-weight-bold text-gray-800" id="pendingOrders">
                  <div class="spinner-border spinner-border-sm"></div>
                </div>
              </div>
              <div class="col-auto">
                <i class="fas fa-comments fa-2x text-gray-300"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ì°¨íŠ¸ ì˜ì—­ -->
    <div class="row">
      <!-- ì›”ë³„ ë§¤ì¶œ ì¶”ì´ -->
      <div class="col-xl-8 col-lg-7">
        <div class="card shadow mb-4">
          <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">ì›”ë³„ ë§¤ì¶œ ì¶”ì´</h6>
            <div class="dropdown no-arrow">
              <select class="form-select form-select-sm" id="salesChartPeriod" onchange="updateSalesChart()">
                <option value="6">ìµœê·¼ 6ê°œì›”</option>
                <option value="12" selected>ìµœê·¼ 12ê°œì›”</option>
                <option value="24">ìµœê·¼ 24ê°œì›”</option>
              </select>
            </div>
          </div>
          <div class="card-body">
            <div class="chart-area">
              <canvas id="salesChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- ì˜ì—… íŒŒì´í”„ë¼ì¸ -->
      <div class="col-xl-4 col-lg-5">
        <div class="card shadow mb-4">
          <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">ì˜ì—… íŒŒì´í”„ë¼ì¸</h6>
          </div>
          <div class="card-body">
            <div class="chart-pie pt-4 pb-2">
              <canvas id="pipelineChart"></canvas>
            </div>
            <div class="mt-4 text-center small">
              <span class="mr-2">
                <i class="fas fa-circle text-primary"></i> ê²¬ì 
              </span>
              <span class="mr-2">
                <i class="fas fa-circle text-success"></i> ì£¼ë¬¸
              </span>
              <span class="mr-2">
                <i class="fas fa-circle text-info"></i> ì¶œê³ 
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- í…Œì´ë¸” ì˜ì—­ -->
    <div class="row">
      <!-- TOP ê³ ê° -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow mb-4">
          <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">ğŸ† TOP ê³ ê° (ë§¤ì¶œ ê¸°ì¤€)</h6>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-bordered" id="topCustomersTable">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>ê³ ê°ëª…</th>
                    <th>ë§¤ì¶œì•¡</th>
                    <th>ì£¼ë¬¸ìˆ˜</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td colspan="4" class="text-center">
                      <div class="spinner-border"></div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- ì£¼ì˜ì‚¬í•­ ì•Œë¦¼ -->
      <div class="col-lg-6 mb-4">
        <div class="card shadow mb-4">
          <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">ğŸš¨ ì£¼ì˜ì‚¬í•­</h6>
          </div>
          <div class="card-body">
            <div id="alertsContainer">
              <div class="text-center">
                <div class="spinner-border"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ë¹ ë¥¸ ì•¡ì…˜ ë²„íŠ¼ë“¤ -->
    <div class="row">
      <div class="col-12">
        <div class="card shadow mb-4">
          <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">ğŸš€ ë¹ ë¥¸ ì‹¤í–‰</h6>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-md-3 mb-3">
                <button class="btn btn-primary btn-lg btn-block" onclick="location.href='/bsn/qot'">
                  <i class="fas fa-file-alt fa-2x mb-2"></i><br>
                  ìƒˆ ê²¬ì ì„œ
                </button>
              </div>
              <div class="col-md-3 mb-3">
                <button class="btn btn-success btn-lg btn-block" onclick="location.href='/bsn/order_management'">
                  <i class="fas fa-shopping-cart fa-2x mb-2"></i><br>
                  ì£¼ë¬¸ì„œ ê´€ë¦¬
                </button>
              </div>
              <div class="col-md-3 mb-3">
                <button class="btn btn-info btn-lg btn-block" onclick="location.href='/bsn/soutbound'">
                  <i class="fas fa-shipping-fast fa-2x mb-2"></i><br>
                  ì¶œê³  ê´€ë¦¬
                </button>
              </div>
              <div class="col-md-3 mb-3">
                <button class="btn btn-warning btn-lg btn-block" onclick="exportSalesReport()">
                  <i class="fas fa-download fa-2x mb-2"></i><br>
                  ë§¤ì¶œ ë¦¬í¬íŠ¸
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script>
    let salesChart, pipelineChart;
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    $(document).ready(function() {
      initCharts();
      loadDashboardData();
      
      // 5ë¶„ë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
      setInterval(loadDashboardData, 5 * 60 * 1000);
    });
    
    // ì°¨íŠ¸ ì´ˆê¸°í™”
    function initCharts() {
      // ë§¤ì¶œ ì¶”ì´ ì°¨íŠ¸
      const salesCtx = document.getElementById('salesChart').getContext('2d');
      salesChart = new Chart(salesCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'ë§¤ì¶œì•¡ (ë§Œì›)',
            data: [],
            borderColor: '#4e73df',
            backgroundColor: 'rgba(78, 115, 223, 0.1)',
            borderWidth: 2,
            fill: true
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return value.toLocaleString() + 'ë§Œì›';
                }
              }
            }
          }
        }
      });
      
      // íŒŒì´í”„ë¼ì¸ ì°¨íŠ¸
      const pipelineCtx = document.getElementById('pipelineChart').getContext('2d');
      pipelineChart = new Chart(pipelineCtx, {
        type: 'doughnut',
        data: {
          labels: ['ê²¬ì ', 'ì£¼ë¬¸', 'ì¶œê³ '],
          datasets: [{
            data: [0, 0, 0],
            backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }
    
    // ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ
    async function loadDashboardData() {
      try {
        // KPI ë°ì´í„° ë¡œë“œ
        const overviewData = await fetchJSON('/bsn/dashboard/overview');
        updateKPICards(overviewData);
        
        // ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ
        const salesData = await fetchJSON('/bsn/dashboard/monthly-sales?months=12');
        updateSalesChart(salesData.chartData);
        
        const pipelineData = await fetchJSON('/bsn/dashboard/pipeline');
        updatePipelineChart(pipelineData);
        
        // í…Œì´ë¸” ë°ì´í„° ë¡œë“œ
        updateTopCustomersTable(overviewData.topCustomers);
        
        const alertsData = await fetchJSON('/bsn/dashboard/alerts');
        updateAlertsDisplay(alertsData);
        
      } catch (error) {
        console.error('ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        Swal.fire('ì˜¤ë¥˜', 'ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }
    
    // KPI ì¹´ë“œ ì—…ë°ì´íŠ¸
    function updateKPICards(data) {
      $('#todaySales').text(formatCurrency(data.todaySales || 0));
      $('#monthSales').text(formatCurrency(data.monthSales || 0));
      
      const conversionRate = data.conversionRate || 0;
      $('#conversionRate').text(conversionRate + '%');
      $('#conversionProgress').css('width', conversionRate + '%');
      
      $('#pendingOrders').text((data.pendingOrders || 0) + 'ê±´');
    }
    
    // ë§¤ì¶œ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
    function updateSalesChart(chartData) {
      if (!chartData || chartData.length === 0) return;
      
      const labels = chartData.map(item => item.month);
      const data = chartData.map(item => Math.round(item.amount / 10000)); // ë§Œì› ë‹¨ìœ„
      
      salesChart.data.labels = labels;
      salesChart.data.datasets[0].data = data;
      salesChart.update();
    }
    
    // íŒŒì´í”„ë¼ì¸ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
    function updatePipelineChart(data) {
      const chartData = [
        data.quotationStage || 0,
        data.orderStage || 0,
        data.outboundStage || 0
      ];
      
      pipelineChart.data.datasets[0].data = chartData;
      pipelineChart.update();
    }
    
    // TOP ê³ ê° í…Œì´ë¸” ì—…ë°ì´íŠ¸
    function updateTopCustomersTable(customers) {
      const tbody = $('#topCustomersTable tbody');
      tbody.empty();
      
      if (!customers || customers.length === 0) {
        tbody.append('<tr><td colspan="4" class="text-center">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>');
        return;
      }
      
      customers.slice(0, 5).forEach((customer, index) => {
        tbody.append(`
          <tr>
            <td>${index + 1}</td>
            <td>${customer.customerName}</td>
            <td>${formatCurrency(customer.totalRevenue)}</td>
            <td>${customer.orderCount}ê±´</td>
          </tr>
        `);
      });
    }
    
    // ì•Œë¦¼ í‘œì‹œ ì—…ë°ì´íŠ¸
    function updateAlertsDisplay(alertsData) {
      const container = $('#alertsContainer');
      container.empty();
      
      let hasAlerts = false;
      
      // ì—¬ì‹  ìœ„í—˜ ê³ ê°
      if (alertsData.creditRiskCustomers && alertsData.creditRiskCustomers.length > 0) {
        hasAlerts = true;
        container.append(`
          <div class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>ì—¬ì‹  ìœ„í—˜:</strong> ${alertsData.creditRiskCustomers.length}ê°œ ê±°ë˜ì²˜
          </div>
        `);
      }
      
      // ì§€ì—° ì¶œê³ 
      if (alertsData.delayedOrders && alertsData.delayedOrders.length > 0) {
        hasAlerts = true;
        container.append(`
          <div class="alert alert-warning" role="alert">
            <i class="fas fa-clock"></i>
            <strong>ì§€ì—° ì¶œê³ :</strong> ${alertsData.delayedOrders.length}ê±´ ì£¼ë¬¸
          </div>
        `);
      }
      
      // ê²¬ì  ë§Œë£Œ ì„ë°•
      if (alertsData.expiringQuotations && alertsData.expiringQuotations.length > 0) {
        hasAlerts = true;
        container.append(`
          <div class="alert alert-info" role="alert">
            <i class="fas fa-calendar-times"></i>
            <strong>ê²¬ì  ë§Œë£Œ ì„ë°•:</strong> ${alertsData.expiringQuotations.length}ê±´
          </div>
        `);
      }
      
      if (!hasAlerts) {
        container.append(`
          <div class="alert alert-success" role="alert">
            <i class="fas fa-check-circle"></i>
            í˜„ì¬ ì£¼ì˜ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.
          </div>
        `);
      }
    }
    
    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    async function fetchJSON(url) {
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return await response.json();
    }
    
    function formatCurrency(amount) {
      if (amount >= 100000000) {
        return Math.round(amount / 100000000) + 'ì–µì›';
      } else if (amount >= 10000) {
        return Math.round(amount / 10000) + 'ë§Œì›';
      } else {
        return Math.round(amount).toLocaleString() + 'ì›';
      }
    }
    
    function refreshAllData() {
      Swal.fire({
        title: 'ìƒˆë¡œê³ ì¹¨ ì¤‘...',
        text: 'ìµœì‹  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤.',
        allowOutsideClick: false,
        showConfirmButton: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });
      
      loadDashboardData().then(() => {
        Swal.fire('ì™„ë£Œ!', 'ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
      });
    }
    
    function exportSalesReport() {
      Swal.fire({
        title: 'ë§¤ì¶œ ë¦¬í¬íŠ¸ ìƒì„±',
        text: 'ì–´ë–¤ ê¸°ê°„ì˜ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'ì´ë²ˆë‹¬',
        cancelButtonText: 'ì „ì²´ ê¸°ê°„',
        reverseButtons: true
      }).then((result) => {
        if (result.isConfirmed) {
          generateReport('month');
        } else if (result.dismiss === Swal.DismissReason.cancel) {
          generateReport('all');
        }
      });
    }
    
    function generateReport(period) {
      // TODO: ë¦¬í¬íŠ¸ ìƒì„± API í˜¸ì¶œ
      Swal.fire('ì¤€ë¹„ì¤‘', 'ë¦¬í¬íŠ¸ ìƒì„± ê¸°ëŠ¥ì„ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤.', 'info');
    }
    
    console.log('ì˜ì—… ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™” ì™„ë£Œ');
  </script>
</div>
</html>