<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/default}">
<head>
  <meta charset="UTF-8" />
  <title>출하 의뢰서 관리</title>
  <style>
    .section-box { padding: 15px; border: 1px solid #e3e6f0; border-radius: 8px; background-color: #ffffff; margin-bottom: 15px; box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15); }
    .section-box h6 { margin-bottom: 12px; color: #4e73df; font-weight: 700; border-bottom: 2px solid #4e73df; padding-bottom: 8px; }
    .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; text-align: center; min-width: 60px; display: inline-block; color: white; }
    .status-대기 { background-color: #ffc107; color: #212529; }
    .status-출고완료 { background-color: #28a745; }
    .new-row-highlight { background-color: #fff3cd !important; }
    .header-grid, .detail-grid { height: 350px; width: 100%; }
    .status-stats { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
    .status-card { flex: 1; min-width: 120px; padding: 10px 15px; border-radius: 8px; text-align: center; color: white; font-weight: 600; }
    .status-card h6 { margin: 0; font-size: 0.9rem; opacity: 0.9; border: none; }
    .status-card .count { font-size: 1.5rem; font-weight: bold; margin: 5px 0; }
  </style>
</head>
<div layout:fragment="content" class="container-fluid px-3 py-2">

    <!-- 페이지 헤더 -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h4 class="mb-0"><i class="fas fa-shipping-fast mr-2"></i>출하 의뢰서 관리</h4>
        <small class="text-muted">출하 의뢰서 조회, 생성 및 삭제</small>
      </div>
      <div>
        <button type="button" class="btn btn-success btn-sm me-1" id="btnSave" style="display: none;"><i class="fas fa-save"></i> 저장</button>
        <button type="button" class="btn btn-secondary btn-sm me-1" id="btnCancel" style="display: none;"><i class="fas fa-times"></i> 취소</button>
        <button type="button" class="btn btn-info btn-sm me-1" id="btnStatusStats"><i class="fas fa-chart-pie"></i> 상태 현황</button>
        <button type="button" class="btn btn-warning btn-sm me-1" id="btnCreateFromOrder" disabled><i class="fas fa-plus-circle"></i> 주문서에서 생성</button>
        <button type="button" class="btn btn-primary btn-sm me-1" id="btnNew"><i class="fas fa-plus"></i> 신규</button>
        <button type="button" class="btn btn-danger btn-sm me-1" id="btnDelete"><i class="fas fa-trash"></i> 삭제</button>
      </div>
    </div>

    <!-- 출고 헤더 그리드 -->
    <div class="section-box">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6><i class="fas fa-list mr-2"></i>출하 의뢰서 목록</h6>
        <button id="btnRefresh" class="btn btn-secondary btn-sm me-1"><i class="fas fa-sync"></i> 새로고침</button>
      </div>
      <div id="headerGrid" class="ag-theme-alpine header-grid"></div>
    </div>

    <!-- 출고 디테일 그리드 -->
    <div class="section-box">
      <h6><i class="fas fa-boxes mr-2"></i>출하 의뢰서 상세 <span id="selectedOutboundNo" class="text-muted fs-6"></span></h6>
      <div id="detailGrid" class="ag-theme-alpine detail-grid"></div>
    </div>

    <!-- 주문서 선택 모달 -->
    <div class="modal fade" id="orderSelectModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="fas fa-clipboard-list mr-2"></i>주문서 선택</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="table-responsive">
              <table class="table table-bordered table-hover">
                <thead class="table-light">
                  <tr><th>선택</th><th>주문번호</th><th>주문일자</th><th>거래처명</th><th>작성자</th></tr>
                </thead>
                <tbody id="orderListBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', () => {
      let headerGridApi, detailGridApi;
      let orderSelectModal;
      let isNewMode = false;
      let newOutboundData = null;
      let selectedHeaderData = null;

      const formatDate = (dateStr) => dateStr ? new Date(dateStr).toLocaleDateString('ko-KR') : '';

      const headerColumnDefs = [
          { headerName: '출하번호', field: 'outboundNo', width: 150, pinned: 'left' },
          { headerName: '작성일자', field: 'writeDt', width: 120, valueFormatter: p => formatDate(p.value) },
          { headerName: '거래처명', field: 'customerName', flex: 1, minWidth: 150 },
          { headerName: '대표명', field: 'representativeNm', width: 120 },
          { headerName: '주문일자', field: 'orderDt', width: 120, valueFormatter: p => formatDate(p.value) },
          { headerName: '출고일자', field: 'outboundDt', width: 120, valueFormatter: p => formatDate(p.value) },
          { headerName: '납기일자', field: 'deliveryDueDate', width: 120, valueFormatter: p => formatDate(p.value) },
          { headerName: '전체 상태', field: 'overallStatus', width: 110,
            cellRenderer: p => `<span class="status-badge status-${p.value}">${p.value}</span>`
          },
          { headerName: '비고', field: 'remarks', flex: 1, minWidth: 150 }
      ];

      const detailColumnDefs = [
          { headerName: '거래처명', field: 'customerName', width: 150 },
          { headerName: '주문일자', field: 'orderDt', width: 120, valueFormatter: p => formatDate(p.value) },
          { headerName: '품목코드', field: 'itemCode', width: 120 },
          { headerName: '품목명', field: 'itemName', flex: 1, minWidth: 200 },
          { headerName: '규격', field: 'standard', width: 150 },
          { headerName: '수량', field: 'qty', width: 100, type: 'numericColumn' },
          { headerName: '출고일', field: 'outboundDt', width: 120, valueFormatter: p => formatDate(p.value) },
          { headerName: '납기일', field: 'deliveryDueDate', width: 120, valueFormatter: p => formatDate(p.value) },
          { headerName: '출고상태', field: 'outboundStatus', width: 110,
            cellRenderer: p => `<span class="status-badge status-${p.value}">${p.value}</span>`
          },
          { headerName: '비고', field: 'remarks', flex: 1, minWidth: 150 }
      ];

      const commonGridOptions = {
          defaultColDef: { sortable: true, filter: true, resizable: true },
          localeText: { noRowsToShow: '데이터가 없습니다.' }
      };

      const headerGridOptions = {
          ...commonGridOptions,
          columnDefs: headerColumnDefs,
          rowSelection: 'single',
          getRowClass: params => (params.data.isNew ? 'new-row-highlight' : ''),
          getRowNodeId: data => data.outboundNo,
          onGridReady: (params) => {
              headerGridApi = params.api;
              loadOutboundList();
          },
          onRowClicked: (event) => {
              if (isNewMode && event.data.isNew) return;
              selectedHeaderData = event.data;
              loadOutboundDetails(event.data.outboundNo);
          }
      };
      agGrid.createGrid(document.getElementById('headerGrid'), headerGridOptions);

      const detailGridOptions = {
          ...commonGridOptions,
          columnDefs: detailColumnDefs,
          onGridReady: (params) => { detailGridApi = params.api; }
      };
      agGrid.createGrid(document.getElementById('detailGrid'), detailGridOptions);
      
      orderSelectModal = new bootstrap.Modal(document.getElementById('orderSelectModal'));

      const fetchData = async (url, options = {}) => {
        try {
          const response = await fetch(url, options);
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: response.statusText }));
            throw new Error(errorData.message || `HTTP ${response.status}`);
          }
          return response.json();
        } catch (error) {
          console.error(`데이터 로드 실패: ${url}`, error);
          Swal.fire('오류', `데이터를 불러오는 데 실패했습니다: ${error.message}`, 'error');
          throw error;
        }
      };

      const loadOutboundList = () => {
        if (!headerGridApi) return;
        fetchData('/bsn/soutbounds').then(data => {
            headerGridApi.setGridOption('rowData', data || []);
        });
      };

      const loadOutboundDetails = (outboundNo) => {
        if (!detailGridApi) return;
        document.getElementById('selectedOutboundNo').textContent = `(${outboundNo})`;
        fetchData(`/bsn/soutbounds/${outboundNo}/details`).then(details => {
            if (detailGridApi && selectedHeaderData) {
                const enrichedDetails = details.map(detail => ({
                    ...detail,
                    customerName: selectedHeaderData.customerName,
                    representativeNm: selectedHeaderData.representativeNm,
                    orderDt: selectedHeaderData.orderDt,
                    outboundDt: selectedHeaderData.outboundDt,
                    deliveryDueDate: selectedHeaderData.deliveryDueDate
                }));
                detailGridApi.setGridOption('rowData', enrichedDetails || []);
            }
        });
      };

      const loadOrderList = () => {
        const tbody = document.getElementById('orderListBody');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center"><div class="spinner-border spinner-border-sm"></div></td></tr>';
        fetchData('/bsn/orders').then(orders => {
          tbody.innerHTML = '';
          if (orders && orders.length > 0) {
            orders.forEach(order => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td><button class="btn btn-sm btn-success select-order" data-order-no="${order.orderNo}">선택</button></td>
                <td>${order.orderNo}</td>
                <td>${formatDate(order.orderDt)}</td>
                <td>${order.customerNm || ''}</td>
                <td>${order.orderWriter || ''}</td>
              `;
              tbody.appendChild(tr);
            });
          } else {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">출고 가능한 주문서가 없습니다.</td></tr>';
          }
        });
      };

      // 신규 등록 흐름
      document.getElementById('btnNew').addEventListener('click', () => {
          if (isNewMode) return;
          isNewMode = true;
          toggleButtons(true);
          newOutboundData = {
              outboundNo: '신규 등록 중...', isNew: true, writeDt: new Date(),
              outboundDt: new Date(), overallStatus: '대기'
          };
          headerGridApi.applyTransaction({ add: [newOutboundData], addIndex: 0 });
          headerGridApi.ensureIndexVisible(0);
          detailGridApi.setGridOption('rowData', []);
          document.getElementById('selectedOutboundNo').textContent = '(신규)';
      });

      document.getElementById('btnCreateFromOrder').addEventListener('click', () => {
          if (!isNewMode) return;
          loadOrderList();
          orderSelectModal.show();
      });

      // ★★★ 변경: 주문서 선택 시 데이터 채우기 로직 수정 ★★★
      document.getElementById('orderListBody').addEventListener('click', e => {
          if (e.target.classList.contains('select-order')) {
              const orderNo = e.target.dataset.orderNo;
              fetchData(`/bsn/orders/${orderNo}`).then(orderData => {
                  if (orderData) {
                      const nodeToUpdate = headerGridApi.getRowNode('신규 등록 중...');
                      if (nodeToUpdate) {
                          // 1. 신규 행의 데이터를 업데이트
                          newOutboundData = {
                              ...newOutboundData,
                              customerCd: orderData.customerCd,
                              customerName: orderData.customerNm,
                              representativeNm: orderData.representativeNm,
                              orderDt: orderData.orderDt,
                              deliveryDueDate: orderData.expectedDeliveryDt || new Date()
                          };
                          nodeToUpdate.setData(newOutboundData);
                          selectedHeaderData = newOutboundData; // 상세 그리드용 데이터도 업데이트
                      }
                      
                      // 2. 상세 그리드 데이터를 직접 구성하고 설정
                      const enrichedDetails = orderData.details.map(d => ({
                          ...d,
                          outboundStatus: '대기',
                          customerName: orderData.customerNm,
                          orderDt: orderData.orderDt,
                          deliveryDueDate: newOutboundData.deliveryDueDate
                      }));
                      detailGridApi.setGridOption('rowData', enrichedDetails);

                      orderSelectModal.hide();
                  }
              });
          }
      });

      document.getElementById('btnSave').addEventListener('click', () => {
          if (!isNewMode) return;
          const headerNode = headerGridApi.getRowNode('신규 등록 중...');
          if (!headerNode || !headerNode.data.customerName) {
              return Swal.fire('오류', '주문서를 선택하여 데이터를 채워주세요.', 'error');
          }
          const detailRows = [];
          detailGridApi.forEachNode(node => detailRows.push(node.data));
          if (detailRows.length === 0) {
              return Swal.fire('오류', '상세 품목이 없습니다.', 'error');
          }
          const finalDto = { ...headerNode.data, details: detailRows };
          delete finalDto.isNew;
          delete finalDto.outboundNo;

          fetchData('/bsn/soutbounds', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(finalDto)
          }).then(data => {
              if (data.success) {
                  Swal.fire('성공', `출하 의뢰서 "${data.outboundNo}"가 생성되었습니다.`, 'success');
                  resetNewMode();
                  loadOutboundList();
              }
          });
      });

      document.getElementById('btnCancel').addEventListener('click', () => resetNewMode());

      function toggleButtons(isNew) {
          document.getElementById('btnSave').style.display = isNew ? 'inline-block' : 'none';
          document.getElementById('btnCancel').style.display = isNew ? 'inline-block' : 'none';
          document.getElementById('btnNew').style.display = isNew ? 'none' : 'inline-block';
          document.getElementById('btnDelete').style.display = isNew ? 'none' : 'inline-block';
          document.getElementById('btnCreateFromOrder').disabled = !isNew;
      }

      function resetNewMode() {
          isNewMode = false;
          const tempRow = headerGridApi.getRowNode('신규 등록 중...');
          if (tempRow) {
              headerGridApi.applyTransaction({ remove: [tempRow.data] });
          }
          detailGridApi.setGridOption('rowData', []);
          document.getElementById('selectedOutboundNo').textContent = '';
          toggleButtons(false);
      }
      
      const deleteSelectedOutbounds = () => {
        if (!headerGridApi) return;
        const selectedRows = headerGridApi.getSelectedRows();
        if (selectedRows.length === 0) {
            return Swal.fire('알림', '삭제할 출하 의뢰서를 선택해주세요.', 'warning');
        }
        Swal.fire({
            title: `${selectedRows.length}건 삭제 확인`,
            text: "선택한 항목을 정말 삭제하시겠습니까?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#e74a3b',
            confirmButtonText: '삭제',
            cancelButtonText: '취소'
        }).then(result => {
            if (result.isConfirmed) {
                const deletePromises = selectedRows.map(row => 
                    fetchData(`/bsn/soutbounds/${row.outboundNo}`, { method: 'DELETE' })
                );
                Promise.all(deletePromises)
                    .then(() => {
                        Swal.fire('삭제 완료', `${selectedRows.length}건의 출하 의뢰서가 삭제되었습니다.`, 'success');
                        loadOutboundList();
                        if(detailGridApi) detailGridApi.setGridOption('rowData', []);
                        document.getElementById('selectedOutboundNo').textContent = '';
                    })
                    .catch(e => console.error(e));
            }
        });
      };

      document.getElementById('btnRefresh').addEventListener('click', loadOutboundList);
      document.getElementById('btnStatusStats').addEventListener('click', () => { /* ... */ });
      document.getElementById('btnDelete').addEventListener('click', deleteSelectedOutbounds);
    });
    </script>
</div>
</html>
