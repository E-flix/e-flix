<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/default}">
<head>
  <meta charset="UTF-8" />
  <title>출하 의뢰서 관리</title>
  <style>
    .section-box {
      padding: 15px;
      border: 1px solid #e3e6f0;
      border-radius: 8px;
      background-color: #ffffff;
      margin-bottom: 15px;
      box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    }

    .section-box h6 {
      margin-bottom: 12px;
      color: #5a5c69;
      font-weight: 700;
      border-bottom: 2px solid #4e73df;
      padding-bottom: 8px;
    }

    .btn-create { background-color: #1cc88a; border-color: #1cc88a; color: white; }
    .btn-create:hover { background-color: #17a673; border-color: #17a673; }

    .btn-edit { background-color: #36b9cc; border-color: #36b9cc; color: white; }
    .btn-edit:hover { background-color: #2c9faf; border-color: #2c9faf; }

    .btn-delete { background-color: #e74a3b; border-color: #e74a3b; color: white; }
    .btn-delete:hover { background-color: #c0392b; border-color: #c0392b; }

    .header-grid { height: 350px; width: 100%; }
    .detail-grid { height: 350px; width: 100%; }

    /* AG-Grid 커스텀 스타일 */
    .ag-theme-alpine {
      --ag-background-color: #ffffff;
      --ag-header-background-color: #f8f9fc;
      --ag-header-foreground-color: #5a5c69;
      --ag-border-color: #e3e6f0;
      --ag-row-hover-color: #f8f9fc;
      --ag-selected-row-background-color: #eaecf4;
      --ag-font-size: 14px;
      width: 100% !important;
    }

    /* 수치 컬럼 우측 정렬 */
    .ag-theme-alpine .text-end {
      text-align: right !important;
    }

    /* 체크박스 컬럼 중앙 정렬 */
    .ag-theme-alpine .ag-checkbox-input-wrapper {
      text-align: center;
    }

    /* 그리드 헤더 스타일 개선 */
    .ag-theme-alpine .ag-header-cell {
      font-weight: 600;
      border-right: 1px solid #e3e6f0;
    }

    /* 출고상태 배지 스타일 */
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-align: center;
      min-width: 60px;
      display: inline-block;
    }

    .status-대기 { background-color: #ffc107; color: #212529; }
    .status-준비중 { background-color: #17a2b8; color: white; }
    .status-출고중 { background-color: #007bff; color: white; }
    .status-출고완료 { background-color: #28a745; color: white; }
    .status-취소 { background-color: #dc3545; color: white; }

    /* 출고 상태 통계 카드 */
    .status-stats {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .status-card {
      flex: 1;
      min-width: 120px;
      padding: 10px 15px;
      border-radius: 8px;
      text-align: center;
      color: white;
      font-weight: 600;
    }

    .status-card h6 {
      margin: 0;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .status-card .count {
      font-size: 1.5rem;
      font-weight: bold;
      margin: 5px 0;
    }
  </style>
</head>
<div layout:fragment="content" class="container-fluid px-3 py-2">

    <!-- 페이지 헤더 -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h4 class="mb-0">
          <i class="fas fa-shipping-fast mr-2"></i>출하 의뢰서 관리
        </h4>
        <small class="text-muted">출하 의뢰서 등록, 수정, 삭제 및 출고 상태 관리</small>
      </div>
      <div>
        <button type="button" class="btn btn-info btn-sm me-1" id="btnStatusStats">
          <i class="fas fa-chart-pie"></i> 상태 현황
        </button>
        <button type="button" class="btn btn-warning btn-sm me-1" id="btnCreateFromOrder">
          <i class="fas fa-plus-circle"></i> 주문서에서 생성
        </button>
        <button type="button" class="btn btn-create btn-sm me-1" id="btnNew">
          <i class="fas fa-plus"></i> 신규
        </button>
        <button type="button" class="btn btn-edit btn-sm me-1" id="btnEdit">
          <i class="fas fa-edit"></i> 수정
        </button>
        <button type="button" class="btn btn-delete btn-sm me-1" id="btnDelete">
          <i class="fas fa-trash"></i> 삭제
        </button>
        <button type="button" class="btn btn-secondary btn-sm" id="btnDebug">
          <i class="fas fa-bug"></i> 디버그
        </button>
      </div>
    </div>

    <!-- 출고 상태 통계 (접을 수 있는 카드) -->
    <div class="section-box" id="statusStatsSection" style="display: none;">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6><i class="fas fa-chart-bar mr-2"></i>출고 상태 현황</h6>
        <button class="btn btn-sm btn-outline-secondary" id="btnCloseStats">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="status-stats" id="statusStatsContainer">
        <!-- 동적으로 생성됨 -->
      </div>
    </div>

    <!-- 출고 헤더 그리드 -->
    <div class="section-box">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6><i class="fas fa-list mr-2"></i>출하 의뢰서 목록</h6>
        <div>
          <button id="btnRefresh" class="btn btn-secondary btn-sm me-1">
            <i class="fas fa-sync"></i> 새로고침
          </button>
          <button id="btnExportExcel" class="btn btn-success btn-sm">
            <i class="fas fa-file-excel"></i> 엑셀
          </button>
        </div>
      </div>
      <div id="headerGrid" class="ag-theme-alpine header-grid"></div>
    </div>

    <!-- 출고 디테일 그리드 -->
    <div class="section-box">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6>
          <i class="fas fa-boxes mr-2"></i>출하 의뢰서 상세
          <span id="selectedOutboundNo" class="text-muted fs-6"></span>
        </h6>
        <div>
          <button id="btnAddDetailRow" class="btn btn-info btn-sm me-1">
            <i class="fas fa-plus"></i> 행 추가
          </button>
          <button id="btnDeleteDetailRow" class="btn btn-warning btn-sm me-1">
            <i class="fas fa-minus"></i> 행 삭제
          </button>
          <button id="btnBulkStatusUpdate" class="btn btn-primary btn-sm">
            <i class="fas fa-edit"></i> 상태 일괄변경
          </button>
        </div>
      </div>
      <div id="detailGrid" class="ag-theme-alpine detail-grid"></div>
    </div>

    <!-- 주문서 선택 모달 -->
    <div class="modal fade" id="orderSelectModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-clipboard-list mr-2"></i>주문서 선택
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="table-responsive">
              <table class="table table-bordered">
                <thead class="table-light">
                  <tr>
                    <th>선택</th>
                    <th>주문번호</th>
                    <th>주문일자</th>
                    <th>거래처명</th>
                    <th>합계금액</th>
                    <th>출고상태</th>
                  </tr>
                </thead>
                <tbody id="orderListBody">
                  <tr>
                    <td colspan="6" class="text-center">
                      <div class="spinner-border spinner-border-sm"></div>
                      주문서를 불러오는 중...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 상태 일괄변경 모달 -->
    <div class="modal fade" id="bulkStatusModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-edit mr-2"></i>출고 상태 일괄변경
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">변경할 상태를 선택하세요:</label>
              <select class="form-select" id="bulkStatusSelect">
                <option value="">상태를 선택하세요</option>
                <option value="대기">🟡 대기</option>
                <option value="준비중">🔵 준비중</option>
                <option value="출고중">🟢 출고중</option>
                <option value="출고완료">✅ 출고완료</option>
                <option value="취소">❌ 취소</option>
              </select>
            </div>
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i>
              선택된 <span id="selectedItemCount">0</span>개 항목의 상태가 변경됩니다.
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times"></i> 취소
            </button>
            <button type="button" class="btn btn-primary" id="btnConfirmBulkStatus">
              <i class="fas fa-save"></i> 적용
            </button>
          </div>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
    /*<![CDATA[*/
    $(document).ready(function() {
      console.log('✅ 출하 의뢰서 관리 페이지 로드 시작');
      
      // ===== 전역 변수 =====
      let headerGridApi, detailGridApi;
      let selectedOutboundData = null;

      // ===== AG-Grid 안전한 데이터 설정 함수 =====
      function safeSetRowData(gridApi, data) {
        if (!gridApi) {
          console.warn('⚠️ Grid API가 없습니다.');
          return;
        }
        
        try {
          if (typeof gridApi.setRowData === 'function') {
            gridApi.setRowData(data);
          } else if (typeof gridApi.setGridOption === 'function') {
            gridApi.setGridOption('rowData', data);
          } else {
            console.error('❌ 지원되는 데이터 설정 방법을 찾을 수 없습니다.');
          }
        } catch (error) {
          console.error('❌ 데이터 설정 실패:', error);
        }
      }

      // ===== AG-Grid 초기화 =====
      function initializeGrids() {
        try {
          console.log('🚀 AG-Grid 초기화 시작');
          
          if (typeof agGrid === 'undefined') {
            throw new Error('AG-Grid가 로드되지 않았습니다.');
          }

          // 헤더 그리드 설정
          const headerColumnDefs = [
            { 
              headerName: '선택', 
              checkboxSelection: true, 
              headerCheckboxSelection: true, 
              width: 60,
              maxWidth: 60,
              pinned: 'left',
              suppressSizeToFit: true
            },
            { 
              headerName: '출하번호', 
              field: 'outboundNo', 
              width: 150,
              minWidth: 130,
              cellClass: 'font-weight-bold text-primary',
              pinned: 'left'
            },
            { 
              headerName: '작성일자', 
              field: 'writeDt', 
              width: 110,
              minWidth: 100
            },
            { 
              headerName: '거래처코드', 
              field: 'customerCd', 
              width: 120,
              minWidth: 100
            },
            { 
              headerName: '거래처명', 
              field: 'customerName', 
              flex: 2,
              minWidth: 150
            },
            { 
              headerName: '대표명', 
              field: 'representativeNm', 
              flex: 1,
              minWidth: 100
            },
            {
              headerName: '주문일자', 
              field: 'orderDt', 
              width: 110,
              minWidth: 100,
              valueFormatter: params => {
                if (!params.value) return '';
                try {
                  return new Date(params.value).toLocaleDateString('ko-KR');
                } catch (e) {
                  return params.value;
                }
              }
            },
            {
              headerName: '출고일자', 
              field: 'outboundDt', 
              width: 110,
              minWidth: 100,
              valueFormatter: params => {
                if (!params.value) return '';
                try {
                  return new Date(params.value).toLocaleDateString('ko-KR');
                } catch (e) {
                  return params.value;
                }
              }
            },
            { 
              headerName: '통화', 
              field: 'money', 
              width: 80,
              maxWidth: 80
            },
            { 
              headerName: '비고', 
              field: 'remarks', 
              flex: 1,
              minWidth: 120
            }
          ];

          const headerGridOptions = {
            columnDefs: headerColumnDefs,
            rowData: [],
            defaultColDef: {
              sortable: true,
              filter: true,
              resizable: true,
              flex: 0
            },
            rowSelection: 'single',
            onRowClicked: onHeaderRowClicked,
            onGridReady: function(params) {
              console.log('📊 헤더 그리드 준비 완료');
              headerGridApi = params.api;
              setTimeout(() => {
                if (headerGridApi && typeof headerGridApi.sizeColumnsToFit === 'function') {
                  headerGridApi.sizeColumnsToFit();
                }
              }, 200);
              loadOutboundList();
            },
            suppressHorizontalScroll: false,
            localeText: {
              noRowsToShow: '출하 의뢰서 데이터가 없습니다.'
            }
          };

          // 디테일 그리드 설정 (★ OUTBOUND_STATUS 필드 추가)
          const detailColumnDefs = [
            { 
              headerName: '선택', 
              checkboxSelection: true, 
              headerCheckboxSelection: true, 
              width: 60,
              maxWidth: 60,
              suppressSizeToFit: true
            },
            { 
              headerName: '순번', 
              field: 'lineNo', 
              width: 80,
              maxWidth: 80, 
              cellClass: 'text-center' 
            },
            { 
              headerName: '품목코드', 
              field: 'itemCode', 
              width: 120,
              minWidth: 100
            },
            { 
              headerName: '품목명', 
              field: 'itemName', 
              flex: 2,
              minWidth: 150
            },
            { 
              headerName: '규격', 
              field: 'standard', 
              flex: 1,
              minWidth: 100
            },
            {
              headerName: '수량', 
              field: 'qty', 
              width: 100,
              maxWidth: 120, 
              type: 'numericColumn',
              valueFormatter: params => Number(params.value || 0).toLocaleString(),
              cellClass: 'text-end'
            },
            { 
              headerName: '단위', 
              field: 'unit', 
              width: 80,
              maxWidth: 80
            },
            {
              headerName: '단가', 
              field: 'unitPrice', 
              width: 110,
              minWidth: 100, 
              type: 'numericColumn',
              valueFormatter: params => Number(params.value || 0).toLocaleString(),
              cellClass: 'text-end'
            },
            {
              headerName: '공급가액', 
              field: 'supplyAmount', 
              width: 120,
              minWidth: 100, 
              type: 'numericColumn',
              valueFormatter: params => Number(params.value || 0).toLocaleString(),
              cellClass: 'text-end'
            },
            {
              headerName: '부가세', 
              field: 'taxAmount', 
              width: 100,
              minWidth: 90, 
              type: 'numericColumn',
              valueFormatter: params => Number(params.value || 0).toLocaleString(),
              cellClass: 'text-end'
            },
            {
              headerName: '합계', 
              field: 'totalAmount', 
              width: 120,
              minWidth: 100, 
              type: 'numericColumn',
              cellClass: 'font-weight-bold text-end',
              valueFormatter: params => Number(params.value || 0).toLocaleString()
            },
            {
              headerName: '출고상태',
              field: 'outboundStatus',
              width: 100,
              minWidth: 90,
              cellClass: 'text-center',
              editable: true,
              cellEditor: 'agSelectCellEditor',
              cellEditorParams: {
                values: ['대기', '준비중', '출고중', '출고완료', '취소']
              },
              cellRenderer: function(params) {
                const status = params.value || '대기';
                return `<span class="status-badge status-${status}">${status}</span>`;
              }
            },
            { 
              headerName: '비고', 
              field: 'remarks', 
              flex: 1,
              minWidth: 100
            }
          ];

          const detailGridOptions = {
            columnDefs: detailColumnDefs,
            rowData: [],
            defaultColDef: {
              sortable: true,
              filter: true,
              resizable: true,
              flex: 0,
              editable: false
            },
            rowSelection: 'multiple',
            onGridReady: function(params) {
              console.log('📋 디테일 그리드 준비 완료');
              detailGridApi = params.api;
              setTimeout(() => {
                if (detailGridApi && typeof detailGridApi.sizeColumnsToFit === 'function') {
                  detailGridApi.sizeColumnsToFit();
                }
              }, 200);
            },
            onCellValueChanged: function(params) {
              // 출고상태 변경 시 즉시 저장
              if (params.colDef.field === 'outboundStatus') {
                updateOutboundStatus(params.data);
              }
            },
            suppressHorizontalScroll: false,
            localeText: {
              noRowsToShow: '출하 의뢰서 상세 데이터가 없습니다.'
            }
          };

          // 그리드 생성
          const headerGridDiv = document.getElementById('headerGrid');
          if (agGrid.createGrid) {
            agGrid.createGrid(headerGridDiv, headerGridOptions);
          } else {
            new agGrid.Grid(headerGridDiv, headerGridOptions);
          }
          
          const detailGridDiv = document.getElementById('detailGrid');
          if (agGrid.createGrid) {
            agGrid.createGrid(detailGridDiv, detailGridOptions);
          } else {
            new agGrid.Grid(detailGridDiv, detailGridOptions);
          }
          
          console.log('✅ AG-Grid 초기화 완료');

        } catch (error) {
          console.error('❌ AG-Grid 초기화 실패:', error);
          showErrorAlert('AG-Grid 초기화에 실패했습니다: ' + error.message);
        }
      }

      // ===== 데이터 로드 함수들 =====
      function loadOutboundList() {
        console.log('📥 출하 의뢰서 목록 로드 시작');
        
        if (headerGridApi) {
          safeSetRowData(headerGridApi, []);
        }
        
        fetch('/bsn/soutbounds')
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
          })
          .then(data => {
            console.log('📊 출하 의뢰서 목록 데이터:', data);
            
            if (headerGridApi) {
              safeSetRowData(headerGridApi, data || []);
              console.log(`✅ 출하 의뢰서 목록 로드 완료: ${data?.length || 0}건`);
              
              setTimeout(() => {
                if (headerGridApi && typeof headerGridApi.sizeColumnsToFit === 'function') {
                  headerGridApi.sizeColumnsToFit();
                }
              }, 200);
            }
          })
          .catch(error => {
            console.error('❌ 출하 의뢰서 목록 로드 실패:', error);
            if (headerGridApi) {
              safeSetRowData(headerGridApi, []);
            }
            showErrorAlert('출하 의뢰서 목록을 불러오는데 실패했습니다: ' + error.message);
          });
      }

      function onHeaderRowClicked(event) {
        const outboundNo = event.data.outboundNo;
        selectedOutboundData = event.data;
        
        console.log('🎯 출하 의뢰서 헤더 클릭:', outboundNo);
        $('#selectedOutboundNo').text(`(${outboundNo})`);
        
        loadOutboundDetails(outboundNo);
      }

      function loadOutboundDetails(outboundNo) {
        console.log('📥 출하 의뢰서 상세 로드 시작:', outboundNo);
        
        if (detailGridApi) {
          safeSetRowData(detailGridApi, []);
        }
        
        fetch(`/bsn/soutbounds/${encodeURIComponent(outboundNo)}/details`)
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
          })
          .then(data => {
            console.log('📋 출하 의뢰서 상세 데이터:', data);
            
            if (detailGridApi) {
              safeSetRowData(detailGridApi, data || []);
              console.log(`✅ 출하 의뢰서 상세 로드 완료: ${data?.length || 0}건`);
              
              setTimeout(() => {
                if (detailGridApi && typeof detailGridApi.sizeColumnsToFit === 'function') {
                  detailGridApi.sizeColumnsToFit();
                }
              }, 200);
            }
          })
          .catch(error => {
            console.error('❌ 출하 의뢰서 상세 로드 실패:', error);
            if (detailGridApi) {
              safeSetRowData(detailGridApi, []);
            }
            showErrorAlert('출하 의뢰서 상세를 불러오는데 실패했습니다: ' + error.message);
          });
      }

      // ===== 상태 관련 함수들 =====
      function loadStatusStats() {
        console.log('📊 상태 통계 로드 시작');
        
        // 임시 데이터 (실제 구현 시 API 호출)
        const stats = [
          { status: '대기', count: 15, className: 'status-대기' },
          { status: '준비중', count: 8, className: 'status-준비중' },
          { status: '출고중', count: 5, className: 'status-출고중' },
          { status: '출고완료', count: 42, className: 'status-출고완료' },
          { status: '취소', count: 2, className: 'status-취소' }
        ];
        
        const container = $('#statusStatsContainer');
        container.empty();
        
        stats.forEach(stat => {
          container.append(`
            <div class="status-card ${stat.className}">
              <h6>${stat.status}</h6>
              <div class="count">${stat.count}</div>
            </div>
          `);
        });
        
        $('#statusStatsSection').show();
      }

      function updateOutboundStatus(data) {
        console.log('🔄 출고 상태 업데이트:', data);
        
        // API 호출하여 상태 업데이트
        fetch(`/bsn/soutbounds/${data.outboundNo}/details/${data.lineNo}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            outboundStatus: data.outboundStatus
          })
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('상태 업데이트 실패');
          }
          return response.json();
        })
        .then(result => {
          if (result.success) {
            console.log('✅ 출고 상태 업데이트 성공');
            showSuccessToast('출고 상태가 업데이트되었습니다.');
          } else {
            throw new Error(result.message || '상태 업데이트 실패');
          }
        })
        .catch(error => {
          console.error('❌ 출고 상태 업데이트 실패:', error);
          showErrorAlert('출고 상태 업데이트에 실패했습니다: ' + error.message);
          // 실패 시 원래 값으로 복구
          loadOutboundDetails(data.outboundNo);
        });
      }

      // ===== 유틸리티 함수들 =====
      function showErrorAlert(message) {
        if (typeof Swal !== 'undefined') {
          Swal.fire('오류', message, 'error');
        } else {
          alert('오류: ' + message);
        }
      }

      function showSuccessAlert(message) {
        if (typeof Swal !== 'undefined') {
          Swal.fire('성공', message, 'success');
        } else {
          alert('성공: ' + message);
        }
      }

      function showSuccessToast(message) {
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            icon: 'success',
            title: message
          });
        } else {
          console.log('성공:', message);
        }
      }

      // ===== 버튼 이벤트 핸들러 =====
      $('#btnRefresh').click(function() {
        console.log('🔄 새로고침 버튼 클릭');
        loadOutboundList();
        if (detailGridApi) {
          safeSetRowData(detailGridApi, []);
        }
        $('#selectedOutboundNo').text('');
        selectedOutboundData = null;
      });

      $('#btnStatusStats').click(function() {
        console.log('📊 상태 현황 버튼 클릭');
        if ($('#statusStatsSection').is(':visible')) {
          $('#statusStatsSection').hide();
        } else {
          loadStatusStats();
        }
      });

      $('#btnCloseStats').click(function() {
        $('#statusStatsSection').hide();
      });

      $('#btnCreateFromOrder').click(function() {
        console.log('📋 주문서에서 생성 버튼 클릭');
        loadOrderList();
        $('#orderSelectModal').modal('show');
      });

      $('#btnBulkStatusUpdate').click(function() {
        console.log('📝 상태 일괄변경 버튼 클릭');
        
        let selectedRows = [];
        if (detailGridApi && typeof detailGridApi.getSelectedRows === 'function') {
          selectedRows = detailGridApi.getSelectedRows();
        }
        
        if (selectedRows.length === 0) {
          showErrorAlert('상태를 변경할 항목을 선택해주세요.');
          return;
        }
        
        $('#selectedItemCount').text(selectedRows.length);
        $('#bulkStatusModal').modal('show');
      });

      $('#btnConfirmBulkStatus').click(function() {
        const newStatus = $('#bulkStatusSelect').val();
        if (!newStatus) {
          showErrorAlert('변경할 상태를 선택해주세요.');
          return;
        }
        
        const selectedRows = detailGridApi.getSelectedRows();
        console.log('🔄 일괄 상태 변경:', newStatus, selectedRows.length + '건');
        
        if (!selectedOutboundData || !selectedOutboundData.outboundNo) {
          showErrorAlert('출하 의뢰서를 먼저 선택해주세요.');
          return;
        }
        
        // 선택된 행들의 라인번호 추출
        const lineNos = selectedRows.map(row => row.lineNo);
        
        // 일괄 상태 업데이트 API 호출
        fetch(`/bsn/soutbounds/${selectedOutboundData.outboundNo}/status/bulk`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            outboundStatus: newStatus,
            lineNos: lineNos
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // 선택된 행들의 상태 업데이트
            selectedRows.forEach(row => {
              row.outboundStatus = newStatus;
            });
            
            // 그리드 새로고침
            detailGridApi.refreshCells();
            
            $('#bulkStatusModal').modal('hide');
            showSuccessAlert(`${data.updatedCount || selectedRows.length}개 항목의 상태가 "${newStatus}"(으)로 변경되었습니다.`);
            
            // 상세 데이터 다시 로드하여 동기화
            setTimeout(() => {
              loadOutboundDetails(selectedOutboundData.outboundNo);
            }, 500);
          } else {
            showErrorAlert(data.message || '상태 변경에 실패했습니다.');
          }
        })
        .catch(error => {
          console.error('❌ 일괄 상태 변경 실패:', error);
          showErrorAlert('상태 변경 중 오류가 발생했습니다.');
        });
      });

      // 기존 버튼들 (간소화)
      $('#btnNew, #btnEdit, #btnDelete').click(function() {
        const action = $(this).find('i').hasClass('fa-plus') ? '신규' : 
                      $(this).find('i').hasClass('fa-edit') ? '수정' : '삭제';
        showErrorAlert(`${action} 기능을 준비중입니다.`);
      });

      $('#btnExportExcel').click(function() {
        showErrorAlert('엑셀 내보내기 기능을 준비중입니다.');
      });

      // 주문서 목록 로드 (기존 로직 유지)
      function loadOrderList() {
        const tbody = $('#orderListBody');
        tbody.html('<tr><td colspan="6" class="text-center"><div class="spinner-border spinner-border-sm"></div> 주문서를 불러오는 중...</td></tr>');
        
        fetch('/bsn/orders')
          .then(response => response.json())
          .then(orders => {
            tbody.empty();
            if (orders && orders.length > 0) {
              orders.forEach(order => {
                tbody.append(`
                  <tr>
                    <td>
                      <button class="btn btn-sm btn-success select-order" data-order-no="${order.orderNo}">
                        선택
                      </button>
                    </td>
                    <td>${order.orderNo}</td>
                    <td>${order.orderDt}</td>
                    <td>${order.customerNm || ''}</td>
                    <td class="text-end">-</td>
                    <td><span class="badge bg-warning">대기</span></td>
                  </tr>
                `);
              });
            } else {
              tbody.html('<tr><td colspan="6" class="text-center text-muted">출고 가능한 주문서가 없습니다.</td></tr>');
            }
          })
          .catch(error => {
            console.error('주문서 목록 로드 실패:', error);
            tbody.html('<tr><td colspan="6" class="text-center text-danger">주문서 목록을 불러오는데 실패했습니다.</td></tr>');
          });
      }

      // 주문서 선택 이벤트 (기존 로직 유지)
      $(document).on('click', '.select-order', function() {
        const orderNo = $(this).data('order-no');
        
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            title: '출하 의뢰서 생성',
            text: `주문서 "${orderNo}"를 기반으로 출하 의뢰서를 생성하시겠습니까?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#1cc88a',
            cancelButtonColor: '#6c757d',
            confirmButtonText: '생성',
            cancelButtonText: '취소'
          }).then((result) => {
            if (result.isConfirmed) {
              createOutboundFromOrder(orderNo);
            }
          });
        }
      });

      function createOutboundFromOrder(orderNo) {
        fetch('/bsn/soutbounds/create-from-order', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ orderNo: orderNo })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showSuccessAlert(`출하 의뢰서 "${data.outboundNo}"가 성공적으로 생성되었습니다.`);
            $('#orderSelectModal').modal('hide');
            loadOutboundList();
          } else {
            showErrorAlert(data.message || '출하 의뢰서 생성에 실패했습니다.');
          }
        })
        .catch(error => {
          console.error('출하 의뢰서 생성 실패:', error);
          showErrorAlert('출하 의뢰서 생성 중 오류가 발생했습니다.');
        });
      }

      // ===== 초기화 =====
      console.log('🎯 출하 의뢰서 관리 초기화 시작');
      
      function waitForAgGrid() {
        if (typeof agGrid !== 'undefined') {
          console.log('✅ AG-Grid 로드 확인됨');
          setTimeout(initializeGrids, 100);
        } else {
          console.log('⏳ AG-Grid 로드 대기 중...');
          setTimeout(waitForAgGrid, 100);
        }
      }
      
      setTimeout(waitForAgGrid, 500);
      
      console.log('🎉 출하 의뢰서 관리 스크립트 초기화 완료');
    });
    /*]]>*/
    </script>

</div>
</html>