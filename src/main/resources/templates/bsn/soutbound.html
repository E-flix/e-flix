<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/default}">
<head>
  <meta charset="UTF-8" />
  <title>ì¶œí•˜ ì˜ë¢°ì„œ ê´€ë¦¬</title>
  <style>
    .section-box { padding: 15px; border: 1px solid #e3e6f0; border-radius: 8px; background-color: #ffffff; margin-bottom: 15px; box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15); }
    .section-box h6 { margin-bottom: 12px; color: #4e73df; font-weight: 700; border-bottom: 2px solid #4e73df; padding-bottom: 8px; }
    .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; text-align: center; min-width: 60px; display: inline-block; color: white; }
    .status-ëŒ€ê¸° { background-color: #ffc107; color: #212529; }
    .status-ì¶œê³ ì™„ë£Œ { background-color: #28a745; }
    .new-row-highlight { background-color: #fff3cd !important; }
    .header-grid, .detail-grid { height: 350px; width: 100%; }
    .status-stats { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
    .status-card { flex: 1; min-width: 120px; padding: 10px 15px; border-radius: 8px; text-align: center; color: white; font-weight: 600; }
    .status-card h6 { margin: 0; font-size: 0.9rem; opacity: 0.9; border: none; }
    .status-card .count { font-size: 1.5rem; font-weight: bold; margin: 5px 0; }
  </style>
</head>
<div layout:fragment="content" class="container-fluid px-3 py-2">

    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h4 class="mb-0"><i class="fas fa-shipping-fast mr-2"></i>ì¶œí•˜ ì˜ë¢°ì„œ ê´€ë¦¬</h4>
        <small class="text-muted">ì¶œí•˜ ì˜ë¢°ì„œ ì¡°íšŒ, ìƒì„± ë° ì‚­ì œ</small>
      </div>
      <div>
        <button type="button" class="btn btn-success btn-sm me-1" id="btnSave" style="display: none;"><i class="fas fa-save"></i> ì €ì¥</button>
        <button type="button" class="btn btn-secondary btn-sm me-1" id="btnCancel" style="display: none;"><i class="fas fa-times"></i> ì·¨ì†Œ</button>
        <button type="button" class="btn btn-info btn-sm me-1" id="btnStatusStats"><i class="fas fa-chart-pie"></i> ìƒíƒœ í˜„í™©</button>
        <button type="button" class="btn btn-warning btn-sm me-1" id="btnCreateFromOrder" disabled><i class="fas fa-plus-circle"></i> ì£¼ë¬¸ì„œì—ì„œ ìƒì„±</button>
        <button type="button" class="btn btn-primary btn-sm me-1" id="btnNew"><i class="fas fa-plus"></i> ì‹ ê·œ</button>
        <button type="button" class="btn btn-danger btn-sm me-1" id="btnDelete"><i class="fas fa-trash"></i> ì‚­ì œ</button>
      </div>
    </div>

    <!-- ì¶œê³  í—¤ë” ê·¸ë¦¬ë“œ -->
    <div class="section-box">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6><i class="fas fa-list mr-2"></i>ì¶œí•˜ ì˜ë¢°ì„œ ëª©ë¡</h6>
        <button id="btnRefresh" class="btn btn-secondary btn-sm me-1"><i class="fas fa-sync"></i> ìƒˆë¡œê³ ì¹¨</button>
      </div>
      <div id="headerGrid" class="ag-theme-alpine header-grid"></div>
    </div>

    <!-- ì¶œê³  ë””í…Œì¼ ê·¸ë¦¬ë“œ -->
    <div class="section-box">
      <h6><i class="fas fa-boxes mr-2"></i>ì¶œí•˜ ì˜ë¢°ì„œ ìƒì„¸ <span id="selectedOutboundNo" class="text-muted fs-6"></span></h6>
      <div id="detailGrid" class="ag-theme-alpine detail-grid"></div>
    </div>

    <!-- ì£¼ë¬¸ì„œ ì„ íƒ ëª¨ë‹¬ -->
    <div class="modal fade" id="orderSelectModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="fas fa-clipboard-list mr-2"></i>ì£¼ë¬¸ì„œ ì„ íƒ</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="table-responsive">
              <table class="table table-bordered table-hover">
                <thead class="table-light">
                  <tr><th>ì„ íƒ</th><th>ì£¼ë¬¸ë²ˆí˜¸</th><th>ì£¼ë¬¸ì¼ì</th><th>ê±°ë˜ì²˜ëª…</th><th>ì‘ì„±ì</th></tr>
                </thead>
                <tbody id="orderListBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', () => {
      // ===== ì „ì—­ ë³€ìˆ˜ =====
      let headerGridApi, detailGridApi;
      let orderSelectModal;
      let isNewMode = false;
      let newOutboundData = null;
      let selectedHeaderData = null;

      console.log('ğŸš€ ì¶œí•˜ ì˜ë¢°ì„œ ê´€ë¦¬ í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');

      // ===== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ =====
      const formatDate = (dateStr) => {
        if (!dateStr) return '';
        try {
          return new Date(dateStr).toLocaleDateString('ko-KR');
        } catch (e) {
          return dateStr;
        }
      };

      const formatDateForAPI = (dateInput) => {
        if (!dateInput) return null;
        try {
          let date;
          if (dateInput instanceof Date) {
            date = dateInput;
          } else if (typeof dateInput === 'string') {
            date = new Date(dateInput);
          } else {
            return null;
          }
          if (isNaN(date.getTime())) return null;
          return date.toISOString().split('T')[0];
        } catch (error) {
          console.warn('ë‚ ì§œ í¬ë§· ì˜¤ë¥˜:', error, dateInput);
          return null;
        }
      };

      const calculateTotalAmount = (details) => {
        if (!details || details.length === 0) return '0';
        const totalQty = details.reduce((sum, detail) => sum + (Number(detail.qty) || 0), 0);
        return totalQty.toString();
      };

      const fetchData = async (url, options = {}) => {
        try {
          const response = await fetch(url, options);
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: response.statusText }));
            throw new Error(errorData.message || `HTTP ${response.status}`);
          }
          return response.json();
        } catch (error) {
          console.error(`ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${url}`, error);
          Swal.fire('ì˜¤ë¥˜', `ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
          throw error;
        }
      };

      // ===== ê·¸ë¦¬ë“œ ì„¤ì • =====
      const headerColumnDefs = [
        { headerName: 'ì¶œí•˜ë²ˆí˜¸', field: 'outboundNo', width: 150, pinned: 'left' },
        { headerName: 'ì‘ì„±ì¼ì', field: 'writeDt', width: 120, valueFormatter: p => formatDate(p.value) },
        { headerName: 'ê±°ë˜ì²˜ëª…', field: 'customerName', flex: 1, minWidth: 150 },
        { headerName: 'ëŒ€í‘œëª…', field: 'representativeNm', width: 120 },
        { headerName: 'ì£¼ë¬¸ì¼ì', field: 'orderDt', width: 120, valueFormatter: p => formatDate(p.value) },
        { headerName: 'ì¶œê³ ì¼ì', field: 'outboundDt', width: 120, valueFormatter: p => formatDate(p.value) },
        { headerName: 'ë‚©ê¸°ì¼ì', field: 'deliveryDueDate', width: 120, valueFormatter: p => formatDate(p.value) },
        { headerName: 'ì „ì²´ ìƒíƒœ', field: 'overallStatus', width: 110,
          cellRenderer: p => `<span class="status-badge status-${p.value || 'ëŒ€ê¸°'}">${p.value || 'ëŒ€ê¸°'}</span>`
        },
        { headerName: 'ë¹„ê³ ', field: 'remarks', flex: 1, minWidth: 150 }
      ];

      const detailColumnDefs = [
        { headerName: 'ê±°ë˜ì²˜ëª…', field: 'customerName', width: 150 },
        { headerName: 'ì£¼ë¬¸ì¼ì', field: 'orderDt', width: 120, valueFormatter: p => formatDate(p.value) },
        { headerName: 'í’ˆëª©ì½”ë“œ', field: 'itemCode', width: 120 },
        { headerName: 'í’ˆëª©ëª…', field: 'itemName', flex: 1, minWidth: 200 },
        { headerName: 'ê·œê²©', field: 'standard', width: 150 },
        { headerName: 'ìˆ˜ëŸ‰', field: 'qty', width: 100, type: 'numericColumn' },
        { headerName: 'ì¶œê³ ì¼', field: 'outboundDt', width: 120, valueFormatter: p => formatDate(p.value) },
        { headerName: 'ë‚©ê¸°ì¼', field: 'deliveryDueDate', width: 120, valueFormatter: p => formatDate(p.value) },
        { headerName: 'ì¶œê³ ìƒíƒœ', field: 'outboundStatus', width: 110,
          cellRenderer: p => `<span class="status-badge status-${p.value || 'ëŒ€ê¸°'}">${p.value || 'ëŒ€ê¸°'}</span>`
        },
        { headerName: 'ë¹„ê³ ', field: 'remarks', flex: 1, minWidth: 150 }
      ];

      const commonGridOptions = {
        defaultColDef: { sortable: true, filter: true, resizable: true },
        localeText: { noRowsToShow: 'ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.' }
      };

      // ===== ê·¸ë¦¬ë“œ ì´ˆê¸°í™” =====
      try {
        console.log('ğŸ“Š AG-Grid ì´ˆê¸°í™” ì‹œì‘');
        
        const headerGridOptions = {
          ...commonGridOptions,
          columnDefs: headerColumnDefs,
          rowSelection: 'single',
          getRowClass: params => (params.data && params.data.isNew ? 'new-row-highlight' : ''),
          getRowNodeId: data => data ? data.outboundNo : null,
          onGridReady: (params) => {
            console.log('âœ… í—¤ë” ê·¸ë¦¬ë“œ ì¤€ë¹„ ì™„ë£Œ');
            headerGridApi = params.api;
            loadOutboundList();
          },
          onRowClicked: (event) => {
            if (isNewMode && event.data && event.data.isNew) return;
            selectedHeaderData = event.data;
            if (event.data && event.data.outboundNo) {
              loadOutboundDetails(event.data.outboundNo);
            }
          }
        };

        const detailGridOptions = {
          ...commonGridOptions,
          columnDefs: detailColumnDefs,
          onGridReady: (params) => {
            console.log('âœ… ë””í…Œì¼ ê·¸ë¦¬ë“œ ì¤€ë¹„ ì™„ë£Œ');
            detailGridApi = params.api;
          }
        };

        agGrid.createGrid(document.getElementById('headerGrid'), headerGridOptions);
        agGrid.createGrid(document.getElementById('detailGrid'), detailGridOptions);
        
        console.log('âœ… AG-Grid ì´ˆê¸°í™” ì™„ë£Œ');
      } catch (error) {
        console.error('âŒ AG-Grid ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        Swal.fire('ì˜¤ë¥˜', 'AG-Grid ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      }
      
      // ===== ëª¨ë‹¬ ì´ˆê¸°í™” =====
      orderSelectModal = new bootstrap.Modal(document.getElementById('orderSelectModal'));

      // ===== ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ë“¤ =====
      const loadOutboundList = () => {
        if (!headerGridApi) return;
        fetchData('/bsn/soutbounds').then(data => {
          headerGridApi.setGridOption('rowData', data || []);
          console.log('ğŸ“‹ ì¶œí•˜ ì˜ë¢°ì„œ ëª©ë¡ ë¡œë“œ ì™„ë£Œ:', data?.length || 0, 'ê±´');
        }).catch(error => {
          console.error('ì¶œí•˜ ì˜ë¢°ì„œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        });
      };

      const loadOutboundDetails = (outboundNo) => {
        if (!detailGridApi) return;
        document.getElementById('selectedOutboundNo').textContent = `(${outboundNo})`;
        fetchData(`/bsn/soutbounds/${outboundNo}/details`).then(details => {
          if (detailGridApi && selectedHeaderData) {
            const enrichedDetails = details.map(detail => ({
              ...detail,
              customerName: selectedHeaderData.customerName,
              representativeNm: selectedHeaderData.representativeNm,
              orderDt: selectedHeaderData.orderDt,
              outboundDt: selectedHeaderData.outboundDt,
              deliveryDueDate: selectedHeaderData.deliveryDueDate
            }));
            detailGridApi.setGridOption('rowData', enrichedDetails || []);
            console.log('ğŸ“¦ ì¶œí•˜ ì˜ë¢°ì„œ ìƒì„¸ ë¡œë“œ ì™„ë£Œ:', enrichedDetails?.length || 0, 'ê±´');
          }
        }).catch(error => {
          console.error('ì¶œí•˜ ì˜ë¢°ì„œ ìƒì„¸ ë¡œë“œ ì‹¤íŒ¨:', error);
        });
      };

      const loadOrderList = () => {
        const tbody = document.getElementById('orderListBody');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center"><div class="spinner-border spinner-border-sm"></div></td></tr>';
        fetchData('/bsn/orders').then(orders => {
          tbody.innerHTML = '';
          if (orders && orders.length > 0) {
            orders.forEach(order => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td><button class="btn btn-sm btn-success select-order" data-order-no="${order.orderNo}">ì„ íƒ</button></td>
                <td>${order.orderNo}</td>
                <td>${formatDate(order.orderDt)}</td>
                <td>${order.customerNm || ''}</td>
                <td>${order.orderWriter || ''}</td>
              `;
              tbody.appendChild(tr);
            });
          } else {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">ì¶œê³  ê°€ëŠ¥í•œ ì£¼ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
          }
        }).catch(error => {
          console.error('ì£¼ë¬¸ì„œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        });
      };

      // ===== ë²„íŠ¼ ì œì–´ í•¨ìˆ˜ë“¤ =====
      const toggleButtons = (isNew) => {
        document.getElementById('btnSave').style.display = isNew ? 'inline-block' : 'none';
        document.getElementById('btnCancel').style.display = isNew ? 'inline-block' : 'none';
        document.getElementById('btnNew').style.display = isNew ? 'none' : 'inline-block';
        document.getElementById('btnDelete').style.display = isNew ? 'none' : 'inline-block';
        document.getElementById('btnCreateFromOrder').disabled = !isNew;
      };

      const resetNewMode = () => {
        console.log('ğŸ”„ ì‹ ê·œ ëª¨ë“œ í•´ì œ');
        isNewMode = false;
        const tempRow = headerGridApi.getRowNode('ì‹ ê·œ ë“±ë¡ ì¤‘...');
        if (tempRow) {
          headerGridApi.applyTransaction({ remove: [tempRow.data] });
        }
        detailGridApi.setGridOption('rowData', []);
        document.getElementById('selectedOutboundNo').textContent = '';
        toggleButtons(false);
        newOutboundData = null;
        selectedHeaderData = null;
      };

      // ===== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤ =====
      
      // ì‹ ê·œ ë²„íŠ¼
      document.getElementById('btnNew').addEventListener('click', () => {
        if (isNewMode) return;
        console.log('â• ì‹ ê·œ ëª¨ë“œ ì§„ì…');
        isNewMode = true;
        toggleButtons(true);
        newOutboundData = {
          outboundNo: 'ì‹ ê·œ ë“±ë¡ ì¤‘...', isNew: true, writeDt: new Date(),
          outboundDt: new Date(), overallStatus: 'ëŒ€ê¸°'
        };
        headerGridApi.applyTransaction({ add: [newOutboundData], addIndex: 0 });
        headerGridApi.ensureIndexVisible(0);
        detailGridApi.setGridOption('rowData', []);
        document.getElementById('selectedOutboundNo').textContent = '(ì‹ ê·œ)';
      });

      // ì£¼ë¬¸ì„œì—ì„œ ìƒì„± ë²„íŠ¼
      document.getElementById('btnCreateFromOrder').addEventListener('click', () => {
        if (!isNewMode) return;
        loadOrderList();
        orderSelectModal.show();
      });

      // ì£¼ë¬¸ì„œ ì„ íƒ ì´ë²¤íŠ¸
      // â˜…â˜…â˜… í™•ì‹¤í•œ ì£¼ë¬¸ì„œ ì„ íƒ ë° í—¤ë” ì—…ë°ì´íŠ¸ ë¡œì§ â˜…â˜…â˜…
      document.getElementById('orderListBody').addEventListener('click', e => {
        if (e.target.classList.contains('select-order')) {
          const orderNo = e.target.dataset.orderNo;
          console.log('ğŸ” ì£¼ë¬¸ì„œ ì„ íƒ:', orderNo);
        
          fetchData(`/bsn/orders/${orderNo}`).then(orderData => {
            console.log('ğŸ“‹ ì£¼ë¬¸ì„œ ë°ì´í„° ìˆ˜ì‹ :', orderData);
          
            if (orderData) {
              // 1. ìƒˆë¡œìš´ í—¤ë” ë°ì´í„° êµ¬ì„±
              const updatedHeaderData = {
                outboundNo: 'ì‹ ê·œ ë“±ë¡ ì¤‘...',
                isNew: true,
                writeDt: new Date(),
                outboundDt: new Date(),
                overallStatus: 'ëŒ€ê¸°',
                // ì£¼ë¬¸ì„œì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„°
                customerCd: orderData.customerCd || '',
                customerName: orderData.customerNm || '', // customerNm â†’ customerName ë§¤í•‘
                representativeNm: orderData.representativeNm || '',
                orderDt: orderData.orderDt,
                deliveryDueDate: orderData.expectedDeliveryDt || new Date(),
                remarks: orderData.remarks || ''
              };
            
              console.log('ğŸ“ êµ¬ì„±ëœ í—¤ë” ë°ì´í„°:', updatedHeaderData);
            
              // 2. ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
              newOutboundData = updatedHeaderData;
              selectedHeaderData = { ...updatedHeaderData };
            
              // 3. AG-Grid ì „ì²´ ë°ì´í„° ì—…ë°ì´íŠ¸ (ê°€ì¥ í™•ì‹¤í•œ ë°©ë²•)
              const currentRowData = [];
              let foundNewRow = false;
            
              headerGridApi.forEachNode(node => {
                if (node.data.outboundNo === 'ì‹ ê·œ ë“±ë¡ ì¤‘...') {
                  // ì‹ ê·œ í–‰ì„ ì—…ë°ì´íŠ¸ëœ ë°ì´í„°ë¡œ êµì²´
                  currentRowData.push(updatedHeaderData);
                  foundNewRow = true;
                  console.log('ğŸ”„ ì‹ ê·œ í–‰ ë°ì´í„° êµì²´');
                } else {
                  // ê¸°ì¡´ í–‰ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
                  currentRowData.push(node.data);
                }
              });
            
              // ë§Œì•½ ì‹ ê·œ í–‰ì´ ì—†ë‹¤ë©´ ì¶”ê°€
              if (!foundNewRow) {
                currentRowData.unshift(updatedHeaderData);
                console.log('â• ì‹ ê·œ í–‰ ì¶”ê°€');
              }
            
              // 4. AG-Grid rowData ì „ì²´ ì¬ì„¤ì •
              headerGridApi.setGridOption('rowData', currentRowData);
              
              // 5. ì¶”ê°€ ì—…ë°ì´íŠ¸ ë°©ë²•ë“¤ (ë°±ì—…)
              setTimeout(() => {
                try {
                  // ë°©ë²• 1: getRowNodeë¡œ ë‹¤ì‹œ ì‹œë„
                  const nodeToUpdate = headerGridApi.getRowNode('ì‹ ê·œ ë“±ë¡ ì¤‘...');
                  if (nodeToUpdate) {
                    console.log('ğŸ¯ ê°œë³„ ë…¸ë“œ ì—…ë°ì´íŠ¸ ì‹œë„');
                    nodeToUpdate.setData(updatedHeaderData);
                    
                    // ê°œë³„ í•„ë“œ ì—…ë°ì´íŠ¸ë„ ì‹œë„
                    Object.keys(updatedHeaderData).forEach(key => {
                      try {
                        nodeToUpdate.setDataValue(key, updatedHeaderData[key]);
                      } catch (e) {
                        console.warn(`âš ï¸ ${key} í•„ë“œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:`, e);
                      }
                    });
                  }
                
                  // ë°©ë²• 2: ê°•ì œ ìƒˆë¡œê³ ì¹¨
                  headerGridApi.refreshCells({ force: true });
                  headerGridApi.redrawRows();
                  console.log('ğŸ”„ ê·¸ë¦¬ë“œ ê°•ì œ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
                
                  // ë°©ë²• 3: ì²« ë²ˆì§¸ í–‰ ì„ íƒ ë° í¬ì»¤ìŠ¤
                  headerGridApi.ensureIndexVisible(0);
                  headerGridApi.getDisplayedRowAtIndex(0)?.setSelected(true);
                
                } catch (error) {
                  console.warn('âš ï¸ ì¶”ê°€ ì—…ë°ì´íŠ¸ ë°©ë²• ì‹¤íŒ¨:', error);
                }
              }, 200);
            
              // 6. ìƒì„¸ ê·¸ë¦¬ë“œ ë°ì´í„° ì„¤ì •
              if (orderData.details && orderData.details.length > 0) {
                const enrichedDetails = orderData.details.map(d => ({
                  ...d,
                  outboundStatus: 'ëŒ€ê¸°',
                  customerName: updatedHeaderData.customerName,
                  representativeNm: updatedHeaderData.representativeNm,
                  orderDt: updatedHeaderData.orderDt,
                  outboundDt: updatedHeaderData.outboundDt,
                  deliveryDueDate: updatedHeaderData.deliveryDueDate
                }));
              
                console.log('ğŸ“¦ ìƒì„¸ ë°ì´í„° ì„¤ì •:', enrichedDetails.length, 'ê±´');
                detailGridApi.setGridOption('rowData', enrichedDetails);
              } else {
                console.warn('âš ï¸ ìƒì„¸ ë°ì´í„°ê°€ ì—†ìŒ');
                detailGridApi.setGridOption('rowData', []);
              }
            
              // 7. ëª¨ë‹¬ ë‹«ê¸°
              orderSelectModal.hide();
            
              // 8. ì„±ê³µ ë©”ì‹œì§€ ë° ê²€ì¦
              setTimeout(() => {
                // ì—…ë°ì´íŠ¸ ê²°ê³¼ ê²€ì¦
                const verifyNode = headerGridApi.getRowNode('ì‹ ê·œ ë“±ë¡ ì¤‘...');
                if (verifyNode && verifyNode.data) {
                  console.log('âœ… ì—…ë°ì´íŠ¸ ê²€ì¦ - í˜„ì¬ ë…¸ë“œ ë°ì´í„°:', verifyNode.data);
                  console.log('âœ… ê±°ë˜ì²˜ëª… í™•ì¸:', verifyNode.data.customerName);
                  console.log('âœ… ëŒ€í‘œëª… í™•ì¸:', verifyNode.data.representativeNm);
                }
              
                Swal.fire({
                  title: 'ì£¼ë¬¸ì„œ ì—°ë™ ì™„ë£Œ! ğŸ‰',
                  html: `
                    <div class="text-center">
                      <p><strong>ì£¼ë¬¸ë²ˆí˜¸:</strong> ${orderNo}</p>
                      <p><strong>ê±°ë˜ì²˜:</strong> ${updatedHeaderData.customerName}</p>
                      <p><strong>ëŒ€í‘œëª…:</strong> ${updatedHeaderData.representativeNm}</p>
                      <p><strong>ìƒì„¸í’ˆëª©:</strong> ${orderData.details?.length || 0}ê±´</p>
                      <hr>
                      <p class="text-success"><small>í—¤ë” ê·¸ë¦¬ë“œë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!</small></p>
                    </div>
                  `,
                  icon: 'success',
                  timer: 3000,
                  showConfirmButton: true,
                  confirmButtonText: 'í™•ì¸'
                });
              }, 500);
            
              console.log('âœ… ì£¼ë¬¸ì„œ ì—°ë™ ì™„ë£Œ');
            
            } else {
              console.error('âŒ ì£¼ë¬¸ì„œ ë°ì´í„°ê°€ ì—†ìŒ');
              Swal.fire('ì˜¤ë¥˜', 'ì£¼ë¬¸ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
            }
          }).catch(error => {
            console.error('âŒ ì£¼ë¬¸ì„œ ì¡°íšŒ ì‹¤íŒ¨:', error);
            Swal.fire('ì˜¤ë¥˜', 'ì£¼ë¬¸ì„œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
          });
        }
      });
      
      // â˜…â˜…â˜… ì¶”ê°€: í—¤ë” ê·¸ë¦¬ë“œ ìƒíƒœ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ í•¨ìˆ˜ â˜…â˜…â˜…
      window.monitorHeaderGrid = function() {
        console.log('=== í—¤ë” ê·¸ë¦¬ë“œ ì‹¤ì‹œê°„ ìƒíƒœ ===');
        
        if (!headerGridApi) {
          console.error('âŒ headerGridApiê°€ ì—†ìŠµë‹ˆë‹¤');
          return;
        }
      
        const allRows = [];
        headerGridApi.forEachNode((node, index) => {
          console.log(`í–‰ ${index}:`, {
            outboundNo: node.data?.outboundNo,
            customerName: node.data?.customerName,
            representativeNm: node.data?.representativeNm,
            isNew: node.data?.isNew
          });
          allRows.push(node.data);
        });
      
        console.log('ì „ì²´ í–‰ ë°ì´í„°:', allRows);
        console.log('ì‹ ê·œ ëª¨ë“œ:', isNewMode);
        console.log('newOutboundData:', newOutboundData);
        console.log('selectedHeaderData:', selectedHeaderData);
      
        // ì‹ ê·œ ë“±ë¡ ì¤‘ì¸ ë…¸ë“œ ì°¾ê¸°
        const newNode = headerGridApi.getRowNode('ì‹ ê·œ ë“±ë¡ ì¤‘...');
        if (newNode) {
          console.log('âœ… ì‹ ê·œ ë“±ë¡ ë…¸ë“œ ì°¾ìŒ:', newNode.data);
        } else {
          console.log('âŒ ì‹ ê·œ ë“±ë¡ ë…¸ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
        }
      
        return allRows;
      };
      
      // â˜…â˜…â˜… ì¶”ê°€: ê°•ì œ í—¤ë” ì—…ë°ì´íŠ¸ í•¨ìˆ˜ â˜…â˜…â˜…
      window.forceUpdateHeader = function(customerName, representativeNm) {
        console.log('ğŸ”§ ê°•ì œ í—¤ë” ì—…ë°ì´íŠ¸ ì‹œì‘');
        
        if (!headerGridApi || !isNewMode) {
          console.error('âŒ ì¡°ê±´ ë¶ˆë§Œì¡± - headerGridApi:', !!headerGridApi, 'isNewMode:', isNewMode);
          return;
        }
      
        const testData = {
          outboundNo: 'ì‹ ê·œ ë“±ë¡ ì¤‘...',
          isNew: true,
          writeDt: new Date(),
          outboundDt: new Date(),
          customerName: customerName || 'í…ŒìŠ¤íŠ¸ ê±°ë˜ì²˜',
          representativeNm: representativeNm || 'í…ŒìŠ¤íŠ¸ ëŒ€í‘œ',
          overallStatus: 'ëŒ€ê¸°'
        };
      
        // ì „ì²´ ë°ì´í„° ì¬êµ¬ì„±
        const newRowData = [testData];
        headerGridApi.forEachNode(node => {
          if (node.data.outboundNo !== 'ì‹ ê·œ ë“±ë¡ ì¤‘...') {
            newRowData.push(node.data);
          }
        });
      
        headerGridApi.setGridOption('rowData', newRowData);
        
        setTimeout(() => {
          headerGridApi.refreshCells({ force: true });
          headerGridApi.redrawRows();
          console.log('âœ… ê°•ì œ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
          
          // ê²°ê³¼ í™•ì¸
          const verifyNode = headerGridApi.getRowNode('ì‹ ê·œ ë“±ë¡ ì¤‘...');
          console.log('ê²€ì¦ ê²°ê³¼:', verifyNode?.data);
        }, 100);
      };

      // ì €ì¥ ë²„íŠ¼ - ì¶œí•˜ ì˜ë¢°ì„œ ë“±ë¡
      // â˜…â˜…â˜… ìˆ˜ì •ëœ ì €ì¥ í•¨ìˆ˜ - í—¤ë” ì •ë³´ ì•ˆì •ì  í™•ë³´ â˜…â˜…â˜…
      document.getElementById('btnSave').addEventListener('click', async () => {
        console.log('ğŸ’¾ ì¶œí•˜ ì˜ë¢°ì„œ ì €ì¥ ì‹œì‘');
      
        if (!isNewMode) {
          Swal.fire('ì•Œë¦¼', 'ì‹ ê·œ ëª¨ë“œì—ì„œë§Œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'info');
          return;
        }
      
        // â˜…â˜…â˜… ìˆ˜ì •ëœ í—¤ë” ë°ì´í„° í™•ë³´ ë¡œì§ â˜…â˜…â˜…
        let headerData = null;
      
        // ë°©ë²• 1: getRowNodeë¡œ ì°¾ê¸°
        try {
          const headerNode = headerGridApi.getRowNode('ì‹ ê·œ ë“±ë¡ ì¤‘...');
          if (headerNode && headerNode.data) {
            headerData = headerNode.data;
            console.log('âœ… ë°©ë²• 1 ì„±ê³µ - getRowNode:', headerData);
          }
        } catch (error) {
          console.warn('âš ï¸ ë°©ë²• 1 ì‹¤íŒ¨:', error);
        }
      
        // ë°©ë²• 2: forEachNodeë¡œ ì°¾ê¸°
        if (!headerData) {
          try {
            headerGridApi.forEachNode(node => {
              if (node.data && node.data.outboundNo === 'ì‹ ê·œ ë“±ë¡ ì¤‘...') {
                headerData = node.data;
                console.log('âœ… ë°©ë²• 2 ì„±ê³µ - forEachNode:', headerData);
                return false; // ì°¾ì•˜ìœ¼ë©´ ì¤‘ë‹¨
              }
            });
          } catch (error) {
            console.warn('âš ï¸ ë°©ë²• 2 ì‹¤íŒ¨:', error);
          }
        }
      
        // ë°©ë²• 3: ì „ì—­ ë³€ìˆ˜ ì‚¬ìš©
        if (!headerData && newOutboundData) {
          headerData = newOutboundData;
          console.log('âœ… ë°©ë²• 3 ì„±ê³µ - ì „ì—­ ë³€ìˆ˜:', headerData);
        }
      
        // ë°©ë²• 4: ì²« ë²ˆì§¸ í–‰ ì§ì ‘ í™•ì¸ (ì‹ ê·œ ëª¨ë“œì—ì„œëŠ” ì²« ë²ˆì§¸ í–‰ì´ ì‹ ê·œ í–‰)
        if (!headerData) {
          try {
            const firstRowNode = headerGridApi.getDisplayedRowAtIndex(0);
            if (firstRowNode && firstRowNode.data && firstRowNode.data.isNew) {
              headerData = firstRowNode.data;
              console.log('âœ… ë°©ë²• 4 ì„±ê³µ - ì²« ë²ˆì§¸ í–‰:', headerData);
            }
          } catch (error) {
            console.warn('âš ï¸ ë°©ë²• 4 ì‹¤íŒ¨:', error);
          }
        }
      
        // ìµœì¢… í™•ì¸
        if (!headerData) {
          console.error('âŒ ëª¨ë“  ë°©ë²• ì‹¤íŒ¨ - í—¤ë” ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
          
          // ë””ë²„ê¹… ì •ë³´ ì¶œë ¥
          console.log('ë””ë²„ê¹… ì •ë³´:');
          console.log('- isNewMode:', isNewMode);
          console.log('- newOutboundData:', newOutboundData);
          console.log('- headerGridApi:', !!headerGridApi);
          
          if (headerGridApi) {
            const allRows = [];
            headerGridApi.forEachNode(node => allRows.push(node.data));
            console.log('- í˜„ì¬ ê·¸ë¦¬ë“œ ëª¨ë“  í–‰:', allRows);
          }
        
          // ì‚¬ìš©ìì—ê²Œ ìì„¸í•œ ì˜¤ë¥˜ ì •ë³´ ì œê³µ
          Swal.fire({
            title: 'í—¤ë” ì •ë³´ ì˜¤ë¥˜',
            html: `
              <div class="text-start">
                <p>í—¤ë” ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                <hr>
                <strong>í•´ê²° ë°©ë²•:</strong>
                <ol>
                  <li>ì‹ ê·œ ë²„íŠ¼ì„ ë‹¤ì‹œ í´ë¦­</li>
                  <li>ì£¼ë¬¸ì„œë¥¼ ë‹¤ì‹œ ì„ íƒ</li>
                  <li>í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨</li>
                </ol>
                <hr>
                <small class="text-muted">
                  ì‹ ê·œëª¨ë“œ: ${isNewMode ? 'âœ…' : 'âŒ'}<br>
                  ì „ì—­ë°ì´í„°: ${newOutboundData ? 'âœ…' : 'âŒ'}
                </small>
              </div>
            `,
            icon: 'error',
            confirmButtonText: 'í™•ì¸',
            footer: '<small>ë¬¸ì œê°€ ì§€ì†ë˜ë©´ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.</small>'
          });
          return;
        }
      
        console.log('ğŸ“‹ ìµœì¢… í—¤ë” ë°ì´í„°:', headerData);
      
        // â˜…â˜…â˜… í•„ìˆ˜ í•„ë“œ ê²€ì¦ â˜…â˜…â˜…
        const validationErrors = [];
      
        if (!headerData.customerCd || !headerData.customerCd.trim()) {
          validationErrors.push('â€¢ ê±°ë˜ì²˜ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
        }
        if (!headerData.customerName || !headerData.customerName.trim()) {
          validationErrors.push('â€¢ ê±°ë˜ì²˜ëª…ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        }
        if (!headerData.outboundDt) {
          validationErrors.push('â€¢ ì¶œê³ ì¼ìë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        }
      
        if (validationErrors.length > 0) {
          console.error('âŒ í—¤ë” ê²€ì¦ ì‹¤íŒ¨:', validationErrors);
          Swal.fire({
            title: 'ì…ë ¥ ì •ë³´ í™•ì¸',
            html: `
              <div class="text-start">
                <p><strong>ë‹¤ìŒ ì •ë³´ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”:</strong></p>
                ${validationErrors.join('<br>')}
                <hr>
                <p class="text-muted">ì£¼ë¬¸ì„œë¥¼ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤.</p>
              </div>
            `,
            icon: 'warning',
            confirmButtonText: 'í™•ì¸'
          });
          return;
        }
      
        // â˜…â˜…â˜… ìƒì„¸ ë°ì´í„° ìˆ˜ì§‘ ë° ê²€ì¦ â˜…â˜…â˜…
        const details = [];
        const detailErrors = [];
      
        detailGridApi.forEachNode((node, index) => {
          const data = node.data;
          console.log(`ğŸ“¦ ìƒì„¸ ${index + 1}:`, data);
        
          // ë¹ˆ í–‰ ê±´ë„ˆë›°ê¸°
          if (!data.itemCode && !data.itemName && !data.qty) {
            return;
          }
        
          // í•„ìˆ˜ í•„ë“œ ê²€ì¦
          if (!data.itemCode || !data.itemCode.trim()) {
            detailErrors.push(`${index + 1}ë²ˆì§¸ í–‰: í’ˆëª©ì½”ë“œê°€ í•„ìš”í•©ë‹ˆë‹¤.`);
            return;
          }
          if (!data.itemName || !data.itemName.trim()) {
            detailErrors.push(`${index + 1}ë²ˆì§¸ í–‰: í’ˆëª©ëª…ì´ í•„ìš”í•©ë‹ˆë‹¤.`);
            return;
          }
          if (!data.qty || Number(data.qty) <= 0) {
            detailErrors.push(`${index + 1}ë²ˆì§¸ í–‰: ìˆ˜ëŸ‰ì€ 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.`);
            return;
          }
        
          // ìƒì„¸ í•­ëª© êµ¬ì„±
          details.push({
            lineNo: details.length + 1,
            itemCode: data.itemCode.trim(),
            itemName: data.itemName.trim(),
            standard: data.standard || data.spec || '',
            qty: Number(data.qty) || 1,
            unit: data.unit || 'EA',
            outboundStatus: data.outboundStatus || 'ëŒ€ê¸°',
            remarks: data.remarks || ''
          });
        });
      
        console.log('ğŸ“¦ ìˆ˜ì§‘ëœ ìƒì„¸ ë°ì´í„°:', details);
        console.log('âŒ ìƒì„¸ ê²€ì¦ ì˜¤ë¥˜:', detailErrors);
      
        if (detailErrors.length > 0) {
          Swal.fire({
            title: 'ìƒì„¸ ì •ë³´ í™•ì¸',
            html: `
              <div class="text-start">
                <p><strong>ë‹¤ìŒ ìƒì„¸ ì •ë³´ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”:</strong></p>
                ${detailErrors.map(err => `â€¢ ${err}`).join('<br>')}
              </div>
            `,
            icon: 'warning',
            confirmButtonText: 'í™•ì¸'
          });
          return;
        }
      
        if (details.length === 0) {
          Swal.fire({
            title: 'ìƒí’ˆ ì •ë³´ í•„ìš”',
            text: 'ì¶œê³ í•  í’ˆëª©ì„ í•œ ê°œ ì´ìƒ ì…ë ¥í•´ ì£¼ì„¸ìš”.',
            icon: 'warning',
            confirmButtonText: 'í™•ì¸'
          });
          return;
        }
      
        // â˜…â˜…â˜… ì €ì¥ í™•ì¸ ëŒ€í™”ìƒì â˜…â˜…â˜…
        const confirmResult = await Swal.fire({
          title: 'ì¶œí•˜ ì˜ë¢°ì„œ ë“±ë¡',
          html: `
            <div class="text-start">
              <p><strong>ğŸ“‹ ë“±ë¡ ì •ë³´:</strong></p>
              <p>â€¢ <strong>ê±°ë˜ì²˜:</strong> ${headerData.customerName}</p>
              <p>â€¢ <strong>ëŒ€í‘œëª…:</strong> ${headerData.representativeNm || '-'}</p>
              <p>â€¢ <strong>ì¶œê³ ì¼ì:</strong> ${formatDateForAPI(headerData.outboundDt)}</p>
              <p>â€¢ <strong>í’ˆëª© ê°œìˆ˜:</strong> ${details.length}ê°œ</p>
              <p>â€¢ <strong>ì´ ìˆ˜ëŸ‰:</strong> ${details.reduce((sum, d) => sum + d.qty, 0)}ê°œ</p>
              <hr>
              <p class="text-center text-muted">ì¶œí•˜ ì˜ë¢°ì„œë¥¼ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            </div>
          `,
          icon: 'question',
          showCancelButton: true,
          confirmButtonColor: '#1cc88a',
          cancelButtonColor: '#6c757d',
          confirmButtonText: '<i class="fas fa-save"></i> ë“±ë¡',
          cancelButtonText: '<i class="fas fa-times"></i> ì·¨ì†Œ',
          reverseButtons: true,
          width: '500px'
        });
      
        if (!confirmResult.isConfirmed) {
          console.log('ì‚¬ìš©ìê°€ ë“±ë¡ì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.');
          return;
        }
      
        // â˜…â˜…â˜… DTO êµ¬ì„± ë° ì „ì†¡ â˜…â˜…â˜…
        const outboundDto = {
          writeDt: formatDateForAPI(new Date()),
          outboundDt: formatDateForAPI(headerData.outboundDt || new Date()),
          customerCd: headerData.customerCd.trim(),
          customerName: headerData.customerName.trim(),
          representativeNm: headerData.representativeNm || '',
          orderDt: headerData.orderDt ? formatDateForAPI(headerData.orderDt) : null,
          money: calculateTotalAmount(details),
          remarks: headerData.remarks || '',
          details: details
        };
      
        console.log('=== ìµœì¢… ì „ì†¡ ë°ì´í„° ===');
        console.log('DTO:', outboundDto);
      
        // ì €ì¥ ì§„í–‰ í‘œì‹œ
        Swal.fire({
          title: 'ë“±ë¡ ì¤‘...',
          html: `
            <div class="text-center">
              <div class="spinner-border text-primary mb-3"></div>
              <p>ì¶œí•˜ ì˜ë¢°ì„œë¥¼ ì €ì¥í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
              <small class="text-muted">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”...</small>
            </div>
          `,
          allowOutsideClick: false,
          showConfirmButton: false
        });
      
        try {
          console.log('ğŸŒ ì„œë²„ ìš”ì²­ ì‹œì‘');
        
          const response = await fetch('/bsn/soutbounds', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json; charset=utf-8' },
            body: JSON.stringify(outboundDto)
          });
        
          console.log('ğŸ“¡ ì„œë²„ ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
        
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${response.statusText}\nìƒì„¸: ${errorText}`);
          }
        
          const result = await response.json();
          console.log('âœ… ì„œë²„ ì‘ë‹µ ë°ì´í„°:', result);
        
          if (result.success) {
            // ì„±ê³µ ì²˜ë¦¬
            await Swal.fire({
              title: 'ë“±ë¡ ì™„ë£Œ! ğŸ‰',
              html: `
                <div class="text-center">
                  <i class="fas fa-check-circle text-success" style="font-size: 4rem; margin-bottom: 20px;"></i>
                  <h4 class="text-success mb-3">ì¶œí•˜ ì˜ë¢°ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!</h4>
                  <div class="alert alert-info">
                    <p class="mb-1"><strong>ì¶œí•˜ë²ˆí˜¸:</strong></p>
                    <h5 class="text-primary">${result.outboundNo}</h5>
                  </div>
                  <p class="text-muted">ëª©ë¡ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
              `,
              icon: 'success',
              confirmButtonText: 'í™•ì¸',
              timer: 6000,
              width: '500px'
            });
          
            // ìƒíƒœ ì´ˆê¸°í™” ë° ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            resetNewMode();
            loadOutboundList();
          
            // ë“±ë¡ëœ í•­ëª© ìë™ ì„ íƒ
            setTimeout(() => {
              if (headerGridApi && result.outboundNo) {
                headerGridApi.forEachNode(node => {
                  if (node.data && node.data.outboundNo === result.outboundNo) {
                    node.setSelected(true);
                    headerGridApi.ensureNodeVisible(node);
                    loadOutboundDetails(result.outboundNo);
                    return false; // ì°¾ì•˜ìœ¼ë©´ ì¤‘ë‹¨
                  }
                });
              }
            }, 1000);
          
          } else {
            // ì„œë²„ì—ì„œ success: false ì‘ë‹µ
            console.error('âŒ ì„œë²„ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì˜¤ë¥˜:', result.message);
            Swal.fire({
              title: 'ë“±ë¡ ì‹¤íŒ¨',
              html: `
                <div class="text-center">
                  <i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem; margin-bottom: 20px;"></i>
                  <p>${result.message || 'ì„œë²„ì—ì„œ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}</p>
                  <small class="text-muted">ì…ë ¥ ì •ë³´ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.</small>
                </div>
              `,
              icon: 'error',
              confirmButtonText: 'í™•ì¸'
            });
          }
        
        } catch (error) {
          console.error('âŒ ë“±ë¡ ìš”ì²­ ì‹¤íŒ¨:', error);
        
          let errorMessage = 'ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
          let errorDetail = error.message;
        
          if (error.message.includes('HTTP 400')) {
            errorMessage = 'ìš”ì²­ ë°ì´í„°ì— ì˜¤ë¥˜ê°€ ìˆìŠµë‹ˆë‹¤.';
          } else if (error.message.includes('HTTP 500')) {
            errorMessage = 'ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
          } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
            errorMessage = 'ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.';
          }
        
          Swal.fire({
            title: 'ë“±ë¡ ì‹¤íŒ¨',
            html: `
              <div class="text-center">
                <i class="fas fa-times-circle text-danger" style="font-size: 3rem; margin-bottom: 20px;"></i>
                <p><strong>${errorMessage}</strong></p>
                <details class="mt-3">
                  <summary class="text-muted" style="cursor: pointer;">ì˜¤ë¥˜ ìƒì„¸ ì •ë³´</summary>
                  <small class="text-muted">${errorDetail}</small>
                </details>
              </div>
            `,
            icon: 'error',
            confirmButtonText: 'í™•ì¸',
            width: '500px'
          });
        }
      });

      // ì·¨ì†Œ ë²„íŠ¼
      document.getElementById('btnCancel').addEventListener('click', () => {
        Swal.fire({
          title: 'ì‘ì—… ì·¨ì†Œ',
          text: 'í˜„ì¬ ì‘ì—…ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì…ë ¥í•œ ë‚´ìš©ì´ ëª¨ë‘ ì‚¬ë¼ì§‘ë‹ˆë‹¤.',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#e74a3b',
          cancelButtonColor: '#6c757d',
          confirmButtonText: 'ì·¨ì†Œ',
          cancelButtonText: 'ê³„ì† ì‘ì—…',
          reverseButtons: true
        }).then((result) => {
          if (result.isConfirmed) {
            resetNewMode();
            Swal.fire({
              title: 'ì·¨ì†Œë¨',
              text: 'ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.',
              icon: 'info',
              timer: 1500,
              showConfirmButton: false
            });
          }
        });
      });

      // ì‚­ì œ ë²„íŠ¼
      document.getElementById('btnDelete').addEventListener('click', () => {
        if (!headerGridApi) return;
        const selectedRows = headerGridApi.getSelectedRows();
        if (selectedRows.length === 0) {
          return Swal.fire('ì•Œë¦¼', 'ì‚­ì œí•  ì¶œí•˜ ì˜ë¢°ì„œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
        }
        Swal.fire({
          title: `${selectedRows.length}ê±´ ì‚­ì œ í™•ì¸`,
          text: "ì„ íƒí•œ í•­ëª©ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#e74a3b',
          confirmButtonText: 'ì‚­ì œ',
          cancelButtonText: 'ì·¨ì†Œ'
        }).then(result => {
          if (result.isConfirmed) {
            const deletePromises = selectedRows.map(row => 
              fetchData(`/bsn/soutbounds/${row.outboundNo}`, { method: 'DELETE' })
            );
            Promise.all(deletePromises)
              .then(() => {
                Swal.fire('ì‚­ì œ ì™„ë£Œ', `${selectedRows.length}ê±´ì˜ ì¶œí•˜ ì˜ë¢°ì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                loadOutboundList();
                if(detailGridApi) detailGridApi.setGridOption('rowData', []);
                document.getElementById('selectedOutboundNo').textContent = '';
              })
              .catch(e => console.error(e));
          }
        });
      });

      // ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼
      document.getElementById('btnRefresh').addEventListener('click', loadOutboundList);
      
      // ìƒíƒœ í˜„í™© ë²„íŠ¼ (ì¶”í›„ êµ¬í˜„)
      document.getElementById('btnStatusStats').addEventListener('click', () => {
        Swal.fire('ì¤€ë¹„ì¤‘', 'ìƒíƒœ í˜„í™© ê¸°ëŠ¥ì„ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤.', 'info');
      });

      // ë””ë²„ê¹… í•¨ìˆ˜ (ì „ì—­ ìŠ¤ì½”í”„)
      window.debugHeaderGrid = function() {
        console.log('=== í—¤ë” ê·¸ë¦¬ë“œ ë””ë²„ê¹… ===');
        console.log('headerGridApi:', !!headerGridApi);
        console.log('isNewMode:', isNewMode);
        console.log('newOutboundData:', newOutboundData);
        console.log('selectedHeaderData:', selectedHeaderData);
        
        if (headerGridApi) {
          const allRows = [];
          headerGridApi.forEachNode(node => {
            allRows.push(node.data);
          });
          console.log('í˜„ì¬ í—¤ë” ê·¸ë¦¬ë“œ ë°ì´í„°:', allRows);
          
          const newNode = headerGridApi.getRowNode('ì‹ ê·œ ë“±ë¡ ì¤‘...');
          console.log('ì‹ ê·œ ë“±ë¡ ë…¸ë“œ:', newNode ? newNode.data : 'NOT FOUND');
        }
      };

      console.log('âœ… ì¶œí•˜ ì˜ë¢°ì„œ ê´€ë¦¬ í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');
    });
    </script>
</div>
</html>