<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/default}">
<head>
  <meta charset="UTF-8" />
  <title>출하 의뢰서 관리</title>
  <style>
    /* ----- 기본 레이아웃 및 디자인 ----- */
    .section-box {
      padding: 15px;
      border: 1px solid #e3e6f0;
      border-radius: 8px;
      background-color: #ffffff;
      margin-bottom: 15px;
      box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    }
    .section-box h6 {
      margin-bottom: 12px;
      color: #4e73df;
      font-weight: 700;
      border-bottom: 2px solid #4e73df;
      padding-bottom: 8px;
    }
    .btn-create { background-color: #1cc88a; border-color: #1cc88a; color: white; }
    .btn-create:hover { background-color: #17a673; border-color: #17a673; }
    .btn-edit { background-color: #36b9cc; border-color: #36b9cc; color: white; }
    .btn-edit:hover { background-color: #2c9faf; border-color: #2c9faf; }
    .btn-delete { background-color: #e74a3b; border-color: #e74a3b; color: white; }
    .btn-delete:hover { background-color: #c0392b; border-color: #c0392b; }
    .header-grid, .detail-grid { height: 350px; width: 100%; }

    /* ----- AG-Grid 커스텀 스타일 ----- */
    .ag-theme-alpine {
      --ag-header-background-color: #f8f9fc;
      --ag-header-foreground-color: #5a5c69;
      --ag-border-color: #e3e6f0;
      --ag-row-hover-color: #f0f3ff;
      --ag-selected-row-background-color: #dfe7ff;
    }
    .ag-theme-alpine .ag-header-cell { font-weight: 600; }
    .text-end { text-align: right !important; }

    /* ----- 출고상태 배지 스타일 ----- */
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-align: center;
      min-width: 60px;
      display: inline-block;
      color: white;
    }
    .status-대기 { background-color: #ffc107; color: #212529; }
    .status-준비중 { background-color: #17a2b8; }
    .status-출고중 { background-color: #007bff; }
    .status-출고완료 { background-color: #28a745; }
    .status-취소 { background-color: #dc3545; }

    /* ----- 출고 상태 통계 카드 ----- */
    .status-stats { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
    .status-card {
      flex: 1;
      min-width: 120px;
      padding: 10px 15px;
      border-radius: 8px;
      text-align: center;
      color: white;
      font-weight: 600;
    }
    .status-card h6 { margin: 0; font-size: 0.9rem; opacity: 0.9; border: none; }
    .status-card .count { font-size: 1.5rem; font-weight: bold; margin: 5px 0; }
    .status-card .amount { font-size: 0.8rem; opacity: 0.8; }
  </style>
</head>
<div layout:fragment="content" class="container-fluid px-3 py-2">

    <!-- 페이지 헤더 -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h4 class="mb-0"><i class="fas fa-shipping-fast mr-2"></i>출하 의뢰서 관리</h4>
        <small class="text-muted">출하 의뢰서 등록, 수정, 삭제 및 출고 상태 관리</small>
      </div>
      <div>
        <button type="button" class="btn btn-info btn-sm me-1" id="btnStatusStats"><i class="fas fa-chart-pie"></i> 상태 현황</button>
        <button type="button" class="btn btn-warning btn-sm me-1" id="btnCreateFromOrder"><i class="fas fa-plus-circle"></i> 주문서에서 생성</button>
        <button type="button" class="btn btn-create btn-sm me-1" id="btnNew"><i class="fas fa-plus"></i> 신규</button>
        <button type="button" class="btn btn-delete btn-sm me-1" id="btnDelete"><i class="fas fa-trash"></i> 삭제</button>
      </div>
    </div>

    <!-- 출고 상태 통계 (접을 수 있는 카드) -->
    <div class="section-box" id="statusStatsSection" style="display: none;">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6><i class="fas fa-chart-bar mr-2"></i>출고 상태 현황</h6>
        <button class="btn btn-sm btn-outline-secondary" id="btnCloseStats"><i class="fas fa-times"></i></button>
      </div>
      <div class="status-stats" id="statusStatsContainer"></div>
    </div>

    <!-- 출고 헤더 그리드 -->
    <div class="section-box">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6><i class="fas fa-list mr-2"></i>출하 의뢰서 목록</h6>
        <button id="btnRefresh" class="btn btn-secondary btn-sm me-1"><i class="fas fa-sync"></i> 새로고침</button>
      </div>
      <div id="headerGrid" class="ag-theme-alpine header-grid"></div>
    </div>

    <!-- 출고 디테일 그리드 -->
    <div class="section-box">
      <h6><i class="fas fa-boxes mr-2"></i>출하 의뢰서 상세 <span id="selectedOutboundNo" class="text-muted fs-6"></span></h6>
      <div id="detailGrid" class="ag-theme-alpine detail-grid"></div>
    </div>

    <!-- 주문서 선택 모달 -->
    <div class="modal fade" id="orderSelectModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="fas fa-clipboard-list mr-2"></i>주문서 선택</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="table-responsive">
              <table class="table table-bordered table-hover">
                <thead class="table-light">
                  <tr><th>선택</th><th>주문번호</th><th>주문일자</th><th>거래처명</th><th>작성자</th></tr>
                </thead>
                <tbody id="orderListBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', () => {
      console.log('✅ 출하 의뢰서 관리 페이지 로드 시작');
      
      let headerGridApi, detailGridApi;

      // AG-Grid 컬럼 정의
      const headerColumnDefs = [
          { headerName: '선택', checkboxSelection: true, width: 60, pinned: 'left' },
          { headerName: '출하번호', field: 'outboundNo', width: 150, cellClass: 'font-weight-bold text-primary', pinned: 'left' },
          { 
            headerName: '전체상태', 
            field: 'overallStatus',
            width: 110,
            cellRenderer: params => {
              const status = params.value || '대기';
              return `<span class="status-badge status-${status}">${status}</span>`;
            }
          },
          { headerName: '작성일자', field: 'writeDt', width: 110 },
          { headerName: '거래처명', field: 'customerName', flex: 2, minWidth: 150 },
          { headerName: '대표명', field: 'representativeNm', flex: 1, minWidth: 100 },
          { headerName: '출고일자', field: 'outboundDt', width: 110, valueFormatter: p => p.value ? new Date(p.value).toLocaleDateString('ko-KR') : '' },
          { headerName: '통화', field: 'money', width: 80 },
          { headerName: '비고', field: 'remarks', flex: 1, minWidth: 120 }
      ];

      const detailColumnDefs = [
          { headerName: '순번', field: 'lineNo', width: 80, cellClass: 'text-center' },
          { headerName: '품목코드', field: 'itemCode', width: 120 },
          { headerName: '품목명', field: 'itemName', flex: 2, minWidth: 150 },
          { headerName: '규격', field: 'standard', flex: 1, minWidth: 100 },
          { headerName: '수량', field: 'qty', width: 100, type: 'numericColumn', valueFormatter: p => Number(p.value || 0).toLocaleString(), cellClass: 'text-end' },
          { headerName: '출고상태', field: 'outboundStatus', width: 100, cellClass: 'text-center',
            cellRenderer: params => `<span class="status-badge status-${params.value}">${params.value}</span>`
          },
          { headerName: '비고', field: 'remarks', flex: 1, minWidth: 100 }
      ];

      // AG-Grid 옵션
      const commonGridOptions = {
          defaultColDef: { sortable: true, filter: true, resizable: true, flex: 0 },
          suppressHorizontalScroll: false,
          localeText: { noRowsToShow: '데이터가 없습니다.' }
      };

      // ★★★ 변경: 그리드 생성과 API 할당을 분리합니다. ★★★
      const headerGridOptions = {
          ...commonGridOptions,
          columnDefs: headerColumnDefs,
          rowSelection: 'multiple',
          onRowClicked: e => loadOutboundDetails(e.data.outboundNo),
          onGridReady: (params) => {
              console.log('Header Grid is ready.');
              headerGridApi = params.api; // API 할당
              loadOutboundList(); // 그리드가 준비된 후 데이터 로드
          }
      };

      const detailGridOptions = {
          ...commonGridOptions,
          columnDefs: detailColumnDefs,
          onGridReady: (params) => {
              console.log('Detail Grid is ready.');
              detailGridApi = params.api; // API 할당
          }
      };

      // 그리드 생성
      agGrid.createGrid(document.getElementById('headerGrid'), headerGridOptions);
      agGrid.createGrid(document.getElementById('detailGrid'), detailGridOptions);

      // 데이터 로드 함수
      const fetchData = async (url, options = {}) => {
        try {
          const response = await fetch(url, options);
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: response.statusText }));
            throw new Error(errorData.message || `HTTP ${response.status}`);
          }
          return response.json();
        } catch (error) {
          console.error(`데이터 로드 실패: ${url}`, error);
          Swal.fire('오류', `데이터를 불러오는 데 실패했습니다: ${error.message}`, 'error');
          throw error;
        }
      };

      const loadOutboundList = () => {
        if (!headerGridApi) {
            console.warn('Header Grid API is not ready yet.');
            return;
        }
        fetchData('/bsn/soutbounds').then(data => {
            headerGridApi.setGridOption('rowData', data || []);
        });
      };

      const loadOutboundDetails = (outboundNo) => {
        if (!detailGridApi) {
            console.warn('Detail Grid API is not ready yet.');
            return;
        }
        document.getElementById('selectedOutboundNo').textContent = `(${outboundNo})`;
        fetchData(`/bsn/soutbounds/${outboundNo}/details`).then(data => {
            detailGridApi.setGridOption('rowData', data || []);
        });
      };

      const loadOrderList = () => {
        const tbody = document.getElementById('orderListBody');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center"><div class="spinner-border spinner-border-sm"></div></td></tr>';
        fetchData('/bsn/orders').then(orders => {
          tbody.innerHTML = '';
          if (orders && orders.length > 0) {
            orders.forEach(order => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td><button class="btn btn-sm btn-success select-order" data-order-no="${order.orderNo}">선택</button></td>
                <td>${order.orderNo}</td>
                <td>${order.orderDt}</td>
                <td>${order.customerNm || ''}</td>
                <td>${order.orderWriter || ''}</td>
              `;
              tbody.appendChild(tr);
            });
          } else {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">출고 가능한 주문서가 없습니다.</td></tr>';
          }
        });
      };

      const loadStatusStats = () => {
        fetchData('/bsn/soutbounds/stats').then(stats => {
          const container = document.getElementById('statusStatsContainer');
          container.innerHTML = '';
          stats.forEach(stat => {
            const card = document.createElement('div');
            card.className = `status-card status-${stat.STATUS}`;
            card.innerHTML = `
              <h6>${stat.STATUS}</h6>
              <div class="count">${stat.COUNT}</div>
              <div class="amount">${Number(stat.TOTALAMOUNT || 0).toLocaleString()} 원</div>
            `;
            container.appendChild(card);
          });
          document.getElementById('statusStatsSection').style.display = 'block';
        });
      };

      // 주문서 기반 출고 생성
      const createOutboundFromOrder = (orderNo) => {
        Swal.fire({
          title: '출하 의뢰서 생성',
          text: `주문서 "${orderNo}"를 기반으로 출하 의뢰서를 생성하시겠습니까?`,
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: '생성',
          cancelButtonText: '취소'
        }).then((result) => {
          if (result.isConfirmed) {
            fetchData('/bsn/soutbounds/create-from-order', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ orderNo })
            }).then(data => {
              if (data.success) {
                Swal.fire('성공', `출하 의뢰서 "${data.outboundNo}"가 생성되었습니다.`, 'success');
                bootstrap.Modal.getInstance(document.getElementById('orderSelectModal')).hide();
                loadOutboundList();
              }
            });
          }
        });
      };
      
      // 출고 삭제
      const deleteSelectedOutbounds = () => {
        if (!headerGridApi) return;
        const selectedRows = headerGridApi.getSelectedRows();
        if (selectedRows.length === 0) {
            return Swal.fire('알림', '삭제할 출하 의뢰서를 선택해주세요.', 'warning');
        }
        Swal.fire({
            title: `${selectedRows.length}건 삭제 확인`,
            text: "선택한 항목을 정말 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#e74a3b',
            confirmButtonText: '삭제',
            cancelButtonText: '취소'
        }).then(result => {
            if (result.isConfirmed) {
                const deletePromises = selectedRows.map(row => 
                    fetchData(`/bsn/soutbounds/${row.outboundNo}`, { method: 'DELETE' })
                );
                Promise.all(deletePromises)
                    .then(() => {
                        Swal.fire('삭제 완료', `${selectedRows.length}건의 출하 의뢰서가 삭제되었습니다.`, 'success');
                        loadOutboundList();
                        if(detailGridApi) detailGridApi.setGridOption('rowData', []);
                        document.getElementById('selectedOutboundNo').textContent = '';
                    })
                    .catch(e => console.error(e));
            }
        });
      };

      // 이벤트 핸들러
      document.getElementById('btnRefresh').addEventListener('click', loadOutboundList);
      document.getElementById('btnStatusStats').addEventListener('click', loadStatusStats);
      document.getElementById('btnCloseStats').addEventListener('click', () => document.getElementById('statusStatsSection').style.display = 'none');
      document.getElementById('btnCreateFromOrder').addEventListener('click', () => {
        loadOrderList();
        new bootstrap.Modal(document.getElementById('orderSelectModal')).show();
      });
      document.getElementById('orderListBody').addEventListener('click', e => {
        if (e.target.classList.contains('select-order')) {
          createOutboundFromOrder(e.target.dataset.orderNo);
        }
      });
      document.getElementById('btnDelete').addEventListener('click', deleteSelectedOutbounds);
      document.getElementById('btnNew').addEventListener('click', () => Swal.fire('준비중', '신규 출하 의뢰서 작성 페이지로 이동합니다.', 'info'));

      // 초기 데이터 로드는 onGridReady 콜백에서 처리합니다.
      console.log('🎉 출하 의뢰서 관리 스크립트 초기화 완료');
    });
    </script>
</div>
</html>
