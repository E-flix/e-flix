<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/default}">
<head>
  <meta charset="UTF-8" />
  <title>ì¶œí•˜ ì˜ë¢°ì„œ ê´€ë¦¬</title>
  <style>
    .section-box {
      padding: 15px;
      border: 1px solid #e3e6f0;
      border-radius: 8px;
      background-color: #ffffff;
      margin-bottom: 15px;
      box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    }

    .section-box h6 {
      margin-bottom: 12px;
      color: #5a5c69;
      font-weight: 700;
      border-bottom: 2px solid #4e73df;
      padding-bottom: 8px;
    }

    .btn-create { background-color: #1cc88a; border-color: #1cc88a; color: white; }
    .btn-create:hover { background-color: #17a673; border-color: #17a673; }

    .btn-edit { background-color: #36b9cc; border-color: #36b9cc; color: white; }
    .btn-edit:hover { background-color: #2c9faf; border-color: #2c9faf; }

    .btn-delete { background-color: #e74a3b; border-color: #e74a3b; color: white; }
    .btn-delete:hover { background-color: #c0392b; border-color: #c0392b; }

    .header-grid { height: 350px; width: 100%; }
    .detail-grid { height: 350px; width: 100%; }

    /* AG-Grid ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ */
    .ag-theme-alpine {
      --ag-background-color: #ffffff;
      --ag-header-background-color: #f8f9fc;
      --ag-header-foreground-color: #5a5c69;
      --ag-border-color: #e3e6f0;
      --ag-row-hover-color: #f8f9fc;
      --ag-selected-row-background-color: #eaecf4;
      --ag-font-size: 14px;
      width: 100% !important;
    }

    /* ìˆ˜ì¹˜ ì»¬ëŸ¼ ìš°ì¸¡ ì •ë ¬ */
    .ag-theme-alpine .text-end {
      text-align: right !important;
    }

    /* ì²´í¬ë°•ìŠ¤ ì»¬ëŸ¼ ì¤‘ì•™ ì •ë ¬ */
    .ag-theme-alpine .ag-checkbox-input-wrapper {
      text-align: center;
    }

    /* ê·¸ë¦¬ë“œ í—¤ë” ìŠ¤íƒ€ì¼ ê°œì„  */
    .ag-theme-alpine .ag-header-cell {
      font-weight: 600;
      border-right: 1px solid #e3e6f0;
    }

    /* ì¶œê³ ìƒíƒœ ë°°ì§€ ìŠ¤íƒ€ì¼ */
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-align: center;
      min-width: 60px;
      display: inline-block;
    }

    .status-ëŒ€ê¸° { background-color: #ffc107; color: #212529; }
    .status-ì¤€ë¹„ì¤‘ { background-color: #17a2b8; color: white; }
    .status-ì¶œê³ ì¤‘ { background-color: #007bff; color: white; }
    .status-ì¶œê³ ì™„ë£Œ { background-color: #28a745; color: white; }
    .status-ì·¨ì†Œ { background-color: #dc3545; color: white; }

    /* ì¶œê³  ìƒíƒœ í†µê³„ ì¹´ë“œ */
    .status-stats {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .status-card {
      flex: 1;
      min-width: 120px;
      padding: 10px 15px;
      border-radius: 8px;
      text-align: center;
      color: white;
      font-weight: 600;
    }

    .status-card h6 {
      margin: 0;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .status-card .count {
      font-size: 1.5rem;
      font-weight: bold;
      margin: 5px 0;
    }
  </style>
</head>
<div layout:fragment="content" class="container-fluid px-3 py-2">

    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h4 class="mb-0">
          <i class="fas fa-shipping-fast mr-2"></i>ì¶œí•˜ ì˜ë¢°ì„œ ê´€ë¦¬
        </h4>
        <small class="text-muted">ì¶œí•˜ ì˜ë¢°ì„œ ë“±ë¡, ìˆ˜ì •, ì‚­ì œ ë° ì¶œê³  ìƒíƒœ ê´€ë¦¬</small>
      </div>
      <div>
        <button type="button" class="btn btn-info btn-sm me-1" id="btnStatusStats">
          <i class="fas fa-chart-pie"></i> ìƒíƒœ í˜„í™©
        </button>
        <button type="button" class="btn btn-warning btn-sm me-1" id="btnCreateFromOrder">
          <i class="fas fa-plus-circle"></i> ì£¼ë¬¸ì„œì—ì„œ ìƒì„±
        </button>
        <button type="button" class="btn btn-create btn-sm me-1" id="btnNew">
          <i class="fas fa-plus"></i> ì‹ ê·œ
        </button>
        <button type="button" class="btn btn-edit btn-sm me-1" id="btnEdit">
          <i class="fas fa-edit"></i> ìˆ˜ì •
        </button>
        <button type="button" class="btn btn-delete btn-sm me-1" id="btnDelete">
          <i class="fas fa-trash"></i> ì‚­ì œ
        </button>
        <button type="button" class="btn btn-secondary btn-sm" id="btnDebug">
          <i class="fas fa-bug"></i> ë””ë²„ê·¸
        </button>
      </div>
    </div>

    <!-- ì¶œê³  ìƒíƒœ í†µê³„ (ì ‘ì„ ìˆ˜ ìˆëŠ” ì¹´ë“œ) -->
    <div class="section-box" id="statusStatsSection" style="display: none;">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6><i class="fas fa-chart-bar mr-2"></i>ì¶œê³  ìƒíƒœ í˜„í™©</h6>
        <button class="btn btn-sm btn-outline-secondary" id="btnCloseStats">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="status-stats" id="statusStatsContainer">
        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
      </div>
    </div>

    <!-- ì¶œê³  í—¤ë” ê·¸ë¦¬ë“œ -->
    <div class="section-box">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6><i class="fas fa-list mr-2"></i>ì¶œí•˜ ì˜ë¢°ì„œ ëª©ë¡</h6>
        <div>
          <button id="btnRefresh" class="btn btn-secondary btn-sm me-1">
            <i class="fas fa-sync"></i> ìƒˆë¡œê³ ì¹¨
          </button>
          <button id="btnExportExcel" class="btn btn-success btn-sm">
            <i class="fas fa-file-excel"></i> ì—‘ì…€
          </button>
        </div>
      </div>
      <div id="headerGrid" class="ag-theme-alpine header-grid"></div>
    </div>

    <!-- ì¶œê³  ë””í…Œì¼ ê·¸ë¦¬ë“œ -->
    <div class="section-box">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6>
          <i class="fas fa-boxes mr-2"></i>ì¶œí•˜ ì˜ë¢°ì„œ ìƒì„¸
          <span id="selectedOutboundNo" class="text-muted fs-6"></span>
        </h6>
        <div>
          <button id="btnAddDetailRow" class="btn btn-info btn-sm me-1">
            <i class="fas fa-plus"></i> í–‰ ì¶”ê°€
          </button>
          <button id="btnDeleteDetailRow" class="btn btn-warning btn-sm me-1">
            <i class="fas fa-minus"></i> í–‰ ì‚­ì œ
          </button>
          <button id="btnBulkStatusUpdate" class="btn btn-primary btn-sm">
            <i class="fas fa-edit"></i> ìƒíƒœ ì¼ê´„ë³€ê²½
          </button>
        </div>
      </div>
      <div id="detailGrid" class="ag-theme-alpine detail-grid"></div>
    </div>

    <!-- ì£¼ë¬¸ì„œ ì„ íƒ ëª¨ë‹¬ -->
    <div class="modal fade" id="orderSelectModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-clipboard-list mr-2"></i>ì£¼ë¬¸ì„œ ì„ íƒ
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="table-responsive">
              <table class="table table-bordered">
                <thead class="table-light">
                  <tr>
                    <th>ì„ íƒ</th>
                    <th>ì£¼ë¬¸ë²ˆí˜¸</th>
                    <th>ì£¼ë¬¸ì¼ì</th>
                    <th>ê±°ë˜ì²˜ëª…</th>
                    <th>í•©ê³„ê¸ˆì•¡</th>
                    <th>ì¶œê³ ìƒíƒœ</th>
                  </tr>
                </thead>
                <tbody id="orderListBody">
                  <tr>
                    <td colspan="6" class="text-center">
                      <div class="spinner-border spinner-border-sm"></div>
                      ì£¼ë¬¸ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ìƒíƒœ ì¼ê´„ë³€ê²½ ëª¨ë‹¬ -->
    <div class="modal fade" id="bulkStatusModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-edit mr-2"></i>ì¶œê³  ìƒíƒœ ì¼ê´„ë³€ê²½
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">ë³€ê²½í•  ìƒíƒœë¥¼ ì„ íƒí•˜ì„¸ìš”:</label>
              <select class="form-select" id="bulkStatusSelect">
                <option value="">ìƒíƒœë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                <option value="ëŒ€ê¸°">ğŸŸ¡ ëŒ€ê¸°</option>
                <option value="ì¤€ë¹„ì¤‘">ğŸ”µ ì¤€ë¹„ì¤‘</option>
                <option value="ì¶œê³ ì¤‘">ğŸŸ¢ ì¶œê³ ì¤‘</option>
                <option value="ì¶œê³ ì™„ë£Œ">âœ… ì¶œê³ ì™„ë£Œ</option>
                <option value="ì·¨ì†Œ">âŒ ì·¨ì†Œ</option>
              </select>
            </div>
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i>
              ì„ íƒëœ <span id="selectedItemCount">0</span>ê°œ í•­ëª©ì˜ ìƒíƒœê°€ ë³€ê²½ë©ë‹ˆë‹¤.
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times"></i> ì·¨ì†Œ
            </button>
            <button type="button" class="btn btn-primary" id="btnConfirmBulkStatus">
              <i class="fas fa-save"></i> ì ìš©
            </button>
          </div>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
    /*<![CDATA[*/
    $(document).ready(function() {
      console.log('âœ… ì¶œí•˜ ì˜ë¢°ì„œ ê´€ë¦¬ í˜ì´ì§€ ë¡œë“œ ì‹œì‘');
      
      // ===== ì „ì—­ ë³€ìˆ˜ =====
      let headerGridApi, detailGridApi;
      let selectedOutboundData = null;

      // ===== AG-Grid ì•ˆì „í•œ ë°ì´í„° ì„¤ì • í•¨ìˆ˜ =====
      function safeSetRowData(gridApi, data) {
        if (!gridApi) {
          console.warn('âš ï¸ Grid APIê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        try {
          if (typeof gridApi.setRowData === 'function') {
            gridApi.setRowData(data);
          } else if (typeof gridApi.setGridOption === 'function') {
            gridApi.setGridOption('rowData', data);
          } else {
            console.error('âŒ ì§€ì›ë˜ëŠ” ë°ì´í„° ì„¤ì • ë°©ë²•ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          }
        } catch (error) {
          console.error('âŒ ë°ì´í„° ì„¤ì • ì‹¤íŒ¨:', error);
        }
      }

      // ===== AG-Grid ì´ˆê¸°í™” =====
      function initializeGrids() {
        try {
          console.log('ğŸš€ AG-Grid ì´ˆê¸°í™” ì‹œì‘');
          
          if (typeof agGrid === 'undefined') {
            throw new Error('AG-Gridê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
          }

          // í—¤ë” ê·¸ë¦¬ë“œ ì„¤ì •
          const headerColumnDefs = [
            { 
              headerName: 'ì„ íƒ', 
              checkboxSelection: true, 
              headerCheckboxSelection: true, 
              width: 60,
              maxWidth: 60,
              pinned: 'left',
              suppressSizeToFit: true
            },
            { 
              headerName: 'ì¶œí•˜ë²ˆí˜¸', 
              field: 'outboundNo', 
              width: 150,
              minWidth: 130,
              cellClass: 'font-weight-bold text-primary',
              pinned: 'left'
            },
            { 
              headerName: 'ì‘ì„±ì¼ì', 
              field: 'writeDt', 
              width: 110,
              minWidth: 100
            },
            { 
              headerName: 'ê±°ë˜ì²˜ì½”ë“œ', 
              field: 'customerCd', 
              width: 120,
              minWidth: 100
            },
            { 
              headerName: 'ê±°ë˜ì²˜ëª…', 
              field: 'customerName', 
              flex: 2,
              minWidth: 150
            },
            { 
              headerName: 'ëŒ€í‘œëª…', 
              field: 'representativeNm', 
              flex: 1,
              minWidth: 100
            },
            {
              headerName: 'ì£¼ë¬¸ì¼ì', 
              field: 'orderDt', 
              width: 110,
              minWidth: 100,
              valueFormatter: params => {
                if (!params.value) return '';
                try {
                  return new Date(params.value).toLocaleDateString('ko-KR');
                } catch (e) {
                  return params.value;
                }
              }
            },
            {
              headerName: 'ì¶œê³ ì¼ì', 
              field: 'outboundDt', 
              width: 110,
              minWidth: 100,
              valueFormatter: params => {
                if (!params.value) return '';
                try {
                  return new Date(params.value).toLocaleDateString('ko-KR');
                } catch (e) {
                  return params.value;
                }
              }
            },
            { 
              headerName: 'í†µí™”', 
              field: 'money', 
              width: 80,
              maxWidth: 80
            },
            { 
              headerName: 'ë¹„ê³ ', 
              field: 'remarks', 
              flex: 1,
              minWidth: 120
            }
          ];

          const headerGridOptions = {
            columnDefs: headerColumnDefs,
            rowData: [],
            defaultColDef: {
              sortable: true,
              filter: true,
              resizable: true,
              flex: 0
            },
            rowSelection: 'single',
            onRowClicked: onHeaderRowClicked,
            onGridReady: function(params) {
              console.log('ğŸ“Š í—¤ë” ê·¸ë¦¬ë“œ ì¤€ë¹„ ì™„ë£Œ');
              headerGridApi = params.api;
              setTimeout(() => {
                if (headerGridApi && typeof headerGridApi.sizeColumnsToFit === 'function') {
                  headerGridApi.sizeColumnsToFit();
                }
              }, 200);
              loadOutboundList();
            },
            suppressHorizontalScroll: false,
            localeText: {
              noRowsToShow: 'ì¶œí•˜ ì˜ë¢°ì„œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'
            }
          };

          // ë””í…Œì¼ ê·¸ë¦¬ë“œ ì„¤ì • (â˜… OUTBOUND_STATUS í•„ë“œ ì¶”ê°€)
          const detailColumnDefs = [
            { 
              headerName: 'ì„ íƒ', 
              checkboxSelection: true, 
              headerCheckboxSelection: true, 
              width: 60,
              maxWidth: 60,
              suppressSizeToFit: true
            },
            { 
              headerName: 'ìˆœë²ˆ', 
              field: 'lineNo', 
              width: 80,
              maxWidth: 80, 
              cellClass: 'text-center' 
            },
            { 
              headerName: 'í’ˆëª©ì½”ë“œ', 
              field: 'itemCode', 
              width: 120,
              minWidth: 100
            },
            { 
              headerName: 'í’ˆëª©ëª…', 
              field: 'itemName', 
              flex: 2,
              minWidth: 150
            },
            { 
              headerName: 'ê·œê²©', 
              field: 'standard', 
              flex: 1,
              minWidth: 100
            },
            {
              headerName: 'ìˆ˜ëŸ‰', 
              field: 'qty', 
              width: 100,
              maxWidth: 120, 
              type: 'numericColumn',
              valueFormatter: params => Number(params.value || 0).toLocaleString(),
              cellClass: 'text-end'
            },
            { 
              headerName: 'ë‹¨ìœ„', 
              field: 'unit', 
              width: 80,
              maxWidth: 80
            },
            {
              headerName: 'ë‹¨ê°€', 
              field: 'unitPrice', 
              width: 110,
              minWidth: 100, 
              type: 'numericColumn',
              valueFormatter: params => Number(params.value || 0).toLocaleString(),
              cellClass: 'text-end'
            },
            {
              headerName: 'ê³µê¸‰ê°€ì•¡', 
              field: 'supplyAmount', 
              width: 120,
              minWidth: 100, 
              type: 'numericColumn',
              valueFormatter: params => Number(params.value || 0).toLocaleString(),
              cellClass: 'text-end'
            },
            {
              headerName: 'ë¶€ê°€ì„¸', 
              field: 'taxAmount', 
              width: 100,
              minWidth: 90, 
              type: 'numericColumn',
              valueFormatter: params => Number(params.value || 0).toLocaleString(),
              cellClass: 'text-end'
            },
            {
              headerName: 'í•©ê³„', 
              field: 'totalAmount', 
              width: 120,
              minWidth: 100, 
              type: 'numericColumn',
              cellClass: 'font-weight-bold text-end',
              valueFormatter: params => Number(params.value || 0).toLocaleString()
            },
            {
              headerName: 'ì¶œê³ ìƒíƒœ',
              field: 'outboundStatus',
              width: 100,
              minWidth: 90,
              cellClass: 'text-center',
              editable: true,
              cellEditor: 'agSelectCellEditor',
              cellEditorParams: {
                values: ['ëŒ€ê¸°', 'ì¤€ë¹„ì¤‘', 'ì¶œê³ ì¤‘', 'ì¶œê³ ì™„ë£Œ', 'ì·¨ì†Œ']
              },
              cellRenderer: function(params) {
                const status = params.value || 'ëŒ€ê¸°';
                return `<span class="status-badge status-${status}">${status}</span>`;
              }
            },
            { 
              headerName: 'ë¹„ê³ ', 
              field: 'remarks', 
              flex: 1,
              minWidth: 100
            }
          ];

          const detailGridOptions = {
            columnDefs: detailColumnDefs,
            rowData: [],
            defaultColDef: {
              sortable: true,
              filter: true,
              resizable: true,
              flex: 0,
              editable: false
            },
            rowSelection: 'multiple',
            onGridReady: function(params) {
              console.log('ğŸ“‹ ë””í…Œì¼ ê·¸ë¦¬ë“œ ì¤€ë¹„ ì™„ë£Œ');
              detailGridApi = params.api;
              setTimeout(() => {
                if (detailGridApi && typeof detailGridApi.sizeColumnsToFit === 'function') {
                  detailGridApi.sizeColumnsToFit();
                }
              }, 200);
            },
            onCellValueChanged: function(params) {
              // ì¶œê³ ìƒíƒœ ë³€ê²½ ì‹œ ì¦‰ì‹œ ì €ì¥
              if (params.colDef.field === 'outboundStatus') {
                updateOutboundStatus(params.data);
              }
            },
            suppressHorizontalScroll: false,
            localeText: {
              noRowsToShow: 'ì¶œí•˜ ì˜ë¢°ì„œ ìƒì„¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'
            }
          };

          // ê·¸ë¦¬ë“œ ìƒì„±
          const headerGridDiv = document.getElementById('headerGrid');
          if (agGrid.createGrid) {
            agGrid.createGrid(headerGridDiv, headerGridOptions);
          } else {
            new agGrid.Grid(headerGridDiv, headerGridOptions);
          }
          
          const detailGridDiv = document.getElementById('detailGrid');
          if (agGrid.createGrid) {
            agGrid.createGrid(detailGridDiv, detailGridOptions);
          } else {
            new agGrid.Grid(detailGridDiv, detailGridOptions);
          }
          
          console.log('âœ… AG-Grid ì´ˆê¸°í™” ì™„ë£Œ');

        } catch (error) {
          console.error('âŒ AG-Grid ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
          showErrorAlert('AG-Grid ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
      }

      // ===== ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ë“¤ =====
      function loadOutboundList() {
        console.log('ğŸ“¥ ì¶œí•˜ ì˜ë¢°ì„œ ëª©ë¡ ë¡œë“œ ì‹œì‘');
        
        if (headerGridApi) {
          safeSetRowData(headerGridApi, []);
        }
        
        fetch('/bsn/soutbounds')
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
          })
          .then(data => {
            console.log('ğŸ“Š ì¶œí•˜ ì˜ë¢°ì„œ ëª©ë¡ ë°ì´í„°:', data);
            
            if (headerGridApi) {
              safeSetRowData(headerGridApi, data || []);
              console.log(`âœ… ì¶œí•˜ ì˜ë¢°ì„œ ëª©ë¡ ë¡œë“œ ì™„ë£Œ: ${data?.length || 0}ê±´`);
              
              setTimeout(() => {
                if (headerGridApi && typeof headerGridApi.sizeColumnsToFit === 'function') {
                  headerGridApi.sizeColumnsToFit();
                }
              }, 200);
            }
          })
          .catch(error => {
            console.error('âŒ ì¶œí•˜ ì˜ë¢°ì„œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            if (headerGridApi) {
              safeSetRowData(headerGridApi, []);
            }
            showErrorAlert('ì¶œí•˜ ì˜ë¢°ì„œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
          });
      }

      function onHeaderRowClicked(event) {
        const outboundNo = event.data.outboundNo;
        selectedOutboundData = event.data;
        
        console.log('ğŸ¯ ì¶œí•˜ ì˜ë¢°ì„œ í—¤ë” í´ë¦­:', outboundNo);
        $('#selectedOutboundNo').text(`(${outboundNo})`);
        
        loadOutboundDetails(outboundNo);
      }

      function loadOutboundDetails(outboundNo) {
        console.log('ğŸ“¥ ì¶œí•˜ ì˜ë¢°ì„œ ìƒì„¸ ë¡œë“œ ì‹œì‘:', outboundNo);
        
        if (detailGridApi) {
          safeSetRowData(detailGridApi, []);
        }
        
        fetch(`/bsn/soutbounds/${encodeURIComponent(outboundNo)}/details`)
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
          })
          .then(data => {
            console.log('ğŸ“‹ ì¶œí•˜ ì˜ë¢°ì„œ ìƒì„¸ ë°ì´í„°:', data);
            
            if (detailGridApi) {
              safeSetRowData(detailGridApi, data || []);
              console.log(`âœ… ì¶œí•˜ ì˜ë¢°ì„œ ìƒì„¸ ë¡œë“œ ì™„ë£Œ: ${data?.length || 0}ê±´`);
              
              setTimeout(() => {
                if (detailGridApi && typeof detailGridApi.sizeColumnsToFit === 'function') {
                  detailGridApi.sizeColumnsToFit();
                }
              }, 200);
            }
          })
          .catch(error => {
            console.error('âŒ ì¶œí•˜ ì˜ë¢°ì„œ ìƒì„¸ ë¡œë“œ ì‹¤íŒ¨:', error);
            if (detailGridApi) {
              safeSetRowData(detailGridApi, []);
            }
            showErrorAlert('ì¶œí•˜ ì˜ë¢°ì„œ ìƒì„¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
          });
      }

      // ===== ìƒíƒœ ê´€ë ¨ í•¨ìˆ˜ë“¤ =====
      function loadStatusStats() {
        console.log('ğŸ“Š ìƒíƒœ í†µê³„ ë¡œë“œ ì‹œì‘');
        
        // ì„ì‹œ ë°ì´í„° (ì‹¤ì œ êµ¬í˜„ ì‹œ API í˜¸ì¶œ)
        const stats = [
          { status: 'ëŒ€ê¸°', count: 15, className: 'status-ëŒ€ê¸°' },
          { status: 'ì¤€ë¹„ì¤‘', count: 8, className: 'status-ì¤€ë¹„ì¤‘' },
          { status: 'ì¶œê³ ì¤‘', count: 5, className: 'status-ì¶œê³ ì¤‘' },
          { status: 'ì¶œê³ ì™„ë£Œ', count: 42, className: 'status-ì¶œê³ ì™„ë£Œ' },
          { status: 'ì·¨ì†Œ', count: 2, className: 'status-ì·¨ì†Œ' }
        ];
        
        const container = $('#statusStatsContainer');
        container.empty();
        
        stats.forEach(stat => {
          container.append(`
            <div class="status-card ${stat.className}">
              <h6>${stat.status}</h6>
              <div class="count">${stat.count}</div>
            </div>
          `);
        });
        
        $('#statusStatsSection').show();
      }

      function updateOutboundStatus(data) {
        console.log('ğŸ”„ ì¶œê³  ìƒíƒœ ì—…ë°ì´íŠ¸:', data);
        
        // API í˜¸ì¶œí•˜ì—¬ ìƒíƒœ ì—…ë°ì´íŠ¸
        fetch(`/bsn/soutbounds/${data.outboundNo}/details/${data.lineNo}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            outboundStatus: data.outboundStatus
          })
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
          }
          return response.json();
        })
        .then(result => {
          if (result.success) {
            console.log('âœ… ì¶œê³  ìƒíƒœ ì—…ë°ì´íŠ¸ ì„±ê³µ');
            showSuccessToast('ì¶œê³  ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
          } else {
            throw new Error(result.message || 'ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
          }
        })
        .catch(error => {
          console.error('âŒ ì¶œê³  ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
          showErrorAlert('ì¶œê³  ìƒíƒœ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
          // ì‹¤íŒ¨ ì‹œ ì›ë˜ ê°’ìœ¼ë¡œ ë³µêµ¬
          loadOutboundDetails(data.outboundNo);
        });
      }

      // ===== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ =====
      function showErrorAlert(message) {
        if (typeof Swal !== 'undefined') {
          Swal.fire('ì˜¤ë¥˜', message, 'error');
        } else {
          alert('ì˜¤ë¥˜: ' + message);
        }
      }

      function showSuccessAlert(message) {
        if (typeof Swal !== 'undefined') {
          Swal.fire('ì„±ê³µ', message, 'success');
        } else {
          alert('ì„±ê³µ: ' + message);
        }
      }

      function showSuccessToast(message) {
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            icon: 'success',
            title: message
          });
        } else {
          console.log('ì„±ê³µ:', message);
        }
      }

      // ===== ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ =====
      $('#btnRefresh').click(function() {
        console.log('ğŸ”„ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ í´ë¦­');
        loadOutboundList();
        if (detailGridApi) {
          safeSetRowData(detailGridApi, []);
        }
        $('#selectedOutboundNo').text('');
        selectedOutboundData = null;
      });

      $('#btnStatusStats').click(function() {
        console.log('ğŸ“Š ìƒíƒœ í˜„í™© ë²„íŠ¼ í´ë¦­');
        if ($('#statusStatsSection').is(':visible')) {
          $('#statusStatsSection').hide();
        } else {
          loadStatusStats();
        }
      });

      $('#btnCloseStats').click(function() {
        $('#statusStatsSection').hide();
      });

      $('#btnCreateFromOrder').click(function() {
        console.log('ğŸ“‹ ì£¼ë¬¸ì„œì—ì„œ ìƒì„± ë²„íŠ¼ í´ë¦­');
        loadOrderList();
        $('#orderSelectModal').modal('show');
      });

      $('#btnBulkStatusUpdate').click(function() {
        console.log('ğŸ“ ìƒíƒœ ì¼ê´„ë³€ê²½ ë²„íŠ¼ í´ë¦­');
        
        let selectedRows = [];
        if (detailGridApi && typeof detailGridApi.getSelectedRows === 'function') {
          selectedRows = detailGridApi.getSelectedRows();
        }
        
        if (selectedRows.length === 0) {
          showErrorAlert('ìƒíƒœë¥¼ ë³€ê²½í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }
        
        $('#selectedItemCount').text(selectedRows.length);
        $('#bulkStatusModal').modal('show');
      });

      $('#btnConfirmBulkStatus').click(function() {
        const newStatus = $('#bulkStatusSelect').val();
        if (!newStatus) {
          showErrorAlert('ë³€ê²½í•  ìƒíƒœë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }
        
        const selectedRows = detailGridApi.getSelectedRows();
        console.log('ğŸ”„ ì¼ê´„ ìƒíƒœ ë³€ê²½:', newStatus, selectedRows.length + 'ê±´');
        
        if (!selectedOutboundData || !selectedOutboundData.outboundNo) {
          showErrorAlert('ì¶œí•˜ ì˜ë¢°ì„œë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }
        
        // ì„ íƒëœ í–‰ë“¤ì˜ ë¼ì¸ë²ˆí˜¸ ì¶”ì¶œ
        const lineNos = selectedRows.map(row => row.lineNo);
        
        // ì¼ê´„ ìƒíƒœ ì—…ë°ì´íŠ¸ API í˜¸ì¶œ
        fetch(`/bsn/soutbounds/${selectedOutboundData.outboundNo}/status/bulk`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            outboundStatus: newStatus,
            lineNos: lineNos
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // ì„ íƒëœ í–‰ë“¤ì˜ ìƒíƒœ ì—…ë°ì´íŠ¸
            selectedRows.forEach(row => {
              row.outboundStatus = newStatus;
            });
            
            // ê·¸ë¦¬ë“œ ìƒˆë¡œê³ ì¹¨
            detailGridApi.refreshCells();
            
            $('#bulkStatusModal').modal('hide');
            showSuccessAlert(`${data.updatedCount || selectedRows.length}ê°œ í•­ëª©ì˜ ìƒíƒœê°€ "${newStatus}"(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            
            // ìƒì„¸ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ ë™ê¸°í™”
            setTimeout(() => {
              loadOutboundDetails(selectedOutboundData.outboundNo);
            }, 500);
          } else {
            showErrorAlert(data.message || 'ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        })
        .catch(error => {
          console.error('âŒ ì¼ê´„ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨:', error);
          showErrorAlert('ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
      });

      // ê¸°ì¡´ ë²„íŠ¼ë“¤ (ê°„ì†Œí™”)
      $('#btnNew, #btnEdit, #btnDelete').click(function() {
        const action = $(this).find('i').hasClass('fa-plus') ? 'ì‹ ê·œ' : 
                      $(this).find('i').hasClass('fa-edit') ? 'ìˆ˜ì •' : 'ì‚­ì œ';
        showErrorAlert(`${action} ê¸°ëŠ¥ì„ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤.`);
      });

      $('#btnExportExcel').click(function() {
        showErrorAlert('ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ì„ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤.');
      });

      // ì£¼ë¬¸ì„œ ëª©ë¡ ë¡œë“œ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
      function loadOrderList() {
        const tbody = $('#orderListBody');
        tbody.html('<tr><td colspan="6" class="text-center"><div class="spinner-border spinner-border-sm"></div> ì£¼ë¬¸ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>');
        
        fetch('/bsn/orders')
          .then(response => response.json())
          .then(orders => {
            tbody.empty();
            if (orders && orders.length > 0) {
              orders.forEach(order => {
                tbody.append(`
                  <tr>
                    <td>
                      <button class="btn btn-sm btn-success select-order" data-order-no="${order.orderNo}">
                        ì„ íƒ
                      </button>
                    </td>
                    <td>${order.orderNo}</td>
                    <td>${order.orderDt}</td>
                    <td>${order.customerNm || ''}</td>
                    <td class="text-end">-</td>
                    <td><span class="badge bg-warning">ëŒ€ê¸°</span></td>
                  </tr>
                `);
              });
            } else {
              tbody.html('<tr><td colspan="6" class="text-center text-muted">ì¶œê³  ê°€ëŠ¥í•œ ì£¼ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>');
            }
          })
          .catch(error => {
            console.error('ì£¼ë¬¸ì„œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            tbody.html('<tr><td colspan="6" class="text-center text-danger">ì£¼ë¬¸ì„œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</td></tr>');
          });
      }

      // ì£¼ë¬¸ì„œ ì„ íƒ ì´ë²¤íŠ¸ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
      $(document).on('click', '.select-order', function() {
        const orderNo = $(this).data('order-no');
        
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            title: 'ì¶œí•˜ ì˜ë¢°ì„œ ìƒì„±',
            text: `ì£¼ë¬¸ì„œ "${orderNo}"ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¶œí•˜ ì˜ë¢°ì„œë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#1cc88a',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'ìƒì„±',
            cancelButtonText: 'ì·¨ì†Œ'
          }).then((result) => {
            if (result.isConfirmed) {
              createOutboundFromOrder(orderNo);
            }
          });
        }
      });

      function createOutboundFromOrder(orderNo) {
        fetch('/bsn/soutbounds/create-from-order', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ orderNo: orderNo })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showSuccessAlert(`ì¶œí•˜ ì˜ë¢°ì„œ "${data.outboundNo}"ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            $('#orderSelectModal').modal('hide');
            loadOutboundList();
          } else {
            showErrorAlert(data.message || 'ì¶œí•˜ ì˜ë¢°ì„œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        })
        .catch(error => {
          console.error('ì¶œí•˜ ì˜ë¢°ì„œ ìƒì„± ì‹¤íŒ¨:', error);
          showErrorAlert('ì¶œí•˜ ì˜ë¢°ì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
      }

      // ===== ì´ˆê¸°í™” =====
      console.log('ğŸ¯ ì¶œí•˜ ì˜ë¢°ì„œ ê´€ë¦¬ ì´ˆê¸°í™” ì‹œì‘');
      
      function waitForAgGrid() {
        if (typeof agGrid !== 'undefined') {
          console.log('âœ… AG-Grid ë¡œë“œ í™•ì¸ë¨');
          setTimeout(initializeGrids, 100);
        } else {
          console.log('â³ AG-Grid ë¡œë“œ ëŒ€ê¸° ì¤‘...');
          setTimeout(waitForAgGrid, 100);
        }
      }
      
      setTimeout(waitForAgGrid, 500);
      
      console.log('ğŸ‰ ì¶œí•˜ ì˜ë¢°ì„œ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');
    });
    /*]]>*/
    </script>

</div>
</html>