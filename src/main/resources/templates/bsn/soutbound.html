<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/default}">
<head>
  <meta charset="UTF-8" />
  <title>ì¶œí•˜ ì˜ë¢°ì„œ ê´€ë¦¬</title>
  <style>
    /* ----- ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ë° ë””ìì¸ ----- */
    .section-box {
      padding: 15px;
      border: 1px solid #e3e6f0;
      border-radius: 8px;
      background-color: #ffffff;
      margin-bottom: 15px;
      box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    }
    .section-box h6 {
      margin-bottom: 12px;
      color: #4e73df;
      font-weight: 700;
      border-bottom: 2px solid #4e73df;
      padding-bottom: 8px;
    }
    .btn-create { background-color: #1cc88a; border-color: #1cc88a; color: white; }
    .btn-create:hover { background-color: #17a673; border-color: #17a673; }
    .btn-edit { background-color: #36b9cc; border-color: #36b9cc; color: white; }
    .btn-edit:hover { background-color: #2c9faf; border-color: #2c9faf; }
    .btn-delete { background-color: #e74a3b; border-color: #e74a3b; color: white; }
    .btn-delete:hover { background-color: #c0392b; border-color: #c0392b; }
    .header-grid, .detail-grid { height: 350px; width: 100%; }

    /* ----- AG-Grid ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ ----- */
    .ag-theme-alpine {
      --ag-header-background-color: #f8f9fc;
      --ag-header-foreground-color: #5a5c69;
      --ag-border-color: #e3e6f0;
      --ag-row-hover-color: #f0f3ff;
      --ag-selected-row-background-color: #dfe7ff;
    }
    .ag-theme-alpine .ag-header-cell { font-weight: 600; }
    .text-end { text-align: right !important; }

    /* ----- ì¶œê³ ìƒíƒœ ë°°ì§€ ìŠ¤íƒ€ì¼ ----- */
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-align: center;
      min-width: 60px;
      display: inline-block;
      color: white;
    }
    .status-ëŒ€ê¸° { background-color: #ffc107; color: #212529; }
    .status-ì¤€ë¹„ì¤‘ { background-color: #17a2b8; }
    .status-ì¶œê³ ì¤‘ { background-color: #007bff; }
    .status-ì¶œê³ ì™„ë£Œ { background-color: #28a745; }
    .status-ì·¨ì†Œ { background-color: #dc3545; }

    /* ----- ì¶œê³  ìƒíƒœ í†µê³„ ì¹´ë“œ ----- */
    .status-stats { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
    .status-card {
      flex: 1;
      min-width: 120px;
      padding: 10px 15px;
      border-radius: 8px;
      text-align: center;
      color: white;
      font-weight: 600;
    }
    .status-card h6 { margin: 0; font-size: 0.9rem; opacity: 0.9; border: none; }
    .status-card .count { font-size: 1.5rem; font-weight: bold; margin: 5px 0; }
    .status-card .amount { font-size: 0.8rem; opacity: 0.8; }
  </style>
</head>
<div layout:fragment="content" class="container-fluid px-3 py-2">

    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h4 class="mb-0"><i class="fas fa-shipping-fast mr-2"></i>ì¶œí•˜ ì˜ë¢°ì„œ ê´€ë¦¬</h4>
        <small class="text-muted">ì¶œí•˜ ì˜ë¢°ì„œ ë“±ë¡, ìˆ˜ì •, ì‚­ì œ ë° ì¶œê³  ìƒíƒœ ê´€ë¦¬</small>
      </div>
      <div>
        <button type="button" class="btn btn-info btn-sm me-1" id="btnStatusStats"><i class="fas fa-chart-pie"></i> ìƒíƒœ í˜„í™©</button>
        <button type="button" class="btn btn-warning btn-sm me-1" id="btnCreateFromOrder"><i class="fas fa-plus-circle"></i> ì£¼ë¬¸ì„œì—ì„œ ìƒì„±</button>
        <button type="button" class="btn btn-create btn-sm me-1" id="btnNew"><i class="fas fa-plus"></i> ì‹ ê·œ</button>
        <button type="button" class="btn btn-delete btn-sm me-1" id="btnDelete"><i class="fas fa-trash"></i> ì‚­ì œ</button>
      </div>
    </div>

    <!-- ì¶œê³  ìƒíƒœ í†µê³„ (ì ‘ì„ ìˆ˜ ìˆëŠ” ì¹´ë“œ) -->
    <div class="section-box" id="statusStatsSection" style="display: none;">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6><i class="fas fa-chart-bar mr-2"></i>ì¶œê³  ìƒíƒœ í˜„í™©</h6>
        <button class="btn btn-sm btn-outline-secondary" id="btnCloseStats"><i class="fas fa-times"></i></button>
      </div>
      <div class="status-stats" id="statusStatsContainer"></div>
    </div>

    <!-- ì¶œê³  í—¤ë” ê·¸ë¦¬ë“œ -->
    <div class="section-box">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6><i class="fas fa-list mr-2"></i>ì¶œí•˜ ì˜ë¢°ì„œ ëª©ë¡</h6>
        <button id="btnRefresh" class="btn btn-secondary btn-sm me-1"><i class="fas fa-sync"></i> ìƒˆë¡œê³ ì¹¨</button>
      </div>
      <div id="headerGrid" class="ag-theme-alpine header-grid"></div>
    </div>

    <!-- ì¶œê³  ë””í…Œì¼ ê·¸ë¦¬ë“œ -->
    <div class="section-box">
      <h6><i class="fas fa-boxes mr-2"></i>ì¶œí•˜ ì˜ë¢°ì„œ ìƒì„¸ <span id="selectedOutboundNo" class="text-muted fs-6"></span></h6>
      <div id="detailGrid" class="ag-theme-alpine detail-grid"></div>
    </div>

    <!-- ì£¼ë¬¸ì„œ ì„ íƒ ëª¨ë‹¬ -->
    <div class="modal fade" id="orderSelectModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="fas fa-clipboard-list mr-2"></i>ì£¼ë¬¸ì„œ ì„ íƒ</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="table-responsive">
              <table class="table table-bordered table-hover">
                <thead class="table-light">
                  <tr><th>ì„ íƒ</th><th>ì£¼ë¬¸ë²ˆí˜¸</th><th>ì£¼ë¬¸ì¼ì</th><th>ê±°ë˜ì²˜ëª…</th><th>ì‘ì„±ì</th></tr>
                </thead>
                <tbody id="orderListBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', () => {
      console.log('âœ… ì¶œí•˜ ì˜ë¢°ì„œ ê´€ë¦¬ í˜ì´ì§€ ë¡œë“œ ì‹œì‘');
      
      let headerGridApi, detailGridApi;

      // AG-Grid ì»¬ëŸ¼ ì •ì˜
      const headerColumnDefs = [
          { headerName: 'ì„ íƒ', checkboxSelection: true, width: 60, pinned: 'left' },
          { headerName: 'ì¶œí•˜ë²ˆí˜¸', field: 'outboundNo', width: 150, cellClass: 'font-weight-bold text-primary', pinned: 'left' },
          { 
            headerName: 'ì „ì²´ìƒíƒœ', 
            field: 'overallStatus',
            width: 110,
            cellRenderer: params => {
              const status = params.value || 'ëŒ€ê¸°';
              return `<span class="status-badge status-${status}">${status}</span>`;
            }
          },
          { headerName: 'ì‘ì„±ì¼ì', field: 'writeDt', width: 110 },
          { headerName: 'ê±°ë˜ì²˜ëª…', field: 'customerName', flex: 2, minWidth: 150 },
          { headerName: 'ëŒ€í‘œëª…', field: 'representativeNm', flex: 1, minWidth: 100 },
          { headerName: 'ì¶œê³ ì¼ì', field: 'outboundDt', width: 110, valueFormatter: p => p.value ? new Date(p.value).toLocaleDateString('ko-KR') : '' },
          { headerName: 'í†µí™”', field: 'money', width: 80 },
          { headerName: 'ë¹„ê³ ', field: 'remarks', flex: 1, minWidth: 120 }
      ];

      const detailColumnDefs = [
          { headerName: 'ìˆœë²ˆ', field: 'lineNo', width: 80, cellClass: 'text-center' },
          { headerName: 'í’ˆëª©ì½”ë“œ', field: 'itemCode', width: 120 },
          { headerName: 'í’ˆëª©ëª…', field: 'itemName', flex: 2, minWidth: 150 },
          { headerName: 'ê·œê²©', field: 'standard', flex: 1, minWidth: 100 },
          { headerName: 'ìˆ˜ëŸ‰', field: 'qty', width: 100, type: 'numericColumn', valueFormatter: p => Number(p.value || 0).toLocaleString(), cellClass: 'text-end' },
          { headerName: 'ì¶œê³ ìƒíƒœ', field: 'outboundStatus', width: 100, cellClass: 'text-center',
            cellRenderer: params => `<span class="status-badge status-${params.value}">${params.value}</span>`
          },
          { headerName: 'ë¹„ê³ ', field: 'remarks', flex: 1, minWidth: 100 }
      ];

      // AG-Grid ì˜µì…˜
      const commonGridOptions = {
          defaultColDef: { sortable: true, filter: true, resizable: true, flex: 0 },
          suppressHorizontalScroll: false,
          localeText: { noRowsToShow: 'ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.' }
      };

      // â˜…â˜…â˜… ë³€ê²½: ê·¸ë¦¬ë“œ ìƒì„±ê³¼ API í• ë‹¹ì„ ë¶„ë¦¬í•©ë‹ˆë‹¤. â˜…â˜…â˜…
      const headerGridOptions = {
          ...commonGridOptions,
          columnDefs: headerColumnDefs,
          rowSelection: 'multiple',
          onRowClicked: e => loadOutboundDetails(e.data.outboundNo),
          onGridReady: (params) => {
              console.log('Header Grid is ready.');
              headerGridApi = params.api; // API í• ë‹¹
              loadOutboundList(); // ê·¸ë¦¬ë“œê°€ ì¤€ë¹„ëœ í›„ ë°ì´í„° ë¡œë“œ
          }
      };

      const detailGridOptions = {
          ...commonGridOptions,
          columnDefs: detailColumnDefs,
          onGridReady: (params) => {
              console.log('Detail Grid is ready.');
              detailGridApi = params.api; // API í• ë‹¹
          }
      };

      // ê·¸ë¦¬ë“œ ìƒì„±
      agGrid.createGrid(document.getElementById('headerGrid'), headerGridOptions);
      agGrid.createGrid(document.getElementById('detailGrid'), detailGridOptions);

      // ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
      const fetchData = async (url, options = {}) => {
        try {
          const response = await fetch(url, options);
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({ message: response.statusText }));
            throw new Error(errorData.message || `HTTP ${response.status}`);
          }
          return response.json();
        } catch (error) {
          console.error(`ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${url}`, error);
          Swal.fire('ì˜¤ë¥˜', `ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
          throw error;
        }
      };

      const loadOutboundList = () => {
        if (!headerGridApi) {
            console.warn('Header Grid API is not ready yet.');
            return;
        }
        fetchData('/bsn/soutbounds').then(data => {
            headerGridApi.setGridOption('rowData', data || []);
        });
      };

      const loadOutboundDetails = (outboundNo) => {
        if (!detailGridApi) {
            console.warn('Detail Grid API is not ready yet.');
            return;
        }
        document.getElementById('selectedOutboundNo').textContent = `(${outboundNo})`;
        fetchData(`/bsn/soutbounds/${outboundNo}/details`).then(data => {
            detailGridApi.setGridOption('rowData', data || []);
        });
      };

      const loadOrderList = () => {
        const tbody = document.getElementById('orderListBody');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center"><div class="spinner-border spinner-border-sm"></div></td></tr>';
        fetchData('/bsn/orders').then(orders => {
          tbody.innerHTML = '';
          if (orders && orders.length > 0) {
            orders.forEach(order => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td><button class="btn btn-sm btn-success select-order" data-order-no="${order.orderNo}">ì„ íƒ</button></td>
                <td>${order.orderNo}</td>
                <td>${order.orderDt}</td>
                <td>${order.customerNm || ''}</td>
                <td>${order.orderWriter || ''}</td>
              `;
              tbody.appendChild(tr);
            });
          } else {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">ì¶œê³  ê°€ëŠ¥í•œ ì£¼ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
          }
        });
      };

      const loadStatusStats = () => {
        fetchData('/bsn/soutbounds/stats').then(stats => {
          const container = document.getElementById('statusStatsContainer');
          container.innerHTML = '';
          stats.forEach(stat => {
            const card = document.createElement('div');
            card.className = `status-card status-${stat.STATUS}`;
            card.innerHTML = `
              <h6>${stat.STATUS}</h6>
              <div class="count">${stat.COUNT}</div>
              <div class="amount">${Number(stat.TOTALAMOUNT || 0).toLocaleString()} ì›</div>
            `;
            container.appendChild(card);
          });
          document.getElementById('statusStatsSection').style.display = 'block';
        });
      };

      // ì£¼ë¬¸ì„œ ê¸°ë°˜ ì¶œê³  ìƒì„±
      const createOutboundFromOrder = (orderNo) => {
        Swal.fire({
          title: 'ì¶œí•˜ ì˜ë¢°ì„œ ìƒì„±',
          text: `ì£¼ë¬¸ì„œ "${orderNo}"ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¶œí•˜ ì˜ë¢°ì„œë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
          icon: 'question',
          showCancelButton: true,
          confirmButtonText: 'ìƒì„±',
          cancelButtonText: 'ì·¨ì†Œ'
        }).then((result) => {
          if (result.isConfirmed) {
            fetchData('/bsn/soutbounds/create-from-order', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ orderNo })
            }).then(data => {
              if (data.success) {
                Swal.fire('ì„±ê³µ', `ì¶œí•˜ ì˜ë¢°ì„œ "${data.outboundNo}"ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                bootstrap.Modal.getInstance(document.getElementById('orderSelectModal')).hide();
                loadOutboundList();
              }
            });
          }
        });
      };
      
      // ì¶œê³  ì‚­ì œ
      const deleteSelectedOutbounds = () => {
        if (!headerGridApi) return;
        const selectedRows = headerGridApi.getSelectedRows();
        if (selectedRows.length === 0) {
            return Swal.fire('ì•Œë¦¼', 'ì‚­ì œí•  ì¶œí•˜ ì˜ë¢°ì„œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
        }
        Swal.fire({
            title: `${selectedRows.length}ê±´ ì‚­ì œ í™•ì¸`,
            text: "ì„ íƒí•œ í•­ëª©ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#e74a3b',
            confirmButtonText: 'ì‚­ì œ',
            cancelButtonText: 'ì·¨ì†Œ'
        }).then(result => {
            if (result.isConfirmed) {
                const deletePromises = selectedRows.map(row => 
                    fetchData(`/bsn/soutbounds/${row.outboundNo}`, { method: 'DELETE' })
                );
                Promise.all(deletePromises)
                    .then(() => {
                        Swal.fire('ì‚­ì œ ì™„ë£Œ', `${selectedRows.length}ê±´ì˜ ì¶œí•˜ ì˜ë¢°ì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                        loadOutboundList();
                        if(detailGridApi) detailGridApi.setGridOption('rowData', []);
                        document.getElementById('selectedOutboundNo').textContent = '';
                    })
                    .catch(e => console.error(e));
            }
        });
      };

      // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
      document.getElementById('btnRefresh').addEventListener('click', loadOutboundList);
      document.getElementById('btnStatusStats').addEventListener('click', loadStatusStats);
      document.getElementById('btnCloseStats').addEventListener('click', () => document.getElementById('statusStatsSection').style.display = 'none');
      document.getElementById('btnCreateFromOrder').addEventListener('click', () => {
        loadOrderList();
        new bootstrap.Modal(document.getElementById('orderSelectModal')).show();
      });
      document.getElementById('orderListBody').addEventListener('click', e => {
        if (e.target.classList.contains('select-order')) {
          createOutboundFromOrder(e.target.dataset.orderNo);
        }
      });
      document.getElementById('btnDelete').addEventListener('click', deleteSelectedOutbounds);
      document.getElementById('btnNew').addEventListener('click', () => Swal.fire('ì¤€ë¹„ì¤‘', 'ì‹ ê·œ ì¶œí•˜ ì˜ë¢°ì„œ ì‘ì„± í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.', 'info'));

      // ì´ˆê¸° ë°ì´í„° ë¡œë“œëŠ” onGridReady ì½œë°±ì—ì„œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
      console.log('ğŸ‰ ì¶œí•˜ ì˜ë¢°ì„œ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');
    });
    </script>
</div>
</html>
