<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/default}">
<head>
  <meta charset="UTF-8" />
  <title>ì¶œê³  ê´€ë¦¬</title>
  <style>
    .section-box {
      padding: 15px;
      border: 1px solid #e3e6f0;
      border-radius: 8px;
      background-color: #ffffff;
      margin-bottom: 15px;
      box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    }

    .section-box h6 {
      margin-bottom: 12px;
      color: #5a5c69;
      font-weight: 700;
      border-bottom: 2px solid #4e73df;
      padding-bottom: 8px;
    }

    .btn-create { background-color: #1cc88a; border-color: #1cc88a; color: white; }
    .btn-create:hover { background-color: #17a673; border-color: #17a673; }

    .btn-edit { background-color: #36b9cc; border-color: #36b9cc; color: white; }
    .btn-edit:hover { background-color: #2c9faf; border-color: #2c9faf; }

    .btn-delete { background-color: #e74a3b; border-color: #e74a3b; color: white; }
    .btn-delete:hover { background-color: #c0392b; border-color: #c0392b; }

    .header-grid { height: 350px; width: 100%; }
    .detail-grid { height: 320px; width: 100%; }

    /* AG-Grid ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ */
    .ag-theme-alpine {
      --ag-background-color: #ffffff;
      --ag-header-background-color: #f8f9fc;
      --ag-header-foreground-color: #5a5c69;
      --ag-border-color: #e3e6f0;
      --ag-row-hover-color: #f8f9fc;
      --ag-selected-row-background-color: #eaecf4;
      --ag-font-size: 14px;
      width: 100% !important;
    }

    /* ê·¸ë¦¬ë“œ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
    #headerGrid, #detailGrid {
      width: 100% !important;
      min-width: 100%;
    }

    /* ìˆ˜ì¹˜ ì»¬ëŸ¼ ìš°ì¸¡ ì •ë ¬ */
    .ag-theme-alpine .text-end {
      text-align: right !important;
    }

    /* ì²´í¬ë°•ìŠ¤ ì»¬ëŸ¼ ì¤‘ì•™ ì •ë ¬ */
    .ag-theme-alpine .ag-checkbox-input-wrapper {
      text-align: center;
    }

    /* ê·¸ë¦¬ë“œ í—¤ë” ìŠ¤íƒ€ì¼ ê°œì„  */
    .ag-theme-alpine .ag-header-cell {
      font-weight: 600;
      border-right: 1px solid #e3e6f0;
    }

    /* ì¶œê³ ìƒíƒœ ë°°ì§€ ìŠ¤íƒ€ì¼ */
    .ag-theme-alpine .badge {
      font-size: 0.75rem;
      padding: 0.25em 0.5em;
      border-radius: 0.375rem;
      font-weight: 600;
    }

    .ag-theme-alpine .bg-success {
      background-color: #198754 !important;
      color: white;
    }

    .ag-theme-alpine .bg-primary {
      background-color: #0d6efd !important;
      color: white;
    }

    .ag-theme-alpine .bg-danger {
      background-color: #dc3545 !important;
      color: white;
    }

    .ag-theme-alpine .bg-warning {
      background-color: #ffc107 !important;
    }

    .ag-theme-alpine .bg-secondary {
      background-color: #6c757d !important;
      color: white;
    }
  </style>
</head>
<div layout:fragment="content" class="container-fluid px-3 py-2">

    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h4 class="mb-0">
          <i class="fas fa-shipping-fast mr-2"></i>ì¶œê³  ê´€ë¦¬
        </h4>
        <small class="text-muted">ì¶œê³  ë“±ë¡, ìˆ˜ì •, ì‚­ì œ ë° ì¡°íšŒ</small>
      </div>
      <div>
        <button type="button" class="btn btn-warning btn-sm me-1" id="btnCreateFromOrder">
          <i class="fas fa-plus-circle"></i> ì£¼ë¬¸ì„œì—ì„œ ìƒì„±
        </button>
        <button type="button" class="btn btn-create btn-sm me-1" id="btnNew">
          <i class="fas fa-plus"></i> ì‹ ê·œ
        </button>
        <button type="button" class="btn btn-edit btn-sm me-1" id="btnEdit">
          <i class="fas fa-edit"></i> ìˆ˜ì •
        </button>
        <button type="button" class="btn btn-delete btn-sm me-1" id="btnDelete">
          <i class="fas fa-trash"></i> ì‚­ì œ
        </button>
        <button type="button" class="btn btn-secondary btn-sm" id="btnDebug">
          <i class="fas fa-bug"></i> ë””ë²„ê·¸
        </button>
      </div>
    </div>

    <!-- ì¶œê³  í—¤ë” ê·¸ë¦¬ë“œ -->
    <div class="section-box">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6><i class="fas fa-list mr-2"></i>ì¶œê³  ëª©ë¡</h6>
        <button id="btnRefresh" class="btn btn-secondary btn-sm"><i class="fas fa-sync"></i> ìƒˆë¡œê³ ì¹¨</button>
      </div>
      <div id="headerGrid" class="ag-theme-alpine header-grid"></div>
    </div>

    <!-- ì¶œê³  ë””í…Œì¼ ê·¸ë¦¬ë“œ -->
    <div class="section-box">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6>
          <i class="fas fa-boxes mr-2"></i>ì¶œê³  ìƒì„¸
          <span id="selectedOutboundNo" class="text-muted fs-6"></span>
        </h6>
        <div>
          <button id="btnAddDetailRow" class="btn btn-info btn-sm"><i class="fas fa-plus"></i> í–‰ ì¶”ê°€</button>
          <button id="btnDeleteDetailRow" class="btn btn-warning btn-sm"><i class="fas fa-minus"></i> í–‰ ì‚­ì œ</button>
        </div>
      </div>
      <div id="detailGrid" class="ag-theme-alpine detail-grid"></div>
    </div>

    <!-- ì£¼ë¬¸ì„œ ì„ íƒ ëª¨ë‹¬ -->
    <div class="modal fade" id="orderSelectModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-clipboard-list mr-2"></i>ì£¼ë¬¸ì„œ ì„ íƒ
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="table-responsive">
              <table class="table table-bordered">
                <thead class="table-light">
                  <tr>
                    <th>ì„ íƒ</th>
                    <th>ì£¼ë¬¸ë²ˆí˜¸</th>
                    <th>ì£¼ë¬¸ì¼ì</th>
                    <th>ê±°ë˜ì²˜ëª…</th>
                    <th>í•©ê³„ê¸ˆì•¡</th>
                    <th>ì¶œê³ ìƒíƒœ</th>
                  </tr>
                </thead>
                <tbody id="orderListBody">
                  <tr>
                    <td colspan="6" class="text-center">
                      <div class="spinner-border spinner-border-sm"></div>
                      ì£¼ë¬¸ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
    /*<![CDATA[*/
    $(document).ready(function() {
      console.log('âœ… ì¶œê³ ê´€ë¦¬ í˜ì´ì§€ ë¡œë“œ ì‹œì‘');
      
      // ===== ì „ì—­ ë³€ìˆ˜ =====
      let headerGridApi, detailGridApi;
      let selectedOutboundData = null;

      // ===== AG-Grid ì•ˆì „í•œ ë°ì´í„° ì„¤ì • í•¨ìˆ˜ =====
      function safeSetRowData(gridApi, data) {
        if (!gridApi) {
          console.warn('âš ï¸ Grid APIê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        
        try {
          // AG-Grid ë²„ì „ë³„ ëŒ€ì‘
          if (typeof gridApi.setRowData === 'function') {
            console.log('ğŸ“Š setRowData ì‚¬ìš©');
            gridApi.setRowData(data);
          } else if (typeof gridApi.setGridOption === 'function') {
            console.log('ğŸ“Š setGridOption ì‚¬ìš©');
            gridApi.setGridOption('rowData', data);
          } else if (gridApi.gridOptions) {
            console.log('ğŸ“Š gridOptions ì§ì ‘ ì„¤ì •');
            gridApi.gridOptions.rowData = data;
            gridApi.refreshCells();
          } else {
            console.error('âŒ ì§€ì›ë˜ëŠ” ë°ì´í„° ì„¤ì • ë°©ë²•ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            console.log('ğŸ” ì‚¬ìš© ê°€ëŠ¥í•œ gridApi ë©”ì„œë“œ:', Object.keys(gridApi));
          }
        } catch (error) {
          console.error('âŒ ë°ì´í„° ì„¤ì • ì‹¤íŒ¨:', error);
        }
      }

      // ===== AG-Grid ì´ˆê¸°í™” =====
      function initializeGrids() {
        try {
          console.log('ğŸš€ AG-Grid ì´ˆê¸°í™” ì‹œì‘');
          
          if (typeof agGrid === 'undefined') {
            throw new Error('AG-Gridê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
          }

          // í—¤ë” ê·¸ë¦¬ë“œ ì„¤ì • (ë ˆì´ì•„ì›ƒ ê°œì„ )
          const headerColumnDefs = [
            { 
              headerName: 'ì„ íƒ', 
              checkboxSelection: true, 
              headerCheckboxSelection: true, 
              width: 60,
              maxWidth: 60,
              pinned: 'left',
              suppressSizeToFit: true
            },
            { 
              headerName: 'ì¶œê³ ë²ˆí˜¸', 
              field: 'outboundNo', 
              width: 150,
              minWidth: 130,
              cellClass: 'font-weight-bold text-primary',
              pinned: 'left'
            },
            { 
              headerName: 'ì‘ì„±ì¼ì', 
              field: 'writeDt', 
              width: 110,
              minWidth: 100
            },
            { 
              headerName: 'ê±°ë˜ì²˜ì½”ë“œ', 
              field: 'customerCd', 
              width: 120,
              minWidth: 100
            },
            { 
              headerName: 'ê±°ë˜ì²˜ëª…', 
              field: 'customerName', 
              flex: 2,
              minWidth: 150
            },
            { 
              headerName: 'ëŒ€í‘œëª…', 
              field: 'representativeNm', 
              flex: 1,
              minWidth: 100
            },
            {
              headerName: 'ì£¼ë¬¸ì¼ì', 
              field: 'orderDt', 
              width: 110,
              minWidth: 100,
              valueFormatter: params => {
                if (!params.value) return '';
                try {
                  return new Date(params.value).toLocaleDateString('ko-KR');
                } catch (e) {
                  return params.value;
                }
              }
            },
            {
              headerName: 'ì¶œê³ ì¼ì', 
              field: 'outboundDt', 
              width: 110,
              minWidth: 100,
              valueFormatter: params => {
                if (!params.value) return '';
                try {
                  return new Date(params.value).toLocaleDateString('ko-KR');
                } catch (e) {
                  return params.value;
                }
              }
            },
            { 
              headerName: 'í†µí™”', 
              field: 'money', 
              width: 80,
              maxWidth: 80
            },
            { 
              headerName: 'ë¹„ê³ ', 
              field: 'remarks', 
              flex: 1,
              minWidth: 120
            }
          ];

          const headerGridOptions = {
            columnDefs: headerColumnDefs,
            rowData: [], // ì´ˆê¸° ë¹ˆ ë°ì´í„°
            defaultColDef: {
              sortable: true,
              filter: true,
              resizable: true,
              flex: 0 // flex ê¸°ë³¸ê°’ì„ 0ìœ¼ë¡œ ì„¤ì •
            },
            rowSelection: 'single',
            onRowClicked: onHeaderRowClicked,
            onGridReady: function(params) {
              console.log('ğŸ“Š í—¤ë” ê·¸ë¦¬ë“œ ì¤€ë¹„ ì™„ë£Œ');
              headerGridApi = params.api;
              
              // ì»¬ëŸ¼ í¬ê¸° ì¡°ì • - ì—¬ëŸ¬ ë°©ë²• ì‹œë„
              setTimeout(() => {
                if (headerGridApi) {
                  try {
                    // ë°©ë²• 1: sizeColumnsToFit ì‹œë„
                    if (typeof headerGridApi.sizeColumnsToFit === 'function') {
                      headerGridApi.sizeColumnsToFit();
                      console.log('âœ… sizeColumnsToFit ì ìš©ë¨');
                    }
                    
                    // ë°©ë²• 2: autoSizeAllColumns ì‹œë„
                    if (typeof headerGridApi.autoSizeAllColumns === 'function') {
                      headerGridApi.autoSizeAllColumns();
                      console.log('âœ… autoSizeAllColumns ì ìš©ë¨');
                    }
                    
                    // ë°©ë²• 3: ìˆ˜ë™ìœ¼ë¡œ ì»¬ëŸ¼ í¬ê¸° ì¡°ì •
                    if (typeof headerGridApi.setColumnWidths === 'function') {
                      headerGridApi.setColumnWidths([
                        { key: 'outboundNo', newWidth: 150 },
                        { key: 'customerName', newWidth: 200 },
                        { key: 'representativeNm', newWidth: 120 }
                      ]);
                      console.log('âœ… ìˆ˜ë™ ì»¬ëŸ¼ í¬ê¸° ì¡°ì • ì ìš©ë¨');
                    }
                    
                  } catch (error) {
                    console.warn('âš ï¸ ì»¬ëŸ¼ í¬ê¸° ì¡°ì • ì˜¤ë¥˜:', error);
                  }
                }
              }, 200);
              
              loadOutboundList();
            },
            onFirstDataRendered: function(params) {
              // ë°ì´í„° ë Œë”ë§ í›„ ì»¬ëŸ¼ í¬ê¸° ì¬ì¡°ì •
              console.log('ğŸ“Š í—¤ë” ê·¸ë¦¬ë“œ ì²« ë°ì´í„° ë Œë”ë§ ì™„ë£Œ');
              setTimeout(() => {
                if (params.api && typeof params.api.sizeColumnsToFit === 'function') {
                  params.api.sizeColumnsToFit();
                }
              }, 100);
            },
            suppressHorizontalScroll: false, // ê°€ë¡œ ìŠ¤í¬ë¡¤ í—ˆìš©
            localeText: {
              noRowsToShow: 'ì¶œê³  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'
            }
          };

          // ë””í…Œì¼ ê·¸ë¦¬ë“œ ì„¤ì • (ë ˆì´ì•„ì›ƒ ê°œì„ )
          const detailColumnDefs = [
            { 
              headerName: 'ì„ íƒ', 
              checkboxSelection: true, 
              headerCheckboxSelection: true, 
              width: 60,
              maxWidth: 60,
              suppressSizeToFit: true
            },
            { 
              headerName: 'ìˆœë²ˆ', 
              field: 'lineNo', 
              width: 80,
              maxWidth: 80, 
              cellClass: 'text-center' 
            },
            { 
              headerName: 'í’ˆëª©ì½”ë“œ', 
              field: 'itemCode', 
              width: 120,
              minWidth: 100
            },
            { 
              headerName: 'í’ˆëª©ëª…', 
              field: 'itemName', 
              flex: 2,
              minWidth: 150
            },
            { 
              headerName: 'ê·œê²©', 
              field: 'standard', 
              flex: 1,
              minWidth: 100
            },
            {
              headerName: 'ìˆ˜ëŸ‰', 
              field: 'qty', 
              width: 100,
              maxWidth: 120, 
              type: 'numericColumn',
              valueFormatter: params => Number(params.value || 0).toLocaleString(),
              cellClass: 'text-end'
            },
            { 
              headerName: 'ë‹¨ìœ„', 
              field: 'unit', 
              width: 80,
              maxWidth: 80
            },
            {
              headerName: 'ë‹¨ê°€', 
              field: 'unitPrice', 
              width: 110,
              minWidth: 100, 
              type: 'numericColumn',
              valueFormatter: params => Number(params.value || 0).toLocaleString(),
              cellClass: 'text-end'
            },
            {
              headerName: 'ê³µê¸‰ê°€ì•¡', 
              field: 'supplyAmount', 
              width: 120,
              minWidth: 100, 
              type: 'numericColumn',
              valueFormatter: params => Number(params.value || 0).toLocaleString(),
              cellClass: 'text-end'
            },
            {
              headerName: 'ë¶€ê°€ì„¸', 
              field: 'taxAmount', 
              width: 100,
              minWidth: 90, 
              type: 'numericColumn',
              valueFormatter: params => Number(params.value || 0).toLocaleString(),
              cellClass: 'text-end'
            },
            {
              headerName: 'í•©ê³„', 
              field: 'totalAmount', 
              width: 120,
              minWidth: 100, 
              type: 'numericColumn',
              cellClass: 'font-weight-bold text-end',
              valueFormatter: params => Number(params.value || 0).toLocaleString()
            },
            {
              headerName: 'ì¶œê³ ìƒíƒœ',
              field: 'outboundStatus',
              width: 100,
              minWidth: 90,
              cellClass: 'text-center',
              cellRenderer: function(params) {
                const status = params.value || 'ëŒ€ê¸°';
                let badgeClass = 'badge ';
                
                switch(status) {
                  case 'ì™„ë£Œ':
                    badgeClass += 'bg-success';
                    break;
                  case 'ì§„í–‰ì¤‘':
                    badgeClass += 'bg-primary';
                    break;
                  case 'ì·¨ì†Œ':
                    badgeClass += 'bg-danger';
                    break;
                  case 'ë³´ë¥˜':
                    badgeClass += 'bg-warning text-dark';
                    break;
                  default:
                    badgeClass += 'bg-secondary';
                }
                
                return `<span class="${badgeClass}">${status}</span>`;
              }
            },
            { 
              headerName: 'ë¹„ê³ ', 
              field: 'remarks', 
              flex: 1,
              minWidth: 100
            }
          ];

          const detailGridOptions = {
            columnDefs: detailColumnDefs,
            rowData: [], // ì´ˆê¸° ë¹ˆ ë°ì´í„°
            defaultColDef: {
              sortable: true,
              filter: true,
              resizable: true,
              flex: 0 // flex ê¸°ë³¸ê°’ì„ 0ìœ¼ë¡œ ì„¤ì •
            },
            rowSelection: 'multiple',
            onGridReady: function(params) {
              console.log('ğŸ“‹ ë””í…Œì¼ ê·¸ë¦¬ë“œ ì¤€ë¹„ ì™„ë£Œ');
              detailGridApi = params.api;
              
              // ì»¬ëŸ¼ í¬ê¸° ì¡°ì • - ì—¬ëŸ¬ ë°©ë²• ì‹œë„
              setTimeout(() => {
                if (detailGridApi) {
                  try {
                    // ë°©ë²• 1: sizeColumnsToFit ì‹œë„
                    if (typeof detailGridApi.sizeColumnsToFit === 'function') {
                      detailGridApi.sizeColumnsToFit();
                      console.log('âœ… ë””í…Œì¼ sizeColumnsToFit ì ìš©ë¨');
                    }
                    
                    // ë°©ë²• 2: autoSizeAllColumns ì‹œë„
                    if (typeof detailGridApi.autoSizeAllColumns === 'function') {
                      detailGridApi.autoSizeAllColumns();
                      console.log('âœ… ë””í…Œì¼ autoSizeAllColumns ì ìš©ë¨');
                    }
                    
                  } catch (error) {
                    console.warn('âš ï¸ ë””í…Œì¼ ì»¬ëŸ¼ í¬ê¸° ì¡°ì • ì˜¤ë¥˜:', error);
                  }
                }
              }, 200);
            },
            onFirstDataRendered: function(params) {
              // ë°ì´í„° ë Œë”ë§ í›„ ì»¬ëŸ¼ í¬ê¸° ì¬ì¡°ì •
              console.log('ğŸ“‹ ë””í…Œì¼ ê·¸ë¦¬ë“œ ì²« ë°ì´í„° ë Œë”ë§ ì™„ë£Œ');
              setTimeout(() => {
                if (params.api && typeof params.api.sizeColumnsToFit === 'function') {
                  params.api.sizeColumnsToFit();
                }
              }, 100);
            },
            suppressHorizontalScroll: false, // ê°€ë¡œ ìŠ¤í¬ë¡¤ í—ˆìš©
            localeText: {
              noRowsToShow: 'ì¶œê³  ìƒì„¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'
            }
          };

          // ê·¸ë¦¬ë“œ ìƒì„±
          console.log('ğŸ—ï¸ í—¤ë” ê·¸ë¦¬ë“œ ìƒì„± ì¤‘...');
          const headerGridDiv = document.getElementById('headerGrid');
          if (agGrid.createGrid) {
            agGrid.createGrid(headerGridDiv, headerGridOptions);
          } else {
            new agGrid.Grid(headerGridDiv, headerGridOptions);
          }
          
          console.log('ğŸ—ï¸ ë””í…Œì¼ ê·¸ë¦¬ë“œ ìƒì„± ì¤‘...');
          const detailGridDiv = document.getElementById('detailGrid');
          if (agGrid.createGrid) {
            agGrid.createGrid(detailGridDiv, detailGridOptions);
          } else {
            new agGrid.Grid(detailGridDiv, detailGridOptions);
          }
          
          console.log('âœ… AG-Grid ì´ˆê¸°í™” ì™„ë£Œ');

        } catch (error) {
          console.error('âŒ AG-Grid ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
          showErrorAlert('AG-Grid ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
      }

      // ===== ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ë“¤ =====
      function loadOutboundList() {
        console.log('ğŸ“¥ ì¶œê³  ëª©ë¡ ë¡œë“œ ì‹œì‘');
        
        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        if (headerGridApi) {
          safeSetRowData(headerGridApi, []);
        }
        
        fetch('/bsn/soutbounds')
          .then(response => {
            console.log('ğŸ“¡ API ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
          })
          .then(data => {
            console.log('ğŸ“Š ì¶œê³  ëª©ë¡ ë°ì´í„°:', data);
            console.log('ğŸ“Š ë°ì´í„° íƒ€ì…:', typeof data, Array.isArray(data));
            console.log('ğŸ“Š ë°ì´í„° ê¸¸ì´:', data?.length);
            
            if (headerGridApi) {
              safeSetRowData(headerGridApi, data || []);
              console.log(`âœ… ì¶œê³  ëª©ë¡ ë¡œë“œ ì™„ë£Œ: ${data?.length || 0}ê±´`);
              
              // ë°ì´í„° ë¡œë“œ í›„ ì»¬ëŸ¼ í¬ê¸° ì¬ì¡°ì •
              setTimeout(() => {
                if (headerGridApi && typeof headerGridApi.sizeColumnsToFit === 'function') {
                  headerGridApi.sizeColumnsToFit();
                  console.log('ğŸ“Š ë°ì´í„° ë¡œë“œ í›„ í—¤ë” ê·¸ë¦¬ë“œ í¬ê¸° ì¬ì¡°ì •');
                }
              }, 200);
            } else {
              console.warn('âš ï¸ headerGridApiê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            }
          })
          .catch(error => {
            console.error('âŒ ì¶œê³  ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            if (headerGridApi) {
              safeSetRowData(headerGridApi, []);
            }
            showErrorAlert('ì¶œê³  ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
          });
      }

      function onHeaderRowClicked(event) {
        const outboundNo = event.data.outboundNo;
        selectedOutboundData = event.data;
        
        console.log('ğŸ¯ ì¶œê³  í—¤ë” í´ë¦­:', outboundNo);
        $('#selectedOutboundNo').text(`(${outboundNo})`);
        
        loadOutboundDetails(outboundNo);
      }

      function loadOutboundDetails(outboundNo) {
        console.log('ğŸ“¥ ì¶œê³  ìƒì„¸ ë¡œë“œ ì‹œì‘:', outboundNo);
        
        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        if (detailGridApi) {
          safeSetRowData(detailGridApi, []);
        }
        
        fetch(`/bsn/soutbounds/${encodeURIComponent(outboundNo)}/details`)
          .then(response => {
            console.log('ğŸ“¡ ìƒì„¸ API ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
          })
          .then(data => {
            console.log('ğŸ“‹ ì¶œê³  ìƒì„¸ ë°ì´í„°:', data);
            
            if (detailGridApi) {
              safeSetRowData(detailGridApi, data || []);
              console.log(`âœ… ì¶œê³  ìƒì„¸ ë¡œë“œ ì™„ë£Œ: ${data?.length || 0}ê±´`);
              
              // ë°ì´í„° ë¡œë“œ í›„ ì»¬ëŸ¼ í¬ê¸° ì¬ì¡°ì •
              setTimeout(() => {
                if (detailGridApi && typeof detailGridApi.sizeColumnsToFit === 'function') {
                  detailGridApi.sizeColumnsToFit();
                  console.log('ğŸ“‹ ë°ì´í„° ë¡œë“œ í›„ ë””í…Œì¼ ê·¸ë¦¬ë“œ í¬ê¸° ì¬ì¡°ì •');
                }
              }, 200);
            } else {
              console.warn('âš ï¸ detailGridApiê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            }
          })
          .catch(error => {
            console.error('âŒ ì¶œê³  ìƒì„¸ ë¡œë“œ ì‹¤íŒ¨:', error);
            if (detailGridApi) {
              safeSetRowData(detailGridApi, []);
            }
            showErrorAlert('ì¶œê³  ìƒì„¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
          });
      }

      // ===== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ =====
      function showErrorAlert(message) {
        if (typeof Swal !== 'undefined') {
          Swal.fire('ì˜¤ë¥˜', message, 'error');
        } else {
          alert('ì˜¤ë¥˜: ' + message);
        }
      }

      function showSuccessAlert(message) {
        if (typeof Swal !== 'undefined') {
          Swal.fire('ì„±ê³µ', message, 'success');
        } else {
          alert('ì„±ê³µ: ' + message);
        }
      }

      // ===== ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ =====
      $('#btnRefresh').click(function() {
        console.log('ğŸ”„ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ í´ë¦­');
        loadOutboundList();
        if (detailGridApi) {
          safeSetRowData(detailGridApi, []);
        }
        $('#selectedOutboundNo').text('');
        selectedOutboundData = null;
      });

      $('#btnCreateFromOrder').click(function() {
        console.log('ğŸ“‹ ì£¼ë¬¸ì„œì—ì„œ ìƒì„± ë²„íŠ¼ í´ë¦­');
        loadOrderList();
        $('#orderSelectModal').modal('show');
      });

      $('#btnNew').click(function() {
        console.log('â• ì‹ ê·œ ë²„íŠ¼ í´ë¦­');
        showErrorAlert('ì‹ ê·œ ì¶œê³  ìƒì„± ê¸°ëŠ¥ì„ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤.');
      });

      $('#btnEdit').click(function() {
        console.log('âœï¸ ìˆ˜ì • ë²„íŠ¼ í´ë¦­');
        if (!selectedOutboundData) {
          showErrorAlert('ìˆ˜ì •í•  ì¶œê³ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }
        showErrorAlert('ì¶œê³  ìˆ˜ì • ê¸°ëŠ¥ì„ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤.');
      });

      $('#btnDelete').click(function() {
        console.log('ğŸ—‘ï¸ ì‚­ì œ ë²„íŠ¼ í´ë¦­');
        
        // AG-Gridì—ì„œ ì„ íƒëœ í–‰ ê°€ì ¸ì˜¤ê¸°
        let selectedRows = [];
        if (headerGridApi && typeof headerGridApi.getSelectedRows === 'function') {
          selectedRows = headerGridApi.getSelectedRows();
        }
        
        if (selectedRows.length === 0) {
          showErrorAlert('ì‚­ì œí•  ì¶œê³ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }
        
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            title: 'ì‚­ì œ í™•ì¸',
            text: `ì„ íƒí•œ ${selectedRows.length}ê±´ì˜ ì¶œê³ ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#e74a3b',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'ì‚­ì œ',
            cancelButtonText: 'ì·¨ì†Œ'
          }).then((result) => {
            if (result.isConfirmed) {
              deleteOutbounds(selectedRows);
            }
          });
        }
      });

      $('#btnDebug').click(function() {
        console.log('ğŸ› ë””ë²„ê·¸ ë²„íŠ¼ í´ë¦­');
        
        const debugInfo = {
          agGridLoaded: typeof agGrid !== 'undefined',
          headerGridApi: !!headerGridApi,
          detailGridApi: !!detailGridApi,
          selectedData: selectedOutboundData,
          currentPath: window.location.pathname,
          headerGridMethods: headerGridApi ? Object.keys(headerGridApi).filter(key => typeof headerGridApi[key] === 'function').slice(0, 10) : [],
          detailGridMethods: detailGridApi ? Object.keys(detailGridApi).filter(key => typeof detailGridApi[key] === 'function').slice(0, 10) : []
        };
        
        console.log('ğŸ” ë””ë²„ê·¸ ì •ë³´:', debugInfo);
        
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            title: 'ë””ë²„ê·¸ ì •ë³´',
            html: `
              <div class="text-start">
                <strong>AG-Grid ë¡œë“œ:</strong> ${debugInfo.agGridLoaded ? 'âœ…' : 'âŒ'}<br>
                <strong>í—¤ë” ê·¸ë¦¬ë“œ:</strong> ${debugInfo.headerGridApi ? 'âœ…' : 'âŒ'}<br>
                <strong>ë””í…Œì¼ ê·¸ë¦¬ë“œ:</strong> ${debugInfo.detailGridApi ? 'âœ…' : 'âŒ'}<br>
                <strong>ì„ íƒëœ ë°ì´í„°:</strong> ${debugInfo.selectedData ? 'âœ…' : 'âŒ'}<br>
                <strong>í˜„ì¬ ê²½ë¡œ:</strong> ${debugInfo.currentPath}<br>
                <hr>
                <strong>í—¤ë” ê·¸ë¦¬ë“œ ë©”ì„œë“œ (ì¼ë¶€):</strong><br>
                <small>${debugInfo.headerGridMethods.join(', ')}</small><br>
                <hr>
                <small>ìì„¸í•œ ì •ë³´ëŠ” ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.</small>
              </div>
            `,
            icon: 'info',
            width: 600
          });
        }
      });

      $('#btnAddDetailRow').click(function() {
        console.log('â• ìƒì„¸ í–‰ ì¶”ê°€ í´ë¦­');
        if (!selectedOutboundData) {
          showErrorAlert('ë¨¼ì € ì¶œê³ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }
        
        // í˜„ì¬ í–‰ ê°œìˆ˜ í™•ì¸
        let currentRowCount = 0;
        if (detailGridApi && typeof detailGridApi.getDisplayedRowCount === 'function') {
          currentRowCount = detailGridApi.getDisplayedRowCount();
        }
        
        const newRow = {
          outboundNo: selectedOutboundData.outboundNo,
          lineNo: currentRowCount + 1,
          itemCode: '',
          itemName: '',
          standard: '',
          qty: 1,
          unit: '',
          unitPrice: 0,
          supplyAmount: 0,
          taxAmount: 0,
          totalAmount: 0,
          outboundStatus: 'ëŒ€ê¸°', // ê¸°ë³¸ ì¶œê³ ìƒíƒœ
          remarks: ''
        };
        
        if (detailGridApi && typeof detailGridApi.applyTransaction === 'function') {
          detailGridApi.applyTransaction({ add: [newRow] });
          console.log('âœ… ìƒˆ ìƒì„¸ í–‰ ì¶”ê°€ë¨');
        } else {
          console.warn('âš ï¸ applyTransaction ë©”ì„œë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
      });

      $('#btnDeleteDetailRow').click(function() {
        console.log('ğŸ—‘ï¸ ìƒì„¸ í–‰ ì‚­ì œ í´ë¦­');
        
        let selectedRows = [];
        if (detailGridApi && typeof detailGridApi.getSelectedRows === 'function') {
          selectedRows = detailGridApi.getSelectedRows();
        }
        
        if (selectedRows.length === 0) {
          showErrorAlert('ì‚­ì œí•  ìƒì„¸ í–‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
          return;
        }
        
        if (detailGridApi && typeof detailGridApi.applyTransaction === 'function') {
          detailGridApi.applyTransaction({ remove: selectedRows });
          console.log(`âœ… ${selectedRows.length}ê°œ ìƒì„¸ í–‰ ì‚­ì œë¨`);
        } else {
          console.warn('âš ï¸ applyTransaction ë©”ì„œë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
      });

      // ===== ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ í•¨ìˆ˜ë“¤ =====
      function loadOrderList() {
        const tbody = $('#orderListBody');
        tbody.html('<tr><td colspan="6" class="text-center"><div class="spinner-border spinner-border-sm"></div> ì£¼ë¬¸ì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>');
        
        fetch('/bsn/orders')
          .then(response => response.json())
          .then(orders => {
            tbody.empty();
            if (orders && orders.length > 0) {
              orders.forEach(order => {
                tbody.append(`
                  <tr>
                    <td>
                      <button class="btn btn-sm btn-success select-order" data-order-no="${order.orderNo}">
                        ì„ íƒ
                      </button>
                    </td>
                    <td>${order.orderNo}</td>
                    <td>${order.orderDt}</td>
                    <td>${order.customerNm || ''}</td>
                    <td class="text-end">-</td>
                    <td><span class="badge bg-warning">ëŒ€ê¸°</span></td>
                  </tr>
                `);
              });
            } else {
              tbody.html('<tr><td colspan="6" class="text-center text-muted">ì¶œê³  ê°€ëŠ¥í•œ ì£¼ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>');
            }
          })
          .catch(error => {
            console.error('ì£¼ë¬¸ì„œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            tbody.html('<tr><td colspan="6" class="text-center text-danger">ì£¼ë¬¸ì„œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</td></tr>');
          });
      }

      // ì£¼ë¬¸ì„œ ì„ íƒ ì´ë²¤íŠ¸
      $(document).on('click', '.select-order', function() {
        const orderNo = $(this).data('order-no');
        console.log('ğŸ“‹ ì£¼ë¬¸ì„œ ì„ íƒ:', orderNo);
        
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            title: 'ì¶œê³  ìƒì„±',
            text: `ì£¼ë¬¸ì„œ "${orderNo}"ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¶œê³ ë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#1cc88a',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'ìƒì„±',
            cancelButtonText: 'ì·¨ì†Œ'
          }).then((result) => {
            if (result.isConfirmed) {
              createOutboundFromOrder(orderNo);
            }
          });
        }
      });

      function createOutboundFromOrder(orderNo) {
        console.log('ğŸšš ì£¼ë¬¸ì„œ ê¸°ë°˜ ì¶œê³  ìƒì„±:', orderNo);
        
        fetch('/bsn/soutbounds/create-from-order', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ orderNo: orderNo })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showSuccessAlert(`ì¶œê³  "${data.outboundNo}"ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            $('#orderSelectModal').modal('hide');
            loadOutboundList(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
          } else {
            showErrorAlert(data.message || 'ì¶œê³  ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        })
        .catch(error => {
          console.error('ì¶œê³  ìƒì„± ì‹¤íŒ¨:', error);
          showErrorAlert('ì¶œê³  ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
      }

      function deleteOutbounds(outbounds) {
        console.log('ğŸ—‘ï¸ ì¶œê³  ì‚­ì œ ì‹œì‘:', outbounds);
        
        const deletePromises = outbounds.map(outbound => 
          fetch(`/bsn/soutbounds/${outbound.outboundNo}`, {
            method: 'DELETE'
          })
        );
        
        Promise.all(deletePromises)
          .then(responses => {
            const allSuccess = responses.every(response => response.ok);
            if (allSuccess) {
              showSuccessAlert(`${outbounds.length}ê±´ì˜ ì¶œê³ ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
              loadOutboundList(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
              if (detailGridApi) {
                safeSetRowData(detailGridApi, []);
              }
              $('#selectedOutboundNo').text('');
              selectedOutboundData = null;
            } else {
              showErrorAlert('ì¼ë¶€ ì¶œê³  ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
          })
          .catch(error => {
            console.error('ì¶œê³  ì‚­ì œ ì‹¤íŒ¨:', error);
            showErrorAlert('ì¶œê³  ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          });
      }

      // ===== ì´ˆê¸°í™” =====
      console.log('ğŸ¯ ì¶œê³ ê´€ë¦¬ ì´ˆê¸°í™” ì‹œì‘');
      
      // AG-Gridê°€ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
      function waitForAgGrid() {
        if (typeof agGrid !== 'undefined') {
          console.log('âœ… AG-Grid ë¡œë“œ í™•ì¸ë¨');
          setTimeout(initializeGrids, 100); // ì•½ê°„ì˜ ì§€ì—° í›„ ì´ˆê¸°í™”
        } else {
          console.log('â³ AG-Grid ë¡œë“œ ëŒ€ê¸° ì¤‘...');
          setTimeout(waitForAgGrid, 100); // 100ms í›„ ì¬ì‹œë„
        }
      }
      
      // í˜ì´ì§€ ë¡œë“œ í›„ ì´ˆê¸°í™”
      setTimeout(waitForAgGrid, 500); // 500ms í›„ ì‹œì‘
      
      console.log('ğŸ‰ ì¶œê³ ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');
    });

    // ===== AG-Grid ë°±ì—… ë¡œë” =====
    window.addEventListener('load', function() {
      setTimeout(function() {
        if (typeof agGrid === 'undefined') {
          console.warn('âš ï¸ AG-Grid CDN ë¡œë“œ ì‹¤íŒ¨ ê°ì§€ - ë°±ì—… ë¡œë“œ ì‹œë„');
          
          const script = document.createElement('script');
          script.src = 'https://unpkg.com/ag-grid-community@30.2.1/dist/ag-grid-community.min.js';
          script.onload = function() {
            console.log('âœ… ë°±ì—… AG-Grid ë¡œë“œ ì™„ë£Œ');
          };
          script.onerror = function() {
            console.error('âŒ ë°±ì—… AG-Grid ë¡œë“œë„ ì‹¤íŒ¨');
            if (typeof Swal !== 'undefined') {
              Swal.fire({
                title: 'AG-Grid ë¡œë“œ ì‹¤íŒ¨',
                text: 'AG-Gridë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.',
                icon: 'error',
                confirmButtonText: 'ìƒˆë¡œê³ ì¹¨',
                allowOutsideClick: false
              }).then(() => {
                location.reload();
              });
            } else {
              alert('AG-Grid ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
              location.reload();
            }
          };
          document.head.appendChild(script);
        }
      }, 2000); // 2ì´ˆ í›„ ì²´í¬
    });

    // ===== ì¶”ê°€ ë””ë²„ê¹… í•¨ìˆ˜ë“¤ =====
    window.debugOutbound = function() {
      console.log('=== ì¶œê³ ê´€ë¦¬ ë””ë²„ê·¸ ì •ë³´ ===');
      console.log('AG-Grid íƒ€ì…:', typeof agGrid);
      console.log('AG-Grid ê°ì²´:', agGrid);
      console.log('headerGridApi:', headerGridApi);
      console.log('detailGridApi:', detailGridApi);
      
      if (headerGridApi) {
        console.log('headerGridApi ë©”ì„œë“œë“¤:');
        console.log('- setRowData:', typeof headerGridApi.setRowData);
        console.log('- setGridOption:', typeof headerGridApi.setGridOption);
        console.log('- getSelectedRows:', typeof headerGridApi.getSelectedRows);
        console.log('- applyTransaction:', typeof headerGridApi.applyTransaction);
      }
      
      // ê°„ë‹¨í•œ API í…ŒìŠ¤íŠ¸
      fetch('/bsn/soutbounds')
        .then(r => r.json())
        .then(data => {
          console.log('API í…ŒìŠ¤íŠ¸ ê²°ê³¼:', data);
          console.log('ë°ì´í„° íƒ€ì…:', typeof data, Array.isArray(data));
          console.log('ë°ì´í„° ê°œìˆ˜:', data?.length);
        })
        .catch(e => console.error('API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', e));
    };

    // ì½˜ì†”ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë””ë²„ê·¸ ëª…ë ¹ì–´
    console.log('ğŸ’¡ ë””ë²„ê·¸ ëª…ë ¹ì–´: debugOutbound() - ì½˜ì†”ì— ì…ë ¥í•˜ì—¬ ë””ë²„ê·¸ ì •ë³´ í™•ì¸');
    /*]]>*/
    </script>

</div>
</html>