<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/default}">
<head>
  <meta charset="UTF-8" />
  <title>출고 관리</title>
  <style>
    .section-box {
      padding: 15px;
      border: 1px solid #e3e6f0;
      border-radius: 8px;
      background-color: #ffffff;
      margin-bottom: 15px;
      box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    }

    .section-box h6 {
      margin-bottom: 12px;
      color: #5a5c69;
      font-weight: 700;
      border-bottom: 2px solid #4e73df;
      padding-bottom: 8px;
    }

    .btn-create { background-color: #1cc88a; border-color: #1cc88a; color: white; }
    .btn-create:hover { background-color: #17a673; border-color: #17a673; }

    .btn-edit { background-color: #36b9cc; border-color: #36b9cc; color: white; }
    .btn-edit:hover { background-color: #2c9faf; border-color: #2c9faf; }

    .btn-delete { background-color: #e74a3b; border-color: #e74a3b; color: white; }
    .btn-delete:hover { background-color: #c0392b; border-color: #c0392b; }

    .header-grid { height: 280px; }
    .detail-grid { height: 320px; }

    /* AG-Grid 커스텀 스타일 */
    .ag-theme-alpine {
      --ag-background-color: #ffffff;
      --ag-header-background-color: #f8f9fc;
      --ag-header-foreground-color: #5a5c69;
      --ag-border-color: #e3e6f0;
      --ag-row-hover-color: #f8f9fc;
      --ag-selected-row-background-color: #eaecf4;
    }
  </style>
</head>
<div layout:fragment="content" class="container-fluid px-3 py-2">

    <!-- 페이지 헤더 -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h4 class="mb-0">
          <i class="fas fa-shipping-fast mr-2"></i>출고 관리
        </h4>
        <small class="text-muted">출고 등록, 수정, 삭제 및 조회</small>
      </div>
      <div>
        <button type="button" class="btn btn-warning btn-sm me-1" id="btnCreateFromOrder">
          <i class="fas fa-plus-circle"></i> 주문서에서 생성
        </button>
        <button type="button" class="btn btn-create btn-sm me-1" id="btnNew">
          <i class="fas fa-plus"></i> 신규
        </button>
        <button type="button" class="btn btn-edit btn-sm me-1" id="btnEdit">
          <i class="fas fa-edit"></i> 수정
        </button>
        <button type="button" class="btn btn-delete btn-sm me-1" id="btnDelete">
          <i class="fas fa-trash"></i> 삭제
        </button>
      </div>
    </div>

    <!-- 출고 헤더 그리드 -->
    <div class="section-box">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6><i class="fas fa-list mr-2"></i>출고 목록</h6>
        <button id="btnRefresh" class="btn btn-secondary btn-sm"><i class="fas fa-sync"></i> 새로고침</button>
      </div>
      <div id="headerGrid" class="ag-theme-alpine header-grid"></div>
    </div>
    <!-- 출고 디테일 그리드 -->
    <div class="section-box">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6>
          <i class="fas fa-boxes mr-2"></i>출고 상세
          <span id="selectedOutboundNo" class="text-muted fs-6"></span>
        </h6>
        <div>
          <button id="btnAddDetailRow" class="btn btn-info btn-sm"><i class="fas fa-plus"></i> 행 추가</button>
          <button id="btnDeleteDetailRow" class="btn btn-warning btn-sm"><i class="fas fa-minus"></i> 행 삭제</button>
        </div>
      </div>
      <div id="detailGrid" class="ag-theme-alpine detail-grid"></div>
    </div>

  
  <!-- 기존에 쓰던 ag-grid-community.min.noStyle.js 대신 이걸로 교체 -->
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.umd.min.js"></script>
      
    <script th:inline="javascript">
    /*<![CDATA[*/
    $(function() {
      console.log('▶ 출고관리 스크립트 시작, agGrid 객체:', window.agGrid);
    
      // UMD 번들에서 Grid 생성자 찾기
      const GridCtor =
        (window.agGrid && window.agGrid.Grid) ||
        (window.agGrid && window.agGrid.default && window.agGrid.default.Grid) ||
        (typeof window.agGrid === 'function' ? window.agGrid : null);
    
      if (!GridCtor) {
        console.error('❌ Grid 생성자(Ctor)를 찾을 수 없습니다!', window.agGrid);
        return;
      }
    
      let headerApi, detailApi;
    
      const headerCols = [
        { headerName: '선택', checkboxSelection:true, headerCheckboxSelection:true, width:60 },
        { headerName: '출고번호', field:'outboundNo', width:150, cellClass:'font-weight-bold text-primary' },
        { headerName: '작성일자', field:'writeDt', width:100 },
        { headerName: '거래처코드', field:'customerCd', width:120 },
        { headerName: '거래처명', field:'customerName', width:200, flex:1 },
        { headerName: '대표명', field:'representativeNm', width:100 },
        {
          headerName:'주문일자', field:'orderDt', width:100,
          valueFormatter:p=>p.value?new Date(p.value).toLocaleDateString():''
        },
        {
          headerName:'출고일자', field:'outboundDt', width:100,
          valueFormatter:p=>p.value?new Date(p.value).toLocaleDateString():''
        },
        { headerName:'통화', field:'money', width:80 },
        { headerName:'비고', field:'remarks', width:150 }
      ];
      
      const detailCols = [
        { headerName:'선택', checkboxSelection:true, headerCheckboxSelection:true, width:60 },
        { headerName:'순번', field:'lineNo', width:80, cellClass:'text-center' },
        { headerName:'품목코드', field:'itemCode', width:120 },
        { headerName:'품목명', field:'itemName', width:200, flex:1 },
        { headerName:'규격', field:'standard', width:120 },
        {
          headerName:'수량', field:'qty', width:100, type:'numericColumn',
          valueFormatter:p=>Number(p.value||0).toLocaleString()
        },
        { headerName:'단위', field:'unit', width:80 },
        {
          headerName:'단가', field:'unitPrice', width:110, type:'numericColumn',
          valueFormatter:p=>Number(p.value||0).toLocaleString()
        },
        {
          headerName:'공급가액', field:'supplyAmount', width:120, type:'numericColumn',
          valueFormatter:p=>Number(p.value||0).toLocaleString()
        },
        {
          headerName:'부가세', field:'taxAmount', width:100, type:'numericColumn',
          valueFormatter:p=>Number(p.value||0).toLocaleString()
        },
        {
          headerName:'합계', field:'totalAmount', width:120, type:'numericColumn',
          cellClass:'font-weight-bold',
          valueFormatter:p=>Number(p.value||0).toLocaleString()
        },
        { headerName:'비고', field:'remarks', width:150 }
      ];
      
      const headerOpts = {
        columnDefs: headerCols,
        defaultColDef:{sortable:true,filter:true,resizable:true},
        rowSelection:'single',
        onRowClicked:onHeaderClick,
        onGridReady: params=>{
          headerApi = params.api;
          headerApi.sizeColumnsToFit();
          loadHeaders();
        }
      };
      const detailOpts = {
        columnDefs: detailCols,
        defaultColDef:{sortable:true,filter:true,resizable:true},
        rowSelection:'multiple',
        onGridReady: params=>{
          detailApi = params.api;
          detailApi.sizeColumnsToFit();
        }
      };
    
      // 실제 그리드 생성
      new GridCtor(document.getElementById('headerGrid'), headerOpts);
      new GridCtor(document.getElementById('detailGrid'), detailOpts);
    
      function loadHeaders() {
        fetch('/bsn/soutbounds')
          .then(r=>r.ok? r.json(): Promise.reject(r))
          .then(data=> headerApi.setRowData(data))
          .catch(e=> {
            console.error('헤더 로드 실패', e);
            headerApi.setRowData([]);
          });
      }
    
      function onHeaderClick(e) {
        const no = e.data.outboundNo;
        $('#selectedOutboundNo').text(`(${no})`);
        fetch(`/bsn/soutbounds/${encodeURIComponent(no)}/details`)
          .then(r=>r.ok? r.json(): Promise.reject(r))
          .then(data=> detailApi.setRowData(data))
          .catch(e=> {
            console.error('상세 로드 실패', e);
            detailApi.setRowData([]);
          });
      }
    
      $('#btnRefresh').click(()=>{
        loadHeaders();
        detailApi && detailApi.setRowData([]);
        $('#selectedOutboundNo').text('');
      });
    
      $('#btnAddDetailRow').click(()=>{
        const sel = headerApi.getSelectedRows();
        if(!sel.length) return Swal.fire('알림','먼저 출고를 선택해 주세요.','info');
        const newRow={
          outboundNo: sel[0].outboundNo,
          lineNo: (detailApi.getDisplayedRowCount()||0)+1,
          itemCode:'',itemName:'',standard:'',
          qty:1,unit:'',unitPrice:0,
          supplyAmount:0,taxAmount:0,totalAmount:0,
          remarks:''
        };
        detailApi.applyTransaction({add:[newRow]});
      });
    
      $('#btnDeleteDetailRow').click(()=>{
        const rows = detailApi.getSelectedRows();
        if(!rows.length) return Swal.fire('알림','삭제할 상세 행을 선택해 주세요.','info');
        detailApi.applyTransaction({remove:rows});
      });
    
      console.log('▶ 출고관리 초기화 완료');
    });
    /*]]>*/
    </script>
    
</div>
