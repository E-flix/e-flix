<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{common/layouts/default}">

<head>
  <meta charset="UTF-8" />  
  <title>주문서 관리</title>
  
  <style>
    /* 전체 컨테이너 */
    .management-container {
      padding: 10px;
      min-height: 100vh;
    }
    
    /* 섹션 박스 스타일 */
    .section-box {
      padding: 15px;
      border: 1px solid #e3e6f0;
      border-radius: 8px;
      background-color: #ffffff;
      margin-bottom: 15px;
      box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    }
    
    .section-box h6 {
      margin-bottom: 12px;
      color: #5a5c69;
      font-weight: 700;
      border-bottom: 2px solid #4e73df;
      padding-bottom: 8px;
      font-size: 1rem;
    }
    
    /* 버튼 색상 (SB Admin 2 스타일에 맞춤) */
    .btn-create { 
      background-color: #1cc88a; 
      border-color: #1cc88a;
      color: white; 
    }
    .btn-create:hover {
      background-color: #17a673;
      border-color: #17a673;
    }
    
    .btn-edit { 
      background-color: #36b9cc; 
      border-color: #36b9cc;
      color: white; 
    }
    .btn-edit:hover {
      background-color: #2c9faf;
      border-color: #2c9faf;
    }
    
    .btn-delete { 
      background-color: #e74a3b; 
      border-color: #e74a3b;
      color: white; 
    }
    .btn-delete:hover {
      background-color: #c0392b;
      border-color: #c0392b;
    }
    
    .btn-save { 
      background-color: #4e73df; 
      border-color: #4e73df;
      color: white; 
    }
    .btn-save:hover {
      background-color: #2e59d9;
      border-color: #2e59d9;
    }
    
    /* 그리드 높이 설정 */
    .header-grid { height: 300px; }
    .credit-grid { height: 240px; }
    .detail-grid { height: 350px; }
    
    /* 탭 스타일 (SB Admin 2 맞춤) */
    .nav-tabs {
      border-bottom: 1px solid #dee2e6;
    }
    
    .nav-tabs .nav-link {
      border: 1px solid transparent;
      border-top-left-radius: 0.35rem;
      border-top-right-radius: 0.35rem;
      color: #858796;
      font-weight: 600;
    }
    
    .nav-tabs .nav-link.active {
      background-color: #4e73df;
      border-color: #4e73df;
      color: white;
    }
    
    /* AG-Grid 커스텀 스타일 (SB Admin 2 테마 맞춤) */
    .ag-theme-alpine {
      --ag-background-color: #ffffff;
      --ag-header-background-color: #f8f9fc;
      --ag-header-foreground-color: #5a5c69;
      --ag-border-color: #e3e6f0;
      --ag-row-hover-color: #f8f9fc;
      --ag-selected-row-background-color: #eaecf4;
      --ag-font-size: 14px;
      --ag-font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    }
    

    .ag-theme-alpine  { width: 100% !important; }

    .ag-theme-alpine .ag-header-cell {
      font-weight: 700;
      color: #5a5c69;
    }
    
    .ag-theme-alpine .ag-row-even {
      background-color: #ffffff;
    }
    
    .ag-theme-alpine .ag-row-odd {
      background-color: #f8f9fc;
    }
    
    /* 읽기 전용 셀 스타일 */
    .readonly-cell {
      background-color: #f8f9fc !important;
      color: #6c757d !important;
    }
    
    /* 편집 가능한 셀 스타일 */
    .editable-cell {
      background-color: #ffffff !important;
      border: 1px solid #4e73df !important;
    }
    
    /* 제목 헤더 스타일 */
    .page-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 8px;
      padding: 12px 20px;
      margin-bottom: 20px;
    }
    
    /* 카드 스타일 */
    .card {
      box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
      border: 1px solid #e3e6f0;
    }
    
    /* 모달 스타일 */
    .modal-header {
      background-color: #4e73df;
      color: white;
      border-bottom: none;
    }
    
    .modal-header .btn-close {
      filter: invert(1);
    }
    
    /* 합계 행 스타일 */
    .ag-theme-alpine .ag-pinned-bottom-row {
      background-color: #4e73df !important;
      color: white !important;
      font-weight: bold;
    }
    
    .ag-theme-alpine .ag-pinned-bottom-row .ag-cell {
      border-top: 2px solid #2e59d9;
    }
  </style>
</head>

<div layout:fragment="content" class="management-container">
  
  <!-- 페이지 제목 -->
  <div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h4 class="mb-0">
          <i class="fas fa-clipboard-list mr-2"></i>주문서 관리
        </h4>
        <small class="opacity-75">주문서 등록, 수정, 삭제 및 조회</small>
      </div>
      
      <!-- 액션 버튼들 -->
      <div>
        <button type="button" class="btn btn-create btn-sm me-1" id="btnNew">
          <i class="fas fa-plus"></i> 신규
        </button>
        <button type="button" class="btn btn-edit btn-sm me-1" id="btnEdit">
          <i class="fas fa-edit"></i> 수정
        </button>
        <button type="button" class="btn btn-delete btn-sm me-1" id="btnDelete">
          <i class="fas fa-trash"></i> 삭제
        </button>
        <button type="button" class="btn btn-save btn-sm" id="btnSave">
          <i class="fas fa-save"></i> 등록
        </button>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card section-box">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-list mr-2"></i>주문서 헤더 목록
          </h6>
          <button type="button" class="btn btn-save btn-sm" id="btnSaveHeader">
            <i class="fas fa-save"></i>헤더 저장
          </button>
        </div>
        <div class="card-body">
          <div id="headerGrid" class="ag-theme-alpine header-grid"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ────────────── 여신 정보 ──────────────-->
  <div class="row">
    <div class="col-12">
      <div class="card section-box">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-success">
            <i class="fas fa-credit-card mr-2"></i>여신 정보
          </h6>
        </div>
        <div class="card-body">
          <div id="creditGrid" class="ag-theme-alpine credit-grid"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 주문서 디테일 그리드 -->
  <div class="card section-box">
    <div class="card-header py-3">
      <div class="d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold text-info">
          <i class="fas fa-boxes mr-2"></i>주문서 디테일
        </h6>
        <div>
          <button type="button" class="btn btn-info btn-sm" id="btnAddRow">
            <i class="fas fa-plus"></i> 행 추가
          </button>
          <button type="button" class="btn btn-warning btn-sm" id="btnDeleteRow">
            <i class="fas fa-minus"></i> 행 삭제
          </button>
          <button type="button" class="btn btn-save btn-sm" id="btnSaveDetail">
            <i class="fas fa-save"></i>저장
          </button>
        </div>
      </div>
    </div>
    <div class="card-body">
      <div id="detailGrid" class="ag-theme-alpine detail-grid"></div>
    </div>
  </div>

  <!-- 거래처 검색 모달 -->
  <div class="modal fade" id="customerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-search mr-2"></i>거래처 조회
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="input-group mb-3">
            <input id="customerSearchInput" type="text" class="form-control" placeholder="거래처명 검색">
            <button id="btnCustomerSearch" class="btn btn-outline-primary">
              <i class="fas fa-search"></i> 검색
            </button>
          </div>
          <div class="table-responsive">
            <table class="table table-bordered mb-0">
              <thead class="table-light">
                <tr>
                  <th>선택</th><th>코드</th><th>이름</th><th>대표명</th><th>전화번호</th>
                </tr>
              </thead>
              <tbody id="customerSearchResults"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 품목 검색 모달 -->
  <div class="modal fade" id="itemModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-cube mr-2"></i>품목 목록
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
          <div class="table-responsive">
            <table class="table table-bordered m-0">
              <thead class="table-light">
                <tr>
                  <th>선택</th><th>코드</th><th>이름</th><th>규격</th><th>단위</th><th>단가</th>
                </tr>
              </thead>
              <tbody id="itemSearchResults"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script th:inline="javascript">
    /*<![CDATA[*/
    $(function () {
    
      /*─────────────── 전역 변수 ───────────────*/
      let headerGridApi, detailGridApi, creditGridApi;
      let currentOrder = null;      // 선택(또는 신규) 헤더 레코드
      let editMode     = false;
      let selectedHeaderNode = null;
    
      /*─────────────── 공통 유틸 ───────────────*/
      function safeSetRowData(api, rows){
        if (!api) return;
        if (api.setRowData)            api.setRowData(rows);               // v28-32
        else if (api.setGridOption)    api.setGridOption('rowData', rows); // v33
      }
      function safeSetPinnedBottomRow(api, rows){
        if (!api) return;
        if (api.setPinnedBottomRowData) api.setPinnedBottomRowData(rows);          // v28-32
        else if (api.setGridOption)     api.setGridOption('pinnedBottomRowData', rows); // v33
      }
    
      /*──────────────── 1. 헤더 그리드 ────────────────*/
      const headerGridOptions = {
        columnDefs:[
        { headerName:'주문번호', field:'orderNo', pinned:'left',
          width:150, cellClass:'font-weight-bold text-primary', editable: false }, // PK는 편집 금지
        { headerName:'주문일자', field:'orderDt', minWidth:110, flex:1, editable: true, cellEditor: 'agDatePicker' },
        { headerName:'거래처',   field:'customerNm', minWidth:150, flex:1, editable: false },
        { headerName:'대표',     field:'representativeNm', minWidth:110, flex:1, editable: false },
        { headerName:'연락처',   field:'phoneNo', minWidth:120, flex:1, editable: false },
        { headerName:'담당자',   field:'salesEmpCd', minWidth:100, flex:1, editable: false },
        { headerName:'할인율(%)',field:'discountRate', minWidth:90,  flex:1,
          valueFormatter:p=> (p.value??0)+'%', editable: false },
        { headerName:'결제조건', field:'paymentTerms',   minWidth:100, flex:1, editable: true },
        { headerName:'작성자',   field:'orderWriter',    minWidth:90,  flex:1, editable: true }
      ],
        headerHeight: 35,
        rowHeight: 35,
        rowSelection:{ mode:'multiRow', checkboxes:true, headerCheckbox:true },
        onRowClicked: handleHeaderRowClicked,
        pagination:true,
        paginationPageSize:10,
        defaultColDef:{ resizable:true, sortable:true, filter:true },
        onCellClicked: onHeaderCellClicked,
        onGridReady:p=>{ headerGridApi = p.api; loadHeaderData(); },
        resizable:true,
        sortable:true,
        filter:true,
        editable: true
      };
    
      /*──────────────── 2. 여신 그리드 – “가로” 구조 ───────────────*/
      const creditGridOptions = {
        columnDefs:[
        { headerName:'여신한도',     field:'creditLimit',     minWidth:110, flex:1,
          type:'numericColumn', valueFormatter:p=>numFmt(p.value) },
        { headerName:'여신잔액',     field:'remainingCredit', minWidth:110, flex:1,
          type:'numericColumn', valueFormatter:p=>numFmt(p.value) },
        { headerName:'여신사용액',   field:'creditUsed',      minWidth:110, flex:1,
          type:'numericColumn', valueFormatter:p=>numFmt(p.value) },
        { headerName:'여신상태',     field:'creditStatus',    minWidth:90,  flex:1 },
        { headerName:'보류여부',     field:'creditHoldFlg',   minWidth:80,  flex:1 },
        { headerName:'거래정지',     field:'tradeStopFlg',    minWidth:80,  flex:1 }
      ],
        // 헤더 높이 지정
        headerHeight: 35,
        // 행 높이 지정
        rowHeight: 35,
        defaultColDef:{ resizable:true },
        rowData:[getInitCreditObj()],          // ← 단 일 행
        suppressRowClickSelection:true,
        suppressMovableColumns:true,
        onGridReady:p=> creditGridApi = p.api,
        domLayout:'autoHeight'
      };
    
      /*──────────────── 3. 디테일 그리드 ────────────────*/
      const detailColDefs = [
        { checkboxSelection:true, headerCheckboxSelection:true, width:50 },
        { headerName:'순번',     field:'lineNo', width:60, cellClass:'text-center', editable: false },
        { headerName:'품목코드', field:'itemCode', width:120, editable: true },
        { headerName:'품목명',   field:'itemName', width:180, editable: true },
        { headerName:'규격',     field:'spec',     width:120, editable: true },
        { headerName:'수량',     field:'qty',      width:90,  type:'numericColumn',
          valueFormatter:p=>Number(p.value||0).toLocaleString(), editable: true },
        { headerName:'단가',     field:'unitPrice',width:110, type:'numericColumn',
          valueFormatter:p=>Number(p.value||0).toLocaleString(), editable: true },
        { headerName:'공급가액', field:'supplyAmount', width:120, type:'numericColumn',
          valueFormatter:p=>Number(p.value||0).toLocaleString(), editable: true },
        { headerName:'부가세',   field:'taxAmount',  width:100, type:'numericColumn',
          valueFormatter:p=>Number(p.value||0).toLocaleString(), editable: true },
        { headerName:'합계',     field:'totalAmount',width:120, type:'numericColumn',
          cellClass:'font-weight-bold',
          valueFormatter:p=>Number(p.value||0).toLocaleString(), editable: false },
        { headerName:'출고일',   field:'outboundDt', width:110,
          valueFormatter:p=> p.value ? dayjs(p.value).format('YYYY-MM-DD') : '',
          editable: true, cellEditor: 'agDatePicker' },
        { headerName:'납기일',   field:'catchDt',    width:110,
          valueFormatter:p=> p.value ? dayjs(p.value).format('YYYY-MM-DD') : '',
          editable: true, cellEditor: 'agDatePicker' },
        { headerName:'출고상태', field:'outState',   width:100, editable: true },
        { headerName:'비고',     field:'remarks',    flex:1, editable: true }
      ];

    
      const detailGridOptions = {
        // 헤더 높이 지정
        headerHeight: 35,
        // 행 높이 지정
        rowHeight: 35,
        resizable:true,
        editable: true,
        columnDefs : detailColDefs,
        defaultColDef:{ resizable:true },
        rowSelection:'multiple',
        animateRows:true,
        onGridReady:p=>{ detailGridApi = p.api; setEditMode(false); },
        onCellValueChanged:()=> setTimeout(calcTotals,80)
      };
    
      /*─────────────── 그리드 생성 ───────────────*/
      headerGridApi = agGrid.createGrid(document.getElementById('headerGrid'),  headerGridOptions).api;
      detailGridApi = agGrid.createGrid(document.getElementById('detailGrid'),  detailGridOptions).api;
      creditGridApi = agGrid.createGrid(document.getElementById('creditGrid'),  creditGridOptions).api;

      /*──────────────── 4. “신규” 버튼 ────────────────*/
      $('#btnNew').click(createNew);
    
      function createNew(){
        $.get('/bsn/orders/nextOrderNo').done(no=>{
          const today = dayjs().format('YYYY-MM-DD');
          const newHeader = {
            orderNo   : no,
            orderDt   : today,
            customerNm: '',          // 이후 자동 채움
            paymentTerms:'Net 30'
          };
    
          /* 헤더 그리드 최상단에 추가 */
          headerGridApi.applyTransaction({ add:[newHeader], addIndex:0 });
          headerGridApi.ensureIndexVisible(0);
          headerGridApi.setFocusedCell(0,'customerNm');
    
          /* 디테일 그리드 빈 행 1줄 */
          safeSetRowData(detailGridApi,[{ lineNo:1, qty:1 }]);
          calcTotals();
    
          /* 여신 초기화 & 편집 모드 on */
          safeSetRowData(creditGridApi, getInitCreditRows());
          currentOrder = newHeader;
          setEditMode(true);
        });
      }

        function headerCellValueChanged(event) {
        const dto = {
          orderNo:      event.data.orderNo,
          orderDt:      event.data.orderDt,
          paymentTerms: event.data.paymentTerms,
          orderWriter:  event.data.orderWriter,
          remarks:      event.data.remarks
        };
        $.ajax({
          url: `/bsn/orders/${encodeURIComponent(dto.orderNo)}`,
          method: 'PUT',
          contentType: 'application/json',
          data: JSON.stringify(dto),
        })
        .done(() => {
          console.log('헤더 업데이트 성공');
        })
        .fail(err => {
          console.error('헤더 업데이트 실패', err);
          // 실패 시 원래 값으로 되돌리기
          event.node.setDataValue(event.colDef.field, event.oldValue);
        });
      }

      function detailCellValueChanged(event) {
        const d = event.data;
        const dto = {
          orderNo:     d.orderNo,
          lineNo:      d.lineNo,
          itemCode:    d.itemCode,
          qty:         d.qty,
          unitPrice:   d.unitPrice,
          supplyAmount:d.supplyAmount,
          remarks:     d.remarks
        };
        $.ajax({
          url: `/bsn/orders/${encodeURIComponent(dto.orderNo)}/details/${dto.lineNo}`,
          method: 'PUT',
          contentType: 'application/json',
          data: JSON.stringify(dto),
        })
        .done(() => {
          console.log('디테일 업데이트 성공');
        })
        .fail(err => {
          console.error('디테일 업데이트 실패', err);
          event.node.setDataValue(event.colDef.field, event.oldValue);
        });
      }

      // 예: 고객 검색 결과 테이블에서 “선택” 버튼 클릭 핸들러
      $('#customerSearchResults').on('click', '.btn-select-cust', function() {
        const cust = $(this).data('cust'); // { customerCd, customerNm, representativeNm, phoneNo, salesEmpCd, discountRate }
        // 헤더 그리드에 한 번에 반영
        ['customerCd','customerNm','representativeNm','phoneNo','salesEmpCd','discountRate']
          .forEach(f => selectedHeaderNode.setDataValue(f, cust[f]));
        // currentOrder 갱신
        currentOrder = selectedHeaderNode.data;
        $('#customerModal').modal('hide');
      });

      
      $(function(){
      
        // … 기존 초기화 코드 …
      
        // 1) 헤더 저장 버튼 핸들러
        $('#btnSaveHeader').click(function(){
          if(!currentOrder || !currentOrder.orderNo){
            Swal.fire('알림','저장할 헤더를 선택 또는 생성해주세요.','info');
            return;
          }
          // 편집 중단
          headerGridApi.stopEditing();
          // DTO 생성
          const headerDto = {
            orderNo:      currentOrder.orderNo,
            orderDt:      currentOrder.orderDt,
            customerCd:   currentOrder.customerCd,
            paymentTerms: currentOrder.paymentTerms,
            orderWriter:  currentOrder.orderWriter,
            remarks:      currentOrder.remarks
          };
          Swal.showLoading();
          $.ajax({
            url: `/bsn/orders/${encodeURIComponent(headerDto.orderNo)}`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(headerDto)
          })
          .done(() => {
            Swal.fire('완료','헤더가 저장되었습니다.','success');
            loadHeaderData();
          })
          .fail(() => {
            Swal.fire('실패','헤더 저장 중 오류가 발생했습니다.','error');
          });
        });
      
        // 2) 디테일 저장 버튼 핸들러
        $('#btnSaveDetail').click(function(){
          if(!currentOrder || !currentOrder.orderNo){
            Swal.fire('알림','먼저 헤더를 선택하거나 생성해주세요.','info');
            return;
          }
          detailGridApi.stopEditing();
          // 모든 디테일 행 수집
          const details = [];
          detailGridApi.forEachNode(node => {
            const d = node.data;
            // 필수 필드(itemCode)가 있으면 포함
            if(d.itemCode){
              details.push({
                orderNo:     currentOrder.orderNo,
                lineNo:      d.lineNo,
                itemCode:    d.itemCode,
                qty:         d.qty,
                unitPrice:   d.unitPrice,
                supplyAmount:d.supplyAmount,
                taxAmount:   d.taxAmount,
                totalAmount: d.totalAmount,
                outboundDt:  d.outboundDt,
                catchDt:     d.catchDt,
                outState:    d.outState,
                remarks:     d.remarks
              });
            }
          });
          if(details.length === 0){
            Swal.fire('안내','저장할 디테일이 없습니다.','warning');
            return;
          }
          Swal.showLoading();
          $.ajax({
            url: `/bsn/orders/${encodeURIComponent(currentOrder.orderNo)}/details`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(details)
          })
          .done(() => {
            Swal.fire('완료','디테일이 저장되었습니다.','success');
          })
          .fail(() => {
            Swal.fire('실패','디테일 저장 중 오류가 발생했습니다.','error');
          });
        });
      });

      // 1-1) 모달이 열릴 때 거래처 리스트 로드
      $('#customerModal').on('shown.bs.modal', function() {
        loadCustomerList();  
        $('#customerSearchInput').val('');      // 검색창 초기화
      });
      
      // 1-2) 검색 버튼 클릭 시에도 조회
      $('#btnCustomerSearch').click(function() {
        loadCustomerList($('#customerSearchInput').val());
      });
      
      // 1-3) 거래처 조회 함수
      function loadCustomerList(keyword = '') {
        $.getJSON('/bsn/customers', { name: keyword })
          .done(function(data) {
            const $tbody = $('#customerSearchResults').empty();
            data.forEach(function(c) {
              const custJson = encodeURIComponent(JSON.stringify(c));
              $tbody.append(`
                <tr>
                  <td>
                    <button class="btn btn-sm btn-primary btn-select-cust"
                            data-cust="${custJson}">
                      선택
                    </button>
                  </td>
                  <td>${c.customerCd}</td>
                  <td>${c.customerNm}</td>
                  <td>${c.representativeNm}</td>
                  <td>${c.phoneNo}</td>
                </tr>
              `);
            });
          })
          .fail(function() {
            Swal.fire('오류','거래처 목록을 불러오지 못했습니다.','error');
          });
      }
      
      // 1-4) “선택” 버튼 클릭 시 헤더 그리드에 값 반영
      $('#customerSearchResults').on('click', '.btn-select-cust', function() {
        const c = JSON.parse(decodeURIComponent($(this).data('cust')));
        ['customerCd','customerNm','representativeNm','phoneNo','salesEmpCd','discountRate']
          .forEach(f => selectedHeaderNode.setDataValue(f, c[f]));
        currentOrder = selectedHeaderNode.data;
        $('#customerModal').modal('hide');
      });


    
      /*──────────────── 5. 저장 버튼 ────────────────*/
      $('#btnSave').click(saveOrder);
    
      function saveOrder(){
        if(!editMode){
          Swal.fire('알림','편집 모드가 아닙니다. “신규” 버튼을 먼저 클릭하세요.','info');
          return;
        }
        headerGridApi.stopEditing();
    
        const headerData = currentOrder;
        if(!headerData){
          Swal.fire('오류','헤더 정보가 없습니다.','error'); return;
        }
    
        const details=[];
        detailGridApi.forEachNode(n=>{
          if(n.data.itemCode) details.push({...n.data});
        });
        if(details.length===0){
          Swal.fire('안내','품목을 한 개 이상 입력해 주세요.','warning'); return;
        }
    
        const dto = {...headerData, details};
    
        Swal.showLoading();
        $.ajax({
          url:'/bsn/orders',
          method:'POST',
          contentType:'application/json',
          data:JSON.stringify(dto)
        }).done(r=>{
          if(r.success){
            Swal.fire('저장 완료','주문서가 등록되었습니다.','success');
            setEditMode(false);
            loadHeaderData();
          }else{
            Swal.fire('저장 실패',r.message||'서버 오류','error');
          }
        }).fail(()=> Swal.fire('저장 실패','통신 오류가 발생했습니다.','error'));
      }


    
      /*──────────────── 헤더 클릭 → 디테일 + 여신 ───────────────*/
      // ① 헤더 행 클릭 시
      function handleHeaderRowClicked(e){
        const { orderNo, customerCd } = e.data;   // ← customerCd 가 이미 헤더에 담겨있음
        currentOrder = e.data;
      
        // 주문 상세
        const reqDetail = $.getJSON(`/bsn/orders/${orderNo}/details`);
        // ★ 여신 : 새 API
        const reqCredit = $.getJSON(`/bsn/customer/${customerCd}/credit`);
      
        $.when(reqDetail, reqCredit).done((dRes, cRes)=>{
            safeSetRowData(detailGridApi, dRes[0]);
            showCredit(cRes[0]);
            calcTotals();
        }).fail(()=> Swal.fire('오류','데이터를 불러오지 못했습니다','error'));
      }
      
      // ② 신규 입력 중 고객을 바꿨을 때도 호출
      function afterSelectCustomer(cust){          // cust = {customerCd, …}
        currentOrder.customerCd = cust.customerCd;
        $('#customerNmInput').val(cust.customerNm);
        // ★ 고객 선택 즉시 여신 새로 고침
        $.getJSON(`/bsn/customer/${cust.customerCd}/credit`).done(showCredit);
      }
      
      function showCredit(c){                      // CreditInfoDTO → 그리드 행 1개
        safeSetRowData(creditGridApi,[{
          creditLimit     : c.creditLimit     ?? 0,
          remainingCredit : c.remainingCredit?? 0,
          creditUsed      : c.creditUsed     ?? 0,
          creditStatus    : c.creditStatus   ?? '',
          creditHoldFlg   : c.creditHoldFlg  ?? '',
          tradeStopFlg    : c.tradeStopFlg   ?? ''
        }]);
      }
      /*──────────────── 여신 정보 채우기 ───────────────*/
      function fillCredit(c){
        const row = {
          creditLimit     : c.creditLimit     ?? 0,
          remainingCredit : c.remainingCredit?? 0,
          creditUsed      : c.creditUsed     ?? 0,
          creditStatus    : c.creditStatus   ?? '',
          creditHoldFlg   : c.creditHoldFlg  ?? '',
          tradeStopFlg    : c.tradeStopFlg   ?? ''
        };
        safeSetRowData(creditGridApi,[row]);
      }

      function onHeaderCellClicked(event) {
        if (event.colDef.field === 'customerNm') {
          selectedHeaderNode = event.node;
          // 검색 인풋 초기화
          $('#customerSearchInput').val('');
          $('#customerSearchResults').empty();
          $('#customerModal').modal('show');
        }
      }
    
      /*──────────────── 7. 삭제 버튼(다중) ────────────────*/
      $('#btnDelete').click(deleteOrder);
    
      function deleteOrder(){
        const sel = headerGridApi.getSelectedRows();
        if(sel.length===0){
          Swal.fire('선택 필요','삭제할 주문서를 체크해 주세요.','warning'); return;
        }
        Swal.fire({
          title:'삭제 확인',
          text:`선택한 ${sel.length}건을 삭제하시겠습니까?`,
          icon:'warning',
          showCancelButton:true,
          confirmButtonColor:'#e74a3b',
          cancelButtonColor:'#6c757d',
          confirmButtonText:'삭제',
          cancelButtonText:'취소'
        }).then(r=>{
          if(!r.isConfirmed) return;
          Swal.showLoading();
          const jobs=sel.map(o=> $.ajax({url:`/bsn/orders/${o.orderNo}`,method:'DELETE'}));
          $.when.apply($,jobs).done(()=>{
            Swal.fire('삭제 완료','삭제되었습니다.','success');
            loadHeaderData();
            safeSetRowData(detailGridApi,[]);
            fillCredit(getInitCreditRows());
          }).fail(()=> Swal.fire('삭제 실패','서버 오류가 발생했습니다.','error'));
        });
      }
    
      /*──────────────── 8. 데이터 로드/계산 ────────────────*/
      function loadHeaderData(){
        $.get('/bsn/sorlist/data')
          .done(list=> safeSetRowData(headerGridApi,list))
          .fail(()=> console.error('주문 목록 로드 실패'));
      }
      function fillCredit(c){
        safeSetRowData(creditGridApi,[
          {field:'여신한도',   value:c.creditLimit,     format:'currency'},
          {field:'여신잔액',   value:c.remainingCredit,format:'currency'},
          {field:'여신사용액', value:c.creditUsed,     format:'currency'},
          {field:'여신상태',   value:c.creditStatus,   format:'text'},
          {field:'거래정지',   value:c.tradeStopFlg,   format:'text'}
        ]);
      }
      function calcTotals(){
        let supply=0,tax=0,total=0;
        detailGridApi.forEachNode(n=>{
          supply+=Number(n.data.supplyAmount||0);
          tax   +=Number(n.data.taxAmount  ||0);
          total +=Number(n.data.totalAmount||0);
        });
        safeSetPinnedBottomRow(detailGridApi,[{
          itemCode:'합계', supplyAmount:supply, taxAmount:tax, totalAmount:total
        }]);
      }
    
      /*──────────────── 9. 기타 ────────────────*/
      function getInitCreditRows(){
        return [
          {field:'여신한도',   value:0, format:'currency'},
          {field:'여신잔액',   value:0, format:'currency'},
          {field:'여신사용액', value:0, format:'currency'},
          {field:'여신상태',   value:'',format:'text'},
          {field:'거래정지',   value:'',format:'text'}
        ];
      }
      function setEditMode(flag){
        editMode = flag;
        detailGridApi.refreshCells({force:true});
        headerGridApi.refreshCells({force:true});
        $('#btnSave,#btnAddRow,#btnDeleteRow').prop('disabled', !flag);
      }

      /*─────────────── 보조 함수 ───────────────*/
      function getInitCreditObj(){
        return {
          creditLimit    :0,
          remainingCredit:0,
          creditUsed     :0,
          creditStatus   :'',
          creditHoldFlg  :'',
          tradeStopFlg   :''
        };
      }
      function numFmt(v){ return Number(v||0).toLocaleString()+'원'; }
      function setEditMode(flag){
        editMode = flag;
        detailGridApi.refreshCells({force:true});
        headerGridApi.refreshCells({force:true});
        $('#btnSave,#btnAddRow,#btnDeleteRow').prop('disabled', !flag);
      }
      console.log('주문서 관리 JS 초기화 완료');
    });
    /*]]>*/
    </script>
</div>
</html>