<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{common/layouts/default}">

<head>
  <meta charset="UTF-8" />  
  <title>주문서 관리</title>
  
  <style>
    /* 전체 컨테이너 */
    .management-container {
      padding: 10px;
      min-height: 100vh;
    }
    
    /* 섹션 박스 스타일 */
    .section-box {
      padding: 15px;
      border: 1px solid #e3e6f0;
      border-radius: 8px;
      background-color: #ffffff;
      margin-bottom: 15px;
      box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    }
    
    .section-box h6 {
      margin-bottom: 12px;
      color: #5a5c69;
      font-weight: 700;
      border-bottom: 2px solid #4e73df;
      padding-bottom: 8px;
      font-size: 1rem;
    }
    
    /* 버튼 색상 (SB Admin 2 스타일에 맞춤) */
    .btn-create { 
      background-color: #1cc88a; 
      border-color: #1cc88a;
      color: white; 
    }
    .btn-create:hover {
      background-color: #17a673;
      border-color: #17a673;
    }
    
    .btn-edit { 
      background-color: #36b9cc; 
      border-color: #36b9cc;
      color: white; 
    }
    .btn-edit:hover {
      background-color: #2c9faf;
      border-color: #2c9faf;
    }
    
    .btn-delete { 
      background-color: #e74a3b; 
      border-color: #e74a3b;
      color: white; 
    }
    .btn-delete:hover {
      background-color: #c0392b;
      border-color: #c0392b;
    }
    
    .btn-save { 
      background-color: #4e73df; 
      border-color: #4e73df;
      color: white; 
    }
    .btn-save:hover {
      background-color: #2e59d9;
      border-color: #2e59d9;
    }
    
    /* 그리드 높이 설정 */
    .header-grid { height: 300px; }
    .credit-grid { height: 240px; }
    .detail-grid { height: 350px; }
    
    /* 탭 스타일 (SB Admin 2 맞춤) */
    .nav-tabs {
      border-bottom: 1px solid #dee2e6;
    }
    
    .nav-tabs .nav-link {
      border: 1px solid transparent;
      border-top-left-radius: 0.35rem;
      border-top-right-radius: 0.35rem;
      color: #858796;
      font-weight: 600;
    }
    
    .nav-tabs .nav-link.active {
      background-color: #4e73df;
      border-color: #4e73df;
      color: white;
    }
    
    /* AG-Grid 커스텀 스타일 (SB Admin 2 테마 맞춤) */
    .ag-theme-alpine {
      --ag-background-color: #ffffff;
      --ag-header-background-color: #f8f9fc;
      --ag-header-foreground-color: #5a5c69;
      --ag-border-color: #e3e6f0;
      --ag-row-hover-color: #f8f9fc;
      --ag-selected-row-background-color: #eaecf4;
      --ag-font-size: 14px;
      --ag-font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    }
    
    .ag-theme-alpine .ag-header-cell {
      font-weight: 700;
      color: #5a5c69;
    }
    
    .ag-theme-alpine .ag-row-even {
      background-color: #ffffff;
    }
    
    .ag-theme-alpine .ag-row-odd {
      background-color: #f8f9fc;
    }
    
    /* 읽기 전용 셀 스타일 */
    .readonly-cell {
      background-color: #f8f9fc !important;
      color: #6c757d !important;
    }
    
    /* 편집 가능한 셀 스타일 */
    .editable-cell {
      background-color: #ffffff !important;
      border: 1px solid #4e73df !important;
    }
    
    /* 제목 헤더 스타일 */
    .page-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 8px;
      padding: 12px 20px;
      margin-bottom: 20px;
    }
    
    /* 카드 스타일 */
    .card {
      box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
      border: 1px solid #e3e6f0;
    }
    
    /* 모달 스타일 */
    .modal-header {
      background-color: #4e73df;
      color: white;
      border-bottom: none;
    }
    
    .modal-header .btn-close {
      filter: invert(1);
    }
    
    /* 합계 행 스타일 */
    .ag-theme-alpine .ag-pinned-bottom-row {
      background-color: #4e73df !important;
      color: white !important;
      font-weight: bold;
    }
    
    .ag-theme-alpine .ag-pinned-bottom-row .ag-cell {
      border-top: 2px solid #2e59d9;
    }
  </style>
</head>

<div layout:fragment="content" class="management-container">
  
  <!-- 페이지 제목 -->
  <div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h4 class="mb-0">
          <i class="fas fa-clipboard-list mr-2"></i>주문서 관리
        </h4>
        <small class="opacity-75">주문서 등록, 수정, 삭제 및 조회</small>
      </div>
      
      <!-- 액션 버튼들 -->
      <div>
        <button type="button" class="btn btn-create btn-sm me-1" id="btnNew">
          <i class="fas fa-plus"></i> 신규
        </button>
        <button type="button" class="btn btn-edit btn-sm me-1" id="btnEdit">
          <i class="fas fa-edit"></i> 수정
        </button>
        <button type="button" class="btn btn-delete btn-sm me-1" id="btnDelete">
          <i class="fas fa-trash"></i> 삭제
        </button>
        <button type="button" class="btn btn-save btn-sm" id="btnSave">
          <i class="fas fa-save"></i> 등록
        </button>
      </div>
    </div>
  </div>

  <!-- 주문서 헤더 + 여신정보 -->
  <div class="row">
    <!-- 주문서 헤더 목록 그리드 -->
    <div class="col-lg-8 col-md-7">
      <div class="card section-box">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-list mr-2"></i>주문서 헤더 목록
          </h6>
        </div>
        <div class="card-body">
          <div id="headerGrid" class="ag-theme-alpine header-grid"></div>
        </div>
      </div>
    </div>

    <!-- 여신 정보 그리드 -->
    <div class="col-lg-4 col-md-5">
      <div class="card section-box">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-success">
            <i class="fas fa-credit-card mr-2"></i>여신 정보
          </h6>
        </div>
        <div class="card-body">
          <div id="creditGrid" class="ag-theme-alpine credit-grid"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 주문서 디테일 그리드 -->
  <div class="card section-box">
    <div class="card-header py-3">
      <div class="d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold text-info">
          <i class="fas fa-boxes mr-2"></i>주문서 디테일
        </h6>
        <div>
          <button type="button" class="btn btn-info btn-sm" id="btnAddRow">
            <i class="fas fa-plus"></i> 행 추가
          </button>
          <button type="button" class="btn btn-warning btn-sm" id="btnDeleteRow">
            <i class="fas fa-minus"></i> 행 삭제
          </button>
        </div>
      </div>
    </div>
    <div class="card-body">
      <div id="detailGrid" class="ag-theme-alpine detail-grid"></div>
    </div>
  </div>

  <!-- 거래처 검색 모달 -->
  <div class="modal fade" id="customerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-search mr-2"></i>거래처 조회
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="input-group mb-3">
            <input id="customerSearchInput" type="text" class="form-control" placeholder="거래처명 검색">
            <button id="btnCustomerSearch" class="btn btn-outline-primary">
              <i class="fas fa-search"></i> 검색
            </button>
          </div>
          <div class="table-responsive">
            <table class="table table-bordered mb-0">
              <thead class="table-light">
                <tr>
                  <th>선택</th><th>코드</th><th>이름</th><th>대표명</th><th>전화번호</th>
                </tr>
              </thead>
              <tbody id="customerSearchResults"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 품목 검색 모달 -->
  <div class="modal fade" id="itemModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-cube mr-2"></i>품목 목록
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
          <div class="table-responsive">
            <table class="table table-bordered m-0">
              <thead class="table-light">
                <tr>
                  <th>선택</th><th>코드</th><th>이름</th><th>규격</th><th>단위</th><th>단가</th>
                </tr>
              </thead>
              <tbody id="itemSearchResults"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script th:inline="javascript">
    /*<![CDATA[*/
    $(function () {
    
      /*──────────────── 전역 변수 ────────────────*/
      let headerGridApi, detailGridApi, creditGridApi;
      let currentOrder = null;
      let editMode     = false;
    
      /*──────────────── 공통 헬퍼 ────────────────*/
      /** v28~v32 : setRowData, v33 : setGridOption */
      function safeSetRowData(api, rows){
        if (!api) return;
        if (typeof api.setRowData === 'function')          api.setRowData(rows);           // 구버전
        else if (typeof api.setGridOption === 'function')  api.setGridOption('rowData', rows); // v33
        else if (api.applyTransaction)                     api.applyTransaction({ setRowData:true, data:rows });
      }
    
      /*──────────────── 1. 헤더 그리드 ────────────────*/
      const headerGridOptions = {
        columnDefs: [
          { headerName:'주문번호', field:'orderNo', pinned:'left', width:140 },
          { headerName:'주문일자', field:'orderDt', width:110 },
          { headerName:'거래처',   field:'customerNm', width:150 },   // ← 변경
          { headerName:'대표',     field:'representativeNm', width:110 },
          { headerName:'연락처',   field:'phoneNo', width:120 },
          { headerName:'담당자',   field:'salesEmpCd', width:100 },
          { headerName:'할인율(%)',field:'discountRate', width:90,
            valueFormatter:p=> (p.value ?? 0)+'%' },
          { headerName:'결제조건', field:'paymentTerms', width:100 },
          { headerName:'작성자',   field:'orderWriter', width:90 }
        ],
        onRowClicked: handleHeaderRowClicked,
        defaultColDef:{ resizable:true, sortable:true, filter:true },
        rowSelection:'single',
        pagination:true,
        paginationPageSize:10,
        paginationPageSizeSelector:[10,20,50,100],
        onGridReady:p=>{
          headerGridApi = p.api;
          loadHeaderData();
        }
      };
    
      /*──────────────── 2. 여신 그리드 ────────────────*/
      const creditGridOptions = {
        columnDefs:[
          { headerName:'항목', field:'field', width:120,
            cellClass:'font-weight-bold text-secondary' },
          { headerName:'값', field:'value', flex:1, cellClass:'text-right',
            valueFormatter:p=> p.data.format==='currency'
                  ? Number(p.value||0).toLocaleString()+'원' : (p.value||'') }
        ],
        defaultColDef:{ resizable:true },
        rowData:getInitCreditRows(),
        onGridReady:p=> creditGridApi = p.api
      };
    
      /*──────────────── 3. 상세 그리드 ────────────────*/
      const detailGridOptions = {
        columnDefs:[
          { checkboxSelection:true, headerCheckboxSelection:true, width:50 },
          { headerName:'순번', field:'lineNo', width:60, cellClass:'text-center' },
          { headerName:'품목코드', field:'itemCode', width:120,
            editable:()=>editMode,
            cellClass:p=> editMode?'editable-cell text-primary':'readonly-cell' },
          { headerName:'품목명', field:'itemName', width:180, cellClass:'readonly-cell' },
          { headerName:'규격',   field:'spec', width:120, cellClass:'readonly-cell' },
          { headerName:'수량',   field:'qty',  width:90, editable:()=>editMode,
            cellEditor:'agNumberCellEditor',
            cellClass:p=> editMode?'editable-cell text-right':'readonly-cell text-right',
            valueFormatter:p=>Number(p.value||0).toLocaleString() },
          { headerName:'단가', field:'unitPrice', width:110,
            cellClass:'readonly-cell text-right',
            valueFormatter:p=>Number(p.value||0).toLocaleString() },
          { headerName:'공급가', field:'supplyAmount', width:120,
            cellClass:'readonly-cell text-right',
            valueFormatter:p=>Number(p.value||0).toLocaleString() },
          { headerName:'부가세', field:'taxAmount', width:100,
            cellClass:'readonly-cell text-right',
            valueFormatter:p=>Number(p.value||0).toLocaleString() },
          { headerName:'합계', field:'totalAmount', width:120,
            cellClass:'readonly-cell text-right font-weight-bold',
            valueFormatter:p=>Number(p.value||0).toLocaleString() },
          { headerName:'출고일',    field:'outboundDt', width:110,
            valueFormatter:p=> p.value ? dayjs(p.value).format('YYYY-MM-DD') : '' },
          { headerName:'납기일',    field:'catchDt',    width:110,
            valueFormatter:p=> p.value ? dayjs(p.value).format('YYYY-MM-DD') : '' },
          { headerName:'출고상태',  field:'outState',   width:100 },
          { headerName:'비고', field:'remarks', flex:1,
            editable:()=>editMode,
            cellClass:p=> editMode?'editable-cell':'readonly-cell' }
        ],
        defaultColDef:{ resizable:true },
        rowSelection:'multiple',
        animateRows:true,
        onGridReady:p=>{
          detailGridApi = p.api;
          setEditMode(false);
        },
        onCellValueChanged:()=> setTimeout(calcTotals,100)
      };
    
      function handleHeaderRowClicked(e){
        const { orderNo, customerCd } = e.data;

        detailGridApi.showLoadingOverlay();

        const ajaxDetail = $.getJSON(`/bsn/orders/${orderNo}/details`);
        const ajaxCredit = $.getJSON(`/bsn/customer/${customerCd}/credit`);

        $.when(ajaxDetail, ajaxCredit).done((dRes, cRes)=>{
            safeSetRowData(detailGridApi, dRes[0]);
            calcTotals();
        
            const creditRows = [
              { field:'여신한도',   value:cRes[0].creditLimit,     format:'currency'},
              { field:'여신잔액',   value:cRes[0].remainingCredit,format:'currency'},
              { field:'여신사용액', value:cRes[0].creditUsed,     format:'currency'},
              { field:'여신상태',   value:cRes[0].creditStatus,   format:'text'},
              { field:'거래정지',   value:cRes[0].tradeStopFlg,   format:'text'}
            ];
            safeSetRowData(creditGridApi, creditRows);
        
        }).fail(()=>{
            Swal.fire('오류','세부 데이터를 불러오지 못했습니다.','error');
            safeSetRowData(detailGridApi, []);
        }).always(()=>{
            detailGridApi.hideOverlay();
        });
      }


      /*──────────────── 4. 호환 빌더 ────────────────*/
      function buildGrid(el, opts){
        if (agGrid && typeof agGrid.createGrid === 'function') return agGrid.createGrid(el, opts).api;
        if (agGrid && agGrid.Grid) { new agGrid.Grid(el, opts); return opts.api; }
        throw new Error('AG-Grid 로드 실패');
      }
    
      headerGridApi = buildGrid(document.getElementById('headerGrid'),  headerGridOptions);
      creditGridApi = buildGrid(document.getElementById('creditGrid'),  creditGridOptions);
      detailGridApi = buildGrid(document.getElementById('detailGrid'),  detailGridOptions);
    
      /*──────────────── 5. 데이터 로드 ────────────────*/
      function loadHeaderData(){
        $.get('/bsn/orders')
          .done(list => safeSetRowData(headerGridApi, list))
          .fail(()=> console.error('주문 목록 로드 실패'));
      }
    
      function loadOrder(orderNo){
        $.get(`/bsn/orders/${orderNo}`)
          .done(dto=>{
            currentOrder = dto;
            safeSetRowData(detailGridApi, dto.details||[]);
            loadCustomerCredit(dto.customerCd);
            calcTotals();
            setEditMode(false);
          });
      }
    
      function loadCustomerCredit(customerCd){
        if(!customerCd){ safeSetRowData(creditGridApi, getInitCreditRows()); return; }
        $.get('/bsn/customer/detail',{customerCd})
          .done(c=>{
            safeSetRowData(creditGridApi, [
              {field:'여신한도',   value:c.creditLimit,    format:'currency'},
              {field:'여신잔액',   value:c.remainingCredit,format:'currency'},
              {field:'여신사용액', value:c.creditUsed,    format:'currency'},
              {field:'여신상태',   value:c.creditStatus,  format:'text'},
              {field:'거래정지',   value:c.tradeStopFlg,  format:'text'}
            ]);
          });
      }
    
      /*──────────────── 6. 버튼 ────────────────*/
      $('#btnNew').click(createNew);
      $('#btnSave').click(saveOrder);
      $('#btnDelete').click(deleteOrder);
      $('#btnAddRow').click(()=> editMode && addRow());
      $('#btnDeleteRow').click(()=> editMode && delRows());
    
      function createNew(){
        $.get('/bsn/orders/nextOrderNo').done(no=>{
          currentOrder = { orderNo:no, orderDt:new Date().toISOString().slice(0,10) };
          safeSetRowData(detailGridApi, []);
          safeSetRowData(creditGridApi, getInitCreditRows());
          setEditMode(true);
        });
      }
    
      function saveOrder(){
        if(!editMode){ alert('편집 모드가 아닙니다'); return; }
        $.ajax({
          url:'/bsn/orders', method:'POST', contentType:'application/json',
          data:JSON.stringify(extractDto())
        })
        .done(r=>{
          if(r.success){ alert('저장 완료'); loadHeaderData(); setEditMode(false); }
          else alert('저장 실패: '+r.message);
        })
        .fail(()=> alert('저장 실패'));
      }
    
      function deleteOrder(){
        if(!currentOrder){ alert('선택된 주문이 없습니다'); return; }
        if(!confirm('삭제하시겠습니까?')) return;
        $.ajax({ url:`/bsn/orders/${currentOrder.orderNo}`, method:'DELETE'})
          .done(r=>{
            if(r.success){
              alert('삭제 완료');
              loadHeaderData();
              safeSetRowData(detailGridApi, []);
              safeSetRowData(creditGridApi, getInitCreditRows());
              currentOrder=null;
            } else alert('삭제 실패: '+r.message);
          });
      }
    
      /*──────────────── 7. 상세 행 ────────────────*/
      function addRow(){
        const idx = detailGridApi.getDisplayedRowCount()+1;
        detailGridApi.applyTransaction({ add:[{lineNo:idx, qty:1}] });
      }
      function delRows(){
        detailGridApi.applyTransaction({ remove: detailGridApi.getSelectedRows()});
        calcTotals();
      }
    
      /*──────────────── 8. 합계 계산 ────────────────*/
      function calcTotals(){
        let supply=0,tax=0,total=0;
        detailGridApi.forEachNode(n=>{
          supply+=Number(n.data.supplyAmount||0);
          tax   +=Number(n.data.taxAmount||0);
          total +=Number(n.data.totalAmount||0);
        });
        detailGridApi.setPinnedBottomRowData([{
          itemCode:'합계', supplyAmount:supply, taxAmount:tax, totalAmount:total
        }]);
      }
    
      /*──────────────── 9. 편집 모드 ────────────────*/
      function setEditMode(flag){
        editMode = flag;
        detailGridApi.refreshCells({force:true});
        $('#btnSave,#btnAddRow,#btnDeleteRow').prop('disabled', !flag);
      }
    
      /*──────────────── 10. DTO ────────────────*/
      function extractDto(){
        const dto = {
          orderNo      : currentOrder?.orderNo,
          orderDt      : currentOrder?.orderDt,
          customerCd   : currentOrder?.customerCd,
          paymentTerms : currentOrder?.paymentTerms,
          orderWriter  : currentOrder?.orderWriter,
          coIdx        : currentOrder?.coIdx,
          remarks      : currentOrder?.remarks,
          details:[]
        };
        detailGridApi.forEachNode(n=>{ if(n.data.itemCode) dto.details.push({...n.data}); });
        return dto;
      }
    
      /*──────────────── 11. 여신 초기값 ────────────────*/
      function getInitCreditRows(){
        return [
          {field:'여신한도',   value:0, format:'currency'},
          {field:'여신잔액',   value:0, format:'currency'},
          {field:'여신사용액', value:0, format:'currency'},
          {field:'여신상태',   value:'',format:'text'},
          {field:'거래정지',   value:'',format:'text'}
        ];
      }
    
      console.log('주문서 관리 JS 초기화 완료');
    });
    /*]]>*/
    </script>
    
</div>
</html>