<!--
============================================
	- 작성자   : 복성민
	- 최초작성 : 2025-06-22
	- 설명    : E-FLIX 구독 결제 진행
--------------------------------------------
	[ 변경 이력 ]
	- 2025-06-22 (복성민): 생성
============================================
-->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>구독 결제 진행</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/bootstrap/vendor/jquery/jquery.min.js}"></script>

    <!-- PortOne SDK -->
    <script src="https://cdn.portone.io/v2/browser-sdk.js"></script>
    <script src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>

    <!-- html to pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        .step span {
            display: inline-block;
            border: 1px solid #ccc;
            border-radius: 50%;
            padding: 5px 10px;
            color: #555;
        }

        .step.active span {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }
    </style>
</head>

<body>
    <div class="container my-5">
        <div class="text-center mb-4">
            <img src="https://upload.wikimedia.org/wikipedia/commons/4/44/Microsoft_logo.svg" height="30" class="me-2">
            <h4 class="d-inline-block align-middle fw-bold">E-FELIX - Business <span
                    th:text="${subscriptionPackage.spkName}"></span></h4>
        </div>

        <div class="card shadow-lg border-0">
            <div class="bg-white p-4 rounded">
                <!-- Step Indicator -->
                <div class="row mb-4 text-center step-indicator">
                    <div class="col step step-1 active"><span>1</span>
                        <div>구독 정보</div>
                    </div>
                    <div class="col step step-2"><span>2</span>
                        <div>사용자 세부 정보</div>
                    </div>
                    <div class="col step step-3"><span>3</span>
                        <div>계약서</div>
                    </div>
                    <div class="col step step-4"><span>4</span>
                        <div>결제 및 완료</div>
                    </div>
                </div>

                <!-- Step 1 -->
                <div class="step-content step-1-content d-block">
                    <div class="row g-4">
                        <!-- Left -->
                        <div class="col-md-7">
                            <h5 class="fw-bold">구독 설정</h5>

                            <div class="mb-3">
                                <label class="form-label fw-bold">웹 및 핵심 서비스:</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="module" value="mou-101"
                                        id="hr">
                                    <label class="form-check-label" for="hr">인사</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="module" value="mou-104"
                                        id="bsn">
                                    <label class="form-check-label" for="bsn">영업</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="module" value="mou-103"
                                        id="purchs">
                                    <label class="form-check-label" for="purchs">재고</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="module" value="mou-102"
                                        id="acc">
                                    <label class="form-check-label" for="acc">회계</label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">구독 기간 선택</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="period" id="period-1month"
                                        value="1">
                                    <label class="form-check-label" for="period-month">1개월</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="period" id="period-3month"
                                        value="3">
                                    <label class="form-check-label" for="period-month">3개월</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="period" id="period-year"
                                        value="12" checked>
                                    <label class="form-check-label" for="period-year">1년</label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">얼마나 자주 청구하시겠습니까?</label>
                                <select class="form-select" id="billing-cycle">
                                    <option value="annual">년</option>
                                    <option value="monthly">월</option>
                                    <option value="once">일시불</option>
                                </select>
                            </div>

                            <div class="border-top pt-3">
                                <div class="fw-bold mb-1">E-FELIX - Business <span th:text="${type}"></span></div>
                                <div class="text-muted mb-2" id="subscription-summary"></div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <span class="text-muted">오늘 결제 기한 (세금이 포함되지 않음)</span>
                                <span class="price-box" id="resultPrice">₩202,800.00</span>
                            </div>

                            <div class="d-grid mt-4">
                                <button class="btn btn-primary" id="next-to-step-2">다음</button>
                            </div>
                        </div>

                        <!-- Right -->
                        <div class="col-md-5">
                            <div class="bg-white p-4">
                                <h5 class="fw-bold">E-FLIX - Business Standard</h5>
                                <p class="">제품 하이라이트</p>
                                <ul>
                                    <li><strong>[인사]</strong> 인사 문서, 근태표, 인사평가 및 급여 명세를 효율적으로 관리하세요.</li>
                                    <li>모든 직원 정보에 <strong>언제 어디서나 안전하게 접근</strong></li>
                                    <li><strong>상시 인사 지원 체계</strong> 포함</li>
                                </ul>

                                <ul>
                                    <li><strong>[영업]</strong> 견적, 계약서, 영업 보고서 등을 빠르게 작성하고 공유하세요.</li>
                                    <li><strong>거래 데이터</strong>를 안전하게 클라우드에 저장</li>
                                    <li><strong>24시간 영업 지원</strong> 가능</li>
                                </ul>

                                <ul>
                                    <li><strong>[재고]</strong> 입출고, 재고 현황 및 창고 관리를 쉽게 시작하세요.</li>
                                    <li><strong>다양한 기기</strong>에서 재고 데이터 확인 및 관리</li>
                                </ul>

                                <ul>
                                    <li><strong>[회계]</strong> 전표, 세금계산서, 재무제표 작성을 빠르게 시작하세요.</li>
                                    <li><strong>언제 어디서나</strong> 회계 문서 접근 가능</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2 -->
                <div class="step-content step-2-content d-none">
                    <div class="row g-4">
                        <!-- Left -->
                        <div class="col-md-7">
                            <h5 class="fw-bold">구매자 정보</h5>

                            <!-- 가입 정보 -->
                            <fieldset class="border rounded-3 p-3">
                                <legend class="float-none w-auto px-2 fs-6 fw-semibold">가입 정보</legend>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="sameAsSubscriber">
                                    <label class="form-check-label" for="sameAsSubscriber">가입자와 동일</label>
                                </div>
                                <div class="row g-2 mb-3">
                                    <div class="col-md-6"><input type="text" class="form-control" id="pschName"
                                            placeholder="신청자">
                                    </div>
                                    <div class="col-md-6"><input type="text" class="form-control" id="pschTel"
                                            placeholder="연락처">
                                    </div>
                                    <div class="col-md-6"><input type="text" class="form-control" id="coName"
                                            placeholder="회사명">
                                    </div>
                                    <div class="col-md-6"><input type="text" class="form-control" id="coNameEn"
                                            placeholder="회사 영문명">
                                    </div>
                                    <div class="col-md-6"><input type="text" class="form-control" id="ceoName"
                                            placeholder="대표자명">
                                    </div>
                                    <div class="col-md-6"><input type="text" class="form-control" id="ceoTel"
                                            placeholder="연락처">
                                    </div>
                                    <div class="col-md-6"><input type="text" class="form-control" id="coAddr"
                                            placeholder="주소">
                                    </div>
                                    <div class="col-md-6"><input type="text" class="form-control" id="bizr_no"
                                            placeholder="사업자 번호">
                                    </div>
                                    <div class="col-md-6"><input type="text" class="form-control" id="coAddrDetail"
                                            placeholder="나머지 주소">
                                    </div>
                                    <div class="col-md-6"><input type="text" class="form-control" id="coZip"
                                            placeholder="우편번호">
                                    </div>
                                    <div class="col-md-10"><input type="text" class="form-control" id="bizr_cert"
                                            placeholder="사업자 등록증">
                                    </div>
                                    <div class="col-md-2"><button class="btn btn-dark w-100">불러오기</button></div>
                                </div>
                            </fieldset>
                            <script th:inline="javascript">
                                let coIdx = null;
                                $(document).ready(function () {
                                    $('#sameAsSubscriber').change(function () {
                                        const userIdx = /*[[${session.userIdx}]]*/ "";
                                        if ($(this).is(':checked')) {
                                            // 체크되었을 때 AJAX로 가입자 정보 가져오기
                                            $.ajax({
                                                type: 'GET',
                                                url: `/company/find?userIdx=${userIdx}`,
                                                success: function (res) {
                                                    const data = res.body;
                                                    if (res.head.res_code === "200") {
                                                        coIdx = data.coIdx;
                                                        $('#pschName').val(data.pschName);
                                                        $('#pschTel').val(data.pschTel);
                                                        $('#coName').val(data.coName);
                                                        $('#coNameEn').val(data.coNameEn);
                                                        $('#ceoName').val(data.ceoName);
                                                        $('#ceoTel').val(data.ceoTel);
                                                        $('#coAddr').val(data.coAddr);
                                                        $('#bizr_no').val(data.bizrNo);
                                                        $('#coAddrDetail').val(data.coAddrDetail);
                                                        $('#coZip').val(data.coZip);
                                                        $('#bizr_cert').val(data.bizrCert);
                                                    } else {
                                                        Swal.fire({
                                                            title: "등록된 회사가 없습니다. </br> 해당 정보로 등록하시겠나요?",
                                                            showDenyButton: true,
                                                            confirmButtonText: "등록",
                                                            denyButtonText: `취소`,
                                                            icon: 'question'
                                                        }).then((result) => {
                                                            /* Read more about isConfirmed, isDenied below */
                                                            if (result.isConfirmed) {
                                                                Swal.fire("저장되었습니다", "", "success");
                                                            }
                                                        });
                                                    }

                                                },
                                                error: function (xhr, status, err) {
                                                    console.error(err);
                                                    Swal.fire("오류", "서버와 통신 중 문제가 발생했습니다.", "error");
                                                }
                                            });
                                        } else {
                                            // 체크 해제 시 폼의 모든 input 값을 초기화
                                            $('#targetForm input').val('');
                                        }
                                    });
                                });
                            </script>

                            <!-- 마스터 ID 정보 -->
                            <fieldset class="border rounded-3 p-3">
                                <legend class="float-none w-auto px-2 fs-6 fw-semibold">마스터 ID 정보</legend>
                                <div class="row g-2 mb-3">
                                    <div class="col-md-6"><input type="text" class="form-control" id="mstId"
                                            placeholder="마스터 ID">
                                    </div>
                                    <div class="col-md-6"><input type="text" class="form-control" id="mstName"
                                            placeholder="이름">
                                    </div>
                                    <div class="col-md-6"><input type="password" class="form-control" id="mstPw"
                                            placeholder="비밀번호">
                                    </div>
                                    <div class="col-md-6"><input type="password" class="form-control" id="mstPwCheck"
                                            placeholder="비밀번호 확인">
                                    </div>
                                    <div class="col-md-6"><input type="text" class="form-control" id="coTel"
                                            placeholder="회사 전화번호">
                                    </div>
                                    <div class="col-md-6"><input type="text" class="form-control" id="mstTel"
                                            placeholder="연락처">
                                    </div>
                                    <div class="col-12"><input type="email" class="form-control" id="mstEmail"
                                            placeholder="이메일">
                                    </div>
                                </div>
                            </fieldset>

                            <div class="d-flex justify-content-between mt-4">
                                <button class="btn btn-primary" id="back-to-step-1">이전</button>
                                <button class="btn btn-primary" id="next-to-step-3">다음</button>
                            </div>
                        </div>

                        <!-- Right -->
                        <div class="col-md-5">
                            <div class="bg-white p-4">
                                <h6 class="fw-bold">주문 요약</h6>

                                <div class="bg-light p-3 rounded border">
                                    <div class="fw-bold mb-1">E-FELIX - Business <span th:text="${type}"></span></div>
                                    <div class="text-muted mb-2" id="subscription-summary"></div>

                                    <div class="d-flex justify-content-between pt-2 border-top mt-3">
                                        <div>
                                            <span class="fw-bold">오늘 결제 기한</span>
                                            <br>
                                            <small class="text-muted">(세금이 포함되지 않음)</small>
                                        </div>
                                        <div class="fw-bold text-end" id="price-display"></div>
                                    </div>
                                </div>

                                <p class="">제품 하이라이트</p>
                                <div id="highlight-list"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3 -->
                <div class="step-content step-3-content d-none">
                    <h5 class="fw-bold">계약서</h5>
                    <p>계약서 내용을 확인하고 작성하세요.</p>
                    <div id="contract-document"></div>
                    <div class="d-flex justify-content-between mt-4">
                        <button class="btn btn-secondary" id="back-to-step-2">이전</button>
                        <!-- <button class="btn btn-success" id="next-to-step-4">다음</button> -->
                        <button class="btn btn-secondary" id="next-to-step-4">결제 진행</button>
                    </div>
                </div>

                <!-- Step 4 -->
                <div class="step-content step-4-content d-none">
                    <div class="row g-4">

                        <!-- Left -->
                        <div class="col-md-7">
                            <h5 class="fw-bold">결제 확인</h5>
                            <p>결제 정보를 확인하고 완료하세요.</p>

                            <!-- 결제 -->
                            <main id="checkoutMain">
                                <div class="bg-white p-4 shadow-sm rounded">
                                    <h6 class="fw-bold mb-4">결제 요약</h6>
                                    <form id="checkoutForm">
                                        <!-- Item Information -->
                                        <div class="d-flex align-items-center mb-4">
                                            <div class="flex-grow-1">
                                                <h5 id="itemName" class="mb-1"></h5>
                                                <p class="price-value text-muted mb-0"></p>
                                            </div>
                                        </div>

                                        <!-- Price Summary -->
                                        <div class="bg-light p-3 rounded border mb-4">
                                            <div class="d-flex justify-content-between">
                                                <label class="fw-bold mb-0">총 구입 가격</label>
                                                <span class="price-value fw-bold text-primary fs-5"></span>
                                            </div>
                                        </div>

                                        <!-- Checkout Button -->
                                        <button id="checkoutButton" type="submit" class="btn btn-primary w-100 py-3">
                                            <span class="checkout-text">결제</span>
                                            <span class="spinner-border spinner-border-sm ms-2 d-none" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </span>
                                        </button>
                                    </form>
                                </div>
                            </main>
                            <div class="d-flex justify-content-between mt-4">
                                <button class="btn btn-secondary" id="back-to-step-3">이전</button>
                                <button class="btn btn-success">완료</button>
                            </div>
                        </div>

                        <!-- Right -->
                        <div class="col-md-5">
                            <div class="bg-white p-4">
                                <h6 class="fw-bold">주문 요약</h6>

                                <div class="bg-light p-3 rounded border">
                                    <div class="fw-bold mb-1">E-FELIX - Business <span
                                            th:text="${subscriptionPackage.spkName}"></span></div>
                                    <div class="text-muted mb-2" id="subscription-summary"></div>

                                    <div class="d-flex justify-content-between pt-2 border-top mt-3">
                                        <div>
                                            <span class="fw-bold">오늘 결제 기한</span>
                                            <br>
                                            <small class="text-muted">(세금이 포함되지 않음)</small>
                                        </div>
                                        <div class="fw-bold text-end" id="price-display"></div>
                                    </div>
                                </div>

                                <p class="">제품 하이라이트</p>
                                <div id="highlight-list"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 서명 모달 -->
    <div class="modal fade" id="signatureModal" tabindex="-1" aria-labelledby="signatureModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="signatureModalLabel">전자 서명</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
                </div>
                <div class="modal-body">
                    <!-- 탭 메뉴 -->
                    <ul class="nav nav-tabs" id="signatureTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="draw-tab" data-bs-toggle="tab"
                                data-bs-target="#draw-pane" type="button" role="tab">직접 그리기</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-pane"
                                type="button" role="tab">파일 업로드</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="signatureTabContent">
                        <!-- 직접 그리기 탭 -->
                        <div class="tab-pane fade show active" id="draw-pane" role="tabpanel">
                            <p class="text-muted mb-3">아래 영역에 마우스나 터치로 서명을 그려주세요.</p>
                            <div class="text-center">
                                <canvas id="signatureCanvas" width="400" height="200"></canvas>
                            </div>
                            <div class="signature-controls text-center">
                                <button type="button" class="btn btn-outline-secondary btn-sm"
                                    id="clearCanvas">지우기</button>
                            </div>
                        </div>

                        <!-- 파일 업로드 탭 -->
                        <div class="tab-pane fade" id="upload-pane" role="tabpanel">
                            <div class="file-upload-area" id="fileUploadArea">
                                <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                                <p class="text-muted mb-2">서명 이미지를 드래그하거나 클릭하여 업로드하세요</p>
                                <p class="text-muted small">PNG, JPG, GIF 파일만 지원됩니다</p>
                                <input type="file" id="signatureFile" accept="image/*" style="display: none;">
                            </div>
                            <div id="uploadPreview" class="mt-3 text-center" style="display: none;">
                                <img id="uploadedImage" class="signature-preview" alt="업로드된 서명">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" id="saveSignature">저장</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 로딩 -->
    <div class="modal fade" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-4">
                    <div class="spinner-border text-primary me-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span>결제 정보를 불러오는 중입니다.</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 결제 성공 -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-check-circle me-2"></i>
                        결제 성공
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <div class="text-success mb-3">
                        <svg width="64" height="64" fill="currentColor" class="bi bi-check-circle" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                            <path
                                d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.061L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z" />
                        </svg>
                    </div>
                    <p class="mb-0">결제에 성공했습니다.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 결제 실패 -->
    <div class="modal fade" id="failModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        결제 실패
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <div class="text-danger mb-3">
                        <svg width="64" height="64" fill="currentColor" class="bi bi-exclamation-triangle"
                            viewBox="0 0 16 16">
                            <path
                                d="M7.938 2.016A.13.13 0 0 1 8.002 2a.13.13 0 0 1 .063.016.146.146 0 0 1 .054.057l6.857 11.667c.036.06.035.124.002.183a.163.163 0 0 1-.054.06.116.116 0 0 1-.066.017H1.146a.115.115 0 0 1-.066-.017.163.163 0 0 1-.054-.06.176.176 0 0 1 .002-.183L7.884 2.073a.147.147 0 0 1 .054-.057zm1.044-.45a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566z" />
                            <path
                                d="M7.002 12a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 5.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995z" />
                        </svg>
                    </div>
                    <p id="failMessage" class="mb-0"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SweetAlert2 CSS/JS CDN  -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Step Navigation Script -->
    <script th:inline="javascript">
        $(document).ready(function () {
            function showStep(stepNumber) {
                // 모든 step-content 숨김
                $('.step-content').removeClass('d-block').addClass('d-none');
                $('.step-' + stepNumber + '-content').removeClass('d-none').addClass('d-block');

                // Step indicator active 설정
                $('.step-indicator .step').removeClass('active');
                $('.step-' + stepNumber).addClass('active');
            }

            function stepValidation1() {

            }

            function stepValidation2() {

            }

            function stepValidation3() {

            }

            $('#next-to-step-2').click(function () {
                stepValidation1();
                showStep(2);
            });

            $('#next-to-step-3').click(function () {
                applyContract();
                showStep(3);
            });

            $('#next-to-step-4').click(function () {
                // const checkout = new Checkout();
                // checkout.load();
                autoCheckout();
                showStep(4);
            });

            $('#back-to-step-1').click(function () {
                showStep(1);
            });

            $('#back-to-step-2').click(function () {
                showStep(2);
            });

            $('#back-to-step-3').click(function () {
                showStep(3);
            });

            // 서비스 체크 초기화
            function resetCheckboxes() {
                $('#hr, #bsn, #purchs, #acc').prop('disabled', false);
            }

            $('#hr, #acc').change(function () {
                updateSummary();
                if (this.checked) {
                    $('#bsn, #purchs').prop('disabled', true);
                } else {
                    resetCheckboxes();
                }
            });

            $('#bsn, #purchs').change(function () {
                updateSummary();
                if (this.checked) {
                    $('#hr, #acc').prop('disabled', true);
                } else {
                    resetCheckboxes();
                }
            });

            const highlightMap = {
                "hr": `
                    <ul>
                        <li><strong>[인사]</strong> 인사 문서, 근태표, 인사평가 및 급여 명세를 효율적으로 관리하세요.</li>
                        <li>모든 직원 정보에 <strong>언제 어디서나 안전하게 접근</strong></li>
                        <li><strong>상시 인사 지원 체계</strong> 포함</li>
                    </ul>`,
                "bsn": `
                    <ul>
                        <li><strong>[영업]</strong> 견적, 계약서, 영업 보고서 등을 빠르게 작성하고 공유하세요.</li>
                        <li><strong>거래 데이터</strong>를 안전하게 클라우드에 저장</li>
                        <li><strong>24시간 영업 지원</strong> 가능</li>
                    </ul>`,
                "purchs": `
                    <ul>
                        <li><strong>[재고]</strong> 입출고, 재고 현황 및 창고 관리를 쉽게 시작하세요.</li>
                        <li><strong>다양한 기기</strong>에서 재고 데이터 확인 및 관리</li>
                    </ul>`,
                "acc": `
                    <ul>
                        <li><strong>[회계]</strong> 전표, 세금계산서, 재무제표 작성을 빠르게 시작하세요.</li>
                        <li><strong>언제 어디서나</strong> 회계 문서 접근 가능</li>
                    </ul>`
            };

            function updateSummary() {
                const periodValue = $('input[name="period"]:checked').val(); // "1", "3", "12"
                const billing = $('#billing-cycle').val(); // "annual", "monthly", "once"

                // 금액 계산
                let price = 0;
                let unit = '';
                let displayPeriod = '';

                // 기본 월 단가 (spkPrice가 월 단가라고 가정)
                const monthlyPrice = spkPrice || 20000; // spkPrice가 없으면 기본값 20000

                // 구독 기간 텍스트 설정
                if (periodValue === "1") {
                    displayPeriod = "1개월";
                } else if (periodValue === "3") {
                    displayPeriod = "3개월";
                } else if (periodValue === "12") {
                    displayPeriod = "1년";
                }

                // 청구 방식에 따른 가격 계산
                if (billing === "annual") {
                    // 년 단위 결제
                    const totalMonths = parseInt(periodValue);
                    price = monthlyPrice * totalMonths;
                    unit = "년";
                } else if (billing === "monthly") {
                    // 월 단위 결제
                    price = monthlyPrice;
                    unit = "월";
                } else if (billing === "once") {
                    // 일시불 결제
                    const totalMonths = parseInt(periodValue);
                    price = monthlyPrice * totalMonths;
                    unit = "회";
                }

                // 가격이 0이면 기본값 설정
                if (price === 0) {
                    price = monthlyPrice;
                    unit = "월";
                }

                // 소수점 처리
                price = Math.round(price);

                // 청구 방식 텍스트 변환
                let billingText = '';
                if (billing === "annual") {
                    billingText = "년";
                } else if (billing === "monthly") {
                    billingText = "월";
                } else if (billing === "once") {
                    billingText = "일시불";
                }

                // 표시 업데이트
                const summaryText = `${displayPeriod} 구독, ₩${price.toLocaleString()} / ${billingText} 지불`;
                $('#subscription-summary').text(summaryText);
                $('#price-display').text(`₩${price.toLocaleString()}`);
                $('#resultPrice').text(`₩${price.toLocaleString()}`);
            }

            function updateBillingOptions() {
                const selectedValue = $('input[name="period"]:checked').val();
                const $billingSelect = $('#billing-cycle');

                // 기존 옵션 제거
                $billingSelect.empty();

                if (selectedValue === '12') {
                    // 1년 선택 시: 매년, 매월
                    $billingSelect.append('<option value="annual">년</option>');
                    $billingSelect.append('<option value="monthly">월</option>');
                } else {
                    // 1개월, 3개월 선택 시: 매월, 일시불
                    $billingSelect.append('<option value="monthly">월</option>');
                    $billingSelect.append('<option value="once">일시불</option>');
                }
            }

            // 초기 설정
            updateBillingOptions();

            // 라디오 버튼이 변경될 때마다 갱신
            $('input[name="period"]').on('change', updateBillingOptions);

            $('input[name="period"]').on('change', updateSummary);
            $('#billing-cycle').on('change', updateSummary);

            $('#next-to-step-2').click(function () {
                // 체크된 모듈 항목 확인
                const checkedServices = $('.form-check-input[name=module]:checked').map(function () {
                    return this.id; // id 값이 hr, bsn, purchs, acc
                }).get();

                // 체크된 구독 기간 항목 확인
                const checkedPeriod = $('.form-check-input[name=period]:checked').id;

                console.log($('.form-check-input[name=module]:checked').map(function () {
                    return this.value;
                }).get());

                // 하이라이트 영역 비우고 다시 추가
                let highlightHtml = "";
                checkedServices.forEach(serviceId => {
                    highlightHtml += highlightMap[serviceId] || "";
                });

                $('#highlight-list').html(highlightHtml);
            });

            function updateCompanyInfo() {
                const data = {

                }
                $.ajax({
                    type: "POST",
                    url: "",
                    data: JSON.stringify(data),
                    contentType: "application/json",
                    success: function (res) {
                        if (res.head.res_code === "200") {

                        } else {

                        }
                    },
                    error: function (xhr, status, err) {
                        console.error(err)
                    }
                });
            }

            function applyContract() {
                const today = new Date();
                const formatted = today.getFullYear() + '-' +
                    String(today.getMonth() + 1).padStart(2, '0') + '-' +
                    String(today.getDate()).padStart(2, '0');
                const signCoName = $('#coName').val();
                const signPschName = $('#pschName').val();
                const signCoAddr = $('#coAddr').val();

                let contractDocumentHTML =
                    `
                    <div class="container bg-white p-5 shadow rounded" id="contract-group">
                        <h2 class="contract-title">ERP 시스템 이용 계약서</h2>

                        <div class="contract-section">
                        <h5>제1조 (당사자)</h5>
                        <p><strong>갑(공급자)</strong><br>
                            회사명: E-FLIX<br>
                            대표자: 팀장<br>
                            주소: (주)예담직업전문학교 대구광역시 중구 중앙대로 403 (남일동 135-1, 5층)
                        </p>
                        <p><strong>을(이용자)</strong><br>
                            회사명: ${signCoName}<br>
                            대표자: ${signPschName}<br>
                            주소: ${signCoAddr}
                        </p>
                        </div>

                        <div class="contract-section">
                        <h5>제2조 (계약 목적)</h5>
                        <p>본 계약은 갑이 개발·제공하는 ERP 시스템(이하 "시스템")을 을이 이용함에 있어 양 당사자의 권리·의무를 정함을 목적으로 한다.</p>
                        </div>

                        <div class="contract-section">
                        <h5>제3조 (이용 범위 및 제공 서비스)</h5>
                        <ol>
                            <li>갑은 을에게 다음의 서비스를 제공한다:
                            <ul>
                                <li>ERP 시스템 웹/모바일 서비스 이용 권한</li>
                                <li>기술지원 및 유지보수 서비스</li>
                                <li>사용자 계정 생성 및 관리 기능</li>
                            </ul>
                            </li>
                            <li>을은 시스템을 내부 업무 목적으로만 이용할 수 있다.</li>
                        </ol>
                        </div>

                        <div class="contract-section">
                        <h5>제4조 (계약 기간)</h5>
                        <p>본 계약의 유효기간은 계약 체결일로부터 <strong>[1년]</strong>이며, 별도 해지 통보가 없을 경우 자동 연장된다.</p>
                        </div>

                        <div class="contract-section">
                        <h5>제5조 (이용 요금 및 결제)</h5>
                        <ol>
                            <li>을은 시스템 이용 요금으로 월 <strong>[금액]</strong>원을 갑에게 지불한다.</li>
                            <li>결제일은 매월 <strong>[지정일]</strong>일이며, 지정된 계좌로 송금한다.</li>
                        </ol>
                        </div>

                        <div class="contract-section">
                        <h5>제6조 (유지보수 및 기술지원)</h5>
                        <p>갑은 을에게 정상적인 시스템 운영을 위한 유지보수와 기술지원을 제공하며, 장애 발생 시 즉시 조치한다.</p>
                        </div>

                        <div class="contract-section">
                        <h5>제7조 (비밀유지)</h5>
                        <p>양 당사자는 계약 수행 중 알게 된 상대방의 모든 정보에 대해 비밀을 유지하며, 제3자에게 누설하지 않는다.</p>
                        </div>

                        <div class="contract-section">
                        <h5>제8조 (계약 해지)</h5>
                        <ol>
                            <li>어느 일방이 계약 내용을 위반할 경우, 상대방은 계약을 해지할 수 있다.</li>
                            <li>해지 시 기지불된 요금은 반환되지 않는다.</li>
                        </ol>
                        </div>

                        <div class="contract-section">
                        <h5>제9조 (기타 조항)</h5>
                        <ol>
                            <li>본 계약에 명시되지 않은 사항은 관련 법령 및 상관례에 따른다.</li>
                            <li>계약에 관한 분쟁은 갑의 소재지를 관할하는 법원에서 해결한다.</li>
                        </ol>
                        </div>

                        <div class="row signature-box">
                        <div class="col-md-6">
                            <strong>갑(공급자)</strong><br>
                            회사명: E-FLIX<br>
                            대표자 서명: 팀장 <img src="/eflix-sign.png" alt="대표자 서명 이미지" width="400" height="200"><br>
                            날짜: ${formatted}
                        </div>
                        <div class="col-md-6">
                            <strong>을(이용자)</strong><br>
                            회사명: ${signCoName}<br>
                            대표자 서명: ${signPschName} <span id="signatureDisplay" style="cursor: pointer; text-decoration: underline;" data-bs-toggle="modal" data-bs-target="#signatureModal">(인)</span><br>
                            날짜: ${formatted}
                        </div>
                        </div>
                    </div>
                    `;
                $("#contract-document").html(contractDocumentHTML);
            }

            // (1) 서명 등록 후 작성 버튼 클릭 → (인) 자리 교체
            $('#toPaymentModal').on('click', function () {
                setTimeout(function () {
                    const paymentModal = new bootstrap.Modal($('#paymentModal')[0]);
                    paymentModal.show();
                }, 500);

                // 예시: canvas 또는 텍스트 입력으로부터 얻은 서명
                const userSignature = "홍길동"; // 또는 이미지 경로

                // 텍스트 서명 버전
                $('#signatureDisplay').html(userSignature + ' (서명)');

                // 또는 이미지 서명 버전
                // $('#signatureDisplay').html('<img src="/images/signature.png" alt="서명" style="height:40px;">');
            });

            // (2) 서명 영역 클릭 시 서명 모달 다시 열기
            $('#signatureDisplay').on('click', function () {
                const signatureModal = new bootstrap.Modal($('#contractSignatureModal')[0]);
                signatureModal.show();
            });

            // Canvas 관련 변수
            let canvas = document.getElementById('signatureCanvas');
            let ctx = canvas.getContext('2d');
            let isDrawing = false;
            let currentSignature = null;

            // Canvas 초기화
            function initCanvas() {
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
            }

            // 마우스 이벤트
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // 터치 이벤트
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);

            function startDrawing(e) {
                isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                ctx.beginPath();
                ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
            }

            function draw(e) {
                if (!isDrawing) return;
                const rect = canvas.getBoundingClientRect();
                ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
                ctx.stroke();
            }

            function stopDrawing() {
                isDrawing = false;
                ctx.beginPath();
            }

            function handleTouch(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' :
                    e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            }

            // Canvas 지우기
            document.getElementById('clearCanvas').addEventListener('click', function () {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            });

            // 파일 업로드 관련
            const fileUploadArea = document.getElementById('fileUploadArea');
            const signatureFile = document.getElementById('signatureFile');
            const uploadPreview = document.getElementById('uploadPreview');
            const uploadedImage = document.getElementById('uploadedImage');

            fileUploadArea.addEventListener('click', () => signatureFile.click());

            // 드래그 앤 드롭
            fileUploadArea.addEventListener('dragover', function (e) {
                e.preventDefault();
                fileUploadArea.classList.add('dragover');
            });

            fileUploadArea.addEventListener('dragleave', function (e) {
                e.preventDefault();
                fileUploadArea.classList.remove('dragover');
            });

            fileUploadArea.addEventListener('drop', function (e) {
                e.preventDefault();
                fileUploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });

            signatureFile.addEventListener('change', function (e) {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });

            function handleFileSelect(file) {
                if (!file.type.match('image.*')) {
                    alert('이미지 파일만 업로드 가능합니다.');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    uploadedImage.src = e.target.result;
                    uploadPreview.style.display = 'block';
                    currentSignature = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            // 서명 저장
            document.getElementById('saveSignature').addEventListener('click', function () {
                let signatureData = null;

                // 현재 활성 탭 확인
                const activeTab = document.querySelector('#signatureTab .nav-link.active').id;

                if (activeTab === 'draw-tab') {
                    // Canvas에서 서명 데이터 가져오기
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    let hasDrawing = false;

                    // Canvas에 그려진 내용이 있는지 확인
                    for (let i = 0; i < data.length; i += 4) {
                        if (data[i + 3] > 0) { // 알파값이 0보다 크면 그려진 내용이 있음
                            hasDrawing = true;
                            break;
                        }
                    }

                    if (hasDrawing) {
                        signatureData = canvas.toDataURL();
                    } else {
                        alert('서명을 그려주세요.');
                        return;
                    }
                } else if (activeTab === 'upload-tab') {
                    // 업로드된 이미지 사용
                    if (currentSignature) {
                        signatureData = currentSignature;
                    } else {
                        alert('서명 이미지를 업로드해주세요.');
                        return;
                    }
                }

                // 서명을 계약서에 적용
                if (signatureData) {
                    const signatureDisplay = document.getElementById('signatureDisplay');
                    signatureDisplay.innerHTML = `<img src="${signatureData}" class="signature-preview" alt="전자서명">`;
                    signatureDisplay.style.textDecoration = 'none';
                    signatureDisplay.removeAttribute('data-bs-toggle');
                    signatureDisplay.removeAttribute('data-bs-target');
                    signatureDisplay.style.cursor = 'default';

                    // 모달 닫기
                    const modal = bootstrap.Modal.getInstance(document.getElementById('signatureModal'));
                    modal.hide();

                    // Canvas와 업로드 초기화
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    uploadPreview.style.display = 'none';
                    signatureFile.value = '';
                    currentSignature = null;

                    alert('서명이 저장되었습니다.');
                }
            });

            // 모달이 열릴 때 Canvas 초기화
            document.getElementById('signatureModal').addEventListener('shown.bs.modal', function () {
                initCanvas();
            });

            // 초기 Canvas 설정
            initCanvas();

            function autoCheckout() {
                // 포트원 빌링키 발급 API 호출
                const uid = Date.now();
                // V1
                IMP.init('imp73166581');
                IMP.request_pay({
                    pg: "kakaopay",
                    pay_method: "card",
                    merchant_uid: `bill_${uid}`,
                    customer_uid: `user_${uid}`, // 사용자의 고유 ID
                    amount: 0,
                    name: "카카오페이 빌링키 등록",
                    buyer_email: $("#pschEmail").val(),
                    buyer_name: $("pschName").val(),
                    buyer_tel: $("#pschTel").val()
                    // m_redirect_url: "https://your-service.com/billing/complete"
                }, function (rsp) {
                    console.log(rsp)
                    if (rsp.success) {
                        // 백엔드에 전송
                        const data = {
                            impUid: rsp.imp_uid,
                            customerUid: rsp.customer_uid
                        }
                        $.ajax({
                            type: "POST",
                            url: "/payment/api/verify/billingKey",
                            data: JSON.stringify(data),
                            contentType: "application/json",
                            success: function (res) {
                                addContract(contractName);
                                addSubscription(rsp.customer_uid, rsp.pg_provider, contractName);
                            },
                            error: function (xhr, status, err) {
                                console.error(err);

                            }
                        });
                    }
                });
            }
            function addContract(contractName) {
                const contractData = {
                    contractHTML: $('#contract-document').html(),
                    contractName
                }

                $.ajax({
                    type: "POST",
                    url: "/subscription/contract",
                    data: JSON.stringify(contractData),
                    contentType: "application/json",
                    success: function (res) {
                        if (res.head.res_code === "200") {
                            // Swal.fire();
                        } else {
                            // Swal.fire();
                        }
                    },
                    error: function (xhr, status, err) {
                        console.error(err);
                    }
                });
            }

            function addSubscription(customer_uid, pg_provider, contractName) {
                const checkedModules = $('.form-check-input[name=module]:checked').map(function () {
                    return this.value;
                }).get().join(",");

                const subMasterData = {
                    subscriptionDTO: {
                        spkIdx,
                        coIdx: coIdx,
                        empIdx: 'emp-101',
                        spiPay: pg_provider,
                        spiPeriod: $('.form-check-input[name=period]:checked').val(),
                        spiCtrt: contractName,
                        spiUid: customer_uid,
                        checkedModules,
                    }, masterDTO: {
                        coIdx: coIdx,
                        mstId: $('#mstId').val(),
                        mstName: $('#mstName').val(),
                        mstPw: $('#mstPw').val(),
                        coTel: $('#coTel').val(),
                        mstTel: $('#mstTel').val(),
                        mstEmail: $('#mstEmail').val(),
                    }
                }

                const subscriptionData = {
                    spkIdx,
                    coIdx: coIdx,
                    empIdx: 'emp-101',
                    spiPay: pg_provider,
                    spiPeriod: $('.form-check-input[name=period]:checked').val(),
                    spiCtrt: contractName,
                    spiUid: customer_uid,
                    checkedModules,
                    coIdx: coIdx,
                    mstId: $('#mstId').val(),
                    mstName: $('#mstName').val(),
                    mstPw: $('#mstPw').val(),
                    coTel: $('#coTel').val(),
                    mstTel: $('#mstTel').val(),
                    mstEmail: $('#mstEmail').val(),
                }

                $.ajax({
                    type: "POST",
                    url: "/subscription/insert",
                    data: JSON.stringify(subscriptionData),
                    contentType: "application/json",
                    success: function (res) {
                        if (res.head.res_code === "200") {
                            Swal.fire("성공", "구독이 성공적으로 이루어졌습니다.", "success");
                        } else {
                            Swal.fire("실패", res.body, "error");
                        }
                    },
                    error: function (xhr, status, err) {
                        console.error(err);
                        Swal.fire("오류", "서버와 통신 중 문제가 발생했습니다.", "error");
                    }
                });
            }
        });

        const spkPrice = /*[[${subscriptionPackage.spkPrice}]]*/ ""
        const spkIdx = /*[[${subscriptionPackage.spkIdx}]]*/ ""
        // 결제
        function Checkout() {
            let item = null;
            this.load = async () => {
                // 로딩 모달창
                const loadingModal = new bootstrap.Modal('#loadingModal');
                loadingModal.show();

                const waitPortOne = new Promise((resolve) => {
                    console.log('Checking window.PortOne:', window.PortOne); // 상태 출력
                    const polling = setInterval(() => {
                        if (window.PortOne != null) {
                            clearInterval(polling);
                            resolve();
                        }
                    }, 5000);
                });

                const waitItem = fetch(`/api/payment/item?spkIdx=${spkIdx}`).then(
                    async (response) => (item = await response.json())
                );

                // 로딩 모달창 닫기
                try {
                    await Promise.all([waitPortOne, waitItem]);
                    console.log('Both promises completed');

                    // 모달 닫기
                    loadingModal.hide();

                    // 모달이 완전히 닫힌 후 다음 단계 실행
                    $('#loadingModal').on('hidden.bs.modal', () => {
                        $('#checkoutMain').removeClass('d-none');
                        this.showCheckout();
                    });

                } catch (error) {
                    console.error('Loading failed:', error);
                    loadingModal.hide();
                    // 에러 처리
                }

                // 결제창 열기
                $('#checkoutMain').removeClass('d-none');
                await this.showCheckout();
            };

            this.showCheckout = async () => {
                $('#itemName').text(item.name);
                $('.price-value').text(`${item.price.toLocaleString()}원`);

                $('#checkoutForm').on('submit', async (e) => {
                    e.preventDefault();
                    this.setWaitingPayment(true);

                    function randomId() {
                        return [...crypto.getRandomValues(new Uint32Array(2))]
                            .map((word) => word.toString(16).padStart(8, "0"))
                            .join("");
                    }

                    const paymentId = randomId();
                    const payment = await PortOne.requestPayment({
                        storeId: "store-092db0f4-068f-4f50-9b06-029fca00b36c",
                        channelKey: "channel-key-a0af8c14-0047-4ad6-ade6-5589354d0047",
                        paymentId,
                        orderName: item.name,
                        totalAmount: item.price,
                        currency: item.currency,
                        payMethod: "CARD",
                        customData: {
                            item: item.id,
                        },
                    });

                    if (payment.code !== undefined) {
                        this.setWaitingPayment(false);
                        console.log(payment);
                        this.openFailDialog(payment.message);
                        return;
                    }

                    const completeResponse = await fetch("/api/payment/complete", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            paymentId: payment.paymentId,
                        }),
                    });

                    this.setWaitingPayment(false);

                    if (completeResponse.ok) {
                        const paymentComplete = await completeResponse.json();
                        if (paymentComplete.status === "PAID") {
                            this.openSuccessDialog();
                        }
                    } else {
                        this.openFailDialog(await completeResponse.text());
                    }
                });
            };

            this.setWaitingPayment = (isWaiting) => {
                if (isWaiting) {
                    $('#checkoutButton')
                        .prop('disabled', true)
                        .addClass('disabled');
                    $('.checkout-text').addClass('d-none');
                    $('#checkoutButton .spinner-border').removeClass('d-none');
                } else {
                    $('#checkoutButton')
                        .prop('disabled', false)
                        .removeClass('disabled');
                    $('.checkout-text').removeClass('d-none');
                    $('#checkoutButton .spinner-border').addClass('d-none');
                }
            };

            this.openFailDialog = (message) => {
                $('#failMessage').text(message);
                const failModal = new bootstrap.Modal('#failModal');
                failModal.show();
            };

            this.openSuccessDialog = () => {
                const successModal = new bootstrap.Modal('#successModal');
                successModal.show();
            };
        }


        // const issueResponse = PortOne.requestIssueBillingKey({
        //     storeId: "store-092db0f4-068f-4f50-9b06-029fca00b36c",
        //     channelKey: "channel-key-b0a7e62d-ac57-4a3f-8c19-be48ce89d669",
        //     billingKeyMethod: "EASY_PAY",
        // });
        // // 빌링키가 제대로 발급되지 않은 경우 에러 코드가 존재합니다
        // if (issueResponse.code !== undefined) {
        //     return alert(issueResponse.message);
        // }

        // // 고객사 서버에 빌링키를 전달합니다
        // const response = await fetch(`/payment/billings`, {
        //     method: "POST",
        //     header: { "Content-Type": "application/json" },
        //     body: JSON.stringify({
        //         billingKey: issueResponse.billingKey,
        //         // ...
        //     }),
        // });
        // if (!response.ok) throw new Error(`response: ${await response.json()}`);

        // customerId, cardNumber, expiryYear, expiryMonth, birthOrBusinessRegistrationNumber, passwordTwoDigits 등 정보를 전달받습니다.

        // 포트원 빌링키 발급 API 호출

        // V2
        // const customerId = `user_${uid}`;
        // const data = {
        //     number: "1234123412341234",
        //     expiryYear: "27",
        //     expiryMonth: "05",
        //     birthOrBusinessRegistrationNumber: "900101",
        //     passwordTwoDigits: "23",
        //     customerId
        // }

        // $.ajax({
        //     type: "POST",
        //     url: "/payment/api/issue/billing",
        //     data: JSON.stringify(data),
        //     contentType: "application/json",
        //     success: function(res) {
        //         console.log(res);
        //     },
        //     error: function(xhr, status, err) {
        //         console.error(err);

        //     }
        // })

        // const userName = /*[[${session.userName}]]*/ "";
        // const packageName = /*[[${subscriptionPackage.spkName}]]*/ "";
        // console.log(packageName);
        // IMP.init('imp73166581');
        // IMP.request_pay({
        //     pg: "kakaopay",
        //     pay_method: "card",
        //     merchant_uid: Date.now(),
        //     customer_uid: "user_" + Date.now(),
        //     name: packageName,
        //     amount: 0,
        //     // amount: spkPrice * $('.form-check-input[name=period]:checked').val(),
        //     buyer_email: $('#pschEmail').val(),
        //     buyer_name: userName,
        //     buyer_tel: $('#pschTel').val(),
        //     buyer_addr: $('#coAddr').val() + $('#coAddrDetail'),
        //     buyer_postcode: $('#coZip').val()
        // }, async function (res) {
        //     let contractName= `contract_${Date.now()}`
        //     if (res.success) {
        //         addContract(contractName);
        //         addSubscription(res.customer_uid, res.pg_provider, contractName);
        //     } else {

        //     }
        // }, function (xhr, status, err) {
        //     console.error(err);
        // });
    </script>
</body>

</html>