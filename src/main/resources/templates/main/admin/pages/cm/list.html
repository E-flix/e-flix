<!--
============================================
	- ì‘ì„±ì   : ë³µì„±ë¯¼
	- ìµœì´ˆì‘ì„± : 2025-06-18
	- ì„¤ëª…    : E-FLIX ê´€ë¦¬ì íšŒì‚¬ ê´€ë¦¬ í˜ì´ì§€
--------------------------------------------
	[ ë³€ê²½ ì´ë ¥ ]
	- 2025-06-19 (ë³µì„±ë¯¼): ë ˆì´ì•„ì›ƒ êµ¬ì„±
============================================
-->
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/main/admin/layouts/default}">

<head>
	<title>ê´€ë¦¬ì</title>
	<style>
		.main-container {
			height: 100vh;
			overflow: hidden;
		}

		.search-section {
			height: 35%;
		}

		.content-section {
			height: 65%;
		}

		.card-body {
			overflow: auto;
		}

		.table-container {
			overflow-y: auto;
		}

		.subscription-table-container {
			height: 180px;
			overflow-y: auto;
		}

		.company-list-container {
			height: 280px;
			overflow-y: auto;
		}

		.form-control-sm {
			padding: 0.25rem 0.5rem;
			font-size: 0.875rem;
		}

		.btn-sm {
			padding: 0.25rem 0.5rem;
			font-size: 0.875rem;
		}

		.card-header {
			padding: 0.5rem 1rem;
			font-size: 0.9rem;
		}

		.card-body {
			padding: 0.75rem;
		}

		.table th,
		.table td {
			padding: 0.5rem;
			font-size: 0.85rem;
		}
	</style>
</head>
<div layout:fragment="content">
	<div class="container-fluid main-container">
        <!-- ìƒë‹¨ ê²€ìƒ‰ ì˜ì—­ -->
        <div class="row search-section">
            <div class="col-12">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">íšŒì‚¬ ê²€ìƒ‰</h6>
                        <div>
                            <button class="btn btn-dark btn-sm me-1">ê²€ìƒ‰</button>
                            <button class="btn btn-danger btn-sm">ì‚­ì œ</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <form id="searchForm">
                            <div class="row mb-2">
                                <div class="col-md-3"><input type="text" class="form-control" name="coIdx" placeholder="íšŒì‚¬ë²ˆí˜¸"></div>
                                <div class="col-md-3"><input type="text" class="form-control" name="coName" placeholder="íšŒì‚¬ëª…"></div>
                                <div class="col-md-3"><input type="text" class="form-control" name="coNameEng" placeholder="íšŒì‚¬ ì˜ë¬¸ëª…"></div>
                                <div class="col-md-3"><input type="text" class="form-control" name="coRegNum" placeholder="ì‚¬ì—…ì ë²ˆí˜¸"></div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-6"><input type="text" class="form-control" name="coAddr" placeholder="ì£¼ì†Œ"></div>
                                <div class="col-md-3"><input type="text" class="form-control" name="coPostcode" placeholder="ìš°í¸ë²ˆí˜¸"></div>
                                <div class="col-md-3"><input type="text" class="form-control" name="coAddrDetail" placeholder="ë‚˜ë¨¸ì§€ ì£¼ì†Œ"></div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-3"><input type="text" class="form-control" name="ceoName" placeholder="ëŒ€í‘œìëª…"></div>
                                <div class="col-md-3"><input type="text" class="form-control" name="ceoTel" placeholder="ì—°ë½ì²˜"></div>
                                <div class="col-md-3"><input type="text" class="form-control" name="pschName" placeholder="ë‹´ë‹¹ìëª…"></div>
                                <div class="col-md-3"><input type="text" class="form-control" name="pschTel" placeholder="ì—°ë½ì²˜"></div>
                            </div>
                            <div class="row">
                                <div class="col-md-3"><input type="text" class="form-control" name="coRegDoc" placeholder="ì‚¬ì—…ìë“±ë¡ì¦"></div>
                                <div class="col-md-3"><input type="email" class="form-control" name="pschEmail" placeholder="ì´ë©”ì¼"></div>
                                <div class="col-md-3"><input type="text" class="form-control" name="svcStatus" placeholder="ìƒíƒœ"></div>
                                <div class="col-md-3"><input type="date" class="form-control" name="expireDate" placeholder="ë§Œë£Œì¼"></div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- í•˜ë‹¨ ì½˜í…ì¸  ì˜ì—­ -->
        <div class="row content-section mt-2">
            <!-- ì™¼ìª½ - íšŒì‚¬ ëª©ë¡ -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">íšŒì‚¬ ëª©ë¡</h6>
                        <div class="d-flex align-items-center">
                            <input type="text" class="form-control form-control-sm me-2" placeholder="ê²€ìƒ‰ì–´" style="width: 150px;">
                            <button class="btn btn-sm btn-primary">ê²€ìƒ‰</button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-container" style="height: 500px;">
                            <table class="table table-bordered table-hover text-center align-middle mb-0">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th><input type="checkbox"></th>
                                        <th>íšŒì‚¬ë²ˆí˜¸</th>
                                        <th>íšŒì‚¬ëª…</th>
                                        <th>ëŒ€í‘œì</th>
                                        <th>ë‹´ë‹¹ì</th>
                                        <th>ì—°ë½ì²˜</th>
                                        <th>ìƒíƒœ</th>
                                    </tr>
                                </thead>
                                <tbody id="companyTableBody">
									<!-- íšŒì‚¬ ëª©ë¡ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer p-2">
                        <nav>
                            <ul class="pagination pagination-sm justify-content-center mb-0">
                                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                <li class="page-item"><a class="page-link" href="#">2</a></li>
                                <li class="page-item"><a class="page-link" href="#">3</a></li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>

            <!-- ì˜¤ë¥¸ìª½ - íšŒì‚¬ ìƒì„¸ ì •ë³´ ë° êµ¬ë… ë‚´ì—­ -->
            <div class="col-md-6">
                <div class="row h-100">
                    <!-- íšŒì‚¬ ìƒì„¸ ì •ë³´ -->
                    <div class="col-12 mb-2" style="height: 48%;">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="mb-0">íšŒì‚¬ ìƒì„¸ ì •ë³´</h6>
                            </div>
                            <div class="card-body" id="companyDetail">
                                <p class="text-muted">íšŒì‚¬ë¥¼ ì„ íƒí•˜ë©´ ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                                <div id="companyDetailContent" style="display: none;">
                                    <div class="row mb-2">
                                        <div class="col-6"><strong>íšŒì‚¬ëª…:</strong> <span id="companyName"></span></div>
                                        <div class="col-6"><strong>íšŒì‚¬ë²ˆí˜¸:</strong> <span id="companyNumber"></span></div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-6"><strong>ëŒ€í‘œì:</strong> <span id="ceoName"></span></div>
                                        <div class="col-6"><strong>ë‹´ë‹¹ì:</strong> <span id="managerName"></span></div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-6"><strong>ì—°ë½ì²˜:</strong> <span id="phoneNumber"></span></div>
                                        <div class="col-6"><strong>ì´ë©”ì¼:</strong> <span id="email"></span></div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-12"><strong>ì£¼ì†Œ:</strong> <span id="address"></span></div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6"><strong>ìƒíƒœ:</strong> <span id="status"></span></div>
                                        <div class="col-6"><strong>ë§Œë£Œì¼:</strong> <span id="expireDate"></span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- êµ¬ë… ë‚´ì—­ -->
                    <div class="col-12" style="height: 48%;">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="mb-0">ğŸ“‹ êµ¬ë… ë‚´ì—­</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="subscription-table-container">
                                    <table class="table table-sm table-striped text-center mb-0">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th>ë²ˆí˜¸</th>
                                                <th>êµ¬ë…ì¼ì‹œ</th>
                                                <th>ê¸ˆì•¡</th>
                                                <th>ê³„ì•½ì„œ</th>
                                                <th>ê±°ë˜ëª…ì„¸ì„œ</th>
                                                <th>ì„¸ê¸ˆê³„ì‚°ì„œ</th>
                                                <th>ì •ë³´</th>
                                            </tr>
                                        </thead>
                                        <tbody id="subscriptionTableBody">
                                            <tr>
                                                <td colspan="7" class="text-muted">íšŒì‚¬ë¥¼ ì„ íƒí•˜ë©´ êµ¬ë… ë‚´ì—­ì´ í‘œì‹œë©ë‹ˆë‹¤.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="card-footer p-2 text-center">
                                <small>ì´ <span id="subscriptionCount">0</span>ê±´</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- êµ¬ë… ì •ë³´ ëª¨ë‹¬ -->
    <div class="modal fade" id="subscriptionModal" tabindex="-1" aria-labelledby="subscriptionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="subscriptionModalLabel">êµ¬ë… ì •ë³´</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="mb-3">
                            <label class="form-label">êµ¬ë…ëª…</label>
                            <input type="text" class="form-control" placeholder="êµ¬ë…ëª…">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ê³„ì—´ ìˆ˜</label>
                            <input type="text" class="form-control" placeholder="ê³„ì—´ ìˆ˜">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ì„œë¹„ìŠ¤</label>
                            <textarea class="form-control" rows="3" placeholder="ì„œë¹„ìŠ¤ëª… ë‚˜ì—´"></textarea>
                        </div>
                        <div class="row mb-3">
                            <div class="col">
                                <label class="form-label">ê¸°ê°„</label>
                                <input type="date" class="form-control">
                            </div>
                            <div class="col d-flex align-items-end">
                                <span class="text-center">~</span>
                            </div>
                            <div class="col">
                                <label class="form-label">&nbsp;</label>
                                <input type="date" class="form-control">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col">
                                <button type="button" class="btn btn-outline-secondary w-100">ê±°ë˜ ëª…ì„¸ì„œ</button>
                            </div>
                            <div class="col">
                                <button type="button" class="btn btn-outline-secondary w-100">ê³„ì•½ì„œ</button>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col">
                                <label class="form-label">ê²°ì œì¼</label>
                                <input type="date" class="form-control">
                            </div>
                            <div class="col">
                                <label class="form-label">ë§Œë£Œì¼</label>
                                <input type="date" class="form-control">
                            </div>
                        </div>
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary">í™•ì¸</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPage = 1;
        
        $(function () {
            // íšŒì‚¬ ëª©ë¡ ë¡œë”©
            function loadCompanyList(page = 1) {
                currentPage = page;

                let params = $("#searchForm").serialize();
                params += "&page=" + page;

                $.ajax({
                    url: '/admin/api/company-subscription',
                    method: 'GET',
                    success: function (res) {
                        const data = res.body;
                        if (res.head.res_code === '200') {
                            const tbody = $('#companyTableBody').empty();
                            data.forEach(company => {
                                const row = `
                                <tr data-coidx="${company.coIdx}" data-coName="${company.coName}" data-pschName="${company.pschName}" data-pschTel="${company.pschTel}" data-pschEmail="${company.pschEmail}">
                                    <td><input type="checkbox"></td>
                                    <td>${company.coIdx}</td>
                                    <td>${company.coName}</td>
                                    <td>${company.ceoName}</td>
                                    <td>${company.pschName}</td>
                                    <td>${company.pschTel}</td>
                                    <td><span class="badge bg-success">${company.svcStatus}</span></td>
                                </tr>`;
                                tbody.append(row);
                            });
                        } else {
                            alert('íšŒì‚¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                        }
                    },
                    error: function() {
                        $('#companyTableBody').empty();
                    }
                });
            }

            // íšŒì‚¬ ì„ íƒ ì‹œ ì˜¤ë¥¸ìª½ ì˜ì—­ ì—…ë°ì´íŠ¸
            $(document).on('click', '#companyTableBody tr', function () {
                const $row = $(this);

                // ê¸°ì¡´ ì„ íƒ í•´ì œ
                $('#companyTableBody tr').removeClass('table-active');
                // í˜„ì¬ í–‰ ì„ íƒ
                $row.addClass('table-active');

                const coIdx = $row.data('coidx');
                const coName = $row.data('coname');
                const pschName = $row.data('pschname');
                const pschTel = $row.data('pschtel');
                const pschEmail = $row.data('pschemail');

                const ceoName = $row.find('td').eq(3).text();
                const svcStatus = $row.find('td').eq(6).text().trim();

                // íšŒì‚¬ ìƒì„¸ ì •ë³´
                $('#companyDetail').html(`
                    <div class="mb-2"><strong>íšŒì‚¬ëª…:</strong> ${coName}</div>
                    <div class="mb-2"><strong>ëŒ€í‘œì:</strong> ${ceoName}</div>
                    <div class="mb-2"><strong>ë‹´ë‹¹ì:</strong> ${pschName}</div>
                    <div class="mb-2"><strong>ë‹´ë‹¹ì ì—°ë½ì²˜:</strong> ${pschTel}</div>
                    <div class="mb-2"><strong>ë‹´ë‹¹ì ì´ë©”ì¼:</strong> ${pschEmail}</div>
                    <div class="mb-2"><strong>ìƒíƒœ:</strong> <span class="badge bg-success">${svcStatus}</span></div>
                `);

                // êµ¬ë… ë‚´ì—­ ì¡°íšŒ
                $.ajax({
                    type: 'GET',
                    url: '/admin/api/subscription',
                    data: { coIdx: coIdx },
                    success: function (res) {
                        const data = res.body;
                        const tbody = $('#subscriptionTableBody').empty();

                        if (res.head.res_code === '200') {
                            data.forEach((subscription, i) => {
                                const row = `
                                    <tr data-idx="${subscription.spiIdx}">
                                        <td>${i + 1}</td>
                                        <td>${subscription.spiStart}</td>
                                        <td>${subscription.spkPrice.toLocaleString('ko-KR', { style: 'currency', currency: 'KRW' })}</td>
                                        <td>
                                            <button class="btn btn-outline-primary btn-sm bill-btn" data-type="statement_preview" data-idx="${subscription.spiIdx}">ë¯¸ë¦¬ë³´ê¸°</button>
                                            <button class="btn btn-outline-primary btn-sm bill-btn" data-type="statement_download" data-idx="${subscription.spiIdx}">ë‹¤ìš´ë¡œë“œ</button>
                                        </td>
                                        <td>
                                            <button class="btn btn-outline-primary btn-sm bill-btn" data-type="statement_preview" data-idx="${subscription.spiIdx}">ë¯¸ë¦¬ë³´ê¸°</button>
                                            <button class="btn btn-outline-primary btn-sm bill-btn" data-type="statement_download" data-idx="${subscription.spiIdx}">ë‹¤ìš´ë¡œë“œ</button>
                                        </td>
                                        <td>
                                            <button class="btn btn-outline-secondary btn-sm bill-btn" data-type="invoice_preview" data-idx="${subscription.spiIdx}">ë¯¸ë¦¬ë³´ê¸°</button>
                                            <button class="btn btn-outline-secondary btn-sm bill-btn" data-type="invoice_download" data-idx="${subscription.spiIdx}">ë‹¤ìš´ë¡œë“œ</button>
                                        </td>
                                        <td><button class="btn btn-sm btn-outline-primary" onclick="showSubscriptionModal()">ìƒì„¸</button></td>
                                    </tr>`;
                                tbody.append(row);
                            });
                            $('#subscriptionCount').text(res.body.length);
                        } else {
                            tbody.append(`<tr><td colspan="7">êµ¬ë… ë‚´ì—­ ì—†ìŒ</td></tr>`);
                        }
                    },
                    error: function() {
                        $('#subscriptionTableBody').empty();
                    }
                });
            });

            // ì²­êµ¬ì„œ/ê³„ì•½ì„œ ë²„íŠ¼ í´ë¦­ ì‹œ íŒŒì¼ ë¡œë”©
            $(document).on('click', '.bill-btn', function () {
                const spiIdx = $(this).data('idx');
                const [docType, type] = $(this).data('type').split('_');
                console.log(spiIdx, type);

                let url = "";
                if (type === "download") {
                    url = `/subscription/report/${docType}/${spiIdx}`;
                } else if (type === "preview") {
                    url = `/subscription/report/preview/${docType}/${spiIdx}`;
                }

                // íŒì—… ì°½ ì˜µì…˜
                const popupOptions = "width=800,height=1000,scrollbars=yes,resizable=yes";

                // ìƒˆ ì°½ ì—´ê¸°
                window.open(url, "_blank", popupOptions);
            });

            // ì´ˆê¸° íšŒì‚¬ ëª©ë¡ ë¡œë”©
            loadCompanyList();
        });
        
        // êµ¬ë… ì •ë³´ ëª¨ë‹¬ í‘œì‹œ
        function showSubscriptionModal() {
            const modal = new bootstrap.Modal(document.getElementById('subscriptionModal'));
            modal.show();
        }
    </script>
</div>