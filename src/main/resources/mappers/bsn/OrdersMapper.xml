<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--  Orders & OrdersDetail 매퍼  -->
<mapper namespace="com.eflix.bsn.mapper.OrdersMapper">

  <!--─────────────────────────────-->
  <!-- 1. 주문 목록 (헤더 그리드)     -->
  <!--─────────────────────────────-->
  <select id="selectAllOrders" resultType="com.eflix.bsn.dto.OrdersDTO">
    SELECT
      ORDER_NO       AS orderNo,
      ORDER_DT       AS orderDt,
      PAYMENT_TERMS  AS paymentTerms,
      CUSTOMER_CD    AS customerCd,
      CO_IDX         AS coIdx,
      ORDER_WRITER   AS orderWriter,
      REMARKS        AS remarks
    FROM ORDERS
    ORDER BY ORDER_DT DESC
  </select>

  <!--─────────────────────────────-->
  <!-- 2. 주문 단건 헤더              -->
  <!--─────────────────────────────-->
  <select id="selectOrderHeader" resultType="com.eflix.bsn.dto.OrdersDTO">
    SELECT
      ORDER_NO       AS orderNo,
      ORDER_DT       AS orderDt,
      PAYMENT_TERMS  AS paymentTerms,
      CUSTOMER_CD    AS customerCd,
      CO_IDX         AS coIdx,
      ORDER_WRITER   AS orderWriter,
      REMARKS        AS remarks
    FROM ORDERS
    WHERE ORDER_NO = #{orderNo}
  </select>

  <!--─────────────────────────────-->
  <!-- 3. 주문 상세 목록              -->
  <!--─────────────────────────────-->
  <select id="selectOrderDetails" resultType="com.eflix.bsn.dto.OrdersDetailDTO">
    SELECT
      ORDER_NO        AS orderNo,
      LINE_NO         AS lineNo,
      ITEM_CODE       AS itemCode,
      ITEM_NAME       AS itemName,
      SPEC            AS spec,
      QTY             AS qty,
      UNIT_PRICE      AS unitPrice,
      SUPPLY_AMOUNT   AS supplyAmount,
      TAX_AMOUNT      AS taxAmount,
      TOTAL_AMOUNT    AS totalAmount,
      REMARKS         AS remarks,
      CO_IDX          AS coIdx,
      OUTBOUND_DT     AS outboundDt,
      CATCH_DT        AS catchDt,
      OUT_STATE       AS outState
    FROM ORDERS_DETAIL
    WHERE ORDER_NO = #{orderNo}
    ORDER BY LINE_NO
  </select>

  <!--─────────────────────────────-->
  <!-- 4. 주문번호 채번               -->
  <!--─────────────────────────────-->
  <select id="selectNextOrderNo" resultType="string">
    SELECT FN_NEXT_ORDER_NO FROM DUAL
  </select>

  <!--─────────────────────────────-->
  <!-- 5. 주문 INSERT                -->
  <!--─────────────────────────────-->
  <insert id="insertOrder" parameterType="com.eflix.bsn.dto.OrdersDTO">
    INSERT INTO ORDERS (
      ORDER_NO, ORDER_DT, PAYMENT_TERMS,
      CUSTOMER_CD, CO_IDX, ORDER_WRITER, REMARKS
    ) VALUES (
      #{orderNo}, #{orderDt}, #{paymentTerms},
      #{customerCd}, #{coIdx}, #{orderWriter}, #{remarks}
    )
  </insert>

  <!--─────────────────────────────-->
  <!-- 6. 주문 UPDATE                -->
  <!--─────────────────────────────-->
  <update id="updateOrder" parameterType="com.eflix.bsn.dto.OrdersDTO">
    UPDATE ORDERS
        SET ORDER_DT       = #{orderDt},
          PAYMENT_TERMS  = #{paymentTerms},
          CUSTOMER_CD    = #{customerCd},
          CO_IDX         = #{coIdx},
          ORDER_WRITER   = #{orderWriter},
          REMARKS        = #{remarks},
          UPD_DT         = SYSDATE
        WHERE ORDER_NO = #{orderNo}
  </update>

  <!--─────────────────────────────-->
  <!-- 7. 주문 DELETE (헤더)          -->
  <!--─────────────────────────────-->
  <delete id="deleteOrder" parameterType="string">
    DELETE FROM ORDERS
    WHERE ORDER_NO = #{orderNo}
  </delete>

  <!--─────────────────────────────-->
  <!-- 8. 상세 DELETE ALL             -->
  <!--─────────────────────────────-->
  <delete id="deleteOrderDetailAll" parameterType="string">
    DELETE FROM ORDERS_DETAIL
    WHERE ORDER_NO = #{orderNo}
  </delete>

  <!--─────────────────────────────-->
  <!-- 9. 상세 INSERT ALL             -->
  <!--─────────────────────────────-->
  <insert id="insertOrderDetailBatch">
    INSERT ALL
    <foreach collection="list" item="d">
      INTO ORDERS_DETAIL (
        ORDER_NO, LINE_NO, ITEM_CODE, ITEM_NAME, SPEC,
        QTY, UNIT_PRICE, SUPPLY_AMOUNT, TAX_AMOUNT, TOTAL_AMOUNT,
        REMARKS, CO_IDX, OUTBOUND_DT, CATCH_DT, OUT_STATE
      ) VALUES (
        #{d.orderNo}, #{d.lineNo}, #{d.itemCode}, #{d.itemName}, #{d.spec},
        #{d.qty}, #{d.unitPrice}, #{d.supplyAmount}, #{d.taxAmount}, #{d.totalAmount},
        #{d.remarks}, #{d.coIdx}, #{d.outboundDt}, #{d.catchDt}, #{d.outState}
      )
    </foreach>
    SELECT 1 FROM DUAL
  </insert>

</mapper>
