<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.eflix.bsn.mapper.OrdersMapper">

  <!-- 결과 매핑 정의 (DTO 필드명과 칼럼명을 1:1 매핑) -->
  <resultMap id="OrdersResultMap" type="com.eflix.bsn.dto.OrdersDTO">
    <id     property="orderNo"           column="ORDER_NO"            />
    <result property="quotationNo"       column="QUOTATION_NO"        />
    <result property="orderDate"         column="ORDER_DT"            />
    <result property="phoneNumber"       column="PHONE_NUMBER"        />
    <result property="deliveryAddr"      column="DELIVERY_ADDR"       />
    <result property="warehouseCd"       column="WAREHOUSE_CD"        />
    <result property="deliveryDt"        column="DELIVERY_DT"         />
    <result property="expectedPaymentDt" column="EXPECTED_PAYMENT_DT" />
    <result property="paymentTerms"      column="PAYMENT_TERMS"       />
    <result property="taxInvoiceYn"      column="TAX_INVOICE_ISSUE_YN" />
    <result property="customerCd"        column="CUSTOMER_CD"         />
  </resultMap>

  <!-- 전체 주문 조회 -->
  <select id="selectAllOrders" resultMap="OrdersResultMap">
    SELECT
      ORDER_NO,
      QUOTATION_NO,
      ORDER_DT,
      PHONE_NUMBER,
      DELIVERY_ADDR,
      WAREHOUSE_CD,
      DELIVERY_DT,
      EXPECTED_PAYMENT_DT,
      PAYMENT_TERMS,
      TAX_INVOICE_ISSUE_YN,
      CUSTOMER_CD
    FROM ORDERS
    ORDER BY ORDER_DT DESC
  </select>

  <!-- 주문 헤더 INSERT -->
  <insert id="insertOrder" parameterType="com.eflix.bsn.dto.OrdersDTO">
    INSERT INTO ORDERS
    ( ORDER_NO
    , QUOTATION_NO
    , ORDER_DT
    , PHONE_NUMBER
    , DELIVERY_ADDR
    , WAREHOUSE_CD
    , DELIVERY_DT
    , EXPECTED_PAYMENT_DT
    , PAYMENT_TERMS
    , TAX_INVOICE_ISSUE_YN
    , CUSTOMER_CD
    )
    VALUES
    ( #{orderNo}
    , #{quotationNo}
    , #{orderDate}
    , #{phoneNumber}
    , #{deliveryAddr}
    , #{warehouseCd}
    , #{deliveryDt}
    , #{expectedPaymentDt}
    , #{paymentTerms}
    , #{taxInvoiceYn}
    , #{customerCd}
    )
  </insert>

  <!-- 주문 상세 INSERT -->
  <insert id="insertOrderDetail" parameterType="com.eflix.bsn.dto.OrdersDetailDTO">
    INSERT INTO ORDER_DETAIL
    ( ORDER_NO
    , LINE_NO
    , ITEM_CODE
    , QTY
    , UNIT_PRICE
    , SUPPLY_AMOUNT
    , TAX_AMOUNT
    , TOTAL_AMOUNT
    , REMARKS
    )
    VALUES
    ( #{orderNo}
    , #{lineNo}
    , #{itemCode}
    , #{qty}
    , #{unitPrice}
    , #{supplyAmount}
    , #{taxAmount}
    , #{totalAmount}
    , #{remarks}
    )
  </insert>

  <!-- 여신 사용액 누적 UPDATE -->
  <update id="updateCreditUsed" parameterType="map">
    UPDATE CREDIT_MANAGEMENT
    SET CREDIT_USED = CREDIT_USED + #{amount}
    WHERE CUSTOMER_CD = #{customerCd}
  </update>

</mapper>
